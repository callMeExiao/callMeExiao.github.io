import{_ as a,c as n,a as p,o as c}from"./app-pBrtxVLr.js";const e={};function l(i,s){return c(),n("div",null,[...s[0]||(s[0]=[p(`<h2 id="_1-å¼•è¨€" tabindex="-1"><a class="header-anchor" href="#_1-å¼•è¨€"><span>1. å¼•è¨€</span></a></h2><p>ä½œä¸ºä¸€ååç«¯å¼€å‘è€…ï¼Œåœ¨æ—¥å¸¸å·¥ä½œä¸­æˆ‘ä»¬ç»å¸¸æ¥è§¦MySQLæ•°æ®åº“ï¼Œä½†éšç€ä¸šåŠ¡å¤æ‚åº¦çš„æå‡ï¼Œæˆ‘å¼€å§‹æ¥è§¦åˆ°PostgreSQLè¿™ä¸ª&quot; ä¸–ç•Œä¸Šæœ€å…ˆè¿›çš„å¼€æºå…³ç³»å‹æ•°æ®åº“&quot;ã€‚åˆæ¬¡ä½¿ç”¨PostgreSQLï¼Œæˆ‘è¢«å®ƒå¼ºå¤§çš„åŠŸèƒ½ç‰¹æ€§æ·±æ·±éœ‡æ’¼ã€‚</p><h3 id="ä¸ºä»€ä¹ˆé€‰æ‹©postgresql" tabindex="-1"><a class="header-anchor" href="#ä¸ºä»€ä¹ˆé€‰æ‹©postgresql"><span>ä¸ºä»€ä¹ˆé€‰æ‹©PostgreSQLï¼Ÿ</span></a></h3><p>ç›¸æ¯”MySQLï¼ŒPostgreSQLåœ¨ä»¥ä¸‹æ–¹é¢è¡¨ç°å‡ºè‰²ï¼š</p><ul><li>ğŸ¯ <strong>æ›´ä¸°å¯Œçš„æ•°æ®ç±»å‹</strong>ï¼šåŸç”Ÿæ”¯æŒJSONã€æ•°ç»„ã€åœ°ç†æ•°æ®ç­‰</li><li>ğŸš€ <strong>æ›´å¼ºå¤§çš„æŸ¥è¯¢èƒ½åŠ›</strong>ï¼šçª—å£å‡½æ•°ã€CTEã€å…¨æ–‡æœç´¢ç­‰</li><li>ğŸŒ <strong>åœ°ç†ä¿¡æ¯å¤„ç†</strong>ï¼šPostGISæ‰©å±•æä¾›ä¸“ä¸šçº§GISåŠŸèƒ½</li><li>âš¡ <strong>é«˜åº¦å¯æ‰©å±•</strong>ï¼šä¸°å¯Œçš„æ‰©å±•ç”Ÿæ€ç³»ç»Ÿ</li><li>ğŸ”’ <strong>ä¼ä¸šçº§ç‰¹æ€§</strong>ï¼šMVCCã€é«˜çº§ç´¢å¼•ã€å¤åˆ¶ç­‰</li></ul><h3 id="æœ¬æ–‡æ¦‚è¿°" tabindex="-1"><a class="header-anchor" href="#æœ¬æ–‡æ¦‚è¿°"><span>æœ¬æ–‡æ¦‚è¿°</span></a></h3><p>æœ¬æ–‡å°†æ·±å…¥ä»‹ç»PostgreSQLç›¸æ¯”MySQLçš„ç‹¬ç‰¹ä¼˜åŠ¿ï¼Œé‡ç‚¹è®²è§£PostGISåœ°ç†åŠŸèƒ½ï¼Œå¹¶åˆ†äº«å®é™…å·¥ä½œä¸­çš„åº”ç”¨åœºæ™¯ã€‚æ— è®ºä½ æ˜¯æ•°æ®åº“æ–°æ‰‹è¿˜æ˜¯æœ‰ç»éªŒçš„å¼€å‘è€…ï¼Œéƒ½èƒ½ä»ä¸­è·å¾—æœ‰ä»·å€¼çš„çŸ¥è¯†ã€‚</p><h2 id="_2-postgresqlçš„ç‹¬ç‰¹æ•°æ®ç±»å‹æ”¯æŒ-ğŸ¯" tabindex="-1"><a class="header-anchor" href="#_2-postgresqlçš„ç‹¬ç‰¹æ•°æ®ç±»å‹æ”¯æŒ-ğŸ¯"><span>2. PostgreSQLçš„ç‹¬ç‰¹æ•°æ®ç±»å‹æ”¯æŒ ğŸ¯</span></a></h2><p>PostgreSQLæœ€ä»¤äººå°è±¡æ·±åˆ»çš„ç‰¹æ€§ä¹‹ä¸€å°±æ˜¯å…¶ä¸°å¯Œçš„æ•°æ®ç±»å‹æ”¯æŒï¼Œè¿™ä¸ºå¼€å‘è€…æä¾›äº†æ›´å¤§çš„çµæ´»æ€§ã€‚</p><h3 id="json-jsonbç±»å‹" tabindex="-1"><a class="header-anchor" href="#json-jsonbç±»å‹"><span>JSON/JSONBç±»å‹</span></a></h3><p>PostgreSQLåŸç”Ÿæ”¯æŒJSONæ•°æ®ç±»å‹ï¼Œè¿™åœ¨å¤„ç†åŠç»“æ„åŒ–æ•°æ®æ—¶éå¸¸æœ‰ç”¨ã€‚</p><h4 id="åŸºæœ¬ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬ä½¿ç”¨"><span>åŸºæœ¬ä½¿ç”¨</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºåŒ…å«JSONå­—æ®µçš„è¡¨</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>products</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name</span><span class="space"> </span><span>VARCHAR(100),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>attributes</span><span class="space"> </span><span>JSON,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>metadata</span><span class="space"> </span><span>JSONB</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æ’å…¥JSONæ•°æ®</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>products</span><span class="space"> </span><span>(name,</span><span class="space"> </span><span>attributes,</span><span class="space"> </span><span>metadata)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;iPhone</span><span class="space"> </span><span>15&#39;,</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span>&#39;{&quot;color&quot;:</span><span class="space"> </span><span>&quot;blue&quot;,</span><span class="space"> </span><span>&quot;storage&quot;:</span><span class="space"> </span><span>&quot;128GB&quot;,</span><span class="space"> </span><span>&quot;price&quot;:</span><span class="space"> </span><span>999}&#39;,</span></span>
<span class="line"><span class="space"> </span><span>&#39;{&quot;brand&quot;:</span><span class="space"> </span><span>&quot;Apple&quot;,</span><span class="space"> </span><span>&quot;category&quot;:</span><span class="space"> </span><span>&quot;smartphone&quot;,</span><span class="space"> </span><span>&quot;tags&quot;:</span><span class="space"> </span><span>[&quot;5G&quot;,</span><span class="space"> </span><span>&quot;premium&quot;]}&#39;</span></span>
<span class="line"><span>);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="jsonbçš„ä¼˜åŠ¿" tabindex="-1"><a class="header-anchor" href="#jsonbçš„ä¼˜åŠ¿"><span>JSONBçš„ä¼˜åŠ¿</span></a></h4><p>JSONBæ˜¯äºŒè¿›åˆ¶æ ¼å¼çš„JSONï¼Œæ”¯æŒç´¢å¼•å’Œé«˜æ•ˆæŸ¥è¯¢ï¼š</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºJSONBç´¢å¼•</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_metadata_gin</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>products</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>GIN</span><span class="space"> </span><span>(metadata);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>é«˜æ•ˆçš„JSONæŸ¥è¯¢</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>*</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>products</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>metadata</span><span class="space"> </span><span>@&gt;</span><span class="space"> </span><span>&#39;{&quot;brand&quot;:</span><span class="space"> </span><span>&quot;Apple&quot;}&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>JSONè·¯å¾„æŸ¥è¯¢</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>name,</span><span class="space"> </span><span>metadata-&gt;&#39;brand&#39;</span><span class="space"> </span><span>as</span><span class="space"> </span><span>brand</span><span class="space"> </span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>products</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>metadata-&gt;&gt;&#39;category&#39;</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;smartphone&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>JSONæ•°ç»„æ“ä½œ</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>name</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>products</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>metadata-&gt;&#39;tags&#39;</span><span class="space"> </span><span>?</span><span class="space"> </span><span>&#39;premium&#39;;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å®é™…åº”ç”¨åœºæ™¯" tabindex="-1"><a class="header-anchor" href="#å®é™…åº”ç”¨åœºæ™¯"><span>å®é™…åº”ç”¨åœºæ™¯</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>ç”µå•†å•†å“å±æ€§å­˜å‚¨</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>ecommerce_products</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name</span><span class="space"> </span><span>VARCHAR(200),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>base_price</span><span class="space"> </span><span>DECIMAL(10,2),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>specifications</span><span class="space"> </span><span>JSONB,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>created_at</span><span class="space"> </span><span>TIMESTAMP</span><span class="space"> </span><span>DEFAULT</span><span class="space"> </span><span>NOW()</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ä¸åŒç±»å‹å•†å“æœ‰ä¸åŒå±æ€§</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>ecommerce_products</span><span class="space"> </span><span>(name,</span><span class="space"> </span><span>base_price,</span><span class="space"> </span><span>specifications)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;MacBook</span><span class="space"> </span><span>Pro&#39;,</span><span class="space"> </span><span>1999.00,</span><span class="space"> </span><span>&#39;{&quot;screen_size&quot;:</span><span class="space"> </span><span>&quot;14inch&quot;,</span><span class="space"> </span><span>&quot;processor&quot;:</span><span class="space"> </span><span>&quot;M3&quot;,</span><span class="space"> </span><span>&quot;ram&quot;:</span><span class="space"> </span><span>&quot;16GB&quot;,</span><span class="space"> </span><span>&quot;storage&quot;:</span><span class="space"> </span><span>&quot;512GB&quot;}&#39;),</span></span>
<span class="line"><span>(&#39;Nike</span><span class="space"> </span><span>Air</span><span class="space"> </span><span>Max&#39;,</span><span class="space"> </span><span>129.99,</span><span class="space"> </span><span>&#39;{&quot;size&quot;:</span><span class="space"> </span><span>[7,</span><span class="space"> </span><span>8,</span><span class="space"> </span><span>9,</span><span class="space"> </span><span>10,</span><span class="space"> </span><span>11],</span><span class="space"> </span><span>&quot;color&quot;:</span><span class="space"> </span><span>[&quot;black&quot;,</span><span class="space"> </span><span>&quot;white&quot;,</span><span class="space"> </span><span>&quot;red&quot;],</span><span class="space"> </span><span>&quot;material&quot;:</span><span class="space"> </span><span>&quot;mesh&quot;}&#39;),</span></span>
<span class="line"><span>(&#39;Coffee</span><span class="space"> </span><span>Maker&#39;,</span><span class="space"> </span><span>89.99,</span><span class="space"> </span><span>&#39;{&quot;capacity&quot;:</span><span class="space"> </span><span>&quot;12cups&quot;,</span><span class="space"> </span><span>&quot;features&quot;:</span><span class="space"> </span><span>[&quot;programmable&quot;,</span><span class="space"> </span><span>&quot;auto-shutoff&quot;],</span><span class="space"> </span><span>&quot;warranty&quot;:</span><span class="space"> </span><span>&quot;2years&quot;}&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>çµæ´»æŸ¥è¯¢ä¸åŒå±æ€§</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>name,</span><span class="space"> </span><span>specifications-&gt;&#39;processor&#39;</span><span class="space"> </span><span>as</span><span class="space"> </span><span>cpu</span><span class="space"> </span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>ecommerce_products</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>specifications</span><span class="space"> </span><span>?</span><span class="space"> </span><span>&#39;processor&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>name,</span><span class="space"> </span><span>jsonb_array_elements_text(specifications-&gt;&#39;color&#39;)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>available_colors</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>ecommerce_products</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>specifications</span><span class="space"> </span><span>?</span><span class="space"> </span><span>&#39;color&#39;;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ•°ç»„ç±»å‹" tabindex="-1"><a class="header-anchor" href="#æ•°ç»„ç±»å‹"><span>æ•°ç»„ç±»å‹</span></a></h3><p>PostgreSQLæ”¯æŒä»»ä½•æ•°æ®ç±»å‹çš„æ•°ç»„ï¼Œè¿™åœ¨å¾ˆå¤šåœºæ™¯ä¸‹éå¸¸å®ç”¨ã€‚</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>æ•°ç»„å­—æ®µå®šä¹‰</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>blog_posts</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>title</span><span class="space"> </span><span>VARCHAR(200),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>tags</span><span class="space"> </span><span>TEXT[],</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>view_counts</span><span class="space"> </span><span>INTEGER[],</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>publish_dates</span><span class="space"> </span><span>DATE[]</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æ’å…¥æ•°ç»„æ•°æ®</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>blog_posts</span><span class="space"> </span><span>(title,</span><span class="space"> </span><span>tags,</span><span class="space"> </span><span>view_counts)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;PostgreSQLå…¥é—¨&#39;,</span><span class="space"> </span><span>ARRAY[&#39;æ•°æ®åº“&#39;,</span><span class="space"> </span><span>&#39;PostgreSQL&#39;,</span><span class="space"> </span><span>&#39;æ•™ç¨‹&#39;],</span><span class="space"> </span><span>ARRAY[100,</span><span class="space"> </span><span>150,</span><span class="space"> </span><span>200]),</span></span>
<span class="line"><span>(&#39;Reactå¼€å‘æŒ‡å—&#39;,</span><span class="space"> </span><span>ARRAY[&#39;å‰ç«¯&#39;,</span><span class="space"> </span><span>&#39;React&#39;,</span><span class="space"> </span><span>&#39;JavaScript&#39;],</span><span class="space"> </span><span>ARRAY[300,</span><span class="space"> </span><span>280,</span><span class="space"> </span><span>320]);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æ•°ç»„æŸ¥è¯¢æ“ä½œ</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æŸ¥æ‰¾åŒ…å«ç‰¹å®šæ ‡ç­¾çš„æ–‡ç« </span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>title</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>blog_posts</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>&#39;PostgreSQL&#39;</span><span class="space"> </span><span>=</span><span class="space"> </span><span>ANY(tags);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æŸ¥æ‰¾æ ‡ç­¾æ•°ç»„é•¿åº¦</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>title,</span><span class="space"> </span><span>array_length(tags,</span><span class="space"> </span><span>1)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>tag_count</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>blog_posts;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æ•°ç»„èšåˆ</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>unnest(tags)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>tag,</span><span class="space"> </span><span>COUNT(*)</span><span class="space"> </span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>blog_posts</span><span class="space"> </span></span>
<span class="line"><span>GROUP</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>tag</span><span class="space"> </span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>count</span><span class="space"> </span><span>DESC;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="è‡ªå®šä¹‰æ•°æ®ç±»å‹" tabindex="-1"><a class="header-anchor" href="#è‡ªå®šä¹‰æ•°æ®ç±»å‹"><span>è‡ªå®šä¹‰æ•°æ®ç±»å‹</span></a></h3><p>PostgreSQLå…è®¸åˆ›å»ºè‡ªå®šä¹‰æ•°æ®ç±»å‹ï¼Œæä¾›æ›´å¼ºçš„ç±»å‹å®‰å…¨æ€§ã€‚</p><h4 id="æšä¸¾ç±»å‹" tabindex="-1"><a class="header-anchor" href="#æšä¸¾ç±»å‹"><span>æšä¸¾ç±»å‹</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºæšä¸¾ç±»å‹</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TYPE</span><span class="space"> </span><span>order_status</span><span class="space"> </span><span>AS</span><span class="space"> </span><span>ENUM</span><span class="space"> </span><span>(&#39;pending&#39;,</span><span class="space"> </span><span>&#39;processing&#39;,</span><span class="space"> </span><span>&#39;shipped&#39;,</span><span class="space"> </span><span>&#39;delivered&#39;,</span><span class="space"> </span><span>&#39;cancelled&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>orders</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>customer_name</span><span class="space"> </span><span>VARCHAR(100),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>status</span><span class="space"> </span><span>order_status</span><span class="space"> </span><span>DEFAULT</span><span class="space"> </span><span>&#39;pending&#39;,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>created_at</span><span class="space"> </span><span>TIMESTAMP</span><span class="space"> </span><span>DEFAULT</span><span class="space"> </span><span>NOW()</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ç±»å‹å®‰å…¨çš„æ’å…¥</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>orders</span><span class="space"> </span><span>(customer_name,</span><span class="space"> </span><span>status)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;å¼ ä¸‰&#39;,</span><span class="space"> </span><span>&#39;pending&#39;),</span></span>
<span class="line"><span>(&#39;æå››&#39;,</span><span class="space"> </span><span>&#39;processing&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æšä¸¾å€¼æ’åº</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>*</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>orders</span><span class="space"> </span><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>status;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å¤åˆç±»å‹" tabindex="-1"><a class="header-anchor" href="#å¤åˆç±»å‹"><span>å¤åˆç±»å‹</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºå¤åˆç±»å‹</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TYPE</span><span class="space"> </span><span>address_type</span><span class="space"> </span><span>AS</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>street</span><span class="space"> </span><span>VARCHAR(100),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>city</span><span class="space"> </span><span>VARCHAR(50),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>province</span><span class="space"> </span><span>VARCHAR(50),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>postal_code</span><span class="space"> </span><span>VARCHAR(10)</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>customers</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name</span><span class="space"> </span><span>VARCHAR(100),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>billing_address</span><span class="space"> </span><span>address_type,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>shipping_address</span><span class="space"> </span><span>address_type</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ä½¿ç”¨å¤åˆç±»å‹</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>customers</span><span class="space"> </span><span>(name,</span><span class="space"> </span><span>billing_address,</span><span class="space"> </span><span>shipping_address)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;ç‹äº”&#39;,</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span>ROW(&#39;ä¸­å…³æ‘å¤§è¡—1å·&#39;,</span><span class="space"> </span><span>&#39;åŒ—äº¬&#39;,</span><span class="space"> </span><span>&#39;åŒ—äº¬å¸‚&#39;,</span><span class="space"> </span><span>&#39;100080&#39;),</span></span>
<span class="line"><span class="space"> </span><span>ROW(&#39;æœé˜³è·¯88å·&#39;,</span><span class="space"> </span><span>&#39;åŒ—äº¬&#39;,</span><span class="space"> </span><span>&#39;åŒ—äº¬å¸‚&#39;,</span><span class="space"> </span><span>&#39;100020&#39;)</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æŸ¥è¯¢å¤åˆç±»å‹å­—æ®µ</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>name,</span><span class="space"> </span><span>(billing_address).city,</span><span class="space"> </span><span>(shipping_address).city</span><span class="space"> </span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>customers;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-é«˜çº§æŸ¥è¯¢åŠŸèƒ½-ğŸš€" tabindex="-1"><a class="header-anchor" href="#_3-é«˜çº§æŸ¥è¯¢åŠŸèƒ½-ğŸš€"><span>3. é«˜çº§æŸ¥è¯¢åŠŸèƒ½ ğŸš€</span></a></h2><p>PostgreSQLæä¾›äº†è®¸å¤šMySQLä¸å…·å¤‡çš„é«˜çº§æŸ¥è¯¢åŠŸèƒ½ï¼Œè®©å¤æ‚çš„æ•°æ®åˆ†æå˜å¾—ç®€å•ã€‚</p><h3 id="çª—å£å‡½æ•°-window-functions" tabindex="-1"><a class="header-anchor" href="#çª—å£å‡½æ•°-window-functions"><span>çª—å£å‡½æ•°ï¼ˆWindow Functionsï¼‰</span></a></h3><p>çª—å£å‡½æ•°æ˜¯PostgreSQLçš„æ€æ‰‹çº§åŠŸèƒ½ï¼Œå¯ä»¥åœ¨ä¸ä½¿ç”¨GROUP BYçš„æƒ…å†µä¸‹è¿›è¡Œèšåˆè®¡ç®—ã€‚</p><h4 id="æ’åå‡½æ•°" tabindex="-1"><a class="header-anchor" href="#æ’åå‡½æ•°"><span>æ’åå‡½æ•°</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºé”€å”®æ•°æ®è¡¨</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>sales</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>salesperson</span><span class="space"> </span><span>VARCHAR(50),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>region</span><span class="space"> </span><span>VARCHAR(50),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>amount</span><span class="space"> </span><span>DECIMAL(10,2),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>sale_date</span><span class="space"> </span><span>DATE</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>sales</span><span class="space"> </span><span>(salesperson,</span><span class="space"> </span><span>region,</span><span class="space"> </span><span>amount,</span><span class="space"> </span><span>sale_date)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;å¼ ä¸‰&#39;,</span><span class="space"> </span><span>&#39;ååŒ—&#39;,</span><span class="space"> </span><span>15000,</span><span class="space"> </span><span>&#39;2024-01-15&#39;),</span></span>
<span class="line"><span>(&#39;æå››&#39;,</span><span class="space"> </span><span>&#39;ååŒ—&#39;,</span><span class="space"> </span><span>12000,</span><span class="space"> </span><span>&#39;2024-01-16&#39;),</span></span>
<span class="line"><span>(&#39;ç‹äº”&#39;,</span><span class="space"> </span><span>&#39;åå—&#39;,</span><span class="space"> </span><span>18000,</span><span class="space"> </span><span>&#39;2024-01-17&#39;),</span></span>
<span class="line"><span>(&#39;èµµå…­&#39;,</span><span class="space"> </span><span>&#39;åå—&#39;,</span><span class="space"> </span><span>16000,</span><span class="space"> </span><span>&#39;2024-01-18&#39;),</span></span>
<span class="line"><span>(&#39;é’±ä¸ƒ&#39;,</span><span class="space"> </span><span>&#39;ååŒ—&#39;,</span><span class="space"> </span><span>14000,</span><span class="space"> </span><span>&#39;2024-01-19&#39;),</span></span>
<span class="line"><span>(&#39;å­™å…«&#39;,</span><span class="space"> </span><span>&#39;åå—&#39;,</span><span class="space"> </span><span>20000,</span><span class="space"> </span><span>&#39;2024-01-20&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ä½¿ç”¨çª—å£å‡½æ•°è¿›è¡Œæ’å</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>salesperson,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>region,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>amount,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ROW_NUMBER()</span><span class="space"> </span><span>OVER</span><span class="space"> </span><span>(ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>amount</span><span class="space"> </span><span>DESC)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>overall_rank,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>RANK()</span><span class="space"> </span><span>OVER</span><span class="space"> </span><span>(PARTITION</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>region</span><span class="space"> </span><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>amount</span><span class="space"> </span><span>DESC)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>region_rank,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>DENSE_RANK()</span><span class="space"> </span><span>OVER</span><span class="space"> </span><span>(PARTITION</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>region</span><span class="space"> </span><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>amount</span><span class="space"> </span><span>DESC)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>dense_region_rank</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>sales;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="lagå’Œleadå‡½æ•°" tabindex="-1"><a class="header-anchor" href="#lagå’Œleadå‡½æ•°"><span>LAGå’ŒLEADå‡½æ•°</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>è®¡ç®—é”€å”®é¢ç¯æ¯”å¢é•¿</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>salesperson,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>sale_date,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>amount,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>LAG(amount)</span><span class="space"> </span><span>OVER</span><span class="space"> </span><span>(PARTITION</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>salesperson</span><span class="space"> </span><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>sale_date)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>prev_amount,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>amount</span><span class="space"> </span><span>-</span><span class="space"> </span><span>LAG(amount)</span><span class="space"> </span><span>OVER</span><span class="space"> </span><span>(PARTITION</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>salesperson</span><span class="space"> </span><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>sale_date)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>growth,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>LEAD(amount)</span><span class="space"> </span><span>OVER</span><span class="space"> </span><span>(PARTITION</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>salesperson</span><span class="space"> </span><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>sale_date)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>next_amount</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>sales</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>salesperson,</span><span class="space"> </span><span>sale_date;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç§»åŠ¨å¹³å‡å’Œç´¯è®¡ç»Ÿè®¡" tabindex="-1"><a class="header-anchor" href="#ç§»åŠ¨å¹³å‡å’Œç´¯è®¡ç»Ÿè®¡"><span>ç§»åŠ¨å¹³å‡å’Œç´¯è®¡ç»Ÿè®¡</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>è®¡ç®—ç§»åŠ¨å¹³å‡å’Œç´¯è®¡é”€å”®é¢</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>sale_date,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>amount,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>AVG(amount)</span><span class="space"> </span><span>OVER</span><span class="space"> </span><span>(ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>sale_date</span><span class="space"> </span><span>ROWS</span><span class="space"> </span><span>BETWEEN</span><span class="space"> </span><span>2</span><span class="space"> </span><span>PRECEDING</span><span class="space"> </span><span>AND</span><span class="space"> </span><span>CURRENT</span><span class="space"> </span><span>ROW)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>moving_avg_3days,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SUM(amount)</span><span class="space"> </span><span>OVER</span><span class="space"> </span><span>(ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>sale_date)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>cumulative_sales,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>COUNT(*)</span><span class="space"> </span><span>OVER</span><span class="space"> </span><span>(ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>sale_date)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>cumulative_count</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>sales</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>sale_date;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å…¬ç”¨è¡¨è¡¨è¾¾å¼-cte" tabindex="-1"><a class="header-anchor" href="#å…¬ç”¨è¡¨è¡¨è¾¾å¼-cte"><span>å…¬ç”¨è¡¨è¡¨è¾¾å¼ï¼ˆCTEï¼‰</span></a></h3><p>CTEè®©å¤æ‚æŸ¥è¯¢æ›´åŠ æ¸…æ™°å’Œå¯ç»´æŠ¤ã€‚</p><h4 id="åŸºæœ¬cte" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬cte"><span>åŸºæœ¬CTE</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>ä½¿ç”¨CTEç®€åŒ–å¤æ‚æŸ¥è¯¢</span></span>
<span class="line"><span>WITH</span><span class="space"> </span><span>regional_stats</span><span class="space"> </span><span>AS</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>region,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>COUNT(*)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>sale_count,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SUM(amount)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>total_amount,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>AVG(amount)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>avg_amount</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>sales</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>GROUP</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>region</span></span>
<span class="line"><span>),</span></span>
<span class="line"><span>top_performers</span><span class="space"> </span><span>AS</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>salesperson,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SUM(amount)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>total_sales</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>sales</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>GROUP</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>salesperson</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>HAVING</span><span class="space"> </span><span>SUM(amount)</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>15000</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>rs.region,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>rs.total_amount,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>rs.avg_amount,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>COUNT(tp.salesperson)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>top_performer_count</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>regional_stats</span><span class="space"> </span><span>rs</span></span>
<span class="line"><span>LEFT</span><span class="space"> </span><span>JOIN</span><span class="space"> </span><span>sales</span><span class="space"> </span><span>s</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>rs.region</span><span class="space"> </span><span>=</span><span class="space"> </span><span>s.region</span></span>
<span class="line"><span>LEFT</span><span class="space"> </span><span>JOIN</span><span class="space"> </span><span>top_performers</span><span class="space"> </span><span>tp</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>s.salesperson</span><span class="space"> </span><span>=</span><span class="space"> </span><span>tp.salesperson</span></span>
<span class="line"><span>GROUP</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>rs.region,</span><span class="space"> </span><span>rs.total_amount,</span><span class="space"> </span><span>rs.avg_amount;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="é€’å½’cte" tabindex="-1"><a class="header-anchor" href="#é€’å½’cte"><span>é€’å½’CTE</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>ç»„ç»‡æ¶æ„é€’å½’æŸ¥è¯¢</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>employees</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name</span><span class="space"> </span><span>VARCHAR(50),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>manager_id</span><span class="space"> </span><span>INTEGER</span><span class="space"> </span><span>REFERENCES</span><span class="space"> </span><span>employees(id),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>department</span><span class="space"> </span><span>VARCHAR(50)</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>employees</span><span class="space"> </span><span>(name,</span><span class="space"> </span><span>manager_id,</span><span class="space"> </span><span>department)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;CEOå¼ æ€»&#39;,</span><span class="space"> </span><span>NULL,</span><span class="space"> </span><span>&#39;ç®¡ç†å±‚&#39;),</span></span>
<span class="line"><span>(&#39;CTOææ€»&#39;,</span><span class="space"> </span><span>1,</span><span class="space"> </span><span>&#39;æŠ€æœ¯éƒ¨&#39;),</span></span>
<span class="line"><span>(&#39;CFOç‹æ€»&#39;,</span><span class="space"> </span><span>1,</span><span class="space"> </span><span>&#39;è´¢åŠ¡éƒ¨&#39;),</span></span>
<span class="line"><span>(&#39;å¼€å‘ç»ç†èµµç»ç†&#39;,</span><span class="space"> </span><span>2,</span><span class="space"> </span><span>&#39;æŠ€æœ¯éƒ¨&#39;),</span></span>
<span class="line"><span>(&#39;é«˜çº§å¼€å‘é’±å·¥&#39;,</span><span class="space"> </span><span>4,</span><span class="space"> </span><span>&#39;æŠ€æœ¯éƒ¨&#39;),</span></span>
<span class="line"><span>(&#39;åˆçº§å¼€å‘å­™å·¥&#39;,</span><span class="space"> </span><span>4,</span><span class="space"> </span><span>&#39;æŠ€æœ¯éƒ¨&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>é€’å½’æŸ¥è¯¢ç»„ç»‡å±‚çº§</span></span>
<span class="line"><span>WITH</span><span class="space"> </span><span>RECURSIVE</span><span class="space"> </span><span>org_hierarchy</span><span class="space"> </span><span>AS</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>åŸºç¡€æŸ¥è¯¢ï¼šæ‰¾åˆ°é¡¶çº§ç®¡ç†è€…</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SELECT</span><span class="space"> </span><span>id,</span><span class="space"> </span><span>name,</span><span class="space"> </span><span>manager_id,</span><span class="space"> </span><span>department,</span><span class="space"> </span><span>0</span><span class="space"> </span><span>as</span><span class="space"> </span><span>level,</span><span class="space"> </span><span>name</span><span class="space"> </span><span>as</span><span class="space"> </span><span>path</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>employees</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>manager_id</span><span class="space"> </span><span>IS</span><span class="space"> </span><span>NULL</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>UNION</span><span class="space"> </span><span>ALL</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>é€’å½’æŸ¥è¯¢ï¼šæ‰¾åˆ°ä¸‹çº§å‘˜å·¥</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SELECT</span><span class="space"> </span><span>e.id,</span><span class="space"> </span><span>e.name,</span><span class="space"> </span><span>e.manager_id,</span><span class="space"> </span><span>e.department,</span><span class="space"> </span><span>oh.level</span><span class="space"> </span><span>+</span><span class="space"> </span><span>1,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>oh.path</span><span class="space"> </span><span>||</span><span class="space"> </span><span>&#39;</span><span class="space"> </span><span>-&gt;</span><span class="space"> </span><span>&#39;</span><span class="space"> </span><span>||</span><span class="space"> </span><span>e.name</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>employees</span><span class="space"> </span><span>e</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>INNER</span><span class="space"> </span><span>JOIN</span><span class="space"> </span><span>org_hierarchy</span><span class="space"> </span><span>oh</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>e.manager_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>oh.id</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>REPEAT(&#39;</span><span class="space"> </span><span class="space"> </span><span>&#39;,</span><span class="space"> </span><span>level)</span><span class="space"> </span><span>||</span><span class="space"> </span><span>name</span><span class="space"> </span><span>as</span><span class="space"> </span><span>hierarchy,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>department,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>level,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>path</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>org_hierarchy</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>path;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å…¨æ–‡æœç´¢" tabindex="-1"><a class="header-anchor" href="#å…¨æ–‡æœç´¢"><span>å…¨æ–‡æœç´¢</span></a></h3><p>PostgreSQLå†…ç½®å¼ºå¤§çš„å…¨æ–‡æœç´¢åŠŸèƒ½ã€‚</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºæ–‡ç« è¡¨</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>articles</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>title</span><span class="space"> </span><span>VARCHAR(200),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>content</span><span class="space"> </span><span>TEXT,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>author</span><span class="space"> </span><span>VARCHAR(50),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>created_at</span><span class="space"> </span><span>TIMESTAMP</span><span class="space"> </span><span>DEFAULT</span><span class="space"> </span><span>NOW()</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>articles</span><span class="space"> </span><span>(title,</span><span class="space"> </span><span>content,</span><span class="space"> </span><span>author)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;PostgreSQLé«˜çº§ç‰¹æ€§&#39;,</span><span class="space"> </span><span>&#39;PostgreSQLæ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„å¼€æºå…³ç³»å‹æ•°æ®åº“ï¼Œæ”¯æŒJSONã€æ•°ç»„ã€åœ°ç†æ•°æ®ç­‰å¤šç§æ•°æ®ç±»å‹...&#39;,</span><span class="space"> </span><span>&#39;å¼ ä¸‰&#39;),</span></span>
<span class="line"><span>(&#39;MySQL</span><span class="space"> </span><span>vs</span><span class="space"> </span><span>PostgreSQL&#39;,</span><span class="space"> </span><span>&#39;åœ¨é€‰æ‹©æ•°æ®åº“æ—¶ï¼ŒMySQLå’ŒPostgreSQLéƒ½æ˜¯ä¼˜ç§€çš„é€‰æ‹©ï¼Œä½†å®ƒä»¬å„æœ‰ç‰¹ç‚¹...&#39;,</span><span class="space"> </span><span>&#39;æå››&#39;),</span></span>
<span class="line"><span>(&#39;PostGISåœ°ç†æ•°æ®å¤„ç†&#39;,</span><span class="space"> </span><span>&#39;PostGISæ˜¯PostgreSQLçš„åœ°ç†ä¿¡æ¯æ‰©å±•ï¼Œæä¾›äº†ä¸°å¯Œçš„ç©ºé—´æ•°æ®å¤„ç†åŠŸèƒ½...&#39;,</span><span class="space"> </span><span>&#39;ç‹äº”&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æ·»åŠ å…¨æ–‡æœç´¢ç´¢å¼•</span></span>
<span class="line"><span>ALTER</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>articles</span><span class="space"> </span><span>ADD</span><span class="space"> </span><span>COLUMN</span><span class="space"> </span><span>search_vector</span><span class="space"> </span><span>tsvector;</span></span>
<span class="line"><span>UPDATE</span><span class="space"> </span><span>articles</span><span class="space"> </span><span>SET</span><span class="space"> </span><span>search_vector</span><span class="space"> </span><span>=</span><span class="space"> </span><span>to_tsvector(&#39;chinese&#39;,</span><span class="space"> </span><span>title</span><span class="space"> </span><span>||</span><span class="space"> </span><span>&#39;</span><span class="space"> </span><span>&#39;</span><span class="space"> </span><span>||</span><span class="space"> </span><span>content);</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_articles_search</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>articles</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>GIN(search_vector);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>å…¨æ–‡æœç´¢æŸ¥è¯¢</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>title,</span><span class="space"> </span><span>author,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ts_rank(search_vector,</span><span class="space"> </span><span>query)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>rank</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>articles,</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>to_tsquery(&#39;chinese&#39;,</span><span class="space"> </span><span>&#39;PostgreSQL</span><span class="space"> </span><span>&amp;</span><span class="space"> </span><span>æ•°æ®åº“&#39;)</span><span class="space"> </span><span>query</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>search_vector</span><span class="space"> </span><span>@@</span><span class="space"> </span><span>query</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>rank</span><span class="space"> </span><span>DESC;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æœç´¢ç»“æœé«˜äº®</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>title,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ts_headline(&#39;chinese&#39;,</span><span class="space"> </span><span>content,</span><span class="space"> </span><span>to_tsquery(&#39;chinese&#39;,</span><span class="space"> </span><span>&#39;PostgreSQL&#39;),</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&#39;MaxWords=20,</span><span class="space"> </span><span>MinWords=5&#39;)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>snippet</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>articles</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>search_vector</span><span class="space"> </span><span>@@</span><span class="space"> </span><span>to_tsquery(&#39;chinese&#39;,</span><span class="space"> </span><span>&#39;PostgreSQL&#39;);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-postgis-åœ°ç†ä¿¡æ¯ç³»ç»Ÿçš„ç‹è€…-ğŸŒ" tabindex="-1"><a class="header-anchor" href="#_4-postgis-åœ°ç†ä¿¡æ¯ç³»ç»Ÿçš„ç‹è€…-ğŸŒ"><span>4. PostGISï¼šåœ°ç†ä¿¡æ¯ç³»ç»Ÿçš„ç‹è€… ğŸŒ</span></a></h2><p>PostGISæ˜¯PostgreSQLæœ€å¼•äººæ³¨ç›®çš„æ‰©å±•ä¹‹ä¸€ï¼Œå®ƒå°†PostgreSQLè½¬å˜ä¸ºä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ç©ºé—´æ•°æ®åº“ã€‚è¿™æ˜¯PostgreSQLç›¸æ¯”MySQLæœ€å¤§çš„ä¼˜åŠ¿ä¹‹ä¸€ã€‚</p><h3 id="postgisç®€ä»‹" tabindex="-1"><a class="header-anchor" href="#postgisç®€ä»‹"><span>PostGISç®€ä»‹</span></a></h3><p>PostGISæ˜¯ä¸€ä¸ªå¼€æºçš„åœ°ç†ä¿¡æ¯ç³»ç»Ÿæ‰©å±•ï¼Œä¸ºPostgreSQLæä¾›äº†ç©ºé—´æ•°æ®ç±»å‹ã€ç©ºé—´ç´¢å¼•å’Œç©ºé—´å‡½æ•°ã€‚å®ƒç¬¦åˆOGCï¼ˆå¼€æ”¾åœ°ç†ç©ºé—´è”ç›Ÿï¼‰æ ‡å‡†ï¼Œè¢«å¹¿æ³›åº”ç”¨äºGISåº”ç”¨ã€ä½ç½®æœåŠ¡ã€åœ°å›¾åº”ç”¨ç­‰é¢†åŸŸã€‚</p><h4 id="å®‰è£…å’Œé…ç½®" tabindex="-1"><a class="header-anchor" href="#å®‰è£…å’Œé…ç½®"><span>å®‰è£…å’Œé…ç½®</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>å¯ç”¨PostGISæ‰©å±•</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>EXTENSION</span><span class="space"> </span><span>postgis;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æŸ¥çœ‹PostGISç‰ˆæœ¬</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>PostGIS_Version();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æŸ¥çœ‹æ”¯æŒçš„ç©ºé—´å‚è€ƒç³»ç»Ÿ</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>*</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>spatial_ref_sys</span><span class="space"> </span><span>LIMIT</span><span class="space"> </span><span>5;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ç©ºé—´æ•°æ®ç±»å‹" tabindex="-1"><a class="header-anchor" href="#ç©ºé—´æ•°æ®ç±»å‹"><span>ç©ºé—´æ•°æ®ç±»å‹</span></a></h3><p>PostGISæ”¯æŒå¤šç§ç©ºé—´æ•°æ®ç±»å‹ï¼Œæ¯ç§ç±»å‹éƒ½æœ‰å…¶ç‰¹å®šçš„ç”¨é€”ã€‚</p><h4 id="åŸºæœ¬å‡ ä½•ç±»å‹" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬å‡ ä½•ç±»å‹"><span>åŸºæœ¬å‡ ä½•ç±»å‹</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºåŒ…å«ç©ºé—´æ•°æ®çš„è¡¨</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>locations</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name</span><span class="space"> </span><span>VARCHAR(100),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>location</span><span class="space"> </span><span>GEOMETRY(POINT,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>WGS84åæ ‡ç³»çš„ç‚¹</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>area</span><span class="space"> </span><span>GEOMETRY(POLYGON,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>å¤šè¾¹å½¢åŒºåŸŸ</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>route</span><span class="space"> </span><span>GEOMETRY(LINESTRING,</span><span class="space"> </span><span>4326)</span><span class="space"> </span><span>--</span><span class="space"> </span><span>çº¿è·¯</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æ’å…¥ç©ºé—´æ•°æ®</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>locations</span><span class="space"> </span><span>(name,</span><span class="space"> </span><span>location,</span><span class="space"> </span><span>area)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;åŒ—äº¬å¤©å®‰é—¨&#39;,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.3974</span><span class="space"> </span><span>39.9093)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>NULL),</span></span>
<span class="line"><span>(&#39;ä¸Šæµ·å¤–æ»©&#39;,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(121.4944</span><span class="space"> </span><span>31.2407)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>NULL),</span></span>
<span class="line"><span>(&#39;æ·±åœ³å¸‚ä¸­å¿ƒåŒºåŸŸ&#39;,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(114.0579</span><span class="space"> </span><span>22.5431)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span>ST_GeomFromText(&#39;POLYGON((114.05</span><span class="space"> </span><span>22.54,</span><span class="space"> </span><span>114.06</span><span class="space"> </span><span>22.54,</span><span class="space"> </span><span>114.06</span><span class="space"> </span><span>22.53,</span><span class="space"> </span><span>114.05</span><span class="space"> </span><span>22.53,</span><span class="space"> </span><span>114.05</span><span class="space"> </span><span>22.54))&#39;,</span><span class="space"> </span><span>4326));</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å¤æ‚å‡ ä½•ç±»å‹" tabindex="-1"><a class="header-anchor" href="#å¤æ‚å‡ ä½•ç±»å‹"><span>å¤æ‚å‡ ä½•ç±»å‹</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>å¤šç‚¹ã€å¤šçº¿ã€å¤šé¢</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>complex_geometries</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name</span><span class="space"> </span><span>VARCHAR(100),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>multi_points</span><span class="space"> </span><span>GEOMETRY(MULTIPOINT,</span><span class="space"> </span><span>4326),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>multi_lines</span><span class="space"> </span><span>GEOMETRY(MULTILINESTRING,</span><span class="space"> </span><span>4326),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>multi_polygons</span><span class="space"> </span><span>GEOMETRY(MULTIPOLYGON,</span><span class="space"> </span><span>4326),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>collection</span><span class="space"> </span><span>GEOMETRY(GEOMETRYCOLLECTION,</span><span class="space"> </span><span>4326)</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æ’å…¥å¤æ‚å‡ ä½•æ•°æ®</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>complex_geometries</span><span class="space"> </span><span>(name,</span><span class="space"> </span><span>multi_points,</span><span class="space"> </span><span>multi_lines)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;è¿é”åº—ä½ç½®&#39;,</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span>ST_GeomFromText(&#39;MULTIPOINT((116.3974</span><span class="space"> </span><span>39.9093),</span><span class="space"> </span><span>(121.4944</span><span class="space"> </span><span>31.2407),</span><span class="space"> </span><span>(114.0579</span><span class="space"> </span><span>22.5431))&#39;,</span><span class="space"> </span><span>4326),</span></span>
<span class="line"><span class="space"> </span><span>ST_GeomFromText(&#39;MULTILINESTRING((116.39</span><span class="space"> </span><span>39.90,</span><span class="space"> </span><span>116.40</span><span class="space"> </span><span>39.91),</span><span class="space"> </span><span>(121.49</span><span class="space"> </span><span>31.24,</span><span class="space"> </span><span>121.50</span><span class="space"> </span><span>31.25))&#39;,</span><span class="space"> </span><span>4326)</span></span>
<span class="line"><span>);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ ¸å¿ƒåœ°ç†å‡½æ•°è¯¦è§£" tabindex="-1"><a class="header-anchor" href="#æ ¸å¿ƒåœ°ç†å‡½æ•°è¯¦è§£"><span>æ ¸å¿ƒåœ°ç†å‡½æ•°è¯¦è§£</span></a></h3><p>PostGISæä¾›äº†æ•°ç™¾ä¸ªç©ºé—´å‡½æ•°ï¼Œè¿™é‡Œä»‹ç»æœ€å¸¸ç”¨å’Œæœ€é‡è¦çš„å‡½æ•°ã€‚</p><h4 id="å‡ ä½•åˆ›å»ºå‡½æ•°" tabindex="-1"><a class="header-anchor" href="#å‡ ä½•åˆ›å»ºå‡½æ•°"><span>å‡ ä½•åˆ›å»ºå‡½æ•°</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>ST_MakePointï¼šåˆ›å»ºç‚¹å‡ ä½•</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>ST_MakePoint(116.3974,</span><span class="space"> </span><span>39.9093)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>point_geom;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ST_GeomFromTextï¼šä»WKTæ–‡æœ¬åˆ›å»ºå‡ ä½•</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.3974</span><span class="space"> </span><span>39.9093)&#39;,</span><span class="space"> </span><span>4326)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>point_from_text;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ST_Bufferï¼šåˆ›å»ºç¼“å†²åŒº</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>ST_Buffer(ST_GeomFromText(&#39;POINT(116.3974</span><span class="space"> </span><span>39.9093)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>0.01)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>buffer_area;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ST_MakeLineï¼šåˆ›å»ºçº¿å‡ ä½•</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>ST_MakeLine(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_MakePoint(116.3974,</span><span class="space"> </span><span>39.9093),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_MakePoint(121.4944,</span><span class="space"> </span><span>31.2407)</span></span>
<span class="line"><span>)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>line_geom;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ST_MakePolygonï¼šåˆ›å»ºå¤šè¾¹å½¢</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>ST_MakePolygon(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_GeomFromText(&#39;LINESTRING(116.39</span><span class="space"> </span><span>39.90,</span><span class="space"> </span><span>116.40</span><span class="space"> </span><span>39.90,</span><span class="space"> </span><span>116.40</span><span class="space"> </span><span>39.91,</span><span class="space"> </span><span>116.39</span><span class="space"> </span><span>39.91,</span><span class="space"> </span><span>116.39</span><span class="space"> </span><span>39.90)&#39;)</span></span>
<span class="line"><span>)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>polygon_geom;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç©ºé—´å…³ç³»å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#ç©ºé—´å…³ç³»å‡½æ•°"><span>ç©ºé—´å…³ç³»å‡½æ•°</span></a></h4><p>è¿™äº›å‡½æ•°ç”¨äºåˆ¤æ–­å‡ ä½•å¯¹è±¡ä¹‹é—´çš„ç©ºé—´å…³ç³»ï¼š</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºæµ‹è¯•æ•°æ®</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>spatial_test</span><span class="space"> </span><span>AS</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&#39;point1&#39;</span><span class="space"> </span><span>as</span><span class="space"> </span><span>name,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.40</span><span class="space"> </span><span>39.90)&#39;,</span><span class="space"> </span><span>4326)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>geom</span></span>
<span class="line"><span>UNION</span><span class="space"> </span><span>ALL</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&#39;point2&#39;,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.41</span><span class="space"> </span><span>39.91)&#39;,</span><span class="space"> </span><span>4326)</span></span>
<span class="line"><span>UNION</span><span class="space"> </span><span>ALL</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&#39;polygon1&#39;,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POLYGON((116.39</span><span class="space"> </span><span>39.89,</span><span class="space"> </span><span>116.42</span><span class="space"> </span><span>39.89,</span><span class="space"> </span><span>116.42</span><span class="space"> </span><span>39.92,</span><span class="space"> </span><span>116.39</span><span class="space"> </span><span>39.92,</span><span class="space"> </span><span>116.39</span><span class="space"> </span><span>39.89))&#39;,</span><span class="space"> </span><span>4326)</span></span>
<span class="line"><span>UNION</span><span class="space"> </span><span>ALL</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&#39;line1&#39;,</span><span class="space"> </span><span>ST_GeomFromText(&#39;LINESTRING(116.38</span><span class="space"> </span><span>39.88,</span><span class="space"> </span><span>116.43</span><span class="space"> </span><span>39.93)&#39;,</span><span class="space"> </span><span>4326);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ST_Containsï¼šåˆ¤æ–­æ˜¯å¦åŒ…å«</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>a.name</span><span class="space"> </span><span>as</span><span class="space"> </span><span>container,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>b.name</span><span class="space"> </span><span>as</span><span class="space"> </span><span>contained,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Contains(a.geom,</span><span class="space"> </span><span>b.geom)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>contains</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>spatial_test</span><span class="space"> </span><span>a,</span><span class="space"> </span><span>spatial_test</span><span class="space"> </span><span>b</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>a.name</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;polygon1&#39;</span><span class="space"> </span><span>AND</span><span class="space"> </span><span>b.name</span><span class="space"> </span><span>LIKE</span><span class="space"> </span><span>&#39;point%&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ST_Intersectsï¼šåˆ¤æ–­æ˜¯å¦ç›¸äº¤</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>a.name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>b.name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Intersects(a.geom,</span><span class="space"> </span><span>b.geom)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>intersects</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>spatial_test</span><span class="space"> </span><span>a,</span><span class="space"> </span><span>spatial_test</span><span class="space"> </span><span>b</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>a.name</span><span class="space"> </span><span>!=</span><span class="space"> </span><span>b.name;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ST_Withinï¼šåˆ¤æ–­æ˜¯å¦åœ¨å†…éƒ¨</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>a.name</span><span class="space"> </span><span>as</span><span class="space"> </span><span>inner_geom,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>b.name</span><span class="space"> </span><span>as</span><span class="space"> </span><span>outer_geom,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Within(a.geom,</span><span class="space"> </span><span>b.geom)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>within</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>spatial_test</span><span class="space"> </span><span>a,</span><span class="space"> </span><span>spatial_test</span><span class="space"> </span><span>b</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>a.name</span><span class="space"> </span><span>LIKE</span><span class="space"> </span><span>&#39;point%&#39;</span><span class="space"> </span><span>AND</span><span class="space"> </span><span>b.name</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;polygon1&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ST_Distanceï¼šè®¡ç®—è·ç¦»ï¼ˆå•ä½ï¼šåº¦ï¼‰</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>a.name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>b.name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Distance(a.geom,</span><span class="space"> </span><span>b.geom)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>distance_degrees,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Distance(ST_Transform(a.geom,</span><span class="space"> </span><span>3857),</span><span class="space"> </span><span>ST_Transform(b.geom,</span><span class="space"> </span><span>3857))</span><span class="space"> </span><span>as</span><span class="space"> </span><span>distance_meters</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>spatial_test</span><span class="space"> </span><span>a,</span><span class="space"> </span><span>spatial_test</span><span class="space"> </span><span>b</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>a.name</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;point1&#39;</span><span class="space"> </span><span>AND</span><span class="space"> </span><span>b.name</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;point2&#39;;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å‡ ä½•åˆ†æå‡½æ•°" tabindex="-1"><a class="header-anchor" href="#å‡ ä½•åˆ†æå‡½æ•°"><span>å‡ ä½•åˆ†æå‡½æ•°</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>ST_Areaï¼šè®¡ç®—é¢ç§¯</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Area(geom)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>area_degrees,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Area(ST_Transform(geom,</span><span class="space"> </span><span>3857))</span><span class="space"> </span><span>as</span><span class="space"> </span><span>area_square_meters</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>spatial_test</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>name</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;polygon1&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ST_Lengthï¼šè®¡ç®—é•¿åº¦</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Length(geom)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>length_degrees,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Length(ST_Transform(geom,</span><span class="space"> </span><span>3857))</span><span class="space"> </span><span>as</span><span class="space"> </span><span>length_meters</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>spatial_test</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>name</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;line1&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ST_Centroidï¼šè®¡ç®—ä¸­å¿ƒç‚¹</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_AsText(ST_Centroid(geom))</span><span class="space"> </span><span>as</span><span class="space"> </span><span>centroid</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>spatial_test</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>name</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;polygon1&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ST_Envelopeï¼šè®¡ç®—è¾¹ç•Œæ¡†</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_AsText(ST_Envelope(geom))</span><span class="space"> </span><span>as</span><span class="space"> </span><span>bounding_box</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>spatial_test;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ST_ConvexHullï¼šè®¡ç®—å‡¸åŒ…</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>ST_AsText(ST_ConvexHull(ST_Collect(geom)))</span><span class="space"> </span><span>as</span><span class="space"> </span><span>convex_hull</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>spatial_test;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="åæ ‡ç³»ç»Ÿå‡½æ•°" tabindex="-1"><a class="header-anchor" href="#åæ ‡ç³»ç»Ÿå‡½æ•°"><span>åæ ‡ç³»ç»Ÿå‡½æ•°</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>ST_Transformï¼šåæ ‡ç³»è½¬æ¢</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ä»WGS84</span><span class="space"> </span><span>(4326)</span><span class="space"> </span><span>è½¬æ¢åˆ°Web</span><span class="space"> </span><span>Mercator</span><span class="space"> </span><span>(3857)</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_AsText(geom)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>original_wgs84,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_AsText(ST_Transform(geom,</span><span class="space"> </span><span>3857))</span><span class="space"> </span><span>as</span><span class="space"> </span><span>transformed_web_mercator</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>spatial_test</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>name</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;point1&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ST_SetSRIDï¼šè®¾ç½®ç©ºé—´å‚è€ƒç³»ç»ŸID</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>ST_SetSRID(ST_MakePoint(116.3974,</span><span class="space"> </span><span>39.9093),</span><span class="space"> </span><span>4326)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>point_with_srid;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ST_SRIDï¼šè·å–ç©ºé—´å‚è€ƒç³»ç»ŸID</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>name,</span><span class="space"> </span><span>ST_SRID(geom)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>srid</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>spatial_test;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å®é™…åº”ç”¨åœºæ™¯-1" tabindex="-1"><a class="header-anchor" href="#å®é™…åº”ç”¨åœºæ™¯-1"><span>å®é™…åº”ç”¨åœºæ™¯</span></a></h3><h4 id="_1-é™„è¿‘å•†å®¶æŸ¥è¯¢" tabindex="-1"><a class="header-anchor" href="#_1-é™„è¿‘å•†å®¶æŸ¥è¯¢"><span>1. é™„è¿‘å•†å®¶æŸ¥è¯¢</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºå•†å®¶è¡¨</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>businesses</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name</span><span class="space"> </span><span>VARCHAR(100),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>category</span><span class="space"> </span><span>VARCHAR(50),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>location</span><span class="space"> </span><span>GEOMETRY(POINT,</span><span class="space"> </span><span>4326),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>rating</span><span class="space"> </span><span>DECIMAL(2,1)</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºç©ºé—´ç´¢å¼•</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_businesses_location</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>businesses</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>GIST</span><span class="space"> </span><span>(location);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æ’å…¥æµ‹è¯•æ•°æ®</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>businesses</span><span class="space"> </span><span>(name,</span><span class="space"> </span><span>category,</span><span class="space"> </span><span>location,</span><span class="space"> </span><span>rating)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;æ˜Ÿå·´å…‹(å›½è´¸åº—)&#39;,</span><span class="space"> </span><span>&#39;å’–å•¡&#39;,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.4074</span><span class="space"> </span><span>39.9093)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>4.5),</span></span>
<span class="line"><span>(&#39;éº¦å½“åŠ³(å»ºå›½é—¨åº—)&#39;,</span><span class="space"> </span><span>&#39;å¿«é¤&#39;,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.4174</span><span class="space"> </span><span>39.9093)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>4.2),</span></span>
<span class="line"><span>(&#39;æµ·åº•æ(ç‹åºœäº•åº—)&#39;,</span><span class="space"> </span><span>&#39;ç«é”…&#39;,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.4074</span><span class="space"> </span><span>39.9193)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>4.8),</span></span>
<span class="line"><span>(&#39;è‚¯å¾·åŸº(ä¸œå•åº—)&#39;,</span><span class="space"> </span><span>&#39;å¿«é¤&#39;,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.4174</span><span class="space"> </span><span>39.9193)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>4.1);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æŸ¥æ‰¾ç”¨æˆ·ä½ç½®1å…¬é‡Œå†…çš„å•†å®¶</span></span>
<span class="line"><span>WITH</span><span class="space"> </span><span>user_location</span><span class="space"> </span><span>AS</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SELECT</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.4074</span><span class="space"> </span><span>39.9143)&#39;,</span><span class="space"> </span><span>4326)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>location</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>b.name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>b.category,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>b.rating,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Distance(ST_Transform(b.location,</span><span class="space"> </span><span>3857),</span><span class="space"> </span><span>ST_Transform(ul.location,</span><span class="space"> </span><span>3857))</span><span class="space"> </span><span>as</span><span class="space"> </span><span>distance_meters</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>businesses</span><span class="space"> </span><span>b,</span><span class="space"> </span><span>user_location</span><span class="space"> </span><span>ul</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>ST_DWithin(ST_Transform(b.location,</span><span class="space"> </span><span>3857),</span><span class="space"> </span><span>ST_Transform(ul.location,</span><span class="space"> </span><span>3857),</span><span class="space"> </span><span>1000)</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>distance_meters;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-åœ°ç†å›´æ " tabindex="-1"><a class="header-anchor" href="#_2-åœ°ç†å›´æ "><span>2. åœ°ç†å›´æ </span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºåœ°ç†å›´æ è¡¨</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>geofences</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name</span><span class="space"> </span><span>VARCHAR(100),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>boundary</span><span class="space"> </span><span>GEOMETRY(POLYGON,</span><span class="space"> </span><span>4326),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>fence_type</span><span class="space"> </span><span>VARCHAR(50)</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æ’å…¥å›´æ æ•°æ®</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>geofences</span><span class="space"> </span><span>(name,</span><span class="space"> </span><span>boundary,</span><span class="space"> </span><span>fence_type)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;åŒ—äº¬äºŒç¯å†…&#39;,</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span>ST_GeomFromText(&#39;POLYGON((116.368</span><span class="space"> </span><span>39.915,</span><span class="space"> </span><span>116.427</span><span class="space"> </span><span>39.915,</span><span class="space"> </span><span>116.427</span><span class="space"> </span><span>39.875,</span><span class="space"> </span><span>116.368</span><span class="space"> </span><span>39.875,</span><span class="space"> </span><span>116.368</span><span class="space"> </span><span>39.915))&#39;,</span><span class="space"> </span><span>4326),</span></span>
<span class="line"><span class="space"> </span><span>&#39;restricted_zone&#39;),</span></span>
<span class="line"><span>(&#39;é…é€èŒƒå›´&#39;,</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span>ST_GeomFromText(&#39;POLYGON((116.390</span><span class="space"> </span><span>39.900,</span><span class="space"> </span><span>116.420</span><span class="space"> </span><span>39.900,</span><span class="space"> </span><span>116.420</span><span class="space"> </span><span>39.920,</span><span class="space"> </span><span>116.390</span><span class="space"> </span><span>39.920,</span><span class="space"> </span><span>116.390</span><span class="space"> </span><span>39.900))&#39;,</span><span class="space"> </span><span>4326),</span></span>
<span class="line"><span class="space"> </span><span>&#39;delivery_zone&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨å›´æ å†…</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>OR</span><span class="space"> </span><span>REPLACE</span><span class="space"> </span><span>FUNCTION</span><span class="space"> </span><span>check_geofence(user_lat</span><span class="space"> </span><span>DECIMAL,</span><span class="space"> </span><span>user_lng</span><span class="space"> </span><span>DECIMAL)</span></span>
<span class="line"><span>RETURNS</span><span class="space"> </span><span>TABLE(fence_name</span><span class="space"> </span><span>VARCHAR,</span><span class="space"> </span><span>is_inside</span><span class="space"> </span><span>BOOLEAN,</span><span class="space"> </span><span>fence_type</span><span class="space"> </span><span>VARCHAR)</span><span class="space"> </span><span>AS</span><span class="space"> </span><span>$$</span></span>
<span class="line"><span>BEGIN</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>RETURN</span><span class="space"> </span><span>QUERY</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>g.name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Contains(g.boundary,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(&#39;</span><span class="space"> </span><span>||</span><span class="space"> </span><span>user_lng</span><span class="space"> </span><span>||</span><span class="space"> </span><span>&#39;</span><span class="space"> </span><span>&#39;</span><span class="space"> </span><span>||</span><span class="space"> </span><span>user_lat</span><span class="space"> </span><span>||</span><span class="space"> </span><span>&#39;)&#39;,</span><span class="space"> </span><span>4326)),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>g.fence_type</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>geofences</span><span class="space"> </span><span>g;</span></span>
<span class="line"><span>END;</span></span>
<span class="line"><span>$$</span><span class="space"> </span><span>LANGUAGE</span><span class="space"> </span><span>plpgsql;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ä½¿ç”¨å‡½æ•°æ£€æŸ¥ä½ç½®</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>*</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>check_geofence(39.9093,</span><span class="space"> </span><span>116.4074);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-è·¯å¾„è§„åˆ’å’Œè·ç¦»è®¡ç®—" tabindex="-1"><a class="header-anchor" href="#_3-è·¯å¾„è§„åˆ’å’Œè·ç¦»è®¡ç®—"><span>3. è·¯å¾„è§„åˆ’å’Œè·ç¦»è®¡ç®—</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºè·¯å¾„ç‚¹è¡¨</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>route_points</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>route_id</span><span class="space"> </span><span>INTEGER,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>sequence_order</span><span class="space"> </span><span>INTEGER,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>location</span><span class="space"> </span><span>GEOMETRY(POINT,</span><span class="space"> </span><span>4326),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>address</span><span class="space"> </span><span>VARCHAR(200)</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æ’å…¥è·¯å¾„æ•°æ®</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>route_points</span><span class="space"> </span><span>(route_id,</span><span class="space"> </span><span>sequence_order,</span><span class="space"> </span><span>location,</span><span class="space"> </span><span>address)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(1,</span><span class="space"> </span><span>1,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.3974</span><span class="space"> </span><span>39.9093)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>&#39;å¤©å®‰é—¨&#39;),</span></span>
<span class="line"><span>(1,</span><span class="space"> </span><span>2,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.4074</span><span class="space"> </span><span>39.9193)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>&#39;ç‹åºœäº•&#39;),</span></span>
<span class="line"><span>(1,</span><span class="space"> </span><span>3,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.4174</span><span class="space"> </span><span>39.9093)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>&#39;å»ºå›½é—¨&#39;),</span></span>
<span class="line"><span>(1,</span><span class="space"> </span><span>4,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.4074</span><span class="space"> </span><span>39.8993)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>&#39;å‰é—¨&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>è®¡ç®—è·¯å¾„æ€»é•¿åº¦</span></span>
<span class="line"><span>WITH</span><span class="space"> </span><span>route_segments</span><span class="space"> </span><span>AS</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>route_id,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>sequence_order,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>location,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>LAG(location)</span><span class="space"> </span><span>OVER</span><span class="space"> </span><span>(PARTITION</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>route_id</span><span class="space"> </span><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>sequence_order)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>prev_location</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>route_points</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>route_id,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SUM(ST_Distance(ST_Transform(location,</span><span class="space"> </span><span>3857),</span><span class="space"> </span><span>ST_Transform(prev_location,</span><span class="space"> </span><span>3857)))</span><span class="space"> </span><span>as</span><span class="space"> </span><span>total_distance_meters</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>route_segments</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>prev_location</span><span class="space"> </span><span>IS</span><span class="space"> </span><span>NOT</span><span class="space"> </span><span>NULL</span></span>
<span class="line"><span>GROUP</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>route_id;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºè·¯å¾„çº¿å‡ ä½•</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>route_id,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_AsText(ST_MakeLine(location</span><span class="space"> </span><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>sequence_order))</span><span class="space"> </span><span>as</span><span class="space"> </span><span>route_line</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>route_points</span></span>
<span class="line"><span>GROUP</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>route_id;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-çƒ­åŠ›å›¾åˆ†æ" tabindex="-1"><a class="header-anchor" href="#_4-çƒ­åŠ›å›¾åˆ†æ"><span>4. çƒ­åŠ›å›¾åˆ†æ</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºäº‹ä»¶è¡¨ï¼ˆå¦‚å¤–å–è®¢å•ï¼‰</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>delivery_orders</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>order_time</span><span class="space"> </span><span>TIMESTAMP,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>delivery_location</span><span class="space"> </span><span>GEOMETRY(POINT,</span><span class="space"> </span><span>4326),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>order_value</span><span class="space"> </span><span>DECIMAL(10,2)</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æ’å…¥æ¨¡æ‹Ÿæ•°æ®</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>delivery_orders</span><span class="space"> </span><span>(order_time,</span><span class="space"> </span><span>delivery_location,</span><span class="space"> </span><span>order_value)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;2024-01-15</span><span class="space"> </span><span>12:30:00&#39;,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.4074</span><span class="space"> </span><span>39.9093)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>85.50),</span></span>
<span class="line"><span>(&#39;2024-01-15</span><span class="space"> </span><span>12:35:00&#39;,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.4084</span><span class="space"> </span><span>39.9103)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>92.30),</span></span>
<span class="line"><span>(&#39;2024-01-15</span><span class="space"> </span><span>12:40:00&#39;,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.4064</span><span class="space"> </span><span>39.9083)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>76.80),</span></span>
<span class="line"><span>(&#39;2024-01-15</span><span class="space"> </span><span>18:30:00&#39;,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.4174</span><span class="space"> </span><span>39.9193)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>156.20),</span></span>
<span class="line"><span>(&#39;2024-01-15</span><span class="space"> </span><span>18:35:00&#39;,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.4184</span><span class="space"> </span><span>39.9183)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>134.70);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºç½‘æ ¼è¿›è¡Œçƒ­åŠ›å›¾åˆ†æ</span></span>
<span class="line"><span>WITH</span><span class="space"> </span><span>grid</span><span class="space"> </span><span>AS</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>i,</span><span class="space"> </span><span>j,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_MakeEnvelope(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>116.40</span><span class="space"> </span><span>+</span><span class="space"> </span><span>(i</span><span class="space"> </span><span>*</span><span class="space"> </span><span>0.01),</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>39.90</span><span class="space"> </span><span>+</span><span class="space"> </span><span>(j</span><span class="space"> </span><span>*</span><span class="space"> </span><span>0.01),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>116.40</span><span class="space"> </span><span>+</span><span class="space"> </span><span>((i</span><span class="space"> </span><span>+</span><span class="space"> </span><span>1)</span><span class="space"> </span><span>*</span><span class="space"> </span><span>0.01),</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>39.90</span><span class="space"> </span><span>+</span><span class="space"> </span><span>((j</span><span class="space"> </span><span>+</span><span class="space"> </span><span>1)</span><span class="space"> </span><span>*</span><span class="space"> </span><span>0.01),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>4326</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>grid_cell</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>generate_series(0,</span><span class="space"> </span><span>2)</span><span class="space"> </span><span>i,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>generate_series(0,</span><span class="space"> </span><span>2)</span><span class="space"> </span><span>j</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>g.i,</span><span class="space"> </span><span>g.j,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>COUNT(o.id)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>order_count,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>COALESCE(SUM(o.order_value),</span><span class="space"> </span><span>0)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>total_value,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_AsText(ST_Centroid(g.grid_cell))</span><span class="space"> </span><span>as</span><span class="space"> </span><span>grid_center</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>grid</span><span class="space"> </span><span>g</span></span>
<span class="line"><span>LEFT</span><span class="space"> </span><span>JOIN</span><span class="space"> </span><span>delivery_orders</span><span class="space"> </span><span>o</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>ST_Contains(g.grid_cell,</span><span class="space"> </span><span>o.delivery_location)</span></span>
<span class="line"><span>GROUP</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>g.i,</span><span class="space"> </span><span>g.j,</span><span class="space"> </span><span>g.grid_cell</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>order_count</span><span class="space"> </span><span>DESC;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-æ‰©å±•ç”Ÿæ€ç³»ç»Ÿ" tabindex="-1"><a class="header-anchor" href="#_5-æ‰©å±•ç”Ÿæ€ç³»ç»Ÿ"><span>5. æ‰©å±•ç”Ÿæ€ç³»ç»Ÿ</span></a></h2><p>PostgreSQLçš„æ‰©å±•æœºåˆ¶æ˜¯å…¶æœ€å¼ºå¤§çš„ç‰¹æ€§ä¹‹ä¸€ï¼Œå…è®¸ç”¨æˆ·è½»æ¾æ·»åŠ æ–°åŠŸèƒ½è€Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç ã€‚</p><h3 id="pg-stat-statements-æ€§èƒ½ç›‘æ§" tabindex="-1"><a class="header-anchor" href="#pg-stat-statements-æ€§èƒ½ç›‘æ§"><span>pg_stat_statementsï¼ˆæ€§èƒ½ç›‘æ§ï¼‰</span></a></h3><p>è¿™ä¸ªæ‰©å±•æä¾›äº†æŸ¥è¯¢æ€§èƒ½ç»Ÿè®¡ä¿¡æ¯ï¼Œæ˜¯æ•°æ®åº“æ€§èƒ½è°ƒä¼˜çš„åˆ©å™¨ã€‚</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>å¯ç”¨æ‰©å±•</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>EXTENSION</span><span class="space"> </span><span>pg_stat_statements;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æŸ¥çœ‹æœ€è€—æ—¶çš„æŸ¥è¯¢</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>query,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>calls,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>total_time,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>mean_time,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>rows,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>100.0</span><span class="space"> </span><span>*</span><span class="space"> </span><span>shared_blks_hit</span><span class="space"> </span><span>/</span><span class="space"> </span><span>nullif(shared_blks_hit</span><span class="space"> </span><span>+</span><span class="space"> </span><span>shared_blks_read,</span><span class="space"> </span><span>0)</span><span class="space"> </span><span>AS</span><span class="space"> </span><span>hit_percent</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>pg_stat_statements</span><span class="space"> </span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>total_time</span><span class="space"> </span><span>DESC</span><span class="space"> </span></span>
<span class="line"><span>LIMIT</span><span class="space"> </span><span>10;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æŸ¥çœ‹æœ€é¢‘ç¹æ‰§è¡Œçš„æŸ¥è¯¢</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>query,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>calls,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>total_time,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>mean_time</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>pg_stat_statements</span><span class="space"> </span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>calls</span><span class="space"> </span><span>DESC</span><span class="space"> </span></span>
<span class="line"><span>LIMIT</span><span class="space"> </span><span>10;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>é‡ç½®ç»Ÿè®¡ä¿¡æ¯</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>pg_stat_statements_reset();</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="pg-trgm-æ¨¡ç³ŠåŒ¹é…" tabindex="-1"><a class="header-anchor" href="#pg-trgm-æ¨¡ç³ŠåŒ¹é…"><span>pg_trgmï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰</span></a></h3><p>æä¾›ä¸‰å…ƒç»„ï¼ˆtrigramï¼‰ç›¸ä¼¼åº¦åŒ¹é…ï¼Œæ”¯æŒæ¨¡ç³Šæœç´¢å’Œç›¸ä¼¼åº¦æŸ¥è¯¢ã€‚</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>å¯ç”¨æ‰©å±•</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>EXTENSION</span><span class="space"> </span><span>pg_trgm;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºæµ‹è¯•è¡¨</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>products_search</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name</span><span class="space"> </span><span>VARCHAR(200),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>description</span><span class="space"> </span><span>TEXT</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>products_search</span><span class="space"> </span><span>(name,</span><span class="space"> </span><span>description)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;iPhone</span><span class="space"> </span><span>15</span><span class="space"> </span><span>Pro</span><span class="space"> </span><span>Max&#39;,</span><span class="space"> </span><span>&#39;Appleæœ€æ–°æ——èˆ°æ‰‹æœºï¼Œé…å¤‡A17</span><span class="space"> </span><span>ProèŠ¯ç‰‡&#39;),</span></span>
<span class="line"><span>(&#39;Samsung</span><span class="space"> </span><span>Galaxy</span><span class="space"> </span><span>S24&#39;,</span><span class="space"> </span><span>&#39;ä¸‰æ˜Ÿæœ€æ–°Androidæ——èˆ°ï¼Œæ‹ç…§åŠŸèƒ½å¼ºå¤§&#39;),</span></span>
<span class="line"><span>(&#39;MacBook</span><span class="space"> </span><span>Pro</span><span class="space"> </span><span>M3&#39;,</span><span class="space"> </span><span>&#39;Appleä¸“ä¸šçº§ç¬”è®°æœ¬ç”µè„‘&#39;),</span></span>
<span class="line"><span>(&#39;ThinkPad</span><span class="space"> </span><span>X1</span><span class="space"> </span><span>Carbon&#39;,</span><span class="space"> </span><span>&#39;è”æƒ³å•†åŠ¡ç¬”è®°æœ¬ç”µè„‘&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºGINç´¢å¼•æ”¯æŒæ¨¡ç³Šæœç´¢</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_products_name_gin</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>products_search</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>GIN</span><span class="space"> </span><span>(name</span><span class="space"> </span><span>gin_trgm_ops);</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_products_desc_gin</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>products_search</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>GIN</span><span class="space"> </span><span>(description</span><span class="space"> </span><span>gin_trgm_ops);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ç›¸ä¼¼åº¦æœç´¢</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>similarity(name,</span><span class="space"> </span><span>&#39;iphone&#39;)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>name_similarity,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>similarity(description,</span><span class="space"> </span><span>&#39;æ‰‹æœº&#39;)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>desc_similarity</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>products_search</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>name</span><span class="space"> </span><span>%</span><span class="space"> </span><span>&#39;iphone&#39;</span><span class="space"> </span><span>OR</span><span class="space"> </span><span>description</span><span class="space"> </span><span>%</span><span class="space"> </span><span>&#39;æ‰‹æœº&#39;</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>greatest(similarity(name,</span><span class="space"> </span><span>&#39;iphone&#39;),</span><span class="space"> </span><span>similarity(description,</span><span class="space"> </span><span>&#39;æ‰‹æœº&#39;))</span><span class="space"> </span><span>DESC;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æ¨¡ç³ŠåŒ¹é…æŸ¥è¯¢</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>name,</span><span class="space"> </span><span>description</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>products_search</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>name</span><span class="space"> </span><span>ILIKE</span><span class="space"> </span><span>&#39;%phone%&#39;</span><span class="space"> </span><span>OR</span><span class="space"> </span><span>description</span><span class="space"> </span><span>ILIKE</span><span class="space"> </span><span>&#39;%æ‰‹æœº%&#39;;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="uuid-ossp-uuidç”Ÿæˆ" tabindex="-1"><a class="header-anchor" href="#uuid-ossp-uuidç”Ÿæˆ"><span>uuid-osspï¼ˆUUIDç”Ÿæˆï¼‰</span></a></h3><p>æä¾›å¤šç§UUIDç”Ÿæˆå‡½æ•°ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­éå¸¸æœ‰ç”¨ã€‚</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>å¯ç”¨æ‰©å±•</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>EXTENSION</span><span class="space"> </span><span>&quot;uuid-ossp&quot;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ç”Ÿæˆä¸åŒç±»å‹çš„UUID</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>uuid_generate_v1()</span><span class="space"> </span><span>as</span><span class="space"> </span><span>uuid_v1,</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>åŸºäºæ—¶é—´æˆ³å’ŒMACåœ°å€</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>uuid_generate_v4()</span><span class="space"> </span><span>as</span><span class="space"> </span><span>uuid_v4;</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>éšæœºUUID</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>åœ¨è¡¨ä¸­ä½¿ç”¨UUIDä½œä¸ºä¸»é”®</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>distributed_users</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>UUID</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY</span><span class="space"> </span><span>DEFAULT</span><span class="space"> </span><span>uuid_generate_v4(),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>username</span><span class="space"> </span><span>VARCHAR(50)</span><span class="space"> </span><span>UNIQUE</span><span class="space"> </span><span>NOT</span><span class="space"> </span><span>NULL,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>email</span><span class="space"> </span><span>VARCHAR(100)</span><span class="space"> </span><span>UNIQUE</span><span class="space"> </span><span>NOT</span><span class="space"> </span><span>NULL,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>created_at</span><span class="space"> </span><span>TIMESTAMP</span><span class="space"> </span><span>DEFAULT</span><span class="space"> </span><span>NOW()</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>distributed_users</span><span class="space"> </span><span>(username,</span><span class="space"> </span><span>email)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;user1&#39;,</span><span class="space"> </span><span>&#39;user1@example.com&#39;),</span></span>
<span class="line"><span>(&#39;user2&#39;,</span><span class="space"> </span><span>&#39;user2@example.com&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>*</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>distributed_users;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-é«˜çº§ç´¢å¼•ç±»å‹" tabindex="-1"><a class="header-anchor" href="#_6-é«˜çº§ç´¢å¼•ç±»å‹"><span>6. é«˜çº§ç´¢å¼•ç±»å‹</span></a></h2><p>PostgreSQLæ”¯æŒå¤šç§é«˜çº§ç´¢å¼•ç±»å‹ï¼Œæ¯ç§éƒ½é’ˆå¯¹ç‰¹å®šçš„æŸ¥è¯¢æ¨¡å¼è¿›è¡Œäº†ä¼˜åŒ–ã€‚</p><h3 id="ginç´¢å¼•-å€’æ’ç´¢å¼•" tabindex="-1"><a class="header-anchor" href="#ginç´¢å¼•-å€’æ’ç´¢å¼•"><span>GINç´¢å¼•ï¼ˆå€’æ’ç´¢å¼•ï¼‰</span></a></h3><p>GINï¼ˆGeneralized Inverted Indexï¼‰ç´¢å¼•ç‰¹åˆ«é€‚åˆåŒ…å«å¤šä¸ªå€¼çš„æ•°æ®ç±»å‹ï¼Œå¦‚æ•°ç»„ã€JSONBã€å…¨æ–‡æœç´¢ç­‰ã€‚</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>ä¸ºJSONBå­—æ®µåˆ›å»ºGINç´¢å¼•</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>user_profiles</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>username</span><span class="space"> </span><span>VARCHAR(50),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>profile</span><span class="space"> </span><span>JSONB,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>tags</span><span class="space"> </span><span>TEXT[]</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>user_profiles</span><span class="space"> </span><span>(username,</span><span class="space"> </span><span>profile,</span><span class="space"> </span><span>tags)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;alice&#39;,</span><span class="space"> </span><span>&#39;{&quot;age&quot;:</span><span class="space"> </span><span>25,</span><span class="space"> </span><span>&quot;city&quot;:</span><span class="space"> </span><span>&quot;åŒ—äº¬&quot;,</span><span class="space"> </span><span>&quot;interests&quot;:</span><span class="space"> </span><span>[&quot;ç¼–ç¨‹&quot;,</span><span class="space"> </span><span>&quot;éŸ³ä¹&quot;,</span><span class="space"> </span><span>&quot;æ—…è¡Œ&quot;]}&#39;,</span><span class="space"> </span><span>ARRAY[&#39;developer&#39;,</span><span class="space"> </span><span>&#39;music-lover&#39;]),</span></span>
<span class="line"><span>(&#39;bob&#39;,</span><span class="space"> </span><span>&#39;{&quot;age&quot;:</span><span class="space"> </span><span>30,</span><span class="space"> </span><span>&quot;city&quot;:</span><span class="space"> </span><span>&quot;ä¸Šæµ·&quot;,</span><span class="space"> </span><span>&quot;interests&quot;:</span><span class="space"> </span><span>[&quot;æ‘„å½±&quot;,</span><span class="space"> </span><span>&quot;è¿åŠ¨&quot;]}&#39;,</span><span class="space"> </span><span>ARRAY[&#39;photographer&#39;,</span><span class="space"> </span><span>&#39;athlete&#39;]),</span></span>
<span class="line"><span>(&#39;charlie&#39;,</span><span class="space"> </span><span>&#39;{&quot;age&quot;:</span><span class="space"> </span><span>28,</span><span class="space"> </span><span>&quot;city&quot;:</span><span class="space"> </span><span>&quot;æ·±åœ³&quot;,</span><span class="space"> </span><span>&quot;interests&quot;:</span><span class="space"> </span><span>[&quot;ç¼–ç¨‹&quot;,</span><span class="space"> </span><span>&quot;æ¸¸æˆ&quot;]}&#39;,</span><span class="space"> </span><span>ARRAY[&#39;developer&#39;,</span><span class="space"> </span><span>&#39;gamer&#39;]);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºGINç´¢å¼•</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_profile_gin</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>user_profiles</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>GIN</span><span class="space"> </span><span>(profile);</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_tags_gin</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>user_profiles</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>GIN</span><span class="space"> </span><span>(tags);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>é«˜æ•ˆçš„JSONBæŸ¥è¯¢</span></span>
<span class="line"><span>EXPLAIN</span><span class="space"> </span><span>(ANALYZE,</span><span class="space"> </span><span>BUFFERS)</span><span class="space"> </span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>username</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>user_profiles</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>profile</span><span class="space"> </span><span>@&gt;</span><span class="space"> </span><span>&#39;{&quot;interests&quot;:</span><span class="space"> </span><span>[&quot;ç¼–ç¨‹&quot;]}&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æ•°ç»„æŸ¥è¯¢</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>username</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>user_profiles</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>tags</span><span class="space"> </span><span>&amp;&amp;</span><span class="space"> </span><span>ARRAY[&#39;developer&#39;];</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>JSONè·¯å¾„æŸ¥è¯¢</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>username,</span><span class="space"> </span><span>profile-&gt;&#39;city&#39;</span><span class="space"> </span><span>as</span><span class="space"> </span><span>city</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>user_profiles</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>profile-&gt;&gt;&#39;city&#39;</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;åŒ—äº¬&#39;;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="gistç´¢å¼•-é€šç”¨æœç´¢æ ‘" tabindex="-1"><a class="header-anchor" href="#gistç´¢å¼•-é€šç”¨æœç´¢æ ‘"><span>GiSTç´¢å¼•ï¼ˆé€šç”¨æœç´¢æ ‘ï¼‰</span></a></h3><p>GiSTï¼ˆGeneralized Search Treeï¼‰ç´¢å¼•æ”¯æŒå¤šç§æ•°æ®ç±»å‹ï¼Œç‰¹åˆ«é€‚åˆå‡ ä½•æ•°æ®å’ŒèŒƒå›´æŸ¥è¯¢ã€‚</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>ä¸ºå‡ ä½•æ•°æ®åˆ›å»ºGiSTç´¢å¼•ï¼ˆPostGISï¼‰</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_businesses_gist</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>businesses</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>GIST</span><span class="space"> </span><span>(location);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ä¸ºèŒƒå›´ç±»å‹åˆ›å»ºGiSTç´¢å¼•</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>reservations</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>room_id</span><span class="space"> </span><span>INTEGER,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>time_range</span><span class="space"> </span><span>TSRANGE,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>guest_name</span><span class="space"> </span><span>VARCHAR(100)</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>reservations</span><span class="space"> </span><span>(room_id,</span><span class="space"> </span><span>time_range,</span><span class="space"> </span><span>guest_name)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(101,</span><span class="space"> </span><span>&#39;[2024-01-15</span><span class="space"> </span><span>14:00,</span><span class="space"> </span><span>2024-01-15</span><span class="space"> </span><span>16:00)&#39;,</span><span class="space"> </span><span>&#39;å¼ ä¸‰&#39;),</span></span>
<span class="line"><span>(102,</span><span class="space"> </span><span>&#39;[2024-01-15</span><span class="space"> </span><span>15:00,</span><span class="space"> </span><span>2024-01-15</span><span class="space"> </span><span>17:00)&#39;,</span><span class="space"> </span><span>&#39;æå››&#39;),</span></span>
<span class="line"><span>(101,</span><span class="space"> </span><span>&#39;[2024-01-15</span><span class="space"> </span><span>18:00,</span><span class="space"> </span><span>2024-01-15</span><span class="space"> </span><span>20:00)&#39;,</span><span class="space"> </span><span>&#39;ç‹äº”&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_reservations_time</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>reservations</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>GIST</span><span class="space"> </span><span>(time_range);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æŸ¥æ‰¾æ—¶é—´å†²çªçš„é¢„è®¢</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>*</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>reservations</span><span class="space"> </span><span>r1</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>EXISTS</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SELECT</span><span class="space"> </span><span>1</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>reservations</span><span class="space"> </span><span>r2</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>r1.room_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>r2.room_id</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>AND</span><span class="space"> </span><span>r1.id</span><span class="space"> </span><span>!=</span><span class="space"> </span><span>r2.id</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>AND</span><span class="space"> </span><span>r1.time_range</span><span class="space"> </span><span>&amp;&amp;</span><span class="space"> </span><span>r2.time_range</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æŸ¥æ‰¾ç‰¹å®šæ—¶é—´æ®µçš„å¯ç”¨æˆ¿é—´</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>DISTINCT</span><span class="space"> </span><span>room_id</span><span class="space"> </span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>reservations</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>NOT</span><span class="space"> </span><span>time_range</span><span class="space"> </span><span>&amp;&amp;</span><span class="space"> </span><span>&#39;[2024-01-15</span><span class="space"> </span><span>15:30,</span><span class="space"> </span><span>2024-01-15</span><span class="space"> </span><span>16:30)&#39;::tsrange;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="brinç´¢å¼•-å—èŒƒå›´ç´¢å¼•" tabindex="-1"><a class="header-anchor" href="#brinç´¢å¼•-å—èŒƒå›´ç´¢å¼•"><span>BRINç´¢å¼•ï¼ˆå—èŒƒå›´ç´¢å¼•ï¼‰</span></a></h3><p>BRINï¼ˆBlock Range Indexï¼‰ç´¢å¼•é€‚åˆå¤§è¡¨ä¸­æœ‰åºæˆ–åŠæœ‰åºçš„æ•°æ®ï¼Œå ç”¨ç©ºé—´å°ï¼Œç»´æŠ¤æˆæœ¬ä½ã€‚</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºæ—¶åºæ•°æ®è¡¨</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>sensor_data</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>BIGSERIAL,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>sensor_id</span><span class="space"> </span><span>INTEGER,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>timestamp</span><span class="space"> </span><span>TIMESTAMP,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>temperature</span><span class="space"> </span><span>DECIMAL(5,2),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>humidity</span><span class="space"> </span><span>DECIMAL(5,2)</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æ’å…¥å¤§é‡æ—¶åºæ•°æ®</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>sensor_data</span><span class="space"> </span><span>(sensor_id,</span><span class="space"> </span><span>timestamp,</span><span class="space"> </span><span>temperature,</span><span class="space"> </span><span>humidity)</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>(random()</span><span class="space"> </span><span>*</span><span class="space"> </span><span>100)::INTEGER,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&#39;2024-01-01&#39;::timestamp</span><span class="space"> </span><span>+</span><span class="space"> </span><span>(i</span><span class="space"> </span><span>||</span><span class="space"> </span><span>&#39;</span><span class="space"> </span><span>seconds&#39;)::interval,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>20</span><span class="space"> </span><span>+</span><span class="space"> </span><span>(random()</span><span class="space"> </span><span>*</span><span class="space"> </span><span>15),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>40</span><span class="space"> </span><span>+</span><span class="space"> </span><span>(random()</span><span class="space"> </span><span>*</span><span class="space"> </span><span>30)</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>generate_series(1,</span><span class="space"> </span><span>1000000)</span><span class="space"> </span><span>i;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºBRINç´¢å¼•</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_sensor_timestamp_brin</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>sensor_data</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>BRIN</span><span class="space"> </span><span>(timestamp);</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_sensor_temp_brin</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>sensor_data</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>BRIN</span><span class="space"> </span><span>(temperature);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>èŒƒå›´æŸ¥è¯¢æ€§èƒ½æµ‹è¯•</span></span>
<span class="line"><span>EXPLAIN</span><span class="space"> </span><span>(ANALYZE,</span><span class="space"> </span><span>BUFFERS)</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>AVG(temperature),</span><span class="space"> </span><span>AVG(humidity)</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>sensor_data</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>timestamp</span><span class="space"> </span><span>BETWEEN</span><span class="space"> </span><span>&#39;2024-01-01</span><span class="space"> </span><span>10:00:00&#39;</span><span class="space"> </span><span>AND</span><span class="space"> </span><span>&#39;2024-01-01</span><span class="space"> </span><span>12:00:00&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æ¯”è¾ƒç´¢å¼•å¤§å°</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>schemaname,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>tablename,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>indexname,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>pg_size_pretty(pg_relation_size(indexname::regclass))</span><span class="space"> </span><span>as</span><span class="space"> </span><span>index_size</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>pg_indexes</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>tablename</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;sensor_data&#39;;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-å¹¶å‘æ§åˆ¶mvcc" tabindex="-1"><a class="header-anchor" href="#_7-å¹¶å‘æ§åˆ¶mvcc"><span>7. å¹¶å‘æ§åˆ¶MVCC</span></a></h2><p>PostgreSQLä½¿ç”¨å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼‰ï¼Œè¿™æ˜¯å…¶ç›¸æ¯”MySQLçš„é‡è¦ä¼˜åŠ¿ä¹‹ä¸€ã€‚</p><h3 id="mvccåŸç†" tabindex="-1"><a class="header-anchor" href="#mvccåŸç†"><span>MVCCåŸç†</span></a></h3><p>MVCCå…è®¸è¯»æ“ä½œä¸é˜»å¡å†™æ“ä½œï¼Œå†™æ“ä½œä¹Ÿä¸é˜»å¡è¯»æ“ä½œï¼Œå¤§å¤§æé«˜äº†å¹¶å‘æ€§èƒ½ã€‚</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºæµ‹è¯•è¡¨</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>account_balance</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>account_id</span><span class="space"> </span><span>VARCHAR(20),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>balance</span><span class="space"> </span><span>DECIMAL(15,2),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>last_updated</span><span class="space"> </span><span>TIMESTAMP</span><span class="space"> </span><span>DEFAULT</span><span class="space"> </span><span>NOW()</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>account_balance</span><span class="space"> </span><span>(account_id,</span><span class="space"> </span><span>balance)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;ACC001&#39;,</span><span class="space"> </span><span>1000.00),</span></span>
<span class="line"><span>(&#39;ACC002&#39;,</span><span class="space"> </span><span>2000.00);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æ¼”ç¤ºäº‹åŠ¡éš”ç¦»</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ä¼šè¯1ï¼šå¼€å§‹äº‹åŠ¡ä½†ä¸æäº¤</span></span>
<span class="line"><span>BEGIN;</span></span>
<span class="line"><span>UPDATE</span><span class="space"> </span><span>account_balance</span><span class="space"> </span><span>SET</span><span class="space"> </span><span>balance</span><span class="space"> </span><span>=</span><span class="space"> </span><span>balance</span><span class="space"> </span><span>-</span><span class="space"> </span><span>100</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>account_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;ACC001&#39;;</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æ­¤æ—¶ä¸è¦COMMIT</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ä¼šè¯2ï¼šåœ¨å¦ä¸€ä¸ªè¿æ¥ä¸­æŸ¥è¯¢</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>*</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>account_balance</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>account_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;ACC001&#39;;</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ä»ç„¶çœ‹åˆ°åŸå§‹å€¼1000.00ï¼Œå› ä¸ºä¼šè¯1çš„äº‹åŠ¡æœªæäº¤</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ä¼šè¯1ï¼šæäº¤äº‹åŠ¡</span></span>
<span class="line"><span>COMMIT;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ä¼šè¯2ï¼šå†æ¬¡æŸ¥è¯¢</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>*</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>account_balance</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>account_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;ACC001&#39;;</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ç°åœ¨çœ‹åˆ°æ›´æ–°åçš„å€¼900.00</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="äº‹åŠ¡éš”ç¦»çº§åˆ«" tabindex="-1"><a class="header-anchor" href="#äº‹åŠ¡éš”ç¦»çº§åˆ«"><span>äº‹åŠ¡éš”ç¦»çº§åˆ«</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>æŸ¥çœ‹å½“å‰éš”ç¦»çº§åˆ«</span></span>
<span class="line"><span>SHOW</span><span class="space"> </span><span>transaction_isolation;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>è®¾ç½®ä¸åŒçš„éš”ç¦»çº§åˆ«</span></span>
<span class="line"><span>BEGIN</span><span class="space"> </span><span>ISOLATION</span><span class="space"> </span><span>LEVEL</span><span class="space"> </span><span>READ</span><span class="space"> </span><span>COMMITTED;</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æˆ–è€…</span></span>
<span class="line"><span>BEGIN</span><span class="space"> </span><span>ISOLATION</span><span class="space"> </span><span>LEVEL</span><span class="space"> </span><span>REPEATABLE</span><span class="space"> </span><span>READ;</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æˆ–è€…</span></span>
<span class="line"><span>BEGIN</span><span class="space"> </span><span>ISOLATION</span><span class="space"> </span><span>LEVEL</span><span class="space"> </span><span>SERIALIZABLE;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æ¼”ç¤ºå¯é‡å¤è¯»</span></span>
<span class="line"><span>BEGIN</span><span class="space"> </span><span>ISOLATION</span><span class="space"> </span><span>LEVEL</span><span class="space"> </span><span>REPEATABLE</span><span class="space"> </span><span>READ;</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>balance</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>account_balance</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>account_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;ACC001&#39;;</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>å³ä½¿å…¶ä»–äº‹åŠ¡ä¿®æ”¹äº†æ•°æ®ï¼Œåœ¨å½“å‰äº‹åŠ¡ä¸­å¤šæ¬¡è¯»å–ä¼šå¾—åˆ°ç›¸åŒç»“æœ</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>balance</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>account_balance</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>account_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;ACC001&#39;;</span></span>
<span class="line"><span>COMMIT;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ­»é”æ£€æµ‹å’Œå¤„ç†" tabindex="-1"><a class="header-anchor" href="#æ­»é”æ£€æµ‹å’Œå¤„ç†"><span>æ­»é”æ£€æµ‹å’Œå¤„ç†</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>PostgreSQLè‡ªåŠ¨æ£€æµ‹æ­»é”å¹¶å›æ»šå…¶ä¸­ä¸€ä¸ªäº‹åŠ¡</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºæ­»é”åœºæ™¯çš„ç¤ºä¾‹</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ä¼šè¯1</span></span>
<span class="line"><span>BEGIN;</span></span>
<span class="line"><span>UPDATE</span><span class="space"> </span><span>account_balance</span><span class="space"> </span><span>SET</span><span class="space"> </span><span>balance</span><span class="space"> </span><span>=</span><span class="space"> </span><span>balance</span><span class="space"> </span><span>-</span><span class="space"> </span><span>50</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>account_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;ACC001&#39;;</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ç­‰å¾…ä¸€ä¼šå„¿ï¼Œç„¶åæ‰§è¡Œï¼š</span></span>
<span class="line"><span>UPDATE</span><span class="space"> </span><span>account_balance</span><span class="space"> </span><span>SET</span><span class="space"> </span><span>balance</span><span class="space"> </span><span>=</span><span class="space"> </span><span>balance</span><span class="space"> </span><span>+</span><span class="space"> </span><span>50</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>account_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;ACC002&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ä¼šè¯2ï¼ˆåŒæ—¶æ‰§è¡Œï¼‰</span></span>
<span class="line"><span>BEGIN;</span></span>
<span class="line"><span>UPDATE</span><span class="space"> </span><span>account_balance</span><span class="space"> </span><span>SET</span><span class="space"> </span><span>balance</span><span class="space"> </span><span>=</span><span class="space"> </span><span>balance</span><span class="space"> </span><span>-</span><span class="space"> </span><span>30</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>account_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;ACC002&#39;;</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ç„¶åæ‰§è¡Œï¼š</span></span>
<span class="line"><span>UPDATE</span><span class="space"> </span><span>account_balance</span><span class="space"> </span><span>SET</span><span class="space"> </span><span>balance</span><span class="space"> </span><span>=</span><span class="space"> </span><span>balance</span><span class="space"> </span><span>+</span><span class="space"> </span><span>30</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>account_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;ACC001&#39;;</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>PostgreSQLä¼šæ£€æµ‹åˆ°æ­»é”å¹¶è‡ªåŠ¨å›æ»šå…¶ä¸­ä¸€ä¸ªäº‹åŠ¡</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8-åˆ†åŒºè¡¨æ”¯æŒ" tabindex="-1"><a class="header-anchor" href="#_8-åˆ†åŒºè¡¨æ”¯æŒ"><span>8. åˆ†åŒºè¡¨æ”¯æŒ</span></a></h2><p>PostgreSQLæä¾›äº†å¼ºå¤§çš„è¡¨åˆ†åŒºåŠŸèƒ½ï¼Œå¯ä»¥æ˜¾è‘—æé«˜å¤§è¡¨çš„æŸ¥è¯¢æ€§èƒ½ã€‚</p><h3 id="å£°æ˜å¼åˆ†åŒº" tabindex="-1"><a class="header-anchor" href="#å£°æ˜å¼åˆ†åŒº"><span>å£°æ˜å¼åˆ†åŒº</span></a></h3><h4 id="èŒƒå›´åˆ†åŒº" tabindex="-1"><a class="header-anchor" href="#èŒƒå›´åˆ†åŒº"><span>èŒƒå›´åˆ†åŒº</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºæŒ‰æ—¥æœŸèŒƒå›´åˆ†åŒºçš„è¡¨</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>sales_data</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>BIGSERIAL,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>sale_date</span><span class="space"> </span><span>DATE</span><span class="space"> </span><span>NOT</span><span class="space"> </span><span>NULL,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>product_id</span><span class="space"> </span><span>INTEGER,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>amount</span><span class="space"> </span><span>DECIMAL(10,2),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>customer_id</span><span class="space"> </span><span>INTEGER</span></span>
<span class="line"><span>)</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>RANGE</span><span class="space"> </span><span>(sale_date);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºåˆ†åŒº</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>sales_2024_q1</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>OF</span><span class="space"> </span><span>sales_data</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FOR</span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>(&#39;2024-01-01&#39;)</span><span class="space"> </span><span>TO</span><span class="space"> </span><span>(&#39;2024-04-01&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>sales_2024_q2</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>OF</span><span class="space"> </span><span>sales_data</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FOR</span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>(&#39;2024-04-01&#39;)</span><span class="space"> </span><span>TO</span><span class="space"> </span><span>(&#39;2024-07-01&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>sales_2024_q3</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>OF</span><span class="space"> </span><span>sales_data</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FOR</span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>(&#39;2024-07-01&#39;)</span><span class="space"> </span><span>TO</span><span class="space"> </span><span>(&#39;2024-10-01&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>sales_2024_q4</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>OF</span><span class="space"> </span><span>sales_data</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FOR</span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>(&#39;2024-10-01&#39;)</span><span class="space"> </span><span>TO</span><span class="space"> </span><span>(&#39;2025-01-01&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æ’å…¥æ•°æ®ä¼šè‡ªåŠ¨è·¯ç”±åˆ°æ­£ç¡®çš„åˆ†åŒº</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>sales_data</span><span class="space"> </span><span>(sale_date,</span><span class="space"> </span><span>product_id,</span><span class="space"> </span><span>amount,</span><span class="space"> </span><span>customer_id)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;2024-02-15&#39;,</span><span class="space"> </span><span>101,</span><span class="space"> </span><span>299.99,</span><span class="space"> </span><span>1001),</span></span>
<span class="line"><span>(&#39;2024-05-20&#39;,</span><span class="space"> </span><span>102,</span><span class="space"> </span><span>199.99,</span><span class="space"> </span><span>1002),</span></span>
<span class="line"><span>(&#39;2024-08-10&#39;,</span><span class="space"> </span><span>103,</span><span class="space"> </span><span>399.99,</span><span class="space"> </span><span>1003),</span></span>
<span class="line"><span>(&#39;2024-11-25&#39;,</span><span class="space"> </span><span>104,</span><span class="space"> </span><span>499.99,</span><span class="space"> </span><span>1004);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æŸ¥è¯¢ä¼šè‡ªåŠ¨ä½¿ç”¨åˆ†åŒºè£å‰ª</span></span>
<span class="line"><span>EXPLAIN</span><span class="space"> </span><span>(ANALYZE,</span><span class="space"> </span><span>BUFFERS)</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>*</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>sales_data</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>sale_date</span><span class="space"> </span><span>BETWEEN</span><span class="space"> </span><span>&#39;2024-02-01&#39;</span><span class="space"> </span><span>AND</span><span class="space"> </span><span>&#39;2024-02-28&#39;;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="åˆ—è¡¨åˆ†åŒº" tabindex="-1"><a class="header-anchor" href="#åˆ—è¡¨åˆ†åŒº"><span>åˆ—è¡¨åˆ†åŒº</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>æŒ‰åœ°åŒºåˆ†åŒº</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>customer_data</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>BIGSERIAL,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>customer_name</span><span class="space"> </span><span>VARCHAR(100),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>region</span><span class="space"> </span><span>VARCHAR(20)</span><span class="space"> </span><span>NOT</span><span class="space"> </span><span>NULL,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>registration_date</span><span class="space"> </span><span>DATE,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>status</span><span class="space"> </span><span>VARCHAR(20)</span></span>
<span class="line"><span>)</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>LIST</span><span class="space"> </span><span>(region);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºåœ°åŒºåˆ†åŒº</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>customer_data_north</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>OF</span><span class="space"> </span><span>customer_data</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FOR</span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>IN</span><span class="space"> </span><span>(&#39;ååŒ—&#39;,</span><span class="space"> </span><span>&#39;ä¸œåŒ—&#39;,</span><span class="space"> </span><span>&#39;è¥¿åŒ—&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>customer_data_south</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>OF</span><span class="space"> </span><span>customer_data</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FOR</span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>IN</span><span class="space"> </span><span>(&#39;åå—&#39;,</span><span class="space"> </span><span>&#39;åä¸­&#39;,</span><span class="space"> </span><span>&#39;è¥¿å—&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>customer_data_east</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>OF</span><span class="space"> </span><span>customer_data</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FOR</span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>IN</span><span class="space"> </span><span>(&#39;åä¸œ&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æ’å…¥æ•°æ®</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>customer_data</span><span class="space"> </span><span>(customer_name,</span><span class="space"> </span><span>region,</span><span class="space"> </span><span>registration_date,</span><span class="space"> </span><span>status)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;å¼ ä¸‰&#39;,</span><span class="space"> </span><span>&#39;ååŒ—&#39;,</span><span class="space"> </span><span>&#39;2024-01-15&#39;,</span><span class="space"> </span><span>&#39;active&#39;),</span></span>
<span class="line"><span>(&#39;æå››&#39;,</span><span class="space"> </span><span>&#39;åå—&#39;,</span><span class="space"> </span><span>&#39;2024-01-20&#39;,</span><span class="space"> </span><span>&#39;active&#39;),</span></span>
<span class="line"><span>(&#39;ç‹äº”&#39;,</span><span class="space"> </span><span>&#39;åä¸œ&#39;,</span><span class="space"> </span><span>&#39;2024-01-25&#39;,</span><span class="space"> </span><span>&#39;inactive&#39;);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å“ˆå¸Œåˆ†åŒº" tabindex="-1"><a class="header-anchor" href="#å“ˆå¸Œåˆ†åŒº"><span>å“ˆå¸Œåˆ†åŒº</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>æŒ‰ç”¨æˆ·IDå“ˆå¸Œåˆ†åŒº</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>user_activities</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>BIGSERIAL,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>user_id</span><span class="space"> </span><span>BIGINT</span><span class="space"> </span><span>NOT</span><span class="space"> </span><span>NULL,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>activity_type</span><span class="space"> </span><span>VARCHAR(50),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>activity_time</span><span class="space"> </span><span>TIMESTAMP,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>details</span><span class="space"> </span><span>JSONB</span></span>
<span class="line"><span>)</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>HASH</span><span class="space"> </span><span>(user_id);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºå“ˆå¸Œåˆ†åŒº</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>user_activities_0</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>OF</span><span class="space"> </span><span>user_activities</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FOR</span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>WITH</span><span class="space"> </span><span>(modulus</span><span class="space"> </span><span>4,</span><span class="space"> </span><span>remainder</span><span class="space"> </span><span>0);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>user_activities_1</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>OF</span><span class="space"> </span><span>user_activities</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FOR</span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>WITH</span><span class="space"> </span><span>(modulus</span><span class="space"> </span><span>4,</span><span class="space"> </span><span>remainder</span><span class="space"> </span><span>1);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>user_activities_2</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>OF</span><span class="space"> </span><span>user_activities</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FOR</span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>WITH</span><span class="space"> </span><span>(modulus</span><span class="space"> </span><span>4,</span><span class="space"> </span><span>remainder</span><span class="space"> </span><span>2);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>user_activities_3</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>OF</span><span class="space"> </span><span>user_activities</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FOR</span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>WITH</span><span class="space"> </span><span>(modulus</span><span class="space"> </span><span>4,</span><span class="space"> </span><span>remainder</span><span class="space"> </span><span>3);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9-å¤–éƒ¨æ•°æ®åŒ…è£…å™¨-fdw" tabindex="-1"><a class="header-anchor" href="#_9-å¤–éƒ¨æ•°æ®åŒ…è£…å™¨-fdw"><span>9. å¤–éƒ¨æ•°æ®åŒ…è£…å™¨ï¼ˆFDWï¼‰</span></a></h2><p>FDWå…è®¸PostgreSQLè®¿é—®å¤–éƒ¨æ•°æ®æºï¼Œå°±åƒè®¿é—®æœ¬åœ°è¡¨ä¸€æ ·ã€‚</p><h3 id="è¿æ¥å…¶ä»–æ•°æ®åº“" tabindex="-1"><a class="header-anchor" href="#è¿æ¥å…¶ä»–æ•°æ®åº“"><span>è¿æ¥å…¶ä»–æ•°æ®åº“</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>å®‰è£…å¹¶å¯ç”¨postgres_fdwæ‰©å±•</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>EXTENSION</span><span class="space"> </span><span>postgres_fdw;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºå¤–éƒ¨æœåŠ¡å™¨</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>SERVER</span><span class="space"> </span><span>remote_pg_server</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FOREIGN</span><span class="space"> </span><span>DATA</span><span class="space"> </span><span>WRAPPER</span><span class="space"> </span><span>postgres_fdw</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>OPTIONS</span><span class="space"> </span><span>(host</span><span class="space"> </span><span>&#39;remote-host.example.com&#39;,</span><span class="space"> </span><span>port</span><span class="space"> </span><span>&#39;5432&#39;,</span><span class="space"> </span><span>dbname</span><span class="space"> </span><span>&#39;remote_db&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºç”¨æˆ·æ˜ å°„</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>USER</span><span class="space"> </span><span>MAPPING</span><span class="space"> </span><span>FOR</span><span class="space"> </span><span>current_user</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SERVER</span><span class="space"> </span><span>remote_pg_server</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>OPTIONS</span><span class="space"> </span><span>(user</span><span class="space"> </span><span>&#39;remote_user&#39;,</span><span class="space"> </span><span>password</span><span class="space"> </span><span>&#39;remote_password&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºå¤–éƒ¨è¡¨</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>FOREIGN</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>remote_users</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>INTEGER,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>username</span><span class="space"> </span><span>VARCHAR(50),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>email</span><span class="space"> </span><span>VARCHAR(100),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>created_at</span><span class="space"> </span><span>TIMESTAMP</span></span>
<span class="line"><span>)</span><span class="space"> </span><span>SERVER</span><span class="space"> </span><span>remote_pg_server</span></span>
<span class="line"><span>OPTIONS</span><span class="space"> </span><span>(schema_name</span><span class="space"> </span><span>&#39;public&#39;,</span><span class="space"> </span><span>table_name</span><span class="space"> </span><span>&#39;users&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æŸ¥è¯¢å¤–éƒ¨è¡¨</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>*</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>remote_users</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>created_at</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>&#39;2024-01-01&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æœ¬åœ°è¡¨å’Œå¤–éƒ¨è¡¨çš„è”åˆæŸ¥è¯¢</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>l.order_id,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>l.amount,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>r.username,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>r.email</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>local_orders</span><span class="space"> </span><span>l</span></span>
<span class="line"><span>JOIN</span><span class="space"> </span><span>remote_users</span><span class="space"> </span><span>r</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>l.user_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>r.id</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>l.order_date</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>&#39;2024-01-01&#39;;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ–‡ä»¶ç³»ç»Ÿè®¿é—®" tabindex="-1"><a class="header-anchor" href="#æ–‡ä»¶ç³»ç»Ÿè®¿é—®"><span>æ–‡ä»¶ç³»ç»Ÿè®¿é—®</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>å¯ç”¨file_fdwæ‰©å±•</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>EXTENSION</span><span class="space"> </span><span>file_fdw;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºæ–‡ä»¶æœåŠ¡å™¨</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>SERVER</span><span class="space"> </span><span>file_server</span><span class="space"> </span><span>FOREIGN</span><span class="space"> </span><span>DATA</span><span class="space"> </span><span>WRAPPER</span><span class="space"> </span><span>file_fdw;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºå¤–éƒ¨è¡¨è¯»å–CSVæ–‡ä»¶</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>FOREIGN</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>csv_import</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>INTEGER,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name</span><span class="space"> </span><span>VARCHAR(100),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>category</span><span class="space"> </span><span>VARCHAR(50),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>price</span><span class="space"> </span><span>DECIMAL(10,2)</span></span>
<span class="line"><span>)</span><span class="space"> </span><span>SERVER</span><span class="space"> </span><span>file_server</span></span>
<span class="line"><span>OPTIONS</span><span class="space"> </span><span>(filename</span><span class="space"> </span><span>&#39;/path/to/products.csv&#39;,</span><span class="space"> </span><span>format</span><span class="space"> </span><span>&#39;csv&#39;,</span><span class="space"> </span><span>header</span><span class="space"> </span><span>&#39;true&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æŸ¥è¯¢CSVæ•°æ®</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>category,</span><span class="space"> </span><span>AVG(price)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>avg_price</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>csv_import</span></span>
<span class="line"><span>GROUP</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>category;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>å°†CSVæ•°æ®å¯¼å…¥åˆ°æœ¬åœ°è¡¨</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>products</span><span class="space"> </span><span>(name,</span><span class="space"> </span><span>category,</span><span class="space"> </span><span>price)</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>name,</span><span class="space"> </span><span>category,</span><span class="space"> </span><span>price</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>csv_import;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_10-å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°" tabindex="-1"><a class="header-anchor" href="#_10-å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°"><span>10. å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°</span></a></h2><p>PostgreSQLæ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€ç¼–å†™å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°ã€‚</p><h3 id="pl-pgsql" tabindex="-1"><a class="header-anchor" href="#pl-pgsql"><span>PL/pgSQL</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºå¤æ‚çš„å­˜å‚¨è¿‡ç¨‹</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>OR</span><span class="space"> </span><span>REPLACE</span><span class="space"> </span><span>FUNCTION</span><span class="space"> </span><span>calculate_customer_stats(customer_id_param</span><span class="space"> </span><span>INTEGER)</span></span>
<span class="line"><span>RETURNS</span><span class="space"> </span><span>TABLE(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>total_orders</span><span class="space"> </span><span>INTEGER,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>total_amount</span><span class="space"> </span><span>DECIMAL(15,2),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>avg_order_amount</span><span class="space"> </span><span>DECIMAL(15,2),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>last_order_date</span><span class="space"> </span><span>DATE,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>customer_tier</span><span class="space"> </span><span>VARCHAR(20)</span></span>
<span class="line"><span>)</span><span class="space"> </span><span>AS</span><span class="space"> </span><span>$$</span></span>
<span class="line"><span>DECLARE</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>order_count</span><span class="space"> </span><span>INTEGER;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>total_spent</span><span class="space"> </span><span>DECIMAL(15,2);</span></span>
<span class="line"><span>BEGIN</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>è®¡ç®—è®¢å•ç»Ÿè®¡</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SELECT</span><span class="space"> </span><span>COUNT(*),</span><span class="space"> </span><span>COALESCE(SUM(amount),</span><span class="space"> </span><span>0)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>order_count,</span><span class="space"> </span><span>total_spent</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>orders</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>customer_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>customer_id_param;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>è¿”å›ç»“æœ</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>RETURN</span><span class="space"> </span><span>QUERY</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>order_count,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>total_spent,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>CASE</span><span class="space"> </span><span>WHEN</span><span class="space"> </span><span>order_count</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>0</span><span class="space"> </span><span>THEN</span><span class="space"> </span><span>total_spent</span><span class="space"> </span><span>/</span><span class="space"> </span><span>order_count</span><span class="space"> </span><span>ELSE</span><span class="space"> </span><span>0</span><span class="space"> </span><span>END,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>(SELECT</span><span class="space"> </span><span>MAX(order_date)</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>orders</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>customer_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>customer_id_param),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>CASE</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>WHEN</span><span class="space"> </span><span>total_spent</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>10000</span><span class="space"> </span><span>THEN</span><span class="space"> </span><span>&#39;VIP&#39;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>WHEN</span><span class="space"> </span><span>total_spent</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>5000</span><span class="space"> </span><span>THEN</span><span class="space"> </span><span>&#39;Gold&#39;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>WHEN</span><span class="space"> </span><span>total_spent</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>1000</span><span class="space"> </span><span>THEN</span><span class="space"> </span><span>&#39;Silver&#39;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ELSE</span><span class="space"> </span><span>&#39;Bronze&#39;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>END;</span></span>
<span class="line"><span>END;</span></span>
<span class="line"><span>$$</span><span class="space"> </span><span>LANGUAGE</span><span class="space"> </span><span>plpgsql;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ä½¿ç”¨å‡½æ•°</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>*</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>calculate_customer_stats(1001);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="è§¦å‘å™¨é«˜çº§åº”ç”¨" tabindex="-1"><a class="header-anchor" href="#è§¦å‘å™¨é«˜çº§åº”ç”¨"><span>è§¦å‘å™¨é«˜çº§åº”ç”¨</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºå®¡è®¡è¡¨</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>audit_log</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>BIGSERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>table_name</span><span class="space"> </span><span>VARCHAR(50),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>operation</span><span class="space"> </span><span>VARCHAR(10),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>old_data</span><span class="space"> </span><span>JSONB,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>new_data</span><span class="space"> </span><span>JSONB,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>changed_by</span><span class="space"> </span><span>VARCHAR(50),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>changed_at</span><span class="space"> </span><span>TIMESTAMP</span><span class="space"> </span><span>DEFAULT</span><span class="space"> </span><span>NOW()</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºé€šç”¨å®¡è®¡è§¦å‘å™¨å‡½æ•°</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>OR</span><span class="space"> </span><span>REPLACE</span><span class="space"> </span><span>FUNCTION</span><span class="space"> </span><span>audit_trigger_function()</span></span>
<span class="line"><span>RETURNS</span><span class="space"> </span><span>TRIGGER</span><span class="space"> </span><span>AS</span><span class="space"> </span><span>$$</span></span>
<span class="line"><span>BEGIN</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>IF</span><span class="space"> </span><span>TG_OP</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;DELETE&#39;</span><span class="space"> </span><span>THEN</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>audit_log</span><span class="space"> </span><span>(table_name,</span><span class="space"> </span><span>operation,</span><span class="space"> </span><span>old_data,</span><span class="space"> </span><span>changed_by)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>(TG_TABLE_NAME,</span><span class="space"> </span><span>TG_OP,</span><span class="space"> </span><span>row_to_json(OLD),</span><span class="space"> </span><span>current_user);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>RETURN</span><span class="space"> </span><span>OLD;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ELSIF</span><span class="space"> </span><span>TG_OP</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;UPDATE&#39;</span><span class="space"> </span><span>THEN</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>audit_log</span><span class="space"> </span><span>(table_name,</span><span class="space"> </span><span>operation,</span><span class="space"> </span><span>old_data,</span><span class="space"> </span><span>new_data,</span><span class="space"> </span><span>changed_by)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>(TG_TABLE_NAME,</span><span class="space"> </span><span>TG_OP,</span><span class="space"> </span><span>row_to_json(OLD),</span><span class="space"> </span><span>row_to_json(NEW),</span><span class="space"> </span><span>current_user);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>RETURN</span><span class="space"> </span><span>NEW;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ELSIF</span><span class="space"> </span><span>TG_OP</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;INSERT&#39;</span><span class="space"> </span><span>THEN</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>audit_log</span><span class="space"> </span><span>(table_name,</span><span class="space"> </span><span>operation,</span><span class="space"> </span><span>new_data,</span><span class="space"> </span><span>changed_by)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>(TG_TABLE_NAME,</span><span class="space"> </span><span>TG_OP,</span><span class="space"> </span><span>row_to_json(NEW),</span><span class="space"> </span><span>current_user);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>RETURN</span><span class="space"> </span><span>NEW;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>END</span><span class="space"> </span><span>IF;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>RETURN</span><span class="space"> </span><span>NULL;</span></span>
<span class="line"><span>END;</span></span>
<span class="line"><span>$$</span><span class="space"> </span><span>LANGUAGE</span><span class="space"> </span><span>plpgsql;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ä¸ºè¡¨æ·»åŠ å®¡è®¡è§¦å‘å™¨</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TRIGGER</span><span class="space"> </span><span>audit_trigger</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>AFTER</span><span class="space"> </span><span>INSERT</span><span class="space"> </span><span>OR</span><span class="space"> </span><span>UPDATE</span><span class="space"> </span><span>OR</span><span class="space"> </span><span>DELETE</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>account_balance</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FOR</span><span class="space"> </span><span>EACH</span><span class="space"> </span><span>ROW</span><span class="space"> </span><span>EXECUTE</span><span class="space"> </span><span>FUNCTION</span><span class="space"> </span><span>audit_trigger_function();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æµ‹è¯•å®¡è®¡åŠŸèƒ½</span></span>
<span class="line"><span>UPDATE</span><span class="space"> </span><span>account_balance</span><span class="space"> </span><span>SET</span><span class="space"> </span><span>balance</span><span class="space"> </span><span>=</span><span class="space"> </span><span>balance</span><span class="space"> </span><span>+</span><span class="space"> </span><span>100</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>account_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;ACC001&#39;;</span></span>
<span class="line"><span>DELETE</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>account_balance</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>account_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;ACC002&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æŸ¥çœ‹å®¡è®¡æ—¥å¿—</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>*</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>audit_log</span><span class="space"> </span><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>changed_at</span><span class="space"> </span><span>DESC;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_11-æ€§èƒ½ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#_11-æ€§èƒ½ä¼˜åŒ–"><span>11. æ€§èƒ½ä¼˜åŒ–</span></a></h2><p>PostgreSQLæä¾›äº†ä¸°å¯Œçš„æ€§èƒ½ä¼˜åŒ–å·¥å…·å’ŒæŠ€æœ¯ã€‚</p><h3 id="æŸ¥è¯¢è®¡åˆ’åˆ†æ" tabindex="-1"><a class="header-anchor" href="#æŸ¥è¯¢è®¡åˆ’åˆ†æ"><span>æŸ¥è¯¢è®¡åˆ’åˆ†æ</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>ä½¿ç”¨EXPLAINåˆ†ææŸ¥è¯¢è®¡åˆ’</span></span>
<span class="line"><span>EXPLAIN</span><span class="space"> </span><span>(ANALYZE,</span><span class="space"> </span><span>BUFFERS,</span><span class="space"> </span><span>VERBOSE)</span><span class="space"> </span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>c.customer_name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>COUNT(o.id)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>order_count,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SUM(o.amount)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>total_amount</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>customers</span><span class="space"> </span><span>c</span></span>
<span class="line"><span>LEFT</span><span class="space"> </span><span>JOIN</span><span class="space"> </span><span>orders</span><span class="space"> </span><span>o</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>c.id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>o.customer_id</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>c.registration_date</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>&#39;2024-01-01&#39;</span></span>
<span class="line"><span>GROUP</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>c.id,</span><span class="space"> </span><span>c.customer_name</span></span>
<span class="line"><span>HAVING</span><span class="space"> </span><span>COUNT(o.id)</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>5</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>total_amount</span><span class="space"> </span><span>DESC;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æŸ¥çœ‹æŸ¥è¯¢æ‰§è¡Œç»Ÿè®¡</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>schemaname,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>tablename,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>seq_scan,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>seq_tup_read,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>idx_scan,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>idx_tup_fetch,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>n_tup_ins,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>n_tup_upd,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>n_tup_del</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>pg_stat_user_tables</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>tablename</span><span class="space"> </span><span>IN</span><span class="space"> </span><span>(&#39;customers&#39;,</span><span class="space"> </span><span>&#39;orders&#39;);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ç´¢å¼•ä¼˜åŒ–ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#ç´¢å¼•ä¼˜åŒ–ç­–ç•¥"><span>ç´¢å¼•ä¼˜åŒ–ç­–ç•¥</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºå¤åˆç´¢å¼•</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_orders_customer_date</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>orders</span><span class="space"> </span><span>(customer_id,</span><span class="space"> </span><span>order_date);</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_orders_amount_date</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>orders</span><span class="space"> </span><span>(amount,</span><span class="space"> </span><span>order_date)</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>amount</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>100;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>éƒ¨åˆ†ç´¢å¼•ï¼ˆæ¡ä»¶ç´¢å¼•ï¼‰</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_active_customers</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>customers</span><span class="space"> </span><span>(registration_date)</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>status</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;active&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>è¡¨è¾¾å¼ç´¢å¼•</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_customers_lower_email</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>customers</span><span class="space"> </span><span>(LOWER(email));</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_orders_year_month</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>orders</span><span class="space"> </span><span>(EXTRACT(YEAR</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>order_date),</span><span class="space"> </span><span>EXTRACT(MONTH</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>order_date));</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>schemaname,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>tablename,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>indexname,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>idx_scan,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>idx_tup_read,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>idx_tup_fetch</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>pg_stat_user_indexes</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>idx_scan</span><span class="space"> </span><span>DESC;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æŸ¥æ‰¾æœªä½¿ç”¨çš„ç´¢å¼•</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>schemaname,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>tablename,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>indexname,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>pg_size_pretty(pg_relation_size(indexname::regclass))</span><span class="space"> </span><span>as</span><span class="space"> </span><span>index_size</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>pg_stat_user_indexes</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>idx_scan</span><span class="space"> </span><span>=</span><span class="space"> </span><span>0</span></span>
<span class="line"><span>AND</span><span class="space"> </span><span>schemaname</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;public&#39;;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="é…ç½®ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#é…ç½®ä¼˜åŒ–"><span>é…ç½®ä¼˜åŒ–</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>æŸ¥çœ‹é‡è¦çš„é…ç½®å‚æ•°</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>name,</span><span class="space"> </span><span>setting,</span><span class="space"> </span><span>unit,</span><span class="space"> </span><span>context</span><span class="space"> </span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>pg_settings</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>name</span><span class="space"> </span><span>IN</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&#39;shared_buffers&#39;,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&#39;effective_cache_size&#39;,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&#39;work_mem&#39;,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&#39;maintenance_work_mem&#39;,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&#39;checkpoint_completion_target&#39;,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&#39;wal_buffers&#39;,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&#39;default_statistics_target&#39;</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æŸ¥çœ‹æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>datname,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>numbackends,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>xact_commit,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>xact_rollback,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>blks_read,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>blks_hit,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>temp_files,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>temp_bytes,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>deadlocks</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>pg_stat_database</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>datname</span><span class="space"> </span><span>=</span><span class="space"> </span><span>current_database();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ç¼“å­˜å‘½ä¸­ç‡åˆ†æ</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&#39;Buffer</span><span class="space"> </span><span>Cache</span><span class="space"> </span><span>Hit</span><span class="space"> </span><span>Rate&#39;</span><span class="space"> </span><span>as</span><span class="space"> </span><span>metric,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ROUND(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>100.0</span><span class="space"> </span><span>*</span><span class="space"> </span><span>sum(blks_hit)</span><span class="space"> </span><span>/</span><span class="space"> </span><span>(sum(blks_hit)</span><span class="space"> </span><span>+</span><span class="space"> </span><span>sum(blks_read)),</span><span class="space"> </span><span>2</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>percentage</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>pg_stat_database</span></span>
<span class="line"><span>UNION</span><span class="space"> </span><span>ALL</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&#39;Index</span><span class="space"> </span><span>Cache</span><span class="space"> </span><span>Hit</span><span class="space"> </span><span>Rate&#39;</span><span class="space"> </span><span>as</span><span class="space"> </span><span>metric,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ROUND(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>100.0</span><span class="space"> </span><span>*</span><span class="space"> </span><span>sum(idx_blks_hit)</span><span class="space"> </span><span>/</span><span class="space"> </span><span>nullif(sum(idx_blks_hit)</span><span class="space"> </span><span>+</span><span class="space"> </span><span>sum(idx_blks_read),</span><span class="space"> </span><span>0),</span><span class="space"> </span><span>2</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>percentage</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>pg_statio_user_indexes;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="vacuumå’Œanalyzeä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#vacuumå’Œanalyzeä¼˜åŒ–"><span>VACUUMå’ŒANALYZEä¼˜åŒ–</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>æ‰‹åŠ¨VACUUMå’ŒANALYZE</span></span>
<span class="line"><span>VACUUM</span><span class="space"> </span><span>ANALYZE</span><span class="space"> </span><span>customers;</span></span>
<span class="line"><span>VACUUM</span><span class="space"> </span><span>ANALYZE</span><span class="space"> </span><span>orders;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æŸ¥çœ‹è¡¨çš„è†¨èƒ€æƒ…å†µ</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>schemaname,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>tablename,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>n_dead_tup,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>n_live_tup,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ROUND(100</span><span class="space"> </span><span>*</span><span class="space"> </span><span>n_dead_tup</span><span class="space"> </span><span>/</span><span class="space"> </span><span>(n_live_tup</span><span class="space"> </span><span>+</span><span class="space"> </span><span>n_dead_tup),</span><span class="space"> </span><span>2)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>dead_tuple_percent,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>last_vacuum,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>last_autovacuum,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>last_analyze,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>last_autoanalyze</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>pg_stat_user_tables</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>n_dead_tup</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>0</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>dead_tuple_percent</span><span class="space"> </span><span>DESC;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>é…ç½®è‡ªåŠ¨VACUUM</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>åœ¨postgresql.confä¸­è®¾ç½®ï¼š</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>autovacuum</span><span class="space"> </span><span>=</span><span class="space"> </span><span>on</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>autovacuum_vacuum_threshold</span><span class="space"> </span><span>=</span><span class="space"> </span><span>50</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>autovacuum_vacuum_scale_factor</span><span class="space"> </span><span>=</span><span class="space"> </span><span>0.2</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>autovacuum_analyze_threshold</span><span class="space"> </span><span>=</span><span class="space"> </span><span>50</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>autovacuum_analyze_scale_factor</span><span class="space"> </span><span>=</span><span class="space"> </span><span>0.1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_12-ä¼ä¸šçº§ç‰¹æ€§" tabindex="-1"><a class="header-anchor" href="#_12-ä¼ä¸šçº§ç‰¹æ€§"><span>12. ä¼ä¸šçº§ç‰¹æ€§</span></a></h2><h3 id="æµå¤åˆ¶å’Œé«˜å¯ç”¨" tabindex="-1"><a class="header-anchor" href="#æµå¤åˆ¶å’Œé«˜å¯ç”¨"><span>æµå¤åˆ¶å’Œé«˜å¯ç”¨</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>ä¸»æœåŠ¡å™¨é…ç½®</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>åœ¨postgresql.confä¸­ï¼š</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>wal_level</span><span class="space"> </span><span>=</span><span class="space"> </span><span>replica</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>max_wal_senders</span><span class="space"> </span><span>=</span><span class="space"> </span><span>3</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>wal_keep_segments</span><span class="space"> </span><span>=</span><span class="space"> </span><span>64</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>archive_mode</span><span class="space"> </span><span>=</span><span class="space"> </span><span>on</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>archive_command</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;cp</span><span class="space"> </span><span>%p</span><span class="space"> </span><span>/path/to/archive/%f&#39;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºå¤åˆ¶ç”¨æˆ·</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>ROLE</span><span class="space"> </span><span>replicator</span><span class="space"> </span><span>WITH</span><span class="space"> </span><span>REPLICATION</span><span class="space"> </span><span>LOGIN</span><span class="space"> </span><span>PASSWORD</span><span class="space"> </span><span>&#39;replica_password&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>åœ¨pg_hba.confä¸­æ·»åŠ ï¼š</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>host</span><span class="space"> </span><span>replication</span><span class="space"> </span><span>replicator</span><span class="space"> </span><span>slave_ip/32</span><span class="space"> </span><span>md5</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æŸ¥çœ‹å¤åˆ¶çŠ¶æ€</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>client_addr,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>state,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>sent_lsn,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>write_lsn,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>flush_lsn,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>replay_lsn,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>write_lag,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>flush_lag,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>replay_lag</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>pg_stat_replication;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æŸ¥çœ‹WALçŠ¶æ€</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>pg_current_wal_lsn(),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>pg_wal_lsn_diff(pg_current_wal_lsn(),</span><span class="space"> </span><span>&#39;0/0&#39;)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>wal_bytes;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å¤‡ä»½å’Œæ¢å¤" tabindex="-1"><a class="header-anchor" href="#å¤‡ä»½å’Œæ¢å¤"><span>å¤‡ä»½å’Œæ¢å¤</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>é€»è¾‘å¤‡ä»½</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>pg_dump</span><span class="space"> </span><span>-h</span><span class="space"> </span><span>localhost</span><span class="space"> </span><span>-U</span><span class="space"> </span><span>postgres</span><span class="space"> </span><span>-d</span><span class="space"> </span><span>mydb</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>backup.sql</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>pg_dump</span><span class="space"> </span><span>-h</span><span class="space"> </span><span>localhost</span><span class="space"> </span><span>-U</span><span class="space"> </span><span>postgres</span><span class="space"> </span><span>-d</span><span class="space"> </span><span>mydb</span><span class="space"> </span><span>-t</span><span class="space"> </span><span>customers</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>customers_backup.sql</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ç‰©ç†å¤‡ä»½ï¼ˆåŸºç¡€å¤‡ä»½ï¼‰</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>pg_basebackup</span><span class="space"> </span><span>-h</span><span class="space"> </span><span>localhost</span><span class="space"> </span><span>-D</span><span class="space"> </span><span>/backup/base</span><span class="space"> </span><span>-U</span><span class="space"> </span><span>replicator</span><span class="space"> </span><span>-v</span><span class="space"> </span><span>-P</span><span class="space"> </span><span>-W</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æ—¶é—´ç‚¹æ¢å¤ï¼ˆPITRï¼‰</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>åœ¨recovery.confä¸­ï¼š</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>restore_command</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;cp</span><span class="space"> </span><span>/path/to/archive/%f</span><span class="space"> </span><span>%p&#39;</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>recovery_target_time</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;2024-01-15</span><span class="space"> </span><span>14:30:00&#39;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æŸ¥çœ‹å¤‡ä»½ä¿¡æ¯</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>pg_start_backup(&#39;manual_backup&#39;,</span><span class="space"> </span><span>false,</span><span class="space"> </span><span>false);</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æ‰§è¡Œæ–‡ä»¶ç³»ç»Ÿå¤‡ä»½</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>pg_stop_backup(false,</span><span class="space"> </span><span>true);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="è¿æ¥æ± å’Œè´Ÿè½½å‡è¡¡" tabindex="-1"><a class="header-anchor" href="#è¿æ¥æ± å’Œè´Ÿè½½å‡è¡¡"><span>è¿æ¥æ± å’Œè´Ÿè½½å‡è¡¡</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>æŸ¥çœ‹å½“å‰è¿æ¥</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>datname,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>usename,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>client_addr,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>state,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>query_start,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>state_change,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>query</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>pg_stat_activity</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>state</span><span class="space"> </span><span>!=</span><span class="space"> </span><span>&#39;idle&#39;</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>query_start;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>è¿æ¥ç»Ÿè®¡</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>datname,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>COUNT(*)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>connection_count,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>COUNT(*)</span><span class="space"> </span><span>FILTER</span><span class="space"> </span><span>(WHERE</span><span class="space"> </span><span>state</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;active&#39;)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>active_connections,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>COUNT(*)</span><span class="space"> </span><span>FILTER</span><span class="space"> </span><span>(WHERE</span><span class="space"> </span><span>state</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;idle&#39;)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>idle_connections</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>pg_stat_activity</span></span>
<span class="line"><span>GROUP</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>datname;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>é•¿æ—¶é—´è¿è¡Œçš„æŸ¥è¯¢</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>pid,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>usename,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>datname,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>query_start,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>now()</span><span class="space"> </span><span>-</span><span class="space"> </span><span>query_start</span><span class="space"> </span><span>as</span><span class="space"> </span><span>duration,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>state,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>query</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>pg_stat_activity</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>state</span><span class="space"> </span><span>!=</span><span class="space"> </span><span>&#39;idle&#39;</span></span>
<span class="line"><span>AND</span><span class="space"> </span><span>now()</span><span class="space"> </span><span>-</span><span class="space"> </span><span>query_start</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>interval</span><span class="space"> </span><span>&#39;5</span><span class="space"> </span><span>minutes&#39;</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>duration</span><span class="space"> </span><span>DESC;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_13-å®é™…æ¡ˆä¾‹ç ”ç©¶" tabindex="-1"><a class="header-anchor" href="#_13-å®é™…æ¡ˆä¾‹ç ”ç©¶"><span>13. å®é™…æ¡ˆä¾‹ç ”ç©¶</span></a></h2><h3 id="æ¡ˆä¾‹1-ç”µå•†è®¢å•ç³»ç»Ÿ" tabindex="-1"><a class="header-anchor" href="#æ¡ˆä¾‹1-ç”µå•†è®¢å•ç³»ç»Ÿ"><span>æ¡ˆä¾‹1ï¼šç”µå•†è®¢å•ç³»ç»Ÿ</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºç”µå•†è®¢å•ç³»ç»Ÿçš„æ ¸å¿ƒè¡¨ç»“æ„</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>ecommerce_products</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>sku</span><span class="space"> </span><span>VARCHAR(50)</span><span class="space"> </span><span>UNIQUE</span><span class="space"> </span><span>NOT</span><span class="space"> </span><span>NULL,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name</span><span class="space"> </span><span>VARCHAR(200)</span><span class="space"> </span><span>NOT</span><span class="space"> </span><span>NULL,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>category_path</span><span class="space"> </span><span>LTREE,</span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>ä½¿ç”¨ltreeæ‰©å±•æ”¯æŒå±‚çº§åˆ†ç±»</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>price</span><span class="space"> </span><span>DECIMAL(10,2),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>inventory_count</span><span class="space"> </span><span>INTEGER,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>attributes</span><span class="space"> </span><span>JSONB,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>search_vector</span><span class="space"> </span><span>TSVECTOR,</span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>å…¨æ–‡æœç´¢</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>created_at</span><span class="space"> </span><span>TIMESTAMP</span><span class="space"> </span><span>DEFAULT</span><span class="space"> </span><span>NOW()</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>ecommerce_orders</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>BIGSERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>order_number</span><span class="space"> </span><span>VARCHAR(50)</span><span class="space"> </span><span>UNIQUE</span><span class="space"> </span><span>NOT</span><span class="space"> </span><span>NULL,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>customer_id</span><span class="space"> </span><span>INTEGER,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>status</span><span class="space"> </span><span>VARCHAR(20)</span><span class="space"> </span><span>DEFAULT</span><span class="space"> </span><span>&#39;pending&#39;,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>total_amount</span><span class="space"> </span><span>DECIMAL(15,2),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>shipping_address</span><span class="space"> </span><span>JSONB,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>order_date</span><span class="space"> </span><span>TIMESTAMP</span><span class="space"> </span><span>DEFAULT</span><span class="space"> </span><span>NOW(),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>shipped_date</span><span class="space"> </span><span>TIMESTAMP,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>delivered_date</span><span class="space"> </span><span>TIMESTAMP</span></span>
<span class="line"><span>)</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>RANGE</span><span class="space"> </span><span>(order_date);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºæŒ‰æœˆåˆ†åŒº</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>ecommerce_orders_2024_01</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>OF</span><span class="space"> </span><span>ecommerce_orders</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FOR</span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>(&#39;2024-01-01&#39;)</span><span class="space"> </span><span>TO</span><span class="space"> </span><span>(&#39;2024-02-01&#39;);</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>ecommerce_orders_2024_02</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>OF</span><span class="space"> </span><span>ecommerce_orders</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FOR</span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>(&#39;2024-02-01&#39;)</span><span class="space"> </span><span>TO</span><span class="space"> </span><span>(&#39;2024-03-01&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>ecommerce_order_items</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>BIGSERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>order_id</span><span class="space"> </span><span>BIGINT</span><span class="space"> </span><span>REFERENCES</span><span class="space"> </span><span>ecommerce_orders(id),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>product_id</span><span class="space"> </span><span>INTEGER</span><span class="space"> </span><span>REFERENCES</span><span class="space"> </span><span>ecommerce_products(id),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>quantity</span><span class="space"> </span><span>INTEGER,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>unit_price</span><span class="space"> </span><span>DECIMAL(10,2),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>total_price</span><span class="space"> </span><span>DECIMAL(10,2)</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>å¯ç”¨å¿…è¦çš„æ‰©å±•</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>EXTENSION</span><span class="space"> </span><span>ltree;</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>EXTENSION</span><span class="space"> </span><span>pg_trgm;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºä¼˜åŒ–ç´¢å¼•</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_products_category</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>ecommerce_products</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>GIST</span><span class="space"> </span><span>(category_path);</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_products_search</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>ecommerce_products</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>GIN</span><span class="space"> </span><span>(search_vector);</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_products_attributes</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>ecommerce_products</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>GIN</span><span class="space"> </span><span>(attributes);</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_orders_customer_date</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>ecommerce_orders</span><span class="space"> </span><span>(customer_id,</span><span class="space"> </span><span>order_date);</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_orders_status</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>ecommerce_orders</span><span class="space"> </span><span>(status)</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>status</span><span class="space"> </span><span>!=</span><span class="space"> </span><span>&#39;delivered&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æ’å…¥ç¤ºä¾‹æ•°æ®</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>ecommerce_products</span><span class="space"> </span><span>(sku,</span><span class="space"> </span><span>name,</span><span class="space"> </span><span>category_path,</span><span class="space"> </span><span>price,</span><span class="space"> </span><span>inventory_count,</span><span class="space"> </span><span>attributes)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;PHONE001&#39;,</span><span class="space"> </span><span>&#39;iPhone</span><span class="space"> </span><span>15</span><span class="space"> </span><span>Pro&#39;,</span><span class="space"> </span><span>&#39;electronics.mobile.smartphones&#39;,</span><span class="space"> </span><span>999.99,</span><span class="space"> </span><span>50,</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span>&#39;{&quot;brand&quot;:</span><span class="space"> </span><span>&quot;Apple&quot;,</span><span class="space"> </span><span>&quot;color&quot;:</span><span class="space"> </span><span>&quot;Natural</span><span class="space"> </span><span>Titanium&quot;,</span><span class="space"> </span><span>&quot;storage&quot;:</span><span class="space"> </span><span>&quot;128GB&quot;,</span><span class="space"> </span><span>&quot;features&quot;:</span><span class="space"> </span><span>[&quot;Face</span><span class="space"> </span><span>ID&quot;,</span><span class="space"> </span><span>&quot;5G&quot;,</span><span class="space"> </span><span>&quot;ProRAW&quot;]}&#39;),</span></span>
<span class="line"><span>(&#39;LAPTOP001&#39;,</span><span class="space"> </span><span>&#39;MacBook</span><span class="space"> </span><span>Pro</span><span class="space"> </span><span>M3&#39;,</span><span class="space"> </span><span>&#39;electronics.computers.laptops&#39;,</span><span class="space"> </span><span>1999.99,</span><span class="space"> </span><span>25,</span></span>
<span class="line"><span class="space"> </span><span>&#39;{&quot;brand&quot;:</span><span class="space"> </span><span>&quot;Apple&quot;,</span><span class="space"> </span><span>&quot;screen&quot;:</span><span class="space"> </span><span>&quot;14-inch&quot;,</span><span class="space"> </span><span>&quot;processor&quot;:</span><span class="space"> </span><span>&quot;M3&quot;,</span><span class="space"> </span><span>&quot;memory&quot;:</span><span class="space"> </span><span>&quot;16GB&quot;,</span><span class="space"> </span><span>&quot;storage&quot;:</span><span class="space"> </span><span>&quot;512GB</span><span class="space"> </span><span>SSD&quot;}&#39;),</span></span>
<span class="line"><span>(&#39;BOOK001&#39;,</span><span class="space"> </span><span>&#39;PostgreSQLæƒå¨æŒ‡å—&#39;,</span><span class="space"> </span><span>&#39;books.technology.databases&#39;,</span><span class="space"> </span><span>89.99,</span><span class="space"> </span><span>100,</span></span>
<span class="line"><span class="space"> </span><span>&#39;{&quot;author&quot;:</span><span class="space"> </span><span>&quot;PostgreSQLä¸“å®¶&quot;,</span><span class="space"> </span><span>&quot;pages&quot;:</span><span class="space"> </span><span>800,</span><span class="space"> </span><span>&quot;language&quot;:</span><span class="space"> </span><span>&quot;ä¸­æ–‡&quot;,</span><span class="space"> </span><span>&quot;format&quot;:</span><span class="space"> </span><span>&quot;ç²¾è£…&quot;}&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æ›´æ–°æœç´¢å‘é‡</span></span>
<span class="line"><span>UPDATE</span><span class="space"> </span><span>ecommerce_products</span><span class="space"> </span><span>SET</span><span class="space"> </span><span>search_vector</span><span class="space"> </span><span>=</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>to_tsvector(&#39;chinese&#39;,</span><span class="space"> </span><span>name</span><span class="space"> </span><span>||</span><span class="space"> </span><span>&#39;</span><span class="space"> </span><span>&#39;</span><span class="space"> </span><span>||</span><span class="space"> </span><span>COALESCE(attributes-&gt;&gt;&#39;brand&#39;,</span><span class="space"> </span><span>&#39;&#39;));</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>å¤æ‚æŸ¥è¯¢ç¤ºä¾‹ï¼šå•†å“æ¨èç³»ç»Ÿ</span></span>
<span class="line"><span>WITH</span><span class="space"> </span><span>customer_preferences</span><span class="space"> </span><span>AS</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>o.customer_id,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>p.category_path,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>COUNT(*)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>purchase_count,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>AVG(oi.unit_price)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>avg_price</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>ecommerce_orders</span><span class="space"> </span><span>o</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>JOIN</span><span class="space"> </span><span>ecommerce_order_items</span><span class="space"> </span><span>oi</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>o.id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>oi.order_id</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>JOIN</span><span class="space"> </span><span>ecommerce_products</span><span class="space"> </span><span>p</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>oi.product_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>p.id</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>o.order_date</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>NOW()</span><span class="space"> </span><span>-</span><span class="space"> </span><span>INTERVAL</span><span class="space"> </span><span>&#39;6</span><span class="space"> </span><span>months&#39;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>GROUP</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>o.customer_id,</span><span class="space"> </span><span>p.category_path</span></span>
<span class="line"><span>),</span></span>
<span class="line"><span>similar_products</span><span class="space"> </span><span>AS</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>p.*,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>similarity(p.name,</span><span class="space"> </span><span>&#39;æ‰‹æœº&#39;)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>name_similarity</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>ecommerce_products</span><span class="space"> </span><span>p</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>p.search_vector</span><span class="space"> </span><span>@@</span><span class="space"> </span><span>to_tsquery(&#39;chinese&#39;,</span><span class="space"> </span><span>&#39;æ‰‹æœº</span><span class="space"> </span><span>|</span><span class="space"> </span><span>ç”µè¯&#39;)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>OR</span><span class="space"> </span><span>p.name</span><span class="space"> </span><span>%</span><span class="space"> </span><span>&#39;æ‰‹æœº&#39;</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>sp.name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>sp.price,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>sp.category_path,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>sp.attributes,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>sp.name_similarity</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>similar_products</span><span class="space"> </span><span>sp</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>sp.inventory_count</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>0</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>sp.name_similarity</span><span class="space"> </span><span>DESC,</span><span class="space"> </span><span>sp.price</span><span class="space"> </span><span>ASC</span></span>
<span class="line"><span>LIMIT</span><span class="space"> </span><span>10;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ¡ˆä¾‹2-åœ°ç†ä½ç½®æœåŠ¡" tabindex="-1"><a class="header-anchor" href="#æ¡ˆä¾‹2-åœ°ç†ä½ç½®æœåŠ¡"><span>æ¡ˆä¾‹2ï¼šåœ°ç†ä½ç½®æœåŠ¡</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>åŸºäºPostGISçš„ä½ç½®æœåŠ¡ç³»ç»Ÿ</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>location_businesses</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name</span><span class="space"> </span><span>VARCHAR(200),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>category</span><span class="space"> </span><span>VARCHAR(100),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>address</span><span class="space"> </span><span>TEXT,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>location</span><span class="space"> </span><span>GEOMETRY(POINT,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>WGS84åæ ‡ç³»</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>rating</span><span class="space"> </span><span>DECIMAL(3,2),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>price_level</span><span class="space"> </span><span>INTEGER,</span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>1-4ä»·æ ¼ç­‰çº§</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>opening_hours</span><span class="space"> </span><span>JSONB,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>contact_info</span><span class="space"> </span><span>JSONB,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>created_at</span><span class="space"> </span><span>TIMESTAMP</span><span class="space"> </span><span>DEFAULT</span><span class="space"> </span><span>NOW()</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>location_users</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>username</span><span class="space"> </span><span>VARCHAR(50),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>current_location</span><span class="space"> </span><span>GEOMETRY(POINT,</span><span class="space"> </span><span>4326),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>home_location</span><span class="space"> </span><span>GEOMETRY(POINT,</span><span class="space"> </span><span>4326),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>preferences</span><span class="space"> </span><span>JSONB,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>last_active</span><span class="space"> </span><span>TIMESTAMP</span><span class="space"> </span><span>DEFAULT</span><span class="space"> </span><span>NOW()</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>åˆ›å»ºç©ºé—´ç´¢å¼•</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_businesses_location</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>location_businesses</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>GIST</span><span class="space"> </span><span>(location);</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_users_current_location</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>location_users</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>GIST</span><span class="space"> </span><span>(current_location);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>æ’å…¥ç¤ºä¾‹æ•°æ®ï¼ˆåŒ—äº¬åœ°åŒºï¼‰</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>location_businesses</span><span class="space"> </span><span>(name,</span><span class="space"> </span><span>category,</span><span class="space"> </span><span>address,</span><span class="space"> </span><span>location,</span><span class="space"> </span><span>rating,</span><span class="space"> </span><span>price_level,</span><span class="space"> </span><span>opening_hours)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;æ˜Ÿå·´å…‹(ä¸‰é‡Œå±¯åº—)&#39;,</span><span class="space"> </span><span>&#39;å’–å•¡å…&#39;,</span><span class="space"> </span><span>&#39;åŒ—äº¬å¸‚æœé˜³åŒºä¸‰é‡Œå±¯è·¯19å·&#39;,</span><span class="space"> </span><span>ST_SetSRID(ST_MakePoint(116.4551,</span><span class="space"> </span><span>39.9365),</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>4.2,</span><span class="space"> </span><span>3,</span></span>
<span class="line"><span class="space"> </span><span>&#39;{&quot;monday&quot;:</span><span class="space"> </span><span>&quot;06:30-22:00&quot;,</span><span class="space"> </span><span>&quot;tuesday&quot;:</span><span class="space"> </span><span>&quot;06:30-22:00&quot;,</span><span class="space"> </span><span>&quot;sunday&quot;:</span><span class="space"> </span><span>&quot;07:00-21:00&quot;}&#39;),</span></span>
<span class="line"><span>(&#39;å…¨èšå¾·(å‰é—¨åº—)&#39;,</span><span class="space"> </span><span>&#39;é¤å…&#39;,</span><span class="space"> </span><span>&#39;åŒ—äº¬å¸‚ä¸œåŸåŒºå‰é—¨å¤§è¡—30å·&#39;,</span><span class="space"> </span><span>ST_SetSRID(ST_MakePoint(116.3967,</span><span class="space"> </span><span>39.9015),</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>4.0,</span><span class="space"> </span><span>4,</span></span>
<span class="line"><span class="space"> </span><span>&#39;{&quot;monday&quot;:</span><span class="space"> </span><span>&quot;11:00-21:00&quot;,</span><span class="space"> </span><span>&quot;tuesday&quot;:</span><span class="space"> </span><span>&quot;11:00-21:00&quot;,</span><span class="space"> </span><span>&quot;sunday&quot;:</span><span class="space"> </span><span>&quot;11:00-21:00&quot;}&#39;),</span></span>
<span class="line"><span>(&#39;åŒ—äº¬å¤§å­¦&#39;,</span><span class="space"> </span><span>&#39;æ•™è‚²&#39;,</span><span class="space"> </span><span>&#39;åŒ—äº¬å¸‚æµ·æ·€åŒºé¢å’Œå›­è·¯5å·&#39;,</span><span class="space"> </span><span>ST_SetSRID(ST_MakePoint(116.3105,</span><span class="space"> </span><span>39.9926),</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>4.8,</span><span class="space"> </span><span>1,</span></span>
<span class="line"><span class="space"> </span><span>&#39;{&quot;monday&quot;:</span><span class="space"> </span><span>&quot;å…¨å¤©å¼€æ”¾&quot;,</span><span class="space"> </span><span>&quot;sunday&quot;:</span><span class="space"> </span><span>&quot;å…¨å¤©å¼€æ”¾&quot;}&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>location_users</span><span class="space"> </span><span>(username,</span><span class="space"> </span><span>current_location,</span><span class="space"> </span><span>home_location,</span><span class="space"> </span><span>preferences)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;user1&#39;,</span><span class="space"> </span><span>ST_SetSRID(ST_MakePoint(116.4074,</span><span class="space"> </span><span>39.9042),</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>ST_SetSRID(ST_MakePoint(116.4074,</span><span class="space"> </span><span>39.9042),</span><span class="space"> </span><span>4326),</span></span>
<span class="line"><span class="space"> </span><span>&#39;{&quot;favorite_categories&quot;:</span><span class="space"> </span><span>[&quot;å’–å•¡å…&quot;,</span><span class="space"> </span><span>&quot;ä¹¦åº—&quot;],</span><span class="space"> </span><span>&quot;max_distance&quot;:</span><span class="space"> </span><span>2000,</span><span class="space"> </span><span>&quot;price_preference&quot;:</span><span class="space"> </span><span>[1,2,3]}&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>é™„è¿‘å•†å®¶æŸ¥è¯¢ï¼ˆ2å…¬é‡ŒèŒƒå›´å†…ï¼‰</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>b.name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>b.category,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>b.rating,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>b.price_level,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Distance(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Transform(b.location,</span><span class="space"> </span><span>3857),</span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>è½¬æ¢ä¸ºç±³åˆ¶åæ ‡ç³»</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Transform(u.current_location,</span><span class="space"> </span><span>3857)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>distance_meters</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>location_businesses</span><span class="space"> </span><span>b</span></span>
<span class="line"><span>CROSS</span><span class="space"> </span><span>JOIN</span><span class="space"> </span><span>location_users</span><span class="space"> </span><span>u</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>u.username</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;user1&#39;</span></span>
<span class="line"><span>AND</span><span class="space"> </span><span>ST_DWithin(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Transform(b.location,</span><span class="space"> </span><span>3857),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Transform(u.current_location,</span><span class="space"> </span><span>3857),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>2000</span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>2å…¬é‡Œ</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>distance_meters</span><span class="space"> </span><span>ASC;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>è·¯å¾„è§„åˆ’æŸ¥è¯¢</span></span>
<span class="line"><span>WITH</span><span class="space"> </span><span>route_points</span><span class="space"> </span><span>AS</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_SetSRID(ST_MakePoint(116.4074,</span><span class="space"> </span><span>39.9042),</span><span class="space"> </span><span>4326)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>start_point,</span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>å¤©å®‰é—¨</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_SetSRID(ST_MakePoint(116.3105,</span><span class="space"> </span><span>39.9926),</span><span class="space"> </span><span>4326)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>end_point</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>åŒ—å¤§</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>b.name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>b.category,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Distance(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Transform(b.location,</span><span class="space"> </span><span>3857),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Transform(ST_MakeLine(rp.start_point,</span><span class="space"> </span><span>rp.end_point),</span><span class="space"> </span><span>3857)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>distance_to_route</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>location_businesses</span><span class="space"> </span><span>b</span></span>
<span class="line"><span>CROSS</span><span class="space"> </span><span>JOIN</span><span class="space"> </span><span>route_points</span><span class="space"> </span><span>rp</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>ST_DWithin(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Transform(b.location,</span><span class="space"> </span><span>3857),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Transform(ST_MakeLine(rp.start_point,</span><span class="space"> </span><span>rp.end_point),</span><span class="space"> </span><span>3857),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>500</span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>è·ç¦»è·¯çº¿500ç±³å†…</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>distance_to_route</span><span class="space"> </span><span>ASC;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>çƒ­åŠ›å›¾æ•°æ®ç”Ÿæˆ</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_X(location)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>longitude,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Y(location)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>latitude,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>COUNT(*)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>business_count,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>AVG(rating)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>avg_rating</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>location_businesses</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>ST_Within(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>location,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_MakeEnvelope(116.3,</span><span class="space"> </span><span>39.8,</span><span class="space"> </span><span>116.5,</span><span class="space"> </span><span>40.0,</span><span class="space"> </span><span>4326)</span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>åŒ—äº¬å¸‚åŒºèŒƒå›´</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span>GROUP</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>ST_SnapToGrid(location,</span><span class="space"> </span><span>0.01)</span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>æŒ‰0.01åº¦ç½‘æ ¼èšåˆ</span></span>
<span class="line"><span>HAVING</span><span class="space"> </span><span>COUNT(*)</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>0</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>business_count</span><span class="space"> </span><span>DESC;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“"><span>æ€»ç»“</span></a></h2><p>é€šè¿‡è¿™æ¬¡PostgreSQLçš„æ·±åº¦æ¢ç´¢ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒç›¸æ¯”MySQLçš„è¯¸å¤šä¼˜åŠ¿ï¼š</p><ol><li><strong>æ•°æ®ç±»å‹ä¸°å¯Œ</strong>ï¼šåŸç”Ÿæ”¯æŒJSON/JSONBã€æ•°ç»„ã€è‡ªå®šä¹‰ç±»å‹ç­‰</li><li><strong>æŸ¥è¯¢åŠŸèƒ½å¼ºå¤§</strong>ï¼šçª—å£å‡½æ•°ã€CTEã€å…¨æ–‡æœç´¢ç­‰é«˜çº§ç‰¹æ€§</li><li><strong>PostGISåœ°ç†ä¿¡æ¯</strong>ï¼šä¸šç•Œæœ€å¼ºçš„åœ°ç†ä¿¡æ¯ç³»ç»Ÿæ”¯æŒ</li><li><strong>æ‰©å±•ç”Ÿæ€ä¸°å¯Œ</strong>ï¼špg_stat_statementsã€pg_trgmã€uuid-osspç­‰å®ç”¨æ‰©å±•</li><li><strong>ç´¢å¼•ç±»å‹å¤šæ ·</strong>ï¼šGINã€GiSTã€BRINç­‰é’ˆå¯¹ä¸åŒåœºæ™¯çš„ç´¢å¼•</li><li><strong>å¹¶å‘æ§åˆ¶å…ˆè¿›</strong>ï¼šMVCCæœºåˆ¶æä¾›æ›´å¥½çš„å¹¶å‘æ€§èƒ½</li><li><strong>åˆ†åŒºè¡¨æ”¯æŒ</strong>ï¼šå£°æ˜å¼åˆ†åŒºç®€åŒ–å¤§è¡¨ç®¡ç†</li><li><strong>å¤–éƒ¨æ•°æ®è®¿é—®</strong>ï¼šFDWå®ç°æ•°æ®è”é‚¦æŸ¥è¯¢</li><li><strong>å­˜å‚¨è¿‡ç¨‹çµæ´»</strong>ï¼šæ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€</li><li><strong>ä¼ä¸šçº§ç‰¹æ€§</strong>ï¼šæµå¤åˆ¶ã€PITRã€é«˜å¯ç”¨ç­‰</li></ol><p>PostgreSQLä¸ä»…ä»…æ˜¯ä¸€ä¸ªå…³ç³»å‹æ•°æ®åº“ï¼Œæ›´æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ•°æ®å¹³å°ã€‚å®ƒçš„è¿™äº›&quot;å¤§æ€æ‹›&quot; åŠŸèƒ½è®©å®ƒåœ¨å¤„ç†å¤æ‚ä¸šåŠ¡åœºæ™¯æ—¶æ¸¸åˆƒæœ‰ä½™ï¼Œç‰¹åˆ«æ˜¯åœ¨éœ€è¦åœ°ç†ä¿¡æ¯å¤„ç†ã€å¤æ‚æ•°æ®åˆ†æã€é«˜å¹¶å‘è¯»å†™çš„ç°ä»£åº”ç”¨ä¸­è¡¨ç°å‡ºè‰²ã€‚</p><p>å¯¹äºå¼€å‘è€…æ¥è¯´ï¼ŒæŒæ¡PostgreSQLçš„è¿™äº›ç‰¹æ€§ï¼Œä¸ä»…èƒ½æé«˜å¼€å‘æ•ˆç‡ï¼Œè¿˜èƒ½ä¸ºç³»ç»Ÿæ¶æ„æä¾›æ›´å¤šå¯èƒ½æ€§ã€‚åœ¨é€‰æ‹©æ•°æ®åº“æŠ€æœ¯æ ˆæ—¶ï¼ŒPostgreSQLç»å¯¹å€¼å¾—è®¤çœŸè€ƒè™‘ã€‚</p>`,157)])])}const r=a(e,[["render",l]]),v=JSON.parse(`{"path":"/article/k5v78e0h/","title":"å·¥ä½œæ‰«ç›²ä¹‹PostgreSQL","lang":"zh-CN","frontmatter":{"title":"å·¥ä½œæ‰«ç›²ä¹‹PostgreSQL","createTime":"2025/09/23 21:33:24","permalink":"/article/k5v78e0h/","description":"1. å¼•è¨€ ä½œä¸ºä¸€ååç«¯å¼€å‘è€…ï¼Œåœ¨æ—¥å¸¸å·¥ä½œä¸­æˆ‘ä»¬ç»å¸¸æ¥è§¦MySQLæ•°æ®åº“ï¼Œä½†éšç€ä¸šåŠ¡å¤æ‚åº¦çš„æå‡ï¼Œæˆ‘å¼€å§‹æ¥è§¦åˆ°PostgreSQLè¿™ä¸ª\\" ä¸–ç•Œä¸Šæœ€å…ˆè¿›çš„å¼€æºå…³ç³»å‹æ•°æ®åº“\\"ã€‚åˆæ¬¡ä½¿ç”¨PostgreSQLï¼Œæˆ‘è¢«å®ƒå¼ºå¤§çš„åŠŸèƒ½ç‰¹æ€§æ·±æ·±éœ‡æ’¼ã€‚ ä¸ºä»€ä¹ˆé€‰æ‹©PostgreSQLï¼Ÿ ç›¸æ¯”MySQLï¼ŒPostgreSQLåœ¨ä»¥ä¸‹æ–¹é¢è¡¨ç°å‡ºè‰²ï¼š ğŸ¯ æ›´ä¸°å¯Œçš„æ•°æ®ç±»å‹ï¼šåŸç”Ÿ...","head":[["meta",{"property":"og:url","content":"https://callmeexiao.baby/article/k5v78e0h/"}],["meta",{"property":"og:site_name","content":"Exiao's Blog"}],["meta",{"property":"og:title","content":"å·¥ä½œæ‰«ç›²ä¹‹PostgreSQL"}],["meta",{"property":"og:description","content":"1. å¼•è¨€ ä½œä¸ºä¸€ååç«¯å¼€å‘è€…ï¼Œåœ¨æ—¥å¸¸å·¥ä½œä¸­æˆ‘ä»¬ç»å¸¸æ¥è§¦MySQLæ•°æ®åº“ï¼Œä½†éšç€ä¸šåŠ¡å¤æ‚åº¦çš„æå‡ï¼Œæˆ‘å¼€å§‹æ¥è§¦åˆ°PostgreSQLè¿™ä¸ª\\" ä¸–ç•Œä¸Šæœ€å…ˆè¿›çš„å¼€æºå…³ç³»å‹æ•°æ®åº“\\"ã€‚åˆæ¬¡ä½¿ç”¨PostgreSQLï¼Œæˆ‘è¢«å®ƒå¼ºå¤§çš„åŠŸèƒ½ç‰¹æ€§æ·±æ·±éœ‡æ’¼ã€‚ ä¸ºä»€ä¹ˆé€‰æ‹©PostgreSQLï¼Ÿ ç›¸æ¯”MySQLï¼ŒPostgreSQLåœ¨ä»¥ä¸‹æ–¹é¢è¡¨ç°å‡ºè‰²ï¼š ğŸ¯ æ›´ä¸°å¯Œçš„æ•°æ®ç±»å‹ï¼šåŸç”Ÿ..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2026-02-04T02:20:05.000Z"}],["meta",{"property":"article:modified_time","content":"2026-02-04T02:20:05.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"å·¥ä½œæ‰«ç›²ä¹‹PostgreSQL\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2026-02-04T02:20:05.000Z\\",\\"author\\":[]}"]]},"headers":[],"readingTime":{"minutes":25.79,"words":7736},"git":{"updatedTime":1770171605000,"contributors":[{"name":"exiao","username":"exiao","email":"exiao@ptkj.net","commits":2,"avatar":"https://avatars.githubusercontent.com/exiao?v=4","url":"https://github.com/exiao"},{"name":"é‡‘é€¸éœ„","username":"é‡‘é€¸éœ„","email":"yixiaojin@ptkj.net","commits":1,"avatar":"https://avatars.githubusercontent.com/é‡‘é€¸éœ„?v=4","url":"https://github.com/é‡‘é€¸éœ„"}]},"autoDesc":true,"filePathRelative":"åç«¯æŠ€æœ¯/å·¥ä½œæ‰«ç›²ä¹‹PostgreSQL.md","categoryList":[{"id":"543517","sort":10001,"name":"åç«¯æŠ€æœ¯"}]}`);export{r as comp,v as data};
