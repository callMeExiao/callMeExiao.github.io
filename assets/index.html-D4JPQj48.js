import{_ as a,c as p,b as n,o as c}from"./app-DqRurxSm.js";const e={};function l(i,s){return c(),p("div",null,[...s[0]||(s[0]=[n(`<h2 id="流量镜像mirror" tabindex="-1"><a class="header-anchor" href="#流量镜像mirror"><span>流量镜像Mirror</span></a></h2><h3 id="背景" tabindex="-1"><a class="header-anchor" href="#背景"><span>背景</span></a></h3><p>将原来微信支付回调通知地址从C#项目服务器（以下统称为C）改为我的Java项目服务器（以下统称为J）。 但同时得保证现有业务的正常运行，所以需要将J的流量镜像到C，并且更改回调通知地址为J。</p><h3 id="实现" tabindex="-1"><a class="header-anchor" href="#实现"><span>实现</span></a></h3><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>#</span><span class="space"> </span><span>/api/wxnotify/refund</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>location</span><span class="space"> </span><span>/api/wxnotify/v3/refund</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>#</span><span class="space"> </span><span>静默镜像到旧服务A</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>mirror</span><span class="space"> </span><span>/refundMirror;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>mirror_request_body</span><span class="space"> </span><span>on;</span><span class="space"> </span><span class="space"> </span><span>#</span><span class="space"> </span><span>复制请求体（POST/PUT需要）</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>#</span><span class="space"> </span><span>转发到本地</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>proxy_pass</span><span class="space"> </span><span>http://localhost:8080;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>proxy_set_header</span><span class="space"> </span><span>Host</span><span class="space"> </span><span>$host;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>proxy_set_header</span><span class="space"> </span><span>X-Real-IP</span><span class="space"> </span><span>$remote_addr;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>proxy_set_header</span><span class="space"> </span><span>X-Forwarded-For</span><span class="space"> </span><span>$proxy_add_x_forwarded_for;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>proxy_set_header</span><span class="space"> </span><span>X-Forwarded-Proto</span><span class="space"> </span><span>$scheme;</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>#</span><span class="space"> </span><span>超时设置（可选）</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>proxy_connect_timeout</span><span class="space"> </span><span>60s;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>proxy_read_timeout</span><span class="space"> </span><span>600s;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>proxy_send_timeout</span><span class="space"> </span><span>600s;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>#</span><span class="space"> </span><span>镜像专用日志</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>access_log</span><span class="space"> </span><span>/var/log/nginx/mirror.log</span><span class="space"> </span><span>mirror_log;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>}</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>#</span><span class="space"> </span><span>refundMirror</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>location</span><span class="space"> </span><span>=</span><span class="space"> </span><span>/refundMirror</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>internal;</span><span class="space"> </span><span class="space"> </span><span>#</span><span class="space"> </span><span>禁止外部直接访问</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>proxy_pass</span><span class="space"> </span><span>http://{C域名}/API/WXTuiFeiNotify.aspx;</span><span class="space"> </span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>#</span><span class="space"> </span><span>代理头配置（需匹配A服务的Host）</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>proxy_set_header</span><span class="space"> </span><span>Host</span><span class="space"> </span><span>{C域名};</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>proxy_set_header</span><span class="space"> </span><span>X-Real-IP</span><span class="space"> </span><span>$remote_addr;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>proxy_set_header</span><span class="space"> </span><span>X-Forwarded-For</span><span class="space"> </span><span>$proxy_add_x_forwarded_for;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>proxy_set_header</span><span class="space"> </span><span>X-Forwarded-Proto</span><span class="space"> </span><span>$scheme;</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>#</span><span class="space"> </span><span>请求体处理</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>proxy_pass_request_body</span><span class="space"> </span><span>on;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>proxy_set_body</span><span class="space"> </span><span>$request_body;</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>#</span><span class="space"> </span><span>超时配置（镜像请求可设置较短超时）</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>proxy_connect_timeout</span><span class="space"> </span><span>5s;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>proxy_read_timeout</span><span class="space"> </span><span>5s;</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>#</span><span class="space"> </span><span>启用镜像日志</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>access_log</span><span class="space"> </span><span>/var/log/nginx/mirror.log</span><span class="space"> </span><span>mirror_log;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,5)])])}const d=a(e,[["render",l]]),t=JSON.parse(`{"path":"/article/m55hg40w/","title":"Nginx之流量镜像Mirror","lang":"zh-CN","frontmatter":{"title":"Nginx之流量镜像Mirror","createTime":"2025/04/22 20:14:37","permalink":"/article/m55hg40w/","description":"流量镜像Mirror 背景 将原来微信支付回调通知地址从C#项目服务器（以下统称为C）改为我的Java项目服务器（以下统称为J）。 但同时得保证现有业务的正常运行，所以需要将J的流量镜像到C，并且更改回调通知地址为J。 实现","head":[["meta",{"property":"og:url","content":"https://callmeexiao.baby/article/m55hg40w/"}],["meta",{"property":"og:site_name","content":"Exiao's Blog"}],["meta",{"property":"og:title","content":"Nginx之流量镜像Mirror"}],["meta",{"property":"og:description","content":"流量镜像Mirror 背景 将原来微信支付回调通知地址从C#项目服务器（以下统称为C）改为我的Java项目服务器（以下统称为J）。 但同时得保证现有业务的正常运行，所以需要将J的流量镜像到C，并且更改回调通知地址为J。 实现"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-06-29T06:22:24.000Z"}],["meta",{"property":"article:modified_time","content":"2025-06-29T06:22:24.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Nginx之流量镜像Mirror\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2025-06-29T06:22:24.000Z\\",\\"author\\":[]}"]]},"headers":[],"readingTime":{"minutes":0.89,"words":267},"git":{"updatedTime":1751178144000,"contributors":[{"name":"Exiao","username":"Exiao","email":"574355578@qq.com","commits":4,"avatar":"https://avatars.githubusercontent.com/Exiao?v=4","url":"https://github.com/Exiao"}]},"autoDesc":true,"filePathRelative":"后端技术/Nginx之流量镜像Mirror.md","categoryList":[{"id":"543517","sort":10000,"name":"后端技术"}]}`);export{d as comp,t as data};
