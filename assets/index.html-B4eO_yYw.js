import{_ as a,c as n,a as e,o as p}from"./app-pBrtxVLr.js";const l={};function c(i,s){return p(),n("div",null,[...s[0]||(s[0]=[e(`<h2 id="引言" tabindex="-1"><a class="header-anchor" href="#引言"><span>引言</span></a></h2><p>本文记录我在项目中从 0 搭建“海康摄像头 → Web 预览与告警图片”的完整链路与实践要点。网络链路如下：</p><p>摄像头 → NVR → 边缘计算路由器 → 光猫 → HikDeviceGateway 所在服务器 → ZLMediaKit 所在服务器 → 业务系统</p><p>核心目标：</p><ul><li>获取稳定可用的预览流 URL（RTSP → 浏览器友好格式）</li><li>通过轮询接口获取告警图片，下载并投递到 MQ 供其他服务消费</li></ul><hr><h2 id="一、系统架构概览" tabindex="-1"><a class="header-anchor" href="#一、系统架构概览"><span>一、系统架构概览</span></a></h2><ul><li><p>组件角色：</p><ul><li><code>HikDeviceGateway</code>：统一对接海康设备，负责 ISUP 5.0 注册、ISAPI 透传与预览流 URL 获取</li><li><code>ZLMediaKit</code>：负责将 RTSP 流协议转换为浏览器友好的 <code>HTTP-fMP4/WS-FLV/HLS</code> 等</li></ul></li><li><p>数据流向：</p><ul><li>摄像头/NVR 产出 RTSP 流 → 网关拉取/汇聚 → 转给 ZLMediaKit 做按需协议转换 → 前端以 <code>fMP4/FLV/HLS</code> 播放</li><li>告警图片由轮询接口发现 → 下载存储 → 投递 MQ 供下游服务消费与展示</li></ul></li></ul><hr><h2 id="二、网络环境搭建与成本优化-动态-ip-ddns" tabindex="-1"><a class="header-anchor" href="#二、网络环境搭建与成本优化-动态-ip-ddns"><span>二、网络环境搭建与成本优化（动态 IP + DDNS）</span></a></h2><p>由于未购买固定公网 IP，我采用“路由器定时任务上报 IP 到 DDNS 服务”的方式，将域名与当前公网 IP 绑定，从而以固定域名远程访问路由器与同网络的 NVR：</p><ul><li>方案要点： <ul><li>路由器定时任务每 5 分钟上报一次当前公网 IP</li><li>DDNS 平台将域名解析更新为最新 IP</li><li>通过固定域名访问路由器/NVR/服务器，便于远程调试与改配置</li></ul></li></ul><hr><h2 id="三、hikdevicegateway-集成与使用" tabindex="-1"><a class="header-anchor" href="#三、hikdevicegateway-集成与使用"><span>三、HikDeviceGateway 集成与使用</span></a></h2><p>参考文档：https://open.hikvision.com/docs/docId?productId=5cda567cf47ae80dd41a54b3&amp;version=%2F0cbf4539c3e74a3f858f9601582544e9&amp;tagPath=%E6%A6%82%E8%BF%B0-%E7%AE%80%E4%BB%8B</p><h3 id="_3-1-isup-5-0-设备注册" tabindex="-1"><a class="header-anchor" href="#_3-1-isup-5-0-设备注册"><span>3.1 ISUP 5.0 设备注册</span></a></h3><ul><li>作用：对接海康设备（摄像头/NVR），统一注册并管理在线状态</li><li>流程概要： <ol><li>在网关侧创建/维护设备接入参数（设备序列号、认证信息、通道信息）</li><li>设备上线后，网关维护心跳与状态；异常时做重连与告警</li></ol></li><li>典型要点： <ul><li>确认设备时间、网络与鉴权参数一致，避免注册失败</li><li>为多通道 NVR 规划好通道索引与码流（主/子码流）</li></ul></li><li>网关页面选择接入网卡 IP 的实操注意： <ul><li>在 HikDeviceGateway 的页面中，需要从下拉框选择“作为设备接入网络”的宿主机网卡 IP。</li><li>不建议在“有大量 Docker 桥接网络”的宿主机上部署网关：网关会枚举并展示这些 bridge 网段的 IP，导致下拉列表挤满无用项。</li><li>该下拉列表最多仅显示有限数量的 IP（实际观察约 12～16 项），一旦真实对外网关 IP不在展示范围内，将无法选择正确的对外网卡。</li><li>建议： <ol><li>在网络干净的宿主机或专用虚拟机上部署网关；</li><li>清理多余的 Docker 网络或减少 bridge 数量；</li><li>明确标注宿主机“对外网关”的真实网卡与 IP，避免选错导致设备接入失败。</li></ol></li></ul></li></ul><h3 id="_3-2-isapi-协议透传" tabindex="-1"><a class="header-anchor" href="#_3-2-isapi-协议透传"><span>3.2 ISAPI 协议透传</span></a></h3><ul><li>作用：通过网关直接调用设备的 ISAPI 接口（查询/控制/参数调整）</li><li>使用场景： <ul><li>查询设备配置（如 <code>GET /ISAPI/System/time</code>）</li><li>设置编码/码率/OSD 等（如 <code>PUT /ISAPI/Streaming/channels/101</code>）</li></ul></li><li>透传调用要点： <ul><li>网关提供 REST 接口，内部代理到设备 ISAPI；统一鉴权与日志</li><li>建议对高频调用做限速与重试</li></ul></li></ul><h3 id="_3-3-预览-rtsp-流-url-获取" tabindex="-1"><a class="header-anchor" href="#_3-3-预览-rtsp-流-url-获取"><span>3.3 预览 RTSP 流 URL 获取</span></a></h3><ul><li>常见海康 RTSP 地址格式： <ul><li>主码流：<code>rtsp://&lt;device_ip&gt;:554/Streaming/Channels/101</code></li><li>子码流：<code>rtsp://&lt;device_ip&gt;:554/Streaming/Channels/102</code></li></ul></li><li>通过网关获取预览 URL： <ul><li>在网关侧调用预览接口，返回设备通道对应的 RTSP URL</li><li>结合设备在线状态与码流偏好，动态选择 101/102 等通道</li></ul></li></ul><hr><h2 id="四、zlmediakit-流媒体服务" tabindex="-1"><a class="header-anchor" href="#四、zlmediakit-流媒体服务"><span>四、ZLMediaKit 流媒体服务</span></a></h2><p>参考文档：https://docs.zlmediakit.com/zh/guide/</p><h3 id="_4-1-rtsp-→-http-fmp4-转换" tabindex="-1"><a class="header-anchor" href="#_4-1-rtsp-→-http-fmp4-转换"><span>4.1 RTSP → HTTP-fMP4 转换</span></a></h3><ul><li>背景：浏览器原生不支持 RTSP，需将协议转换为 <code>HTTP-fMP4/WS-FLV/HLS</code> 等</li><li>典型用法： <ol><li>通过 ZLMediaKit 的 API 添加 RTSP 代理（按需拉流）</li><li>获取对应的播放地址（例如 <code>http://&lt;zlm_host&gt;/live/&lt;stream&gt;.fmp4</code>）</li></ol></li><li>示例（添加流代理，具体参数以实际部署为准）：</li></ul><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#61AFEF;">curl</span><span class="space"> </span><span style="color:#D19A66;">-X</span><span class="space"> </span><span style="color:#98C379;">POST</span><span class="space"> </span><span style="color:#98C379;">&quot;http://&lt;zlm_host&gt;:&lt;api_port&gt;/index/api/addStreamProxy&quot;</span><span class="space"> </span><span style="color:#56B6C2;">\\</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="color:#D19A66;">-d</span><span class="space"> </span><span style="color:#98C379;">&quot;vhost=__defaultVhost__&amp;app=live&amp;stream=cam01&amp;url=rtsp://&lt;device_ip&gt;:554/Streaming/Channels/101&amp;retry_count=3&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>常见播放地址形式： <ul><li><code>HTTP-fMP4</code>：<code>http://&lt;zlm_host&gt;/live/cam01.fmp4</code></li><li><code>WS-FLV</code>：<code>ws://&lt;zlm_host&gt;/live/cam01.live.flv</code></li><li><code>HLS</code>：<code>http://&lt;zlm_host&gt;/live/cam01/hls.m3u8</code></li></ul></li></ul><h3 id="_4-2-延迟与带宽简述" tabindex="-1"><a class="header-anchor" href="#_4-2-延迟与带宽简述"><span>4.2 延迟与带宽简述</span></a></h3><ul><li>低延迟建议：优先使用 <code>HTTP-fMP4/WS-FLV</code> 等秒开、低时延方式</li><li>带宽规划：依据码率（主码流/子码流）与并发播放数量做带宽预估</li></ul><hr><h2 id="五、告警图片功能实现-轮询-下载-mq-投递" tabindex="-1"><a class="header-anchor" href="#五、告警图片功能实现-轮询-下载-mq-投递"><span>五、告警图片功能实现（轮询 + 下载 + MQ 投递）</span></a></h2><h3 id="_5-1-轮询策略与时间窗口" tabindex="-1"><a class="header-anchor" href="#_5-1-轮询策略与时间窗口"><span>5.1 轮询策略与时间窗口</span></a></h3><ul><li>实现思路：隔固定时间（如每 30 秒/1 分钟）调用接口，查询“最近一段时间”是否有新图片；有则下载并投递 MQ。</li><li>时间窗口：使用 <code>[now - interval - overlap, now]</code>，其中 <code>overlap</code>（如 5~10 秒）用于处理时钟误差或接口延迟，避免漏图。</li><li>游标维护：每个设备/通道维护“最后处理时间戳”；下一次查询从该时间戳向后推进，配合 overlap 防抖。</li><li>幂等关键：新图片以 <code>deviceId + channel + eventTime + filename</code> 作为唯一键，已处理的键写入去重集合（如 Redis set）。</li></ul><p>示例伪代码：</p><div class="language-pseudo line-numbers-mode" data-ext="pseudo" data-title="pseudo"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>for</span><span class="space"> </span><span>each</span><span class="space"> </span><span>deviceChannel</span><span class="space"> </span><span>in</span><span class="space"> </span><span>configuredList:</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>windowStart</span><span class="space"> </span><span>=</span><span class="space"> </span><span>max(lastProcessedTime[deviceChannel]</span><span class="space"> </span><span>-</span><span class="space"> </span><span>overlap,</span><span class="space"> </span><span>now</span><span class="space"> </span><span>-</span><span class="space"> </span><span>interval)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>windowEnd</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>=</span><span class="space"> </span><span>now</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>images</span><span class="space"> </span><span>=</span><span class="space"> </span><span>queryImages(deviceChannel,</span><span class="space"> </span><span>windowStart,</span><span class="space"> </span><span>windowEnd)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>for</span><span class="space"> </span><span>img</span><span class="space"> </span><span>in</span><span class="space"> </span><span>images:</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>key</span><span class="space"> </span><span>=</span><span class="space"> </span><span>hash(deviceId,</span><span class="space"> </span><span>channel,</span><span class="space"> </span><span>img.eventTime,</span><span class="space"> </span><span>img.filename)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>if</span><span class="space"> </span><span>not</span><span class="space"> </span><span>exists(processedSet,</span><span class="space"> </span><span>key):</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>path</span><span class="space"> </span><span>=</span><span class="space"> </span><span>download(img.url)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>sendToMQ({deviceId,</span><span class="space"> </span><span>channel,</span><span class="space"> </span><span>eventTime,</span><span class="space"> </span><span>path,</span><span class="space"> </span><span>checksum})</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>mark(processedSet,</span><span class="space"> </span><span>key)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>lastProcessedTime[deviceChannel]</span><span class="space"> </span><span>=</span><span class="space"> </span><span>max(lastProcessedTime,</span><span class="space"> </span><span>img.eventTime)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-下载与存储规范" tabindex="-1"><a class="header-anchor" href="#_5-2-下载与存储规范"><span>5.2 下载与存储规范</span></a></h3><ul><li>下载方式：HTTP 流式下载，校验 <code>Content-Length/MD5</code>，失败重试（指数退避，最大重试次数）。</li><li>存储路径：<code>/alerts/{deviceId}/{channel}/{yyyy-MM-dd}/{eventTime}_{filename}</code>；统一文件命名便于检索与生命周期管理。</li><li>图片质量：根据业务需要控制分辨率与压缩质量（JPEG/PNG），建议优先 JPEG 以降低存储占用。</li><li>清理策略：针对历史数据配置生命周期（例如保留 90 天），定期归档或清理。</li></ul><h3 id="_5-3-mq-投递与消费" tabindex="-1"><a class="header-anchor" href="#_5-3-mq-投递与消费"><span>5.3 MQ 投递与消费</span></a></h3><ul><li>消息结构（示例）：</li></ul><div class="language-json line-numbers-mode" data-ext="json" data-title="json"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">&quot;deviceId&quot;</span><span style="color:#ABB2BF;">:</span><span class="space"> </span><span style="color:#98C379;">&quot;HK-001&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">&quot;channel&quot;</span><span style="color:#ABB2BF;">:</span><span class="space"> </span><span style="color:#98C379;">&quot;101&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">&quot;eventTime&quot;</span><span style="color:#ABB2BF;">:</span><span class="space"> </span><span style="color:#98C379;">&quot;2025-11-02T21:33:21Z&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">&quot;imagePath&quot;</span><span style="color:#ABB2BF;">:</span><span class="space"> </span><span style="color:#98C379;">&quot;/alerts/HK-001/101/2025-11-02/1730871201_alarm.jpg&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">&quot;checksum&quot;</span><span style="color:#ABB2BF;">:</span><span class="space"> </span><span style="color:#98C379;">&quot;md5-xxxx&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">&quot;size&quot;</span><span style="color:#ABB2BF;">:</span><span class="space"> </span><span style="color:#D19A66;">183245</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>队列设置：开启持久化；失败重试与死信队列（DLQ）；消费者幂等（根据唯一键去重）。</li><li>业务消费：下游服务根据 <code>deviceId/channel/eventTime</code> 做关联，支持二次处理（识别/标注/推送）。</li></ul><h3 id="_5-4-失败兜底与监控" tabindex="-1"><a class="header-anchor" href="#_5-4-失败兜底与监控"><span>5.4 失败兜底与监控</span></a></h3><ul><li>失败重试：下载失败或 MQ 不可用时，写入重试队列，采用指数退避；超过阈值写入 DLQ 等待人工/定时恢复。</li><li>指标监控：记录每分钟新图片数、下载失败率、MQ 投递失败率、平均处理时延；出现异常时告警。</li><li>速率限制：为接口调用与下载设置限流，避免高并发导致设备或网关过载。</li></ul><hr><h2 id="六、性能测试-保留" tabindex="-1"><a class="header-anchor" href="#六、性能测试-保留"><span>六、性能测试（保留）</span></a></h2><ul><li>并发能力：在 N 路摄像头同时预览时的 CPU/内存占用与丢帧率</li><li>端到端时延：摄像头 → 网关 → ZLMediaKit → 浏览器 的总时延测量</li><li>带宽测算：主/子码流在不同并发下的上/下行带宽占用</li></ul><hr><h2 id="七、项目总结" tabindex="-1"><a class="header-anchor" href="#七、项目总结"><span>七、项目总结</span></a></h2><ul><li><code>HikDeviceGateway + ZLMediaKit</code> 组合能较好满足“RTSP 到 Web 播放”的通用需求</li><li>动态 IP + DDNS 大幅降低公网成本，同时保证远程维护与配置变更可行</li><li>告警图片抓取与展示对前端无强依赖，只需提供稳定 URL 与基本接口即可</li></ul><hr><h2 id="附录" tabindex="-1"><a class="header-anchor" href="#附录"><span>附录</span></a></h2><ul><li>DDNS 上报脚本与定时任务示例（见上文）</li><li>常用端口（按需开放）： <ul><li><code>554</code>：RTSP（摄像头/NVR）</li><li><code>80/443</code>：HTTP/HTTPS（网关/ZLMediaKit/管理台）</li><li><code>1935</code>：RTMP（ZLMediaKit 可选）</li></ul></li><li>参考链接： <ul><li>HikDeviceGateway 文档：https://open.hikvision.com/docs/docId?productId=5cda567cf47ae80dd41a54b3&amp;version=%2F0cbf4539c3e74a3f858f9601582544e9&amp;tagPath=%E6%A6%82%E8%BF%B0-%E7%AE%80%E4%BB%8B</li><li>ZLMediaKit 指南：https://docs.zlmediakit.com/zh/guide/</li></ul></li></ul>`,53)])])}const o=a(l,[["render",c]]),d=JSON.parse(`{"path":"/article/6yq6nd8j/","title":"阶段总结之海康摄像头接入","lang":"zh-CN","frontmatter":{"title":"阶段总结之海康摄像头接入","createTime":"2026/02/04 09:54:43","permalink":"/article/6yq6nd8j/","description":"引言 本文记录我在项目中从 0 搭建“海康摄像头 → Web 预览与告警图片”的完整链路与实践要点。网络链路如下： 摄像头 → NVR → 边缘计算路由器 → 光猫 → HikDeviceGateway 所在服务器 → ZLMediaKit 所在服务器 → 业务系统 核心目标： 获取稳定可用的预览流 URL（RTSP → 浏览器友好格式） 通过轮询接口...","head":[["meta",{"property":"og:url","content":"https://callmeexiao.baby/article/6yq6nd8j/"}],["meta",{"property":"og:site_name","content":"Exiao's Blog"}],["meta",{"property":"og:title","content":"阶段总结之海康摄像头接入"}],["meta",{"property":"og:description","content":"引言 本文记录我在项目中从 0 搭建“海康摄像头 → Web 预览与告警图片”的完整链路与实践要点。网络链路如下： 摄像头 → NVR → 边缘计算路由器 → 光猫 → HikDeviceGateway 所在服务器 → ZLMediaKit 所在服务器 → 业务系统 核心目标： 获取稳定可用的预览流 URL（RTSP → 浏览器友好格式） 通过轮询接口..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2026-02-04T02:20:05.000Z"}],["meta",{"property":"article:modified_time","content":"2026-02-04T02:20:05.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"阶段总结之海康摄像头接入\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2026-02-04T02:20:05.000Z\\",\\"author\\":[]}"]]},"headers":[],"readingTime":{"minutes":6.57,"words":1970},"git":{"updatedTime":1770171605000,"contributors":[{"name":"exiao","username":"exiao","email":"574355578@qq.com","commits":1,"avatar":"https://avatars.githubusercontent.com/exiao?v=4","url":"https://github.com/exiao"},{"name":"金逸霄","username":"金逸霄","email":"yixiaojin@ptkj.net","commits":1,"avatar":"https://avatars.githubusercontent.com/金逸霄?v=4","url":"https://github.com/金逸霄"}]},"autoDesc":true,"filePathRelative":"后端技术/阶段总结之海康摄像头接入.md","categoryList":[{"id":"543517","sort":10001,"name":"后端技术"}]}`);export{o as comp,d as data};
