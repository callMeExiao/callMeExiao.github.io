import{_ as a,c as t,a as s,o as l}from"./app-pBrtxVLr.js";const i={};function o(n,e){return l(),t("div",null,[...e[0]||(e[0]=[s(`<h2 id="_1-协议栈与连接阶段" tabindex="-1"><a class="header-anchor" href="#_1-协议栈与连接阶段"><span>1. 协议栈与连接阶段</span></a></h2><p>目标连接地址：</p><p>wss://&lt;broker-host&gt;:&lt;port&gt;/&lt;path&gt;</p><p>协议栈自底向上：</p><p>TCP -&gt; TLS -&gt; HTTP Upgrade -&gt; WebSocket -&gt; MQTT</p><p>典型阶段：</p><ol><li>TCP 三次握手（端口可达）</li><li>TLS Handshake（证书校验、SNI、协商套件）</li><li>HTTP Upgrade（WebSocket 握手）</li><li>MQTT CONNECT / CONNACK（认证/会话参数）</li></ol><p><strong>注意</strong>：<code>telnet</code> 仅验证 TCP 端口可达，不覆盖 TLS/WebSocket/MQTT。</p><h2 id="_2-tls-校验机制" tabindex="-1"><a class="header-anchor" href="#_2-tls-校验机制"><span>2. TLS 校验机制</span></a></h2><p>TLS 校验包含两类校验：</p><ul><li><strong>证书链验证</strong>：证书是否由可信 CA 签发</li><li><strong>主机名校验</strong>：证书 SAN/CN 是否匹配目标主机</li></ul><p>常见失败原因：</p><ul><li>使用 IP 访问，但证书仅包含域名</li><li>证书链不完整（缺中间证书）</li><li>证书过期或系统时间偏差</li><li>SNI 不正确导致返回默认证书</li></ul><h2 id="_3-paho-客户端的关键点-wss" tabindex="-1"><a class="header-anchor" href="#_3-paho-客户端的关键点-wss"><span>3. Paho 客户端的关键点（WSS）</span></a></h2><p>Paho 使用 <code>WebSocketSecureNetworkModule</code> → <code>SSLNetworkModule</code> 处理 WSS：</p><ul><li>TLS 握手前设置 SNI（<code>host</code>）</li><li>依据 <code>MqttConnectOptions</code> 控制主机名校验与证书校验</li><li>WebSocket handshake 在 TLS 完成后执行</li></ul><h2 id="_4-本次改动-信任所有证书-关闭主机名校验" tabindex="-1"><a class="header-anchor" href="#_4-本次改动-信任所有证书-关闭主机名校验"><span>4. 本次改动：信任所有证书 + 关闭主机名校验</span></a></h2><p>配置（prod）：</p><div class="language-yml line-numbers-mode" data-ext="yml" data-title="yml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#E06C75;">mqtt</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">china-tower</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">insecure-ssl</span><span style="color:#ABB2BF;">:</span><span class="space"> </span><span style="color:#D19A66;">true</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>逻辑：</p><ol><li>构造 TrustManager 实现（空校验）</li><li>SSLContext.getInstance(&quot;TLS&quot;) → init(null, trustManagers, ...)</li><li>options.setSocketFactory(sslContext.getSocketFactory())</li><li>options.setHttpsHostnameVerificationEnabled(false)</li><li>options.setSSLHostnameVerifier((h, s) -&gt; true)</li></ol><p>结果：</p><ul><li>证书链不校验</li><li>主机名不校验</li><li>仍是 TLS 加密通道，但认证失效</li></ul><h2 id="_5-风险评估" tabindex="-1"><a class="header-anchor" href="#_5-风险评估"><span>5. 风险评估</span></a></h2><p>关闭校验后：</p><ul><li>MITM 可伪造服务器证书</li><li>凭证泄露风险 ↑</li><li>消息篡改/监听风险 ↑</li></ul><p>适用场景：</p><ul><li>受控内网</li><li>短期排障</li><li>强监管条件下允许的临时方案</li></ul><h2 id="_6-连接确认的工程指标" tabindex="-1"><a class="header-anchor" href="#_6-连接确认的工程指标"><span>6. 连接确认的工程指标</span></a></h2><p>建议使用“三层确认”：</p><ol><li>connectComplete（连接已建立）</li><li>订阅成功事件</li><li>收到测试消息</li></ol><p>仅有“配置加载/bean started”日志不代表连接成功。</p><h2 id="_7-安全恢复方案" tabindex="-1"><a class="header-anchor" href="#_7-安全恢复方案"><span>7. 安全恢复方案</span></a></h2><p>排障结束后恢复安全校验：</p><ul><li>用证书匹配的域名访问</li><li>配置正确的 CA 链</li><li>由对方补齐证书链</li><li>确保系统时间正确</li></ul><h2 id="_8-术语对照" tabindex="-1"><a class="header-anchor" href="#_8-术语对照"><span>8. 术语对照</span></a></h2><ul><li>TLS: Transport Layer Security</li><li>SNI: Server Name Indication</li><li>SAN: Subject Alternative Name</li><li>MITM: Man-In-The-Middle</li><li>CONNACK: MQTT 连接确认响应</li></ul>`,37)])])}const r=a(i,[["render",o]]),c=JSON.parse(`{"path":"/article/5a8f6jl3/","title":"MQTToverWSS(TLS)连接与证书校验","lang":"zh-CN","frontmatter":{"title":"MQTToverWSS(TLS)连接与证书校验","createTime":"2026/02/04 09:55:46","permalink":"/article/5a8f6jl3/","description":"1. 协议栈与连接阶段 目标连接地址： wss://<broker-host>:<port>/<path> 协议栈自底向上： TCP -> TLS -> HTTP Upgrade -> WebSocket -> MQTT 典型阶段： TCP 三次握手（端口可达） TLS Handshake（证书校验、SNI、协商套件） HTTP Upgrade（Web...","head":[["meta",{"property":"og:url","content":"https://callmeexiao.baby/article/5a8f6jl3/"}],["meta",{"property":"og:site_name","content":"Exiao's Blog"}],["meta",{"property":"og:title","content":"MQTToverWSS(TLS)连接与证书校验"}],["meta",{"property":"og:description","content":"1. 协议栈与连接阶段 目标连接地址： wss://<broker-host>:<port>/<path> 协议栈自底向上： TCP -> TLS -> HTTP Upgrade -> WebSocket -> MQTT 典型阶段： TCP 三次握手（端口可达） TLS Handshake（证书校验、SNI、协商套件） HTTP Upgrade（Web..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2026-02-04T02:20:05.000Z"}],["meta",{"property":"article:modified_time","content":"2026-02-04T02:20:05.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"MQTToverWSS(TLS)连接与证书校验\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2026-02-04T02:20:05.000Z\\",\\"author\\":[]}"]]},"headers":[],"readingTime":{"minutes":1.83,"words":550},"git":{"updatedTime":1770171605000,"contributors":[{"name":"exiao","username":"exiao","email":"574355578@qq.com","commits":2,"avatar":"https://avatars.githubusercontent.com/exiao?v=4","url":"https://github.com/exiao"},{"name":"金逸霄","username":"金逸霄","email":"yixiaojin@ptkj.net","commits":3,"avatar":"https://avatars.githubusercontent.com/金逸霄?v=4","url":"https://github.com/金逸霄"}]},"autoDesc":true,"filePathRelative":"BugFixLogs/MQTToverWSS(TLS)连接与证书校验.md","categoryList":[{"id":"43f493","sort":10006,"name":"BugFixLogs"}]}`);export{r as comp,c as data};
