<!doctype html><html lang="zh-CN"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="generator" content="VuePress 2.0.0-rc.20" /><meta name="theme" content="VuePress Theme Plume " /><script id="check-mac-os">document.documentElement.classList.toggle('mac', /Mac|iPhone|iPod|iPad/i.test(navigator.platform))</script><meta property="og:url" content="https://callmeexiao.baby/article/ny5p9e82/"><meta property="og:site_name" content="Exiao's Blog"><meta property="og:title" content="æµ…è°ˆRabbitMQ"><meta property="og:description" content="å¼•è¨€ï¼šä¸ºä»€ä¹ˆå¼•å…¥ MQï¼ˆè§£è€¦ + å‰Šå³°ï¼‰ å¼•å…¥ RabbitMQ çš„æ ¸å¿ƒç›®æ ‡éå¸¸æ˜ç¡®ï¼šè§£è€¦ä¸å‰Šå³°ã€‚ è§£è€¦ï¼šç”Ÿäº§è€…åªå…³å¿ƒâ€œæŠ•é€’ä»»åŠ¡â€ï¼Œæ¶ˆè´¹è€…åªå…³å¿ƒâ€œå¤„ç†ä»»åŠ¡â€ï¼ŒåŒæ–¹ç‹¬ç«‹æ¼”è¿›ã€‚ å‰Šå³°ï¼šçªå‘æµé‡è¿›å…¥é˜Ÿåˆ—ç¼“å†²ï¼Œåå°æŒ‰ç¨³å®šé€Ÿç‡æ¶ˆè´¹ï¼Œé¿å…ç›´æ¥å†²å‡»ä¸‹æ¸¸ã€‚ æ¶æ„æ¦‚è§ˆï¼šæ¶ˆæ¯æµä¸ç»„ä»¶å…³ç³» æœ¬æ–‡ç¤ºä¾‹é‡‡ç”¨â€œä»»åŠ¡æŠ•é€’ â†’ ä»»åŠ¡å¤„ç† â†’ ç»“æœå›ä¼ â€çš„é“¾è·¯æ¨¡å¼ï¼Œæ ¸å¿ƒç”±äº¤æ¢æœºã€ä¸»é˜Ÿåˆ—..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2026-02-04T05:33:24.000Z"><meta property="article:modified_time" content="2026-02-04T05:33:24.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"æµ…è°ˆRabbitMQ","image":[""],"dateModified":"2026-02-04T05:33:24.000Z","author":[]}</script><link rel="icon" type="image/png" href="https://theme-plume.vuejs.press/favicon-32x32.png"><title>æµ…è°ˆRabbitMQ | Exiao's Blog</title><meta name="description" content="å¼•è¨€ï¼šä¸ºä»€ä¹ˆå¼•å…¥ MQï¼ˆè§£è€¦ + å‰Šå³°ï¼‰ å¼•å…¥ RabbitMQ çš„æ ¸å¿ƒç›®æ ‡éå¸¸æ˜ç¡®ï¼šè§£è€¦ä¸å‰Šå³°ã€‚ è§£è€¦ï¼šç”Ÿäº§è€…åªå…³å¿ƒâ€œæŠ•é€’ä»»åŠ¡â€ï¼Œæ¶ˆè´¹è€…åªå…³å¿ƒâ€œå¤„ç†ä»»åŠ¡â€ï¼ŒåŒæ–¹ç‹¬ç«‹æ¼”è¿›ã€‚ å‰Šå³°ï¼šçªå‘æµé‡è¿›å…¥é˜Ÿåˆ—ç¼“å†²ï¼Œåå°æŒ‰ç¨³å®šé€Ÿç‡æ¶ˆè´¹ï¼Œé¿å…ç›´æ¥å†²å‡»ä¸‹æ¸¸ã€‚ æ¶æ„æ¦‚è§ˆï¼šæ¶ˆæ¯æµä¸ç»„ä»¶å…³ç³» æœ¬æ–‡ç¤ºä¾‹é‡‡ç”¨â€œä»»åŠ¡æŠ•é€’ â†’ ä»»åŠ¡å¤„ç† â†’ ç»“æœå›ä¼ â€çš„é“¾è·¯æ¨¡å¼ï¼Œæ ¸å¿ƒç”±äº¤æ¢æœºã€ä¸»é˜Ÿåˆ—..."><link rel="preload" href="/assets/style-Cd332rkf.css" as="style"><link rel="stylesheet" href="/assets/style-Cd332rkf.css"><link rel="modulepreload" href="/assets/app-pBrtxVLr.js"><link rel="modulepreload" href="/assets/index.html-72c88PdW.js"></head><body><div id="app"><!--[--><!--[--><div class="theme-plume vp-layout" vp-container data-v-3bf3774b><!--[--><!--[--><!--]--><!--[--><span tabindex="-1" data-v-1afd8ef4></span><a href="#VPContent" class="vp-skip-link visually-hidden" data-v-1afd8ef4> Skip to content </a><!--]--><!----><header class="vp-nav" data-v-3bf3774b data-v-93076610><div class="vp-navbar" vp-navbar data-v-93076610 data-v-fb9743c7><div class="wrapper" data-v-fb9743c7><div class="container" data-v-fb9743c7><div class="title" data-v-fb9743c7><div class="vp-navbar-title" data-v-fb9743c7 data-v-800466e1><a class="vp-link no-icon link title" href="/" data-v-800466e1 data-v-8fd51d7e><!--[--><!--[--><!--]--><!--[--><!--[--><!--[--><img class="vp-image dark logo" style="" src="https://theme-plume.vuejs.press/plume.png" alt data-v-c4044e2a><!--]--><!--[--><img class="vp-image light logo" style="" src="https://theme-plume.vuejs.press/plume.png" alt data-v-c4044e2a><!--]--><!--]--><!--]--><span data-v-800466e1>Exiao&#39;s Blog</span><!--[--><!--]--><!--]--><!----></a></div></div><div class="content" data-v-fb9743c7><div class="content-body" data-v-fb9743c7><!--[--><!--]--><div class="vp-navbar-search search" data-v-fb9743c7><div class="search-wrapper" data-v-9b6231cb><!----><div id="local-search" data-v-9b6231cb><button type="button" class="mini-search mini-search-button" aria-label="æœç´¢æ–‡æ¡£" data-v-9b6231cb><span class="mini-search-button-container"><span class="mini-search-search-icon vpi-mini-search" aria-label="search icon"></span><span class="mini-search-button-placeholder">æœç´¢æ–‡æ¡£</span></span><span class="mini-search-button-keys"><kbd class="mini-search-button-key"></kbd><kbd class="mini-search-button-key">K</kbd></span></button></div></div></div><nav aria-labelledby="main-nav-aria-label" class="vp-navbar-menu menu" data-v-fb9743c7 data-v-f0b866c0><span id="main-nav-aria-label" class="visually-hidden" data-v-f0b866c0>Main Navigation</span><!--[--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/" tabindex="0" data-v-f0b866c0 data-v-575a5ecb data-v-8fd51d7e><!--[--><!----><span data-v-575a5ecb>é¦–é¡µ</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/blog/" tabindex="0" data-v-f0b866c0 data-v-575a5ecb data-v-8fd51d7e><!--[--><!----><span data-v-575a5ecb>åšå®¢</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/blog/tags/" tabindex="0" data-v-f0b866c0 data-v-575a5ecb data-v-8fd51d7e><!--[--><!----><span data-v-575a5ecb>æ ‡ç­¾</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/blog/archives/" tabindex="0" data-v-f0b866c0 data-v-575a5ecb data-v-8fd51d7e><!--[--><!----><span data-v-575a5ecb>å½’æ¡£</span><!--]--><!----></a><!--]--><!--[--><div class="vp-flyout vp-navbar-menu-group" data-v-f0b866c0 data-v-c02d6d2b><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-c02d6d2b><span class="text" data-v-c02d6d2b><!----><!----><span data-v-c02d6d2b>ç¬”è®°</span><span class="vpi-chevron-down text-icon" data-v-c02d6d2b></span></span></button><div class="menu" data-v-c02d6d2b><div class="vp-menu" data-v-c02d6d2b data-v-97b8bc66><div class="items" data-v-97b8bc66><!--[--><!--[--><div class="vp-menu-link" data-v-97b8bc66 data-v-f09a0f1d><a class="vp-link no-icon link" href="/demo/" data-v-f09a0f1d data-v-8fd51d7e><!--[--><!----> ç¤ºä¾‹<!--]--><!----></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!----><!----><div class="vp-social-links vp-navbar-social-links social-links" data-v-fb9743c7 data-v-b384e0a0 data-v-820a862b><!--[--><a class="vp-social-link no-icon" href="https://github.com/callMeExiao/callMeExiao.github.io" aria-label="github" target="_blank" rel="noopener" data-v-820a862b data-v-20c69dec><span class="vpi-social-github" /></a><!--]--></div><div class="vp-flyout vp-navbar-extra extra" data-v-fb9743c7 data-v-450b28d0 data-v-c02d6d2b><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-c02d6d2b><span class="vpi-more-horizontal icon" data-v-c02d6d2b></span></button><div class="menu" data-v-c02d6d2b><div class="vp-menu" data-v-c02d6d2b data-v-97b8bc66><!----><!--[--><!--[--><!----><!----><div class="group" data-v-450b28d0><div class="item social-links" data-v-450b28d0><div class="vp-social-links social-links-list" data-v-450b28d0 data-v-820a862b><!--[--><a class="vp-social-link no-icon" href="https://github.com/callMeExiao/callMeExiao.github.io" aria-label="github" target="_blank" rel="noopener" data-v-820a862b data-v-20c69dec><span class="vpi-social-github" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="vp-navbar-hamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="nav-screen" data-v-fb9743c7 data-v-1bb12327><span class="container" data-v-1bb12327><span class="top" data-v-1bb12327></span><span class="middle" data-v-1bb12327></span><span class="bottom" data-v-1bb12327></span></span></button></div></div></div></div><div class="divider" data-v-fb9743c7><div class="divider-line" data-v-fb9743c7></div></div></div><!----></header><div class="vp-local-nav fixed reached-top is-blog" data-v-3bf3774b data-v-f47454cb><button class="hidden menu" disabled aria-expanded="false" aria-controls="SidebarNav" data-v-f47454cb><span class="vpi-align-left menu-icon" data-v-f47454cb></span><span class="menu-text" data-v-f47454cb>Menu</span></button><div class="vp-local-nav-outline-dropdown" style="--vp-vh:0px;" data-v-f47454cb data-v-9029d9f5><button data-v-9029d9f5>è¿”å›é¡¶éƒ¨</button><!----></div></div><!----><!--[--><div id="VPContent" vp-content class="vp-content" data-v-3bf3774b data-v-63d685ff><div class="vp-doc-container is-blog" data-v-63d685ff data-v-48823583><!--[--><!--]--><div class="container" data-v-48823583><!----><div class="content" data-v-48823583><div class="content-container" data-v-48823583><!--[--><!--]--><main class="main" data-v-48823583><nav class="vp-breadcrumb" data-v-48823583 data-v-c735a90d><ol vocab="https://schema.org/" typeof="BreadcrumbList" data-v-c735a90d><!--[--><li property="itemListElement" typeof="ListItem" data-v-c735a90d><a class="vp-link no-icon link breadcrumb" href="/" property="item" typeof="WebPage" data-v-c735a90d data-v-8fd51d7e><!--[-->é¦–é¡µ<!--]--><!----></a><span class="vpi-chevron-right" data-v-c735a90d></span><meta property="name" content="é¦–é¡µ" data-v-c735a90d><meta property="position" content="1" data-v-c735a90d></li><li property="itemListElement" typeof="ListItem" data-v-c735a90d><a class="vp-link no-icon link breadcrumb" href="/blog/" property="item" typeof="WebPage" data-v-c735a90d data-v-8fd51d7e><!--[-->åšå®¢<!--]--><!----></a><span class="vpi-chevron-right" data-v-c735a90d></span><meta property="name" content="åšå®¢" data-v-c735a90d><meta property="position" content="2" data-v-c735a90d></li><li property="itemListElement" typeof="ListItem" data-v-c735a90d><a class="vp-link no-icon link breadcrumb" href="/blog/categories/?id=543517" property="item" typeof="WebPage" data-v-c735a90d data-v-8fd51d7e><!--[-->åç«¯æŠ€æœ¯<!--]--><!----></a><span class="vpi-chevron-right" data-v-c735a90d></span><meta property="name" content="åç«¯æŠ€æœ¯" data-v-c735a90d><meta property="position" content="3" data-v-c735a90d></li><li property="itemListElement" typeof="ListItem" data-v-c735a90d><a class="vp-link no-icon link breadcrumb current" href="/article/ny5p9e82/" property="item" typeof="WebPage" data-v-c735a90d data-v-8fd51d7e><!--[-->æµ…è°ˆRabbitMQ<!--]--><!----></a><!----><meta property="name" content="æµ…è°ˆRabbitMQ" data-v-c735a90d><meta property="position" content="4" data-v-c735a90d></li><!--]--></ol></nav><!--[--><h1 class="vp-doc-title page-title" data-v-d8ca9256>æµ…è°ˆRabbitMQ <!----></h1><div class="vp-doc-meta" data-v-d8ca9256><p class="reading-time" data-v-d8ca9256><span class="vpi-books icon" data-v-d8ca9256></span><span data-v-d8ca9256>çº¦ 1619 å­—</span><span data-v-d8ca9256>å¤§çº¦ 5 åˆ†é’Ÿ</span></p><!----><p class="create-time" data-v-d8ca9256><span class="vpi-clock icon" data-v-d8ca9256></span><span data-v-d8ca9256>2026-02-04</span></p></div><!--]--><div class="_article_ny5p9e82_ external-link-icon-enabled vp-doc plume-content" vp-content data-v-48823583><div data-v-48823583><h2 id="å¼•è¨€-ä¸ºä»€ä¹ˆå¼•å…¥-mq-è§£è€¦-å‰Šå³°" tabindex="-1"><a class="header-anchor" href="#å¼•è¨€-ä¸ºä»€ä¹ˆå¼•å…¥-mq-è§£è€¦-å‰Šå³°"><span>å¼•è¨€ï¼šä¸ºä»€ä¹ˆå¼•å…¥ MQï¼ˆè§£è€¦ + å‰Šå³°ï¼‰</span></a></h2><p>å¼•å…¥ RabbitMQ çš„æ ¸å¿ƒç›®æ ‡éå¸¸æ˜ç¡®ï¼š<strong>è§£è€¦</strong>ä¸<strong>å‰Šå³°</strong>ã€‚</p><ul><li><strong>è§£è€¦</strong>ï¼šç”Ÿäº§è€…åªå…³å¿ƒâ€œæŠ•é€’ä»»åŠ¡â€ï¼Œæ¶ˆè´¹è€…åªå…³å¿ƒâ€œå¤„ç†ä»»åŠ¡â€ï¼ŒåŒæ–¹ç‹¬ç«‹æ¼”è¿›ã€‚</li><li><strong>å‰Šå³°</strong>ï¼šçªå‘æµé‡è¿›å…¥é˜Ÿåˆ—ç¼“å†²ï¼Œåå°æŒ‰ç¨³å®šé€Ÿç‡æ¶ˆè´¹ï¼Œé¿å…ç›´æ¥å†²å‡»ä¸‹æ¸¸ã€‚</li></ul><h2 id="æ¶æ„æ¦‚è§ˆ-æ¶ˆæ¯æµä¸ç»„ä»¶å…³ç³»" tabindex="-1"><a class="header-anchor" href="#æ¶æ„æ¦‚è§ˆ-æ¶ˆæ¯æµä¸ç»„ä»¶å…³ç³»"><span>æ¶æ„æ¦‚è§ˆï¼šæ¶ˆæ¯æµä¸ç»„ä»¶å…³ç³»</span></a></h2><p>æœ¬æ–‡ç¤ºä¾‹é‡‡ç”¨â€œ<strong>ä»»åŠ¡æŠ•é€’ â†’ ä»»åŠ¡å¤„ç† â†’ ç»“æœå›ä¼ </strong>â€çš„é“¾è·¯æ¨¡å¼ï¼Œæ ¸å¿ƒç”±äº¤æ¢æœºã€ä¸»é˜Ÿåˆ—ã€é‡è¯•é˜Ÿåˆ—ä¸æ­»ä¿¡é˜Ÿåˆ—ç»„æˆã€‚</p><div class="language-mermaid line-numbers-mode" data-ext="mermaid" data-title="mermaid"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>flowchart</span><span class="space"> </span><span>LR</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>A[&quot;ä¸šåŠ¡å…¥å£/ä»»åŠ¡ç”Ÿæˆ&quot;]</span><span class="space"> </span><span>--&gt;</span><span class="space"> </span><span>B[&quot;TASK_EXCHANGE&quot;]</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>B</span><span class="space"> </span><span>--&gt;</span><span class="space"> </span><span>C[&quot;TASK_QUEUE&quot;]</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>C</span><span class="space"> </span><span>--&gt;</span><span class="space"> </span><span>D[&quot;æ¶ˆè´¹è€…å¤„ç†&quot;]</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>D</span><span class="space"> </span><span>--&gt;|å¤±è´¥|</span><span class="space"> </span><span>E[&quot;RETRY_QUEUE</span><span class="space"> </span><span>(TTL)&quot;]</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>E</span><span class="space"> </span><span>--&gt;|è¿‡æœŸ|</span><span class="space"> </span><span>B</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>D</span><span class="space"> </span><span>--&gt;|å¤±è´¥è¾¾åˆ°ä¸Šé™|</span><span class="space"> </span><span>F[&quot;DLQ_QUEUE&quot;]</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>D</span><span class="space"> </span><span>--&gt;|æˆåŠŸ|</span><span class="space"> </span><span>G[&quot;RESULT_QUEUE&quot;]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ä¸“ä¸šæœ¯è¯­é€ŸæŸ¥" tabindex="-1"><a class="header-anchor" href="#ä¸“ä¸šæœ¯è¯­é€ŸæŸ¥"><span>ä¸“ä¸šæœ¯è¯­é€ŸæŸ¥</span></a></h2><ul><li><strong>Broker</strong>ï¼šé‚®å±€/å¿«é€’ä¸­è½¬ç«™ã€‚MQ æœåŠ¡ç«¯å®ä¾‹ï¼Œè´Ÿè´£æ¥æ”¶ã€å­˜å‚¨ã€è½¬å‘æ¶ˆæ¯ã€‚</li><li><strong>Exchange</strong>ï¼šåˆ†æ‹£å°ã€‚äº¤æ¢æœºæ ¹æ®è·¯ç”±è§„åˆ™æŠŠæ¶ˆæ¯æŠ•é€’åˆ°é˜Ÿåˆ—ï¼ˆdirect / fanout / topic / headersï¼‰ã€‚</li><li><strong>Queue</strong>ï¼šæ’é˜Ÿé€šé“/ä»“åº“ã€‚æ¶ˆæ¯æœ€ç»ˆè½åœ°çš„ç¼“å†²åŒºï¼Œæ¶ˆè´¹è€…ä»é˜Ÿåˆ—å–æ¶ˆæ¯å¤„ç†ã€‚</li><li><strong>Binding</strong>ï¼šæŠŠåˆ†æ‹£å°å’Œé€šé“â€œè¿çº¿â€ã€‚äº¤æ¢æœºä¸é˜Ÿåˆ—çš„ç»‘å®šå…³ç³»ï¼Œå®šä¹‰è·¯ç”±é”®åŒ¹é…è§„åˆ™ã€‚</li><li><strong>Routing Key</strong>ï¼šåŒ…è£¹æ ‡ç­¾ã€‚ç”Ÿäº§è€…å‘é€æ—¶æºå¸¦çš„è·¯ç”±é”®ï¼Œç”¨äºåŒ¹é…ç»‘å®šè§„åˆ™ã€‚</li><li><strong>Message</strong>ï¼šåŒ…è£¹ = å†…å®¹ + é¢å•ã€‚æ¶ˆæ¯ä½“åŒ…å« payload ä¸ metadataï¼ˆheadersã€messageId ç­‰ï¼‰ã€‚</li><li><strong>Producer / Consumer</strong>ï¼šå¯„ä»¶äºº / æ”¶ä»¶äººã€‚ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…æ‹‰å–å¹¶å¤„ç†æ¶ˆæ¯ã€‚</li><li><strong>Connection / Channel</strong>ï¼šé«˜é€Ÿå…¬è·¯ / è½¦é“ã€‚Connection æ˜¯ TCP è¿æ¥ï¼›Channel æ˜¯å…¶ä¸Šçš„è½»é‡å¤ç”¨é€šé“ã€‚</li><li><strong>Virtual Host (vhost)</strong>ï¼šåŒä¸€ä»“åº“é‡Œçš„ç‹¬ç«‹å°éš”é—´ã€‚é€»è¾‘éš”ç¦»ç©ºé—´ï¼ŒåŒºåˆ†ä¸åŒä¸šåŠ¡/ç¯å¢ƒã€‚</li><li><strong>ACK / NACK / Reject</strong>ï¼šç­¾æ”¶/æ‹’æ”¶ã€‚ACK ç¡®è®¤æˆåŠŸï¼›NACK/Reject å¤±è´¥å¹¶å†³å®šæ˜¯å¦é‡å›é˜Ÿåˆ—ã€‚</li><li><strong>Prefetch (QoS)</strong>ï¼šä¸€æ¬¡æœ€å¤šæ‹¿å‡ ä»¶åŒ…è£¹ã€‚é™åˆ¶æ¶ˆè´¹è€…æœªç¡®è®¤æ¶ˆæ¯çš„æœ€å¤§æ•°é‡ã€‚</li><li><strong>TTL</strong>ï¼šä¿è´¨æœŸã€‚æ¶ˆæ¯/é˜Ÿåˆ—å­˜æ´»æ—¶é—´ï¼Œåˆ°æœŸåè¿‡æœŸæˆ–è½¬æ­»ä¿¡ã€‚</li><li><strong>DLX / DLQ</strong>ï¼šé—®é¢˜ä»¶å›æ”¶ç«™ã€‚æ­»ä¿¡äº¤æ¢æœºä¸æ­»ä¿¡é˜Ÿåˆ—ï¼Œæ‰¿æ¥å¤±è´¥æˆ–è¿‡æœŸæ¶ˆæ¯ã€‚</li><li><strong>Durable / Persistent</strong>ï¼šæ–­ç”µä¹Ÿä¸ä¸¢è®°å½•ã€‚é˜Ÿåˆ—/æ¶ˆæ¯æŒä¹…åŒ–ï¼ŒBroker é‡å¯åä»å¯æ¢å¤ã€‚</li><li><strong>Publisher Confirm / Return</strong>ï¼šå¿«é€’å‘ä»¶å›æ‰§/é€€ä»¶ã€‚å‘å¸ƒç¡®è®¤ä¸é€€å›æœºåˆ¶ï¼Œä¿éšœæŠ•é€’å¯é æ€§ã€‚</li><li><strong>Idempotencyï¼ˆå¹‚ç­‰ï¼‰</strong>ï¼šé‡å¤ç‚¹å‡»ä¹Ÿåªå¤„ç†ä¸€æ¬¡ã€‚åŒä¸€æ¶ˆæ¯é‡å¤æ¶ˆè´¹ä¸äº§ç”Ÿå‰¯ä½œç”¨ã€‚</li></ul><h3 id="ä¸¾ä¸ªğŸŒ°" tabindex="-1"><a class="header-anchor" href="#ä¸¾ä¸ªğŸŒ°"><span>ä¸¾ä¸ªğŸŒ°</span></a></h3><table><thead><tr><th>æœ¯è¯­</th><th>ä¸šåŠ¡ä¾‹å­</th></tr></thead><tbody><tr><td>Broker</td><td>RabbitMQ æœåŠ¡æœ¬ä½“ï¼ˆè¿ç»´éƒ¨ç½²çš„ä¸€å¥— MQ å®ä¾‹ï¼‰</td></tr><tr><td>Exchange</td><td><code>TASK_EXCHANGE</code>ï¼Œè´Ÿè´£æŠŠâ€œä»»åŠ¡æ¶ˆæ¯â€åˆ†å‘åˆ°ä¸åŒé˜Ÿåˆ—</td></tr><tr><td>Queue</td><td><code>TASK_QUEUE</code>ï¼Œå­˜æ”¾å¾…å¤„ç†çš„ä»»åŠ¡</td></tr><tr><td>Routing Key</td><td><code>task.process</code>ï¼Œç”¨äºæŠŠä»»åŠ¡æ¶ˆæ¯è·¯ç”±åˆ°ä»»åŠ¡é˜Ÿåˆ—</td></tr><tr><td>Producer</td><td>ä¸šåŠ¡æ¥å£åœ¨ä¸‹å•åå‘é€â€œç”Ÿæˆä»»åŠ¡â€çš„æ¶ˆæ¯</td></tr><tr><td>Consumer</td><td>åå°ä»»åŠ¡å¤„ç†æœåŠ¡æ¶ˆè´¹æ¶ˆæ¯å¹¶æ‰§è¡Œå¤„ç†é€»è¾‘</td></tr><tr><td>ACK</td><td>ä»»åŠ¡å¤„ç†å®Œæˆåç¡®è®¤ï¼Œæ¶ˆæ¯ä»é˜Ÿåˆ—åˆ é™¤</td></tr><tr><td>NACK/Reject</td><td>å¤„ç†å¤±è´¥æ—¶æ‹’æ”¶ï¼Œè®©æ¶ˆæ¯èµ°é‡è¯•æˆ–æ­»ä¿¡</td></tr><tr><td>TTL</td><td>å¤±è´¥æ¶ˆæ¯å…ˆè¿›å…¥é‡è¯•é˜Ÿåˆ—ï¼Œ15 ç§’åå›æµä¸»é˜Ÿåˆ—</td></tr><tr><td>DLQ</td><td>é‡è¯•è¶…è¿‡ä¸Šé™çš„æ¶ˆæ¯è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ç­‰å¾…äººå·¥å¤„ç†</td></tr><tr><td>Prefetch</td><td>æ¶ˆè´¹è€…ä¸€æ¬¡åªæ‹‰ 1 æ¡ï¼Œé¿å…â€œæŠ“å¤ªå¤šå¤„ç†ä¸è¿‡æ¥â€</td></tr><tr><td>Idempotency</td><td>ä»»åŠ¡æ¶ˆæ¯é‡å¤æŠ•é€’æ—¶ï¼Œä¸šåŠ¡åªç”Ÿæˆä¸€æ¬¡ç»“æœ</td></tr></tbody></table><h2 id="å…¨å±€åŸºç¡€é…ç½®-json-åºåˆ—åŒ–ä¸ç»Ÿä¸€ç›‘å¬å™¨" tabindex="-1"><a class="header-anchor" href="#å…¨å±€åŸºç¡€é…ç½®-json-åºåˆ—åŒ–ä¸ç»Ÿä¸€ç›‘å¬å™¨"><span>å…¨å±€åŸºç¡€é…ç½®ï¼šJSON åºåˆ—åŒ–ä¸ç»Ÿä¸€ç›‘å¬å™¨</span></a></h2><p>ä½¿ç”¨ Jackson ä½œä¸ºå…¨å±€æ¶ˆæ¯è½¬æ¢å™¨ï¼Œé¿å… Java åŸç”Ÿååºåˆ—åŒ–å¸¦æ¥çš„å®‰å…¨é£é™©ï¼ŒåŒæ—¶ç»Ÿä¸€åºåˆ—åŒ–ç­–ç•¥ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Configuration</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span class="space"> </span><span style="color:#C678DD;">class</span><span class="space"> </span><span style="color:#E5C07B;">MqGlobalConfig</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Bean</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">public</span><span class="space"> </span><span style="color:#E5C07B;">MessageConverter</span><span class="space"> </span><span style="color:#61AFEF;">messageConverter</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">ObjectMapper</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">objectMapper</span><span style="color:#ABB2BF;">)</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#C678DD;">new</span><span class="space"> </span><span style="color:#61AFEF;">Jackson2JsonMessageConverter</span><span style="color:#ABB2BF;">(objectMapper);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Bean</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">public</span><span class="space"> </span><span style="color:#E5C07B;">RabbitTemplate</span><span class="space"> </span><span style="color:#61AFEF;">rabbitTemplate</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">ConnectionFactory</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">cf</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">MessageConverter</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">converter</span><span style="color:#ABB2BF;">)</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">RabbitTemplate</span><span class="space"> </span><span style="color:#E06C75;">template</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#C678DD;">new</span><span class="space"> </span><span style="color:#61AFEF;">RabbitTemplate</span><span style="color:#ABB2BF;">(cf);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">template</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setMessageConverter</span><span style="color:#ABB2BF;">(converter);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#ABB2BF;">template;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Bean</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">public</span><span class="space"> </span><span style="color:#E5C07B;">SimpleRabbitListenerContainerFactory</span><span class="space"> </span><span style="color:#61AFEF;">listenerContainerFactory</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">ConnectionFactory</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">cf</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#E5C07B;">MessageConverter</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">converter</span><span style="color:#ABB2BF;">)</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">SimpleRabbitListenerContainerFactory</span><span class="space"> </span><span style="color:#E06C75;">factory</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#C678DD;">new</span><span class="space"> </span><span style="color:#61AFEF;">SimpleRabbitListenerContainerFactory</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">factory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setConnectionFactory</span><span style="color:#ABB2BF;">(cf);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">factory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setMessageConverter</span><span style="color:#ABB2BF;">(converter);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#ABB2BF;">factory;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="åœºæ™¯ä¸€-å¼‚æ­¥ä»»åŠ¡æŠ•é€’é“¾è·¯-ç”Ÿäº§è€…" tabindex="-1"><a class="header-anchor" href="#åœºæ™¯ä¸€-å¼‚æ­¥ä»»åŠ¡æŠ•é€’é“¾è·¯-ç”Ÿäº§è€…"><span>åœºæ™¯ä¸€ï¼šå¼‚æ­¥ä»»åŠ¡æŠ•é€’é“¾è·¯ï¼ˆç”Ÿäº§è€…ï¼‰</span></a></h2><p>ç”Ÿäº§è€…åªè´Ÿè´£å°†ä»»åŠ¡æŠ•é€’åˆ°äº¤æ¢æœºï¼Œç”±è·¯ç”±é”®å†³å®šè¿›å…¥å“ªä¸ªé˜Ÿåˆ—ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Component</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span class="space"> </span><span style="color:#C678DD;">class</span><span class="space"> </span><span style="color:#E5C07B;">TaskProducer</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#C678DD;">final</span><span class="space"> </span><span style="color:#E5C07B;">RabbitTemplate</span><span class="space"> </span><span style="color:#E06C75;">rabbitTemplate</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Value</span><span style="color:#E06C75;">(</span><span style="color:#98C379;">&quot;${app.mq.task.exchange:TASK_EXCHANGE}&quot;</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">exchange</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Value</span><span style="color:#E06C75;">(</span><span style="color:#98C379;">&quot;${app.mq.task.routing-key:task.process}&quot;</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">routingKey</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">public</span><span class="space"> </span><span style="color:#C678DD;">void</span><span class="space"> </span><span style="color:#61AFEF;">send</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">TaskPayload</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">payload</span><span style="color:#ABB2BF;">)</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">rabbitTemplate</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">convertAndSend</span><span style="color:#ABB2BF;">(exchange,</span><span class="space"> </span><span style="color:#ABB2BF;">routingKey,</span><span class="space"> </span><span style="color:#ABB2BF;">payload);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="åœºæ™¯äºŒ-ç»“æœå›ä¼ å¤„ç†é“¾è·¯-æ¶ˆè´¹è€…" tabindex="-1"><a class="header-anchor" href="#åœºæ™¯äºŒ-ç»“æœå›ä¼ å¤„ç†é“¾è·¯-æ¶ˆè´¹è€…"><span>åœºæ™¯äºŒï¼šç»“æœå›ä¼ å¤„ç†é“¾è·¯ï¼ˆæ¶ˆè´¹è€…ï¼‰</span></a></h2><p>æ¶ˆè´¹è€…ä½¿ç”¨ <strong>æ‰‹åŠ¨ ACK</strong>ï¼Œå¹¶åœ¨å¼‚å¸¸æ—¶è¿›è¡Œé‡è¯•æˆ–æ­»ä¿¡å¤„ç†ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Component</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span class="space"> </span><span style="color:#C678DD;">class</span><span class="space"> </span><span style="color:#E5C07B;">TaskListener</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">RabbitListener</span><span style="color:#E06C75;">(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#D19A66;">bindings</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">QueueBinding</span><span style="color:#E06C75;">(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#D19A66;">value</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Queue</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">value</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#98C379;">&quot;${app.mq.task.queue:TASK_QUEUE}&quot;</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#D19A66;">durable</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#98C379;">&quot;true&quot;</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#D19A66;">exchange</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Exchange</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">value</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#98C379;">&quot;${app.mq.task.exchange:TASK_EXCHANGE}&quot;</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#D19A66;">key</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#98C379;">&quot;${app.mq.task.routing-key:task.process}&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#D19A66;">ackMode</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#98C379;">&quot;MANUAL&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">public</span><span class="space"> </span><span style="color:#C678DD;">void</span><span class="space"> </span><span style="color:#61AFEF;">onMessage</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">TaskPayload</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">payload</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#E5C07B;">Message</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">msg</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#E5C07B;">Channel</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">channel</span><span style="color:#ABB2BF;">)</span><span class="space"> </span><span style="color:#C678DD;">throws</span><span class="space"> </span><span style="color:#E5C07B;">IOException</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">long</span><span class="space"> </span><span style="color:#E06C75;">deliveryTag</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#E5C07B;">msg</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getMessageProperties</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">getDeliveryTag</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">try</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">//</span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">æ ¸å¿ƒå¤„ç†é€»è¾‘ï¼ˆè„±æ•ï¼‰</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#61AFEF;">handle</span><span style="color:#ABB2BF;">(payload);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">channel</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">basicAck</span><span style="color:#ABB2BF;">(deliveryTag,</span><span class="space"> </span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span><span class="space"> </span><span style="color:#C678DD;">catch</span><span class="space"> </span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Exception</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">e</span><span style="color:#ABB2BF;">)</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">//</span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">å¤±è´¥æ—¶èµ°é‡è¯•/æ­»ä¿¡</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#61AFEF;">handleRetryOrDlq</span><span style="color:#ABB2BF;">(payload,</span><span class="space"> </span><span style="color:#ABB2BF;">msg,</span><span class="space"> </span><span style="color:#ABB2BF;">channel,</span><span class="space"> </span><span style="color:#ABB2BF;">deliveryTag);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="å¯é æ€§è®¾è®¡-æ‰‹åŠ¨-ack-é™æ¬¡é‡è¯•" tabindex="-1"><a class="header-anchor" href="#å¯é æ€§è®¾è®¡-æ‰‹åŠ¨-ack-é™æ¬¡é‡è¯•"><span>å¯é æ€§è®¾è®¡ï¼šæ‰‹åŠ¨ ACK + é™æ¬¡é‡è¯•</span></a></h2><p>æœ¬æ–‡ç¤ºä¾‹é‡‡ç”¨ <strong>header è®¡æ•°</strong>æ–¹å¼è®°å½•é‡è¯•æ¬¡æ•°ï¼Œé¿å…æ— é™é‡è¯•å¸¦æ¥çš„é›ªå´©ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">public</span><span class="space"> </span><span style="color:#C678DD;">class</span><span class="space"> </span><span style="color:#E5C07B;">MqRetryUtil</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#C678DD;">static</span><span class="space"> </span><span style="color:#C678DD;">final</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">X_RETRY_COUNT</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#98C379;">&quot;x-retry-count&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">public</span><span class="space"> </span><span style="color:#C678DD;">static</span><span class="space"> </span><span style="color:#C678DD;">boolean</span><span class="space"> </span><span style="color:#61AFEF;">isRetryExceeded</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Message</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">msg</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#C678DD;">int</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">maxRetry</span><span style="color:#ABB2BF;">)</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">Integer</span><span class="space"> </span><span style="color:#E06C75;">retry</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#ABB2BF;">(Integer)</span><span class="space"> </span><span style="color:#E5C07B;">msg</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getMessageProperties</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">getHeaders</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">get</span><span style="color:#ABB2BF;">(X_RETRY_COUNT);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#ABB2BF;">(retry</span><span class="space"> </span><span style="color:#56B6C2;">==</span><span class="space"> </span><span style="color:#D19A66;">null</span><span class="space"> </span><span style="color:#C678DD;">?</span><span class="space"> </span><span style="color:#D19A66;">0</span><span class="space"> </span><span style="color:#C678DD;">:</span><span class="space"> </span><span style="color:#ABB2BF;">retry)</span><span class="space"> </span><span style="color:#56B6C2;">&gt;=</span><span class="space"> </span><span style="color:#ABB2BF;">maxRetry;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">public</span><span class="space"> </span><span style="color:#C678DD;">static</span><span class="space"> </span><span style="color:#C678DD;">void</span><span class="space"> </span><span style="color:#61AFEF;">republishWithRetry</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Channel</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">channel</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">long</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">deliveryTag</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">byte</span><span style="color:#ABB2BF;">[]</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">body</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">routingKey</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">MessageProperties</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">props</span><span style="color:#ABB2BF;">)</span><span class="space"> </span><span style="color:#C678DD;">throws</span><span class="space"> </span><span style="color:#E5C07B;">IOException</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">channel</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">basicNack</span><span style="color:#ABB2BF;">(deliveryTag,</span><span class="space"> </span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">Map</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#E5C07B;">Object</span><span style="color:#ABB2BF;">&gt;</span><span class="space"> </span><span style="color:#E06C75;">headers</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#C678DD;">new</span><span class="space"> </span><span style="color:#E5C07B;">HashMap</span><span style="color:#ABB2BF;">&lt;&gt;(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">props</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getHeaders</span><span style="color:#ABB2BF;">()</span><span class="space"> </span><span style="color:#56B6C2;">==</span><span class="space"> </span><span style="color:#D19A66;">null</span><span class="space"> </span><span style="color:#C678DD;">?</span><span class="space"> </span><span style="color:#E5C07B;">Map</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">of</span><span style="color:#ABB2BF;">()</span><span class="space"> </span><span style="color:#C678DD;">:</span><span class="space"> </span><span style="color:#E5C07B;">props</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getHeaders</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">int</span><span class="space"> </span><span style="color:#E06C75;">nextRetry</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#E5C07B;">headers</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getOrDefault</span><span style="color:#ABB2BF;">(X_RETRY_COUNT,</span><span class="space"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">)</span><span class="space"> </span><span style="color:#56B6C2;">+</span><span class="space"> </span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">headers</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">put</span><span style="color:#ABB2BF;">(X_RETRY_COUNT,</span><span class="space"> </span><span style="color:#ABB2BF;">nextRetry);</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">AMQP</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">BasicProperties</span><span class="space"> </span><span style="color:#E06C75;">newProps</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#C678DD;">new</span><span class="space"> </span><span style="color:#ABB2BF;">AMQP.</span><span style="color:#E5C07B;">BasicProperties</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">Builder</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">headers</span><span style="color:#ABB2BF;">(headers)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">build</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">channel</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">basicPublish</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;&quot;</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#ABB2BF;">routingKey,</span><span class="space"> </span><span style="color:#ABB2BF;">newProps,</span><span class="space"> </span><span style="color:#ABB2BF;">body);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="å»¶è¿Ÿä¸å¤±è´¥å¤„ç†-ttl-dlx-æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#å»¶è¿Ÿä¸å¤±è´¥å¤„ç†-ttl-dlx-æ¨¡å¼"><span>å»¶è¿Ÿä¸å¤±è´¥å¤„ç†ï¼šTTL + DLX æ¨¡å¼</span></a></h2><p>æœ¬æ–‡ç¤ºä¾‹é‡‡ç”¨â€œ<strong>TTL å»¶è¿Ÿé‡è¯•é˜Ÿåˆ— + DLX å›æµ</strong>â€æ¨¡å¼å®ç°ç®€å•å¯é çš„é‡è¯•é€»è¾‘ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Bean</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span class="space"> </span><span style="color:#E5C07B;">Queue</span><span class="space"> </span><span style="color:#61AFEF;">retryQueue</span><span style="color:#E06C75;">()</span><span class="space"> </span><span style="color:#E06C75;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#E5C07B;">QueueBuilder</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">durable</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;TASK_RETRY_QUEUE&quot;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">withArgument</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;x-message-ttl&quot;</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#D19A66;">15000</span><span style="color:#ABB2BF;">)</span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">//</span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">15</span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">ç§’åè½¬å›ä¸»é˜Ÿåˆ—</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">withArgument</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;x-dead-letter-exchange&quot;</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#98C379;">&quot;TASK_EXCHANGE&quot;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">withArgument</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;x-dead-letter-routing-key&quot;</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#98C379;">&quot;task.process&quot;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">build</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Bean</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span class="space"> </span><span style="color:#E5C07B;">Queue</span><span class="space"> </span><span style="color:#61AFEF;">dlqQueue</span><span style="color:#E06C75;">()</span><span class="space"> </span><span style="color:#E06C75;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#E5C07B;">QueueBuilder</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">durable</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;TASK_DLQ_QUEUE&quot;</span><span style="color:#ABB2BF;">).</span><span style="color:#61AFEF;">build</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="å¹¶å‘ä¸æ€§èƒ½è°ƒä¼˜-prefetch-å¹¶å‘èŒƒå›´" tabindex="-1"><a class="header-anchor" href="#å¹¶å‘ä¸æ€§èƒ½è°ƒä¼˜-prefetch-å¹¶å‘èŒƒå›´"><span>å¹¶å‘ä¸æ€§èƒ½è°ƒä¼˜ï¼šprefetch + å¹¶å‘èŒƒå›´</span></a></h2><p>ä¸ºé¿å…æ¶ˆè´¹è€…ä¸€æ¬¡æ€§æŠ“å–è¿‡å¤šæ¶ˆæ¯ï¼Œä½¿ç”¨ <strong>prefetch = 1</strong>ï¼Œå¹¶æ”¯æŒâ€œæœ€å°-æœ€å¤§â€å¹¶å‘é…ç½®ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Bean</span><span style="color:#E06C75;">(</span><span style="color:#98C379;">&quot;taskListenerFactory&quot;</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span class="space"> </span><span style="color:#E5C07B;">SimpleRabbitListenerContainerFactory</span><span class="space"> </span><span style="color:#61AFEF;">taskListenerFactory</span><span style="color:#E06C75;">(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">ConnectionFactory</span><span class="space"> </span><span style="color:#E06C75;">cf</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">MessageConverter</span><span class="space"> </span><span style="color:#E06C75;">converter</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">ThreadPoolTaskExecutor</span><span class="space"> </span><span style="color:#E06C75;">executor</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Value</span><span style="color:#E06C75;">(</span><span style="color:#98C379;">&quot;${app.mq.task.prefetch:1}&quot;</span><span style="color:#E06C75;">)</span><span class="space"> </span><span style="color:#C678DD;">int</span><span class="space"> </span><span style="color:#E06C75;">prefetch</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Value</span><span style="color:#E06C75;">(</span><span style="color:#98C379;">&quot;${app.mq.task.concurrency:1-3}&quot;</span><span style="color:#E06C75;">)</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">concurrency)</span><span class="space"> </span><span style="color:#E06C75;">{</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">SimpleRabbitListenerContainerFactory</span><span class="space"> </span><span style="color:#E06C75;">factory</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#C678DD;">new</span><span class="space"> </span><span style="color:#61AFEF;">SimpleRabbitListenerContainerFactory</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">factory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setConnectionFactory</span><span style="color:#ABB2BF;">(cf);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">factory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setPrefetchCount</span><span style="color:#ABB2BF;">(prefetch);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">factory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setMessageConverter</span><span style="color:#ABB2BF;">(converter);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">factory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setAcknowledgeMode</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">AcknowledgeMode</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">MANUAL</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">factory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setTaskExecutor</span><span style="color:#ABB2BF;">(executor);</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">int</span><span style="color:#E06C75;">[]</span><span class="space"> </span><span style="color:#E06C75;">range</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#61AFEF;">parseConcurrency</span><span style="color:#E06C75;">(concurrency</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#D19A66;">3</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">factory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setConcurrentConsumers</span><span style="color:#ABB2BF;">(range[</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">]);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">factory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setMaxConcurrentConsumers</span><span style="color:#ABB2BF;">(range[</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">]);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#E06C75;">factory</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="æ—¥å¿—ä¸å¯è§‚æµ‹æ€§" tabindex="-1"><a class="header-anchor" href="#æ—¥å¿—ä¸å¯è§‚æµ‹æ€§"><span>æ—¥å¿—ä¸å¯è§‚æµ‹æ€§</span></a></h2><p>å…³é”®æ—¥å¿—å»ºè®®è‡³å°‘åŒ…å«ï¼š</p><ul><li><code>messageId / deliveryTag</code></li><li><code>exchange / routingKey</code></li><li><code>taskId</code>ï¼ˆä¸šåŠ¡è„±æ• IDï¼‰</li><li><code>retryCount</code></li></ul><p>è¿™æ ·èƒ½å¿«é€Ÿå®šä½æ¶ˆæ¯è·¯å¾„ä¸å¤±è´¥åŸå› ã€‚</p><h2 id="é…ç½®ç¤ºä¾‹-è„±æ•ç‰ˆ" tabindex="-1"><a class="header-anchor" href="#é…ç½®ç¤ºä¾‹-è„±æ•ç‰ˆ"><span>é…ç½®ç¤ºä¾‹ï¼ˆè„±æ•ç‰ˆï¼‰</span></a></h2><div class="language-yaml line-numbers-mode" data-ext="yaml" data-title="yaml"><button class="copy" title="å¤åˆ¶ä»£ç " data-copied="å·²å¤åˆ¶"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#E06C75;">app</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">mq</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">task</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">exchange</span><span style="color:#ABB2BF;">:</span><span class="space"> </span><span style="color:#98C379;">TASK_EXCHANGE</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">queue</span><span style="color:#ABB2BF;">:</span><span class="space"> </span><span style="color:#98C379;">TASK_QUEUE</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">routing-key</span><span style="color:#ABB2BF;">:</span><span class="space"> </span><span style="color:#98C379;">task.process</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">prefetch</span><span style="color:#ABB2BF;">:</span><span class="space"> </span><span style="color:#D19A66;">1</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">concurrency</span><span style="color:#ABB2BF;">:</span><span class="space"> </span><span style="color:#98C379;">1-3</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">max-retry-count</span><span style="color:#ABB2BF;">:</span><span class="space"> </span><span style="color:#D19A66;">3</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">listener-enabled</span><span style="color:#ABB2BF;">:</span><span class="space"> </span><span style="color:#D19A66;">true</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="å¸¸è§é—®é¢˜ä¸è¸©å‘æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#å¸¸è§é—®é¢˜ä¸è¸©å‘æ€»ç»“"><span>å¸¸è§é—®é¢˜ä¸è¸©å‘æ€»ç»“</span></a></h2><ul><li>é‡è¯•å¿…é¡»é™æ¬¡ï¼Œå¦åˆ™ä¼šé€ æˆæ¶ˆæ¯é£æš´ã€‚</li><li>TTL é‡è¯•é€‚åˆç®€å•å»¶è¿Ÿï¼Œå¤æ‚å»¶è¿Ÿå¯ç”¨å»¶è¿Ÿäº¤æ¢æœºæˆ–è°ƒåº¦æœåŠ¡ã€‚</li><li>ä¸€æ—¦ä½¿ç”¨æ‰‹åŠ¨ ACKï¼ŒåŠ¡å¿…ç¡®ä¿å¼‚å¸¸è·¯å¾„ä¹Ÿèƒ½æ˜ç¡® ACK/NACKã€‚</li><li>æ¶ˆè´¹è€…å¹¶å‘ä¸ prefetch å¿…é¡»åŒ¹é…ï¼Œå¦åˆ™å®¹æ˜“å‡ºç°â€œå‡å¹¶å‘â€ã€‚</li></ul></div><!----><!----><!----></div></main><footer class="vp-doc-footer" data-v-48823583 data-v-9110afba><!--[--><!--]--><!----><div class="contributors" aria-label="Contributors" data-v-9110afba><span class="contributors-label" data-v-9110afba>è´¡çŒ®è€…: </span><span class="contributors-info" data-v-9110afba><!--[--><!--[--><span class="contributor" data-v-9110afba>é‡‘é€¸éœ„</span><!----><!--]--><!--]--></span></div><nav class="prev-next" data-v-9110afba><div class="pager" data-v-9110afba><a class="vp-link no-icon link pager-link prev" href="/article/gjl1230v/" data-v-9110afba data-v-8fd51d7e><!--[--><span class="desc" data-v-9110afba>ä¸Šä¸€é¡µ</span><span class="title" data-v-9110afba>ä» Java è§†è§’å»ç†è§£ TS å’Œ React</span><!--]--><!----></a></div><div class="pager" data-v-9110afba><a class="vp-link no-icon link pager-link next" href="/article/x7uyj2fp/" data-v-9110afba data-v-8fd51d7e><!--[--><span class="desc" data-v-9110afba>ä¸‹ä¸€é¡µ</span><span class="title" data-v-9110afba>åœ°å›¾è·¨åŒºé«˜äº®å’Œç‚¹å‡»é—®é¢˜ä¿®å¤è®°å½•</span><!--]--><!----></a></div></nav></footer><!----><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!--]--><button type="button" class="vp-back-to-top" aria-label="back to top" data-v-3bf3774b style="display:none;" data-v-22e14b5d><span class="percent" data-allow-mismatch data-v-22e14b5d>0%</span><span class="show icon vpi-back-to-top" data-v-22e14b5d></span><svg aria-hidden="true" data-v-22e14b5d><circle cx="50%" cy="50%" data-allow-mismatch style="stroke-dasharray:calc(0% - 12.566370614359172px) calc(314.1592653589793% - 12.566370614359172px);" data-v-22e14b5d></circle></svg></button><footer class="vp-footer" vp-footer data-v-3bf3774b data-v-232bff92><!--[--><div class="container" data-v-232bff92><p class="message" data-v-232bff92>â€”â€”â€”â€”â€”â€”â€”â€”åˆ°åº•å•¦!â€”â€”â€”â€”â€”â€”â€”â€”</p><p class="copyright" data-v-232bff92>copyleft Â© 2025 Exiao</p></div><!--]--></footer><!--[--><!--]--><!--]--></div><!----><!--]--><!--[--><!--]--><!--]--></div><script type="module" src="/assets/app-pBrtxVLr.js" defer></script></body></html>