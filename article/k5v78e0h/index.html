<!doctype html><html lang="zh-CN"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="generator" content="VuePress 2.0.0-rc.20" /><meta name="theme" content="VuePress Theme Plume " /><script id="check-mac-os">document.documentElement.classList.toggle('mac', /Mac|iPhone|iPod|iPad/i.test(navigator.platform))</script><meta property="og:url" content="https://callmeexiao.baby/article/k5v78e0h/"><meta property="og:site_name" content="Exiao's Blog"><meta property="og:title" content="工作扫盲之PostgreSQL"><meta property="og:description" content="1. 引言 作为一名后端开发者，在日常工作中我们经常接触MySQL数据库，但随着业务复杂度的提升，我开始接触到PostgreSQL这个"世界上最先进的开源关系型数据库"。初次使用PostgreSQL，我被它强大的功能特性深深震撼。 为什么选择PostgreSQL？ 相比MySQL，PostgreSQL在以下方面表现出色： 🎯 更丰富的数据类型：原生支..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2025-09-23T13:57:05.000Z"><meta property="article:modified_time" content="2025-09-23T13:57:05.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"工作扫盲之PostgreSQL","image":[""],"dateModified":"2025-09-23T13:57:05.000Z","author":[]}</script><link rel="icon" type="image/png" href="https://theme-plume.vuejs.press/favicon-32x32.png"><title>工作扫盲之PostgreSQL | Exiao's Blog</title><meta name="description" content="1. 引言 作为一名后端开发者，在日常工作中我们经常接触MySQL数据库，但随着业务复杂度的提升，我开始接触到PostgreSQL这个"世界上最先进的开源关系型数据库"。初次使用PostgreSQL，我被它强大的功能特性深深震撼。 为什么选择PostgreSQL？ 相比MySQL，PostgreSQL在以下方面表现出色： 🎯 更丰富的数据类型：原生支..."><link rel="preload" href="/assets/style-BqZcJpOC.css" as="style"><link rel="stylesheet" href="/assets/style-BqZcJpOC.css"><link rel="modulepreload" href="/assets/app-DqRurxSm.js"><link rel="modulepreload" href="/assets/index.html-D8-YHzo7.js"></head><body><div id="app"><!--[--><!--[--><div class="theme-plume vp-layout" vp-container data-v-17d2f8af><!--[--><!--[--><!--]--><!--[--><span tabindex="-1" data-v-92e85012></span><a href="#VPContent" class="vp-skip-link visually-hidden" data-v-92e85012> Skip to content </a><!--]--><!----><header class="vp-nav" data-v-17d2f8af data-v-2df5986a><div class="vp-navbar" vp-navbar data-v-2df5986a data-v-eee7df0d><div class="wrapper" data-v-eee7df0d><div class="container" data-v-eee7df0d><div class="title" data-v-eee7df0d><div class="vp-navbar-title" data-v-eee7df0d data-v-3b228add><a class="vp-link no-icon link title" href="/" data-v-3b228add data-v-f64f8f73><!--[--><!--[--><!--]--><!--[--><!--[--><!--[--><img class="vp-image dark logo" style="" src="https://theme-plume.vuejs.press/plume.png" alt data-v-4b758291><!--]--><!--[--><img class="vp-image light logo" style="" src="https://theme-plume.vuejs.press/plume.png" alt data-v-4b758291><!--]--><!--]--><!--]--><span data-v-3b228add>Exiao&#39;s Blog</span><!--[--><!--]--><!--]--><!----></a></div></div><div class="content" data-v-eee7df0d><div class="content-body" data-v-eee7df0d><!--[--><!--]--><div class="vp-navbar-search search" data-v-eee7df0d><div class="search-wrapper" data-v-9b6231cb><!----><div id="local-search" data-v-9b6231cb><button type="button" class="mini-search mini-search-button" aria-label="搜索文档" data-v-9b6231cb><span class="mini-search-button-container"><span class="mini-search-search-icon vpi-mini-search" aria-label="search icon"></span><span class="mini-search-button-placeholder">搜索文档</span></span><span class="mini-search-button-keys"><kbd class="mini-search-button-key"></kbd><kbd class="mini-search-button-key">K</kbd></span></button></div></div></div><nav aria-labelledby="main-nav-aria-label" class="vp-navbar-menu menu" data-v-eee7df0d data-v-66446e56><span id="main-nav-aria-label" class="visually-hidden" data-v-66446e56>Main Navigation</span><!--[--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/" tabindex="0" data-v-66446e56 data-v-342672b3 data-v-f64f8f73><!--[--><!----><span data-v-342672b3>首页</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/blog/" tabindex="0" data-v-66446e56 data-v-342672b3 data-v-f64f8f73><!--[--><!----><span data-v-342672b3>博客</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/blog/tags/" tabindex="0" data-v-66446e56 data-v-342672b3 data-v-f64f8f73><!--[--><!----><span data-v-342672b3>标签</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/blog/archives/" tabindex="0" data-v-66446e56 data-v-342672b3 data-v-f64f8f73><!--[--><!----><span data-v-342672b3>归档</span><!--]--><!----></a><!--]--><!--[--><div class="vp-flyout vp-navbar-menu-group" data-v-66446e56 data-v-dca43752><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-dca43752><span class="text" data-v-dca43752><!----><!----><span data-v-dca43752>笔记</span><span class="vpi-chevron-down text-icon" data-v-dca43752></span></span></button><div class="menu" data-v-dca43752><div class="vp-menu" data-v-dca43752 data-v-f8967b1c><div class="items" data-v-f8967b1c><!--[--><!--[--><div class="vp-menu-link" data-v-f8967b1c data-v-0fda2c07><a class="vp-link no-icon link" href="/demo/" data-v-0fda2c07 data-v-f64f8f73><!--[--><!----> 示例<!--]--><!----></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!----><!----><div class="vp-social-links vp-navbar-social-links social-links" data-v-eee7df0d data-v-ecec0c8a data-v-dd3069e9><!--[--><a class="vp-social-link no-icon" href="https://github.com/callMeExiao/callMeExiao.github.io" aria-label="github" target="_blank" rel="noopener" data-v-dd3069e9 data-v-0cddb312><span class="vpi-social-github" /></a><!--]--></div><div class="vp-flyout vp-navbar-extra extra" data-v-eee7df0d data-v-bf4de098 data-v-dca43752><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-dca43752><span class="vpi-more-horizontal icon" data-v-dca43752></span></button><div class="menu" data-v-dca43752><div class="vp-menu" data-v-dca43752 data-v-f8967b1c><!----><!--[--><!--[--><!----><!----><div class="group" data-v-bf4de098><div class="item social-links" data-v-bf4de098><div class="vp-social-links social-links-list" data-v-bf4de098 data-v-dd3069e9><!--[--><a class="vp-social-link no-icon" href="https://github.com/callMeExiao/callMeExiao.github.io" aria-label="github" target="_blank" rel="noopener" data-v-dd3069e9 data-v-0cddb312><span class="vpi-social-github" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="vp-navbar-hamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="nav-screen" data-v-eee7df0d data-v-0ebe48cd><span class="container" data-v-0ebe48cd><span class="top" data-v-0ebe48cd></span><span class="middle" data-v-0ebe48cd></span><span class="bottom" data-v-0ebe48cd></span></span></button></div></div></div></div><div class="divider" data-v-eee7df0d><div class="divider-line" data-v-eee7df0d></div></div></div><!----></header><div class="vp-local-nav fixed reached-top is-blog" data-v-17d2f8af data-v-e9548b20><button class="hidden menu" disabled aria-expanded="false" aria-controls="SidebarNav" data-v-e9548b20><span class="vpi-align-left menu-icon" data-v-e9548b20></span><span class="menu-text" data-v-e9548b20>Menu</span></button><div class="vp-local-nav-outline-dropdown" style="--vp-vh:0px;" data-v-e9548b20 data-v-eceef591><button data-v-eceef591>返回顶部</button><!----></div></div><!----><!--[--><div id="VPContent" vp-content class="vp-content" data-v-17d2f8af data-v-5a4a90a8><div class="vp-doc-container is-blog" data-v-5a4a90a8 data-v-a703df67><!--[--><!--]--><div class="container" data-v-a703df67><!----><div class="content" data-v-a703df67><div class="content-container" data-v-a703df67><!--[--><!--]--><main class="main" data-v-a703df67><nav class="vp-breadcrumb" data-v-a703df67 data-v-c9336da5><ol vocab="https://schema.org/" typeof="BreadcrumbList" data-v-c9336da5><!--[--><li property="itemListElement" typeof="ListItem" data-v-c9336da5><a class="vp-link no-icon link breadcrumb" href="/" property="item" typeof="WebPage" data-v-c9336da5 data-v-f64f8f73><!--[-->首页<!--]--><!----></a><span class="vpi-chevron-right" data-v-c9336da5></span><meta property="name" content="首页" data-v-c9336da5><meta property="position" content="1" data-v-c9336da5></li><li property="itemListElement" typeof="ListItem" data-v-c9336da5><a class="vp-link no-icon link breadcrumb" href="/blog/" property="item" typeof="WebPage" data-v-c9336da5 data-v-f64f8f73><!--[-->博客<!--]--><!----></a><span class="vpi-chevron-right" data-v-c9336da5></span><meta property="name" content="博客" data-v-c9336da5><meta property="position" content="2" data-v-c9336da5></li><li property="itemListElement" typeof="ListItem" data-v-c9336da5><a class="vp-link no-icon link breadcrumb" href="/blog/categories/?id=543517" property="item" typeof="WebPage" data-v-c9336da5 data-v-f64f8f73><!--[-->后端技术<!--]--><!----></a><span class="vpi-chevron-right" data-v-c9336da5></span><meta property="name" content="后端技术" data-v-c9336da5><meta property="position" content="3" data-v-c9336da5></li><li property="itemListElement" typeof="ListItem" data-v-c9336da5><a class="vp-link no-icon link breadcrumb current" href="/article/k5v78e0h/" property="item" typeof="WebPage" data-v-c9336da5 data-v-f64f8f73><!--[-->工作扫盲之PostgreSQL<!--]--><!----></a><!----><meta property="name" content="工作扫盲之PostgreSQL" data-v-c9336da5><meta property="position" content="4" data-v-c9336da5></li><!--]--></ol></nav><!--[--><h1 class="vp-doc-title page-title" data-v-a3ab3236>工作扫盲之PostgreSQL <!----></h1><div class="vp-doc-meta" data-v-a3ab3236><p class="reading-time" data-v-a3ab3236><span class="vpi-books icon" data-v-a3ab3236></span><span data-v-a3ab3236>约 7736 字</span><span data-v-a3ab3236>大约 26 分钟</span></p><!----><p class="create-time" data-v-a3ab3236><span class="vpi-clock icon" data-v-a3ab3236></span><span data-v-a3ab3236>2025-09-23</span></p></div><!--]--><div class="_article_k5v78e0h_ external-link-icon-enabled vp-doc plume-content" vp-content data-v-a703df67><div data-v-a703df67><h2 id="_1-引言" tabindex="-1"><a class="header-anchor" href="#_1-引言"><span>1. 引言</span></a></h2><p>作为一名后端开发者，在日常工作中我们经常接触MySQL数据库，但随着业务复杂度的提升，我开始接触到PostgreSQL这个&quot;世界上最先进的开源关系型数据库&quot;。初次使用PostgreSQL，我被它强大的功能特性深深震撼。</p><h3 id="为什么选择postgresql" tabindex="-1"><a class="header-anchor" href="#为什么选择postgresql"><span>为什么选择PostgreSQL？</span></a></h3><p>相比MySQL，PostgreSQL在以下方面表现出色：</p><ul><li>🎯 <strong>更丰富的数据类型</strong>：原生支持JSON、数组、地理数据等</li><li>🚀 <strong>更强大的查询能力</strong>：窗口函数、CTE、全文搜索等</li><li>🌍 <strong>地理信息处理</strong>：PostGIS扩展提供专业级GIS功能</li><li>⚡ <strong>高度可扩展</strong>：丰富的扩展生态系统</li><li>🔒 <strong>企业级特性</strong>：MVCC、高级索引、复制等</li></ul><h3 id="本文概述" tabindex="-1"><a class="header-anchor" href="#本文概述"><span>本文概述</span></a></h3><p>本文将深入介绍PostgreSQL相比MySQL的独特优势，重点讲解PostGIS地理功能，并分享实际工作中的应用场景。无论你是数据库新手还是有经验的开发者，都能从中获得有价值的知识。</p><h2 id="_2-postgresql的独特数据类型支持-🎯" tabindex="-1"><a class="header-anchor" href="#_2-postgresql的独特数据类型支持-🎯"><span>2. PostgreSQL的独特数据类型支持 🎯</span></a></h2><p>PostgreSQL最令人印象深刻的特性之一就是其丰富的数据类型支持，这为开发者提供了更大的灵活性。</p><h3 id="json-jsonb类型" tabindex="-1"><a class="header-anchor" href="#json-jsonb类型"><span>JSON/JSONB类型</span></a></h3><p>PostgreSQL原生支持JSON数据类型，这在处理半结构化数据时非常有用。</p><h4 id="基本使用" tabindex="-1"><a class="header-anchor" href="#基本使用"><span>基本使用</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>创建包含JSON字段的表</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>products</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name</span><span class="space"> </span><span>VARCHAR(100),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>attributes</span><span class="space"> </span><span>JSON,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>metadata</span><span class="space"> </span><span>JSONB</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>插入JSON数据</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>products</span><span class="space"> </span><span>(name,</span><span class="space"> </span><span>attributes,</span><span class="space"> </span><span>metadata)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;iPhone</span><span class="space"> </span><span>15&#39;,</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span>&#39;{&quot;color&quot;:</span><span class="space"> </span><span>&quot;blue&quot;,</span><span class="space"> </span><span>&quot;storage&quot;:</span><span class="space"> </span><span>&quot;128GB&quot;,</span><span class="space"> </span><span>&quot;price&quot;:</span><span class="space"> </span><span>999}&#39;,</span></span>
<span class="line"><span class="space"> </span><span>&#39;{&quot;brand&quot;:</span><span class="space"> </span><span>&quot;Apple&quot;,</span><span class="space"> </span><span>&quot;category&quot;:</span><span class="space"> </span><span>&quot;smartphone&quot;,</span><span class="space"> </span><span>&quot;tags&quot;:</span><span class="space"> </span><span>[&quot;5G&quot;,</span><span class="space"> </span><span>&quot;premium&quot;]}&#39;</span></span>
<span class="line"><span>);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="jsonb的优势" tabindex="-1"><a class="header-anchor" href="#jsonb的优势"><span>JSONB的优势</span></a></h4><p>JSONB是二进制格式的JSON，支持索引和高效查询：</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>创建JSONB索引</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_metadata_gin</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>products</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>GIN</span><span class="space"> </span><span>(metadata);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>高效的JSON查询</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>*</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>products</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>metadata</span><span class="space"> </span><span>@&gt;</span><span class="space"> </span><span>&#39;{&quot;brand&quot;:</span><span class="space"> </span><span>&quot;Apple&quot;}&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>JSON路径查询</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>name,</span><span class="space"> </span><span>metadata-&gt;&#39;brand&#39;</span><span class="space"> </span><span>as</span><span class="space"> </span><span>brand</span><span class="space"> </span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>products</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>metadata-&gt;&gt;&#39;category&#39;</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;smartphone&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>JSON数组操作</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>name</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>products</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>metadata-&gt;&#39;tags&#39;</span><span class="space"> </span><span>?</span><span class="space"> </span><span>&#39;premium&#39;;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="实际应用场景" tabindex="-1"><a class="header-anchor" href="#实际应用场景"><span>实际应用场景</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>电商商品属性存储</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>ecommerce_products</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name</span><span class="space"> </span><span>VARCHAR(200),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>base_price</span><span class="space"> </span><span>DECIMAL(10,2),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>specifications</span><span class="space"> </span><span>JSONB,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>created_at</span><span class="space"> </span><span>TIMESTAMP</span><span class="space"> </span><span>DEFAULT</span><span class="space"> </span><span>NOW()</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>不同类型商品有不同属性</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>ecommerce_products</span><span class="space"> </span><span>(name,</span><span class="space"> </span><span>base_price,</span><span class="space"> </span><span>specifications)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;MacBook</span><span class="space"> </span><span>Pro&#39;,</span><span class="space"> </span><span>1999.00,</span><span class="space"> </span><span>&#39;{&quot;screen_size&quot;:</span><span class="space"> </span><span>&quot;14inch&quot;,</span><span class="space"> </span><span>&quot;processor&quot;:</span><span class="space"> </span><span>&quot;M3&quot;,</span><span class="space"> </span><span>&quot;ram&quot;:</span><span class="space"> </span><span>&quot;16GB&quot;,</span><span class="space"> </span><span>&quot;storage&quot;:</span><span class="space"> </span><span>&quot;512GB&quot;}&#39;),</span></span>
<span class="line"><span>(&#39;Nike</span><span class="space"> </span><span>Air</span><span class="space"> </span><span>Max&#39;,</span><span class="space"> </span><span>129.99,</span><span class="space"> </span><span>&#39;{&quot;size&quot;:</span><span class="space"> </span><span>[7,</span><span class="space"> </span><span>8,</span><span class="space"> </span><span>9,</span><span class="space"> </span><span>10,</span><span class="space"> </span><span>11],</span><span class="space"> </span><span>&quot;color&quot;:</span><span class="space"> </span><span>[&quot;black&quot;,</span><span class="space"> </span><span>&quot;white&quot;,</span><span class="space"> </span><span>&quot;red&quot;],</span><span class="space"> </span><span>&quot;material&quot;:</span><span class="space"> </span><span>&quot;mesh&quot;}&#39;),</span></span>
<span class="line"><span>(&#39;Coffee</span><span class="space"> </span><span>Maker&#39;,</span><span class="space"> </span><span>89.99,</span><span class="space"> </span><span>&#39;{&quot;capacity&quot;:</span><span class="space"> </span><span>&quot;12cups&quot;,</span><span class="space"> </span><span>&quot;features&quot;:</span><span class="space"> </span><span>[&quot;programmable&quot;,</span><span class="space"> </span><span>&quot;auto-shutoff&quot;],</span><span class="space"> </span><span>&quot;warranty&quot;:</span><span class="space"> </span><span>&quot;2years&quot;}&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>灵活查询不同属性</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>name,</span><span class="space"> </span><span>specifications-&gt;&#39;processor&#39;</span><span class="space"> </span><span>as</span><span class="space"> </span><span>cpu</span><span class="space"> </span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>ecommerce_products</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>specifications</span><span class="space"> </span><span>?</span><span class="space"> </span><span>&#39;processor&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>name,</span><span class="space"> </span><span>jsonb_array_elements_text(specifications-&gt;&#39;color&#39;)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>available_colors</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>ecommerce_products</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>specifications</span><span class="space"> </span><span>?</span><span class="space"> </span><span>&#39;color&#39;;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="数组类型" tabindex="-1"><a class="header-anchor" href="#数组类型"><span>数组类型</span></a></h3><p>PostgreSQL支持任何数据类型的数组，这在很多场景下非常实用。</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>数组字段定义</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>blog_posts</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>title</span><span class="space"> </span><span>VARCHAR(200),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>tags</span><span class="space"> </span><span>TEXT[],</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>view_counts</span><span class="space"> </span><span>INTEGER[],</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>publish_dates</span><span class="space"> </span><span>DATE[]</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>插入数组数据</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>blog_posts</span><span class="space"> </span><span>(title,</span><span class="space"> </span><span>tags,</span><span class="space"> </span><span>view_counts)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;PostgreSQL入门&#39;,</span><span class="space"> </span><span>ARRAY[&#39;数据库&#39;,</span><span class="space"> </span><span>&#39;PostgreSQL&#39;,</span><span class="space"> </span><span>&#39;教程&#39;],</span><span class="space"> </span><span>ARRAY[100,</span><span class="space"> </span><span>150,</span><span class="space"> </span><span>200]),</span></span>
<span class="line"><span>(&#39;React开发指南&#39;,</span><span class="space"> </span><span>ARRAY[&#39;前端&#39;,</span><span class="space"> </span><span>&#39;React&#39;,</span><span class="space"> </span><span>&#39;JavaScript&#39;],</span><span class="space"> </span><span>ARRAY[300,</span><span class="space"> </span><span>280,</span><span class="space"> </span><span>320]);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>数组查询操作</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>查找包含特定标签的文章</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>title</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>blog_posts</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>&#39;PostgreSQL&#39;</span><span class="space"> </span><span>=</span><span class="space"> </span><span>ANY(tags);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>查找标签数组长度</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>title,</span><span class="space"> </span><span>array_length(tags,</span><span class="space"> </span><span>1)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>tag_count</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>blog_posts;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>数组聚合</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>unnest(tags)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>tag,</span><span class="space"> </span><span>COUNT(*)</span><span class="space"> </span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>blog_posts</span><span class="space"> </span></span>
<span class="line"><span>GROUP</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>tag</span><span class="space"> </span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>count</span><span class="space"> </span><span>DESC;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="自定义数据类型" tabindex="-1"><a class="header-anchor" href="#自定义数据类型"><span>自定义数据类型</span></a></h3><p>PostgreSQL允许创建自定义数据类型，提供更强的类型安全性。</p><h4 id="枚举类型" tabindex="-1"><a class="header-anchor" href="#枚举类型"><span>枚举类型</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>创建枚举类型</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TYPE</span><span class="space"> </span><span>order_status</span><span class="space"> </span><span>AS</span><span class="space"> </span><span>ENUM</span><span class="space"> </span><span>(&#39;pending&#39;,</span><span class="space"> </span><span>&#39;processing&#39;,</span><span class="space"> </span><span>&#39;shipped&#39;,</span><span class="space"> </span><span>&#39;delivered&#39;,</span><span class="space"> </span><span>&#39;cancelled&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>orders</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>customer_name</span><span class="space"> </span><span>VARCHAR(100),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>status</span><span class="space"> </span><span>order_status</span><span class="space"> </span><span>DEFAULT</span><span class="space"> </span><span>&#39;pending&#39;,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>created_at</span><span class="space"> </span><span>TIMESTAMP</span><span class="space"> </span><span>DEFAULT</span><span class="space"> </span><span>NOW()</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>类型安全的插入</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>orders</span><span class="space"> </span><span>(customer_name,</span><span class="space"> </span><span>status)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;张三&#39;,</span><span class="space"> </span><span>&#39;pending&#39;),</span></span>
<span class="line"><span>(&#39;李四&#39;,</span><span class="space"> </span><span>&#39;processing&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>枚举值排序</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>*</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>orders</span><span class="space"> </span><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>status;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="复合类型" tabindex="-1"><a class="header-anchor" href="#复合类型"><span>复合类型</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>创建复合类型</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TYPE</span><span class="space"> </span><span>address_type</span><span class="space"> </span><span>AS</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>street</span><span class="space"> </span><span>VARCHAR(100),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>city</span><span class="space"> </span><span>VARCHAR(50),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>province</span><span class="space"> </span><span>VARCHAR(50),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>postal_code</span><span class="space"> </span><span>VARCHAR(10)</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>customers</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name</span><span class="space"> </span><span>VARCHAR(100),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>billing_address</span><span class="space"> </span><span>address_type,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>shipping_address</span><span class="space"> </span><span>address_type</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>使用复合类型</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>customers</span><span class="space"> </span><span>(name,</span><span class="space"> </span><span>billing_address,</span><span class="space"> </span><span>shipping_address)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;王五&#39;,</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span>ROW(&#39;中关村大街1号&#39;,</span><span class="space"> </span><span>&#39;北京&#39;,</span><span class="space"> </span><span>&#39;北京市&#39;,</span><span class="space"> </span><span>&#39;100080&#39;),</span></span>
<span class="line"><span class="space"> </span><span>ROW(&#39;朝阳路88号&#39;,</span><span class="space"> </span><span>&#39;北京&#39;,</span><span class="space"> </span><span>&#39;北京市&#39;,</span><span class="space"> </span><span>&#39;100020&#39;)</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>查询复合类型字段</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>name,</span><span class="space"> </span><span>(billing_address).city,</span><span class="space"> </span><span>(shipping_address).city</span><span class="space"> </span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>customers;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-高级查询功能-🚀" tabindex="-1"><a class="header-anchor" href="#_3-高级查询功能-🚀"><span>3. 高级查询功能 🚀</span></a></h2><p>PostgreSQL提供了许多MySQL不具备的高级查询功能，让复杂的数据分析变得简单。</p><h3 id="窗口函数-window-functions" tabindex="-1"><a class="header-anchor" href="#窗口函数-window-functions"><span>窗口函数（Window Functions）</span></a></h3><p>窗口函数是PostgreSQL的杀手级功能，可以在不使用GROUP BY的情况下进行聚合计算。</p><h4 id="排名函数" tabindex="-1"><a class="header-anchor" href="#排名函数"><span>排名函数</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>创建销售数据表</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>sales</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>salesperson</span><span class="space"> </span><span>VARCHAR(50),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>region</span><span class="space"> </span><span>VARCHAR(50),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>amount</span><span class="space"> </span><span>DECIMAL(10,2),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>sale_date</span><span class="space"> </span><span>DATE</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>sales</span><span class="space"> </span><span>(salesperson,</span><span class="space"> </span><span>region,</span><span class="space"> </span><span>amount,</span><span class="space"> </span><span>sale_date)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;张三&#39;,</span><span class="space"> </span><span>&#39;华北&#39;,</span><span class="space"> </span><span>15000,</span><span class="space"> </span><span>&#39;2024-01-15&#39;),</span></span>
<span class="line"><span>(&#39;李四&#39;,</span><span class="space"> </span><span>&#39;华北&#39;,</span><span class="space"> </span><span>12000,</span><span class="space"> </span><span>&#39;2024-01-16&#39;),</span></span>
<span class="line"><span>(&#39;王五&#39;,</span><span class="space"> </span><span>&#39;华南&#39;,</span><span class="space"> </span><span>18000,</span><span class="space"> </span><span>&#39;2024-01-17&#39;),</span></span>
<span class="line"><span>(&#39;赵六&#39;,</span><span class="space"> </span><span>&#39;华南&#39;,</span><span class="space"> </span><span>16000,</span><span class="space"> </span><span>&#39;2024-01-18&#39;),</span></span>
<span class="line"><span>(&#39;钱七&#39;,</span><span class="space"> </span><span>&#39;华北&#39;,</span><span class="space"> </span><span>14000,</span><span class="space"> </span><span>&#39;2024-01-19&#39;),</span></span>
<span class="line"><span>(&#39;孙八&#39;,</span><span class="space"> </span><span>&#39;华南&#39;,</span><span class="space"> </span><span>20000,</span><span class="space"> </span><span>&#39;2024-01-20&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>使用窗口函数进行排名</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>salesperson,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>region,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>amount,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ROW_NUMBER()</span><span class="space"> </span><span>OVER</span><span class="space"> </span><span>(ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>amount</span><span class="space"> </span><span>DESC)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>overall_rank,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>RANK()</span><span class="space"> </span><span>OVER</span><span class="space"> </span><span>(PARTITION</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>region</span><span class="space"> </span><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>amount</span><span class="space"> </span><span>DESC)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>region_rank,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>DENSE_RANK()</span><span class="space"> </span><span>OVER</span><span class="space"> </span><span>(PARTITION</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>region</span><span class="space"> </span><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>amount</span><span class="space"> </span><span>DESC)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>dense_region_rank</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>sales;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="lag和lead函数" tabindex="-1"><a class="header-anchor" href="#lag和lead函数"><span>LAG和LEAD函数</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>计算销售额环比增长</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>salesperson,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>sale_date,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>amount,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>LAG(amount)</span><span class="space"> </span><span>OVER</span><span class="space"> </span><span>(PARTITION</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>salesperson</span><span class="space"> </span><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>sale_date)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>prev_amount,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>amount</span><span class="space"> </span><span>-</span><span class="space"> </span><span>LAG(amount)</span><span class="space"> </span><span>OVER</span><span class="space"> </span><span>(PARTITION</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>salesperson</span><span class="space"> </span><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>sale_date)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>growth,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>LEAD(amount)</span><span class="space"> </span><span>OVER</span><span class="space"> </span><span>(PARTITION</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>salesperson</span><span class="space"> </span><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>sale_date)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>next_amount</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>sales</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>salesperson,</span><span class="space"> </span><span>sale_date;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="移动平均和累计统计" tabindex="-1"><a class="header-anchor" href="#移动平均和累计统计"><span>移动平均和累计统计</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>计算移动平均和累计销售额</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>sale_date,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>amount,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>AVG(amount)</span><span class="space"> </span><span>OVER</span><span class="space"> </span><span>(ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>sale_date</span><span class="space"> </span><span>ROWS</span><span class="space"> </span><span>BETWEEN</span><span class="space"> </span><span>2</span><span class="space"> </span><span>PRECEDING</span><span class="space"> </span><span>AND</span><span class="space"> </span><span>CURRENT</span><span class="space"> </span><span>ROW)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>moving_avg_3days,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SUM(amount)</span><span class="space"> </span><span>OVER</span><span class="space"> </span><span>(ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>sale_date)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>cumulative_sales,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>COUNT(*)</span><span class="space"> </span><span>OVER</span><span class="space"> </span><span>(ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>sale_date)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>cumulative_count</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>sales</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>sale_date;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="公用表表达式-cte" tabindex="-1"><a class="header-anchor" href="#公用表表达式-cte"><span>公用表表达式（CTE）</span></a></h3><p>CTE让复杂查询更加清晰和可维护。</p><h4 id="基本cte" tabindex="-1"><a class="header-anchor" href="#基本cte"><span>基本CTE</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>使用CTE简化复杂查询</span></span>
<span class="line"><span>WITH</span><span class="space"> </span><span>regional_stats</span><span class="space"> </span><span>AS</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>region,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>COUNT(*)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>sale_count,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SUM(amount)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>total_amount,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>AVG(amount)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>avg_amount</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>sales</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>GROUP</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>region</span></span>
<span class="line"><span>),</span></span>
<span class="line"><span>top_performers</span><span class="space"> </span><span>AS</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>salesperson,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SUM(amount)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>total_sales</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>sales</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>GROUP</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>salesperson</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>HAVING</span><span class="space"> </span><span>SUM(amount)</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>15000</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>rs.region,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>rs.total_amount,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>rs.avg_amount,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>COUNT(tp.salesperson)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>top_performer_count</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>regional_stats</span><span class="space"> </span><span>rs</span></span>
<span class="line"><span>LEFT</span><span class="space"> </span><span>JOIN</span><span class="space"> </span><span>sales</span><span class="space"> </span><span>s</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>rs.region</span><span class="space"> </span><span>=</span><span class="space"> </span><span>s.region</span></span>
<span class="line"><span>LEFT</span><span class="space"> </span><span>JOIN</span><span class="space"> </span><span>top_performers</span><span class="space"> </span><span>tp</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>s.salesperson</span><span class="space"> </span><span>=</span><span class="space"> </span><span>tp.salesperson</span></span>
<span class="line"><span>GROUP</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>rs.region,</span><span class="space"> </span><span>rs.total_amount,</span><span class="space"> </span><span>rs.avg_amount;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="递归cte" tabindex="-1"><a class="header-anchor" href="#递归cte"><span>递归CTE</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>组织架构递归查询</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>employees</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name</span><span class="space"> </span><span>VARCHAR(50),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>manager_id</span><span class="space"> </span><span>INTEGER</span><span class="space"> </span><span>REFERENCES</span><span class="space"> </span><span>employees(id),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>department</span><span class="space"> </span><span>VARCHAR(50)</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>employees</span><span class="space"> </span><span>(name,</span><span class="space"> </span><span>manager_id,</span><span class="space"> </span><span>department)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;CEO张总&#39;,</span><span class="space"> </span><span>NULL,</span><span class="space"> </span><span>&#39;管理层&#39;),</span></span>
<span class="line"><span>(&#39;CTO李总&#39;,</span><span class="space"> </span><span>1,</span><span class="space"> </span><span>&#39;技术部&#39;),</span></span>
<span class="line"><span>(&#39;CFO王总&#39;,</span><span class="space"> </span><span>1,</span><span class="space"> </span><span>&#39;财务部&#39;),</span></span>
<span class="line"><span>(&#39;开发经理赵经理&#39;,</span><span class="space"> </span><span>2,</span><span class="space"> </span><span>&#39;技术部&#39;),</span></span>
<span class="line"><span>(&#39;高级开发钱工&#39;,</span><span class="space"> </span><span>4,</span><span class="space"> </span><span>&#39;技术部&#39;),</span></span>
<span class="line"><span>(&#39;初级开发孙工&#39;,</span><span class="space"> </span><span>4,</span><span class="space"> </span><span>&#39;技术部&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>递归查询组织层级</span></span>
<span class="line"><span>WITH</span><span class="space"> </span><span>RECURSIVE</span><span class="space"> </span><span>org_hierarchy</span><span class="space"> </span><span>AS</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>基础查询：找到顶级管理者</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SELECT</span><span class="space"> </span><span>id,</span><span class="space"> </span><span>name,</span><span class="space"> </span><span>manager_id,</span><span class="space"> </span><span>department,</span><span class="space"> </span><span>0</span><span class="space"> </span><span>as</span><span class="space"> </span><span>level,</span><span class="space"> </span><span>name</span><span class="space"> </span><span>as</span><span class="space"> </span><span>path</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>employees</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>manager_id</span><span class="space"> </span><span>IS</span><span class="space"> </span><span>NULL</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>UNION</span><span class="space"> </span><span>ALL</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>递归查询：找到下级员工</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SELECT</span><span class="space"> </span><span>e.id,</span><span class="space"> </span><span>e.name,</span><span class="space"> </span><span>e.manager_id,</span><span class="space"> </span><span>e.department,</span><span class="space"> </span><span>oh.level</span><span class="space"> </span><span>+</span><span class="space"> </span><span>1,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>oh.path</span><span class="space"> </span><span>||</span><span class="space"> </span><span>&#39;</span><span class="space"> </span><span>-&gt;</span><span class="space"> </span><span>&#39;</span><span class="space"> </span><span>||</span><span class="space"> </span><span>e.name</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>employees</span><span class="space"> </span><span>e</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>INNER</span><span class="space"> </span><span>JOIN</span><span class="space"> </span><span>org_hierarchy</span><span class="space"> </span><span>oh</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>e.manager_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>oh.id</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>REPEAT(&#39;</span><span class="space"> </span><span class="space"> </span><span>&#39;,</span><span class="space"> </span><span>level)</span><span class="space"> </span><span>||</span><span class="space"> </span><span>name</span><span class="space"> </span><span>as</span><span class="space"> </span><span>hierarchy,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>department,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>level,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>path</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>org_hierarchy</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>path;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="全文搜索" tabindex="-1"><a class="header-anchor" href="#全文搜索"><span>全文搜索</span></a></h3><p>PostgreSQL内置强大的全文搜索功能。</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>创建文章表</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>articles</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>title</span><span class="space"> </span><span>VARCHAR(200),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>content</span><span class="space"> </span><span>TEXT,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>author</span><span class="space"> </span><span>VARCHAR(50),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>created_at</span><span class="space"> </span><span>TIMESTAMP</span><span class="space"> </span><span>DEFAULT</span><span class="space"> </span><span>NOW()</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>articles</span><span class="space"> </span><span>(title,</span><span class="space"> </span><span>content,</span><span class="space"> </span><span>author)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;PostgreSQL高级特性&#39;,</span><span class="space"> </span><span>&#39;PostgreSQL是一个功能强大的开源关系型数据库，支持JSON、数组、地理数据等多种数据类型...&#39;,</span><span class="space"> </span><span>&#39;张三&#39;),</span></span>
<span class="line"><span>(&#39;MySQL</span><span class="space"> </span><span>vs</span><span class="space"> </span><span>PostgreSQL&#39;,</span><span class="space"> </span><span>&#39;在选择数据库时，MySQL和PostgreSQL都是优秀的选择，但它们各有特点...&#39;,</span><span class="space"> </span><span>&#39;李四&#39;),</span></span>
<span class="line"><span>(&#39;PostGIS地理数据处理&#39;,</span><span class="space"> </span><span>&#39;PostGIS是PostgreSQL的地理信息扩展，提供了丰富的空间数据处理功能...&#39;,</span><span class="space"> </span><span>&#39;王五&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>添加全文搜索索引</span></span>
<span class="line"><span>ALTER</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>articles</span><span class="space"> </span><span>ADD</span><span class="space"> </span><span>COLUMN</span><span class="space"> </span><span>search_vector</span><span class="space"> </span><span>tsvector;</span></span>
<span class="line"><span>UPDATE</span><span class="space"> </span><span>articles</span><span class="space"> </span><span>SET</span><span class="space"> </span><span>search_vector</span><span class="space"> </span><span>=</span><span class="space"> </span><span>to_tsvector(&#39;chinese&#39;,</span><span class="space"> </span><span>title</span><span class="space"> </span><span>||</span><span class="space"> </span><span>&#39;</span><span class="space"> </span><span>&#39;</span><span class="space"> </span><span>||</span><span class="space"> </span><span>content);</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_articles_search</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>articles</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>GIN(search_vector);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>全文搜索查询</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>title,</span><span class="space"> </span><span>author,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ts_rank(search_vector,</span><span class="space"> </span><span>query)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>rank</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>articles,</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>to_tsquery(&#39;chinese&#39;,</span><span class="space"> </span><span>&#39;PostgreSQL</span><span class="space"> </span><span>&amp;</span><span class="space"> </span><span>数据库&#39;)</span><span class="space"> </span><span>query</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>search_vector</span><span class="space"> </span><span>@@</span><span class="space"> </span><span>query</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>rank</span><span class="space"> </span><span>DESC;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>搜索结果高亮</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>title,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ts_headline(&#39;chinese&#39;,</span><span class="space"> </span><span>content,</span><span class="space"> </span><span>to_tsquery(&#39;chinese&#39;,</span><span class="space"> </span><span>&#39;PostgreSQL&#39;),</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&#39;MaxWords=20,</span><span class="space"> </span><span>MinWords=5&#39;)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>snippet</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>articles</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>search_vector</span><span class="space"> </span><span>@@</span><span class="space"> </span><span>to_tsquery(&#39;chinese&#39;,</span><span class="space"> </span><span>&#39;PostgreSQL&#39;);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-postgis-地理信息系统的王者-🌍" tabindex="-1"><a class="header-anchor" href="#_4-postgis-地理信息系统的王者-🌍"><span>4. PostGIS：地理信息系统的王者 🌍</span></a></h2><p>PostGIS是PostgreSQL最引人注目的扩展之一，它将PostgreSQL转变为一个功能强大的空间数据库。这是PostgreSQL相比MySQL最大的优势之一。</p><h3 id="postgis简介" tabindex="-1"><a class="header-anchor" href="#postgis简介"><span>PostGIS简介</span></a></h3><p>PostGIS是一个开源的地理信息系统扩展，为PostgreSQL提供了空间数据类型、空间索引和空间函数。它符合OGC（开放地理空间联盟）标准，被广泛应用于GIS应用、位置服务、地图应用等领域。</p><h4 id="安装和配置" tabindex="-1"><a class="header-anchor" href="#安装和配置"><span>安装和配置</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>启用PostGIS扩展</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>EXTENSION</span><span class="space"> </span><span>postgis;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>查看PostGIS版本</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>PostGIS_Version();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>查看支持的空间参考系统</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>*</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>spatial_ref_sys</span><span class="space"> </span><span>LIMIT</span><span class="space"> </span><span>5;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="空间数据类型" tabindex="-1"><a class="header-anchor" href="#空间数据类型"><span>空间数据类型</span></a></h3><p>PostGIS支持多种空间数据类型，每种类型都有其特定的用途。</p><h4 id="基本几何类型" tabindex="-1"><a class="header-anchor" href="#基本几何类型"><span>基本几何类型</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>创建包含空间数据的表</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>locations</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name</span><span class="space"> </span><span>VARCHAR(100),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>location</span><span class="space"> </span><span>GEOMETRY(POINT,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>WGS84坐标系的点</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>area</span><span class="space"> </span><span>GEOMETRY(POLYGON,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>多边形区域</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>route</span><span class="space"> </span><span>GEOMETRY(LINESTRING,</span><span class="space"> </span><span>4326)</span><span class="space"> </span><span>--</span><span class="space"> </span><span>线路</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>插入空间数据</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>locations</span><span class="space"> </span><span>(name,</span><span class="space"> </span><span>location,</span><span class="space"> </span><span>area)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;北京天安门&#39;,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.3974</span><span class="space"> </span><span>39.9093)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>NULL),</span></span>
<span class="line"><span>(&#39;上海外滩&#39;,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(121.4944</span><span class="space"> </span><span>31.2407)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>NULL),</span></span>
<span class="line"><span>(&#39;深圳市中心区域&#39;,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(114.0579</span><span class="space"> </span><span>22.5431)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span>ST_GeomFromText(&#39;POLYGON((114.05</span><span class="space"> </span><span>22.54,</span><span class="space"> </span><span>114.06</span><span class="space"> </span><span>22.54,</span><span class="space"> </span><span>114.06</span><span class="space"> </span><span>22.53,</span><span class="space"> </span><span>114.05</span><span class="space"> </span><span>22.53,</span><span class="space"> </span><span>114.05</span><span class="space"> </span><span>22.54))&#39;,</span><span class="space"> </span><span>4326));</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="复杂几何类型" tabindex="-1"><a class="header-anchor" href="#复杂几何类型"><span>复杂几何类型</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>多点、多线、多面</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>complex_geometries</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name</span><span class="space"> </span><span>VARCHAR(100),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>multi_points</span><span class="space"> </span><span>GEOMETRY(MULTIPOINT,</span><span class="space"> </span><span>4326),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>multi_lines</span><span class="space"> </span><span>GEOMETRY(MULTILINESTRING,</span><span class="space"> </span><span>4326),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>multi_polygons</span><span class="space"> </span><span>GEOMETRY(MULTIPOLYGON,</span><span class="space"> </span><span>4326),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>collection</span><span class="space"> </span><span>GEOMETRY(GEOMETRYCOLLECTION,</span><span class="space"> </span><span>4326)</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>插入复杂几何数据</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>complex_geometries</span><span class="space"> </span><span>(name,</span><span class="space"> </span><span>multi_points,</span><span class="space"> </span><span>multi_lines)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;连锁店位置&#39;,</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span>ST_GeomFromText(&#39;MULTIPOINT((116.3974</span><span class="space"> </span><span>39.9093),</span><span class="space"> </span><span>(121.4944</span><span class="space"> </span><span>31.2407),</span><span class="space"> </span><span>(114.0579</span><span class="space"> </span><span>22.5431))&#39;,</span><span class="space"> </span><span>4326),</span></span>
<span class="line"><span class="space"> </span><span>ST_GeomFromText(&#39;MULTILINESTRING((116.39</span><span class="space"> </span><span>39.90,</span><span class="space"> </span><span>116.40</span><span class="space"> </span><span>39.91),</span><span class="space"> </span><span>(121.49</span><span class="space"> </span><span>31.24,</span><span class="space"> </span><span>121.50</span><span class="space"> </span><span>31.25))&#39;,</span><span class="space"> </span><span>4326)</span></span>
<span class="line"><span>);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="核心地理函数详解" tabindex="-1"><a class="header-anchor" href="#核心地理函数详解"><span>核心地理函数详解</span></a></h3><p>PostGIS提供了数百个空间函数，这里介绍最常用和最重要的函数。</p><h4 id="几何创建函数" tabindex="-1"><a class="header-anchor" href="#几何创建函数"><span>几何创建函数</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>ST_MakePoint：创建点几何</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>ST_MakePoint(116.3974,</span><span class="space"> </span><span>39.9093)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>point_geom;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ST_GeomFromText：从WKT文本创建几何</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.3974</span><span class="space"> </span><span>39.9093)&#39;,</span><span class="space"> </span><span>4326)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>point_from_text;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ST_Buffer：创建缓冲区</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>ST_Buffer(ST_GeomFromText(&#39;POINT(116.3974</span><span class="space"> </span><span>39.9093)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>0.01)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>buffer_area;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ST_MakeLine：创建线几何</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>ST_MakeLine(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_MakePoint(116.3974,</span><span class="space"> </span><span>39.9093),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_MakePoint(121.4944,</span><span class="space"> </span><span>31.2407)</span></span>
<span class="line"><span>)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>line_geom;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ST_MakePolygon：创建多边形</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>ST_MakePolygon(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_GeomFromText(&#39;LINESTRING(116.39</span><span class="space"> </span><span>39.90,</span><span class="space"> </span><span>116.40</span><span class="space"> </span><span>39.90,</span><span class="space"> </span><span>116.40</span><span class="space"> </span><span>39.91,</span><span class="space"> </span><span>116.39</span><span class="space"> </span><span>39.91,</span><span class="space"> </span><span>116.39</span><span class="space"> </span><span>39.90)&#39;)</span></span>
<span class="line"><span>)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>polygon_geom;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="空间关系函数" tabindex="-1"><a class="header-anchor" href="#空间关系函数"><span>空间关系函数</span></a></h4><p>这些函数用于判断几何对象之间的空间关系：</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>创建测试数据</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>spatial_test</span><span class="space"> </span><span>AS</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&#39;point1&#39;</span><span class="space"> </span><span>as</span><span class="space"> </span><span>name,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.40</span><span class="space"> </span><span>39.90)&#39;,</span><span class="space"> </span><span>4326)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>geom</span></span>
<span class="line"><span>UNION</span><span class="space"> </span><span>ALL</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&#39;point2&#39;,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.41</span><span class="space"> </span><span>39.91)&#39;,</span><span class="space"> </span><span>4326)</span></span>
<span class="line"><span>UNION</span><span class="space"> </span><span>ALL</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&#39;polygon1&#39;,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POLYGON((116.39</span><span class="space"> </span><span>39.89,</span><span class="space"> </span><span>116.42</span><span class="space"> </span><span>39.89,</span><span class="space"> </span><span>116.42</span><span class="space"> </span><span>39.92,</span><span class="space"> </span><span>116.39</span><span class="space"> </span><span>39.92,</span><span class="space"> </span><span>116.39</span><span class="space"> </span><span>39.89))&#39;,</span><span class="space"> </span><span>4326)</span></span>
<span class="line"><span>UNION</span><span class="space"> </span><span>ALL</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&#39;line1&#39;,</span><span class="space"> </span><span>ST_GeomFromText(&#39;LINESTRING(116.38</span><span class="space"> </span><span>39.88,</span><span class="space"> </span><span>116.43</span><span class="space"> </span><span>39.93)&#39;,</span><span class="space"> </span><span>4326);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ST_Contains：判断是否包含</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>a.name</span><span class="space"> </span><span>as</span><span class="space"> </span><span>container,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>b.name</span><span class="space"> </span><span>as</span><span class="space"> </span><span>contained,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Contains(a.geom,</span><span class="space"> </span><span>b.geom)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>contains</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>spatial_test</span><span class="space"> </span><span>a,</span><span class="space"> </span><span>spatial_test</span><span class="space"> </span><span>b</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>a.name</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;polygon1&#39;</span><span class="space"> </span><span>AND</span><span class="space"> </span><span>b.name</span><span class="space"> </span><span>LIKE</span><span class="space"> </span><span>&#39;point%&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ST_Intersects：判断是否相交</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>a.name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>b.name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Intersects(a.geom,</span><span class="space"> </span><span>b.geom)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>intersects</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>spatial_test</span><span class="space"> </span><span>a,</span><span class="space"> </span><span>spatial_test</span><span class="space"> </span><span>b</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>a.name</span><span class="space"> </span><span>!=</span><span class="space"> </span><span>b.name;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ST_Within：判断是否在内部</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>a.name</span><span class="space"> </span><span>as</span><span class="space"> </span><span>inner_geom,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>b.name</span><span class="space"> </span><span>as</span><span class="space"> </span><span>outer_geom,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Within(a.geom,</span><span class="space"> </span><span>b.geom)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>within</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>spatial_test</span><span class="space"> </span><span>a,</span><span class="space"> </span><span>spatial_test</span><span class="space"> </span><span>b</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>a.name</span><span class="space"> </span><span>LIKE</span><span class="space"> </span><span>&#39;point%&#39;</span><span class="space"> </span><span>AND</span><span class="space"> </span><span>b.name</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;polygon1&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ST_Distance：计算距离（单位：度）</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>a.name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>b.name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Distance(a.geom,</span><span class="space"> </span><span>b.geom)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>distance_degrees,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Distance(ST_Transform(a.geom,</span><span class="space"> </span><span>3857),</span><span class="space"> </span><span>ST_Transform(b.geom,</span><span class="space"> </span><span>3857))</span><span class="space"> </span><span>as</span><span class="space"> </span><span>distance_meters</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>spatial_test</span><span class="space"> </span><span>a,</span><span class="space"> </span><span>spatial_test</span><span class="space"> </span><span>b</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>a.name</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;point1&#39;</span><span class="space"> </span><span>AND</span><span class="space"> </span><span>b.name</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;point2&#39;;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="几何分析函数" tabindex="-1"><a class="header-anchor" href="#几何分析函数"><span>几何分析函数</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>ST_Area：计算面积</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Area(geom)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>area_degrees,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Area(ST_Transform(geom,</span><span class="space"> </span><span>3857))</span><span class="space"> </span><span>as</span><span class="space"> </span><span>area_square_meters</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>spatial_test</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>name</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;polygon1&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ST_Length：计算长度</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Length(geom)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>length_degrees,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Length(ST_Transform(geom,</span><span class="space"> </span><span>3857))</span><span class="space"> </span><span>as</span><span class="space"> </span><span>length_meters</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>spatial_test</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>name</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;line1&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ST_Centroid：计算中心点</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_AsText(ST_Centroid(geom))</span><span class="space"> </span><span>as</span><span class="space"> </span><span>centroid</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>spatial_test</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>name</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;polygon1&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ST_Envelope：计算边界框</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_AsText(ST_Envelope(geom))</span><span class="space"> </span><span>as</span><span class="space"> </span><span>bounding_box</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>spatial_test;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ST_ConvexHull：计算凸包</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>ST_AsText(ST_ConvexHull(ST_Collect(geom)))</span><span class="space"> </span><span>as</span><span class="space"> </span><span>convex_hull</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>spatial_test;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="坐标系统函数" tabindex="-1"><a class="header-anchor" href="#坐标系统函数"><span>坐标系统函数</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>ST_Transform：坐标系转换</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>从WGS84</span><span class="space"> </span><span>(4326)</span><span class="space"> </span><span>转换到Web</span><span class="space"> </span><span>Mercator</span><span class="space"> </span><span>(3857)</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_AsText(geom)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>original_wgs84,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_AsText(ST_Transform(geom,</span><span class="space"> </span><span>3857))</span><span class="space"> </span><span>as</span><span class="space"> </span><span>transformed_web_mercator</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>spatial_test</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>name</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;point1&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ST_SetSRID：设置空间参考系统ID</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>ST_SetSRID(ST_MakePoint(116.3974,</span><span class="space"> </span><span>39.9093),</span><span class="space"> </span><span>4326)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>point_with_srid;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>ST_SRID：获取空间参考系统ID</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>name,</span><span class="space"> </span><span>ST_SRID(geom)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>srid</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>spatial_test;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="实际应用场景-1" tabindex="-1"><a class="header-anchor" href="#实际应用场景-1"><span>实际应用场景</span></a></h3><h4 id="_1-附近商家查询" tabindex="-1"><a class="header-anchor" href="#_1-附近商家查询"><span>1. 附近商家查询</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>创建商家表</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>businesses</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name</span><span class="space"> </span><span>VARCHAR(100),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>category</span><span class="space"> </span><span>VARCHAR(50),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>location</span><span class="space"> </span><span>GEOMETRY(POINT,</span><span class="space"> </span><span>4326),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>rating</span><span class="space"> </span><span>DECIMAL(2,1)</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>创建空间索引</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_businesses_location</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>businesses</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>GIST</span><span class="space"> </span><span>(location);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>插入测试数据</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>businesses</span><span class="space"> </span><span>(name,</span><span class="space"> </span><span>category,</span><span class="space"> </span><span>location,</span><span class="space"> </span><span>rating)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;星巴克(国贸店)&#39;,</span><span class="space"> </span><span>&#39;咖啡&#39;,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.4074</span><span class="space"> </span><span>39.9093)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>4.5),</span></span>
<span class="line"><span>(&#39;麦当劳(建国门店)&#39;,</span><span class="space"> </span><span>&#39;快餐&#39;,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.4174</span><span class="space"> </span><span>39.9093)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>4.2),</span></span>
<span class="line"><span>(&#39;海底捞(王府井店)&#39;,</span><span class="space"> </span><span>&#39;火锅&#39;,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.4074</span><span class="space"> </span><span>39.9193)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>4.8),</span></span>
<span class="line"><span>(&#39;肯德基(东单店)&#39;,</span><span class="space"> </span><span>&#39;快餐&#39;,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.4174</span><span class="space"> </span><span>39.9193)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>4.1);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>查找用户位置1公里内的商家</span></span>
<span class="line"><span>WITH</span><span class="space"> </span><span>user_location</span><span class="space"> </span><span>AS</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SELECT</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.4074</span><span class="space"> </span><span>39.9143)&#39;,</span><span class="space"> </span><span>4326)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>location</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>b.name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>b.category,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>b.rating,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Distance(ST_Transform(b.location,</span><span class="space"> </span><span>3857),</span><span class="space"> </span><span>ST_Transform(ul.location,</span><span class="space"> </span><span>3857))</span><span class="space"> </span><span>as</span><span class="space"> </span><span>distance_meters</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>businesses</span><span class="space"> </span><span>b,</span><span class="space"> </span><span>user_location</span><span class="space"> </span><span>ul</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>ST_DWithin(ST_Transform(b.location,</span><span class="space"> </span><span>3857),</span><span class="space"> </span><span>ST_Transform(ul.location,</span><span class="space"> </span><span>3857),</span><span class="space"> </span><span>1000)</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>distance_meters;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-地理围栏" tabindex="-1"><a class="header-anchor" href="#_2-地理围栏"><span>2. 地理围栏</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>创建地理围栏表</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>geofences</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name</span><span class="space"> </span><span>VARCHAR(100),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>boundary</span><span class="space"> </span><span>GEOMETRY(POLYGON,</span><span class="space"> </span><span>4326),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>fence_type</span><span class="space"> </span><span>VARCHAR(50)</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>插入围栏数据</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>geofences</span><span class="space"> </span><span>(name,</span><span class="space"> </span><span>boundary,</span><span class="space"> </span><span>fence_type)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;北京二环内&#39;,</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span>ST_GeomFromText(&#39;POLYGON((116.368</span><span class="space"> </span><span>39.915,</span><span class="space"> </span><span>116.427</span><span class="space"> </span><span>39.915,</span><span class="space"> </span><span>116.427</span><span class="space"> </span><span>39.875,</span><span class="space"> </span><span>116.368</span><span class="space"> </span><span>39.875,</span><span class="space"> </span><span>116.368</span><span class="space"> </span><span>39.915))&#39;,</span><span class="space"> </span><span>4326),</span></span>
<span class="line"><span class="space"> </span><span>&#39;restricted_zone&#39;),</span></span>
<span class="line"><span>(&#39;配送范围&#39;,</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span>ST_GeomFromText(&#39;POLYGON((116.390</span><span class="space"> </span><span>39.900,</span><span class="space"> </span><span>116.420</span><span class="space"> </span><span>39.900,</span><span class="space"> </span><span>116.420</span><span class="space"> </span><span>39.920,</span><span class="space"> </span><span>116.390</span><span class="space"> </span><span>39.920,</span><span class="space"> </span><span>116.390</span><span class="space"> </span><span>39.900))&#39;,</span><span class="space"> </span><span>4326),</span></span>
<span class="line"><span class="space"> </span><span>&#39;delivery_zone&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>检查用户是否在围栏内</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>OR</span><span class="space"> </span><span>REPLACE</span><span class="space"> </span><span>FUNCTION</span><span class="space"> </span><span>check_geofence(user_lat</span><span class="space"> </span><span>DECIMAL,</span><span class="space"> </span><span>user_lng</span><span class="space"> </span><span>DECIMAL)</span></span>
<span class="line"><span>RETURNS</span><span class="space"> </span><span>TABLE(fence_name</span><span class="space"> </span><span>VARCHAR,</span><span class="space"> </span><span>is_inside</span><span class="space"> </span><span>BOOLEAN,</span><span class="space"> </span><span>fence_type</span><span class="space"> </span><span>VARCHAR)</span><span class="space"> </span><span>AS</span><span class="space"> </span><span>$$</span></span>
<span class="line"><span>BEGIN</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>RETURN</span><span class="space"> </span><span>QUERY</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>g.name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Contains(g.boundary,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(&#39;</span><span class="space"> </span><span>||</span><span class="space"> </span><span>user_lng</span><span class="space"> </span><span>||</span><span class="space"> </span><span>&#39;</span><span class="space"> </span><span>&#39;</span><span class="space"> </span><span>||</span><span class="space"> </span><span>user_lat</span><span class="space"> </span><span>||</span><span class="space"> </span><span>&#39;)&#39;,</span><span class="space"> </span><span>4326)),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>g.fence_type</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>geofences</span><span class="space"> </span><span>g;</span></span>
<span class="line"><span>END;</span></span>
<span class="line"><span>$$</span><span class="space"> </span><span>LANGUAGE</span><span class="space"> </span><span>plpgsql;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>使用函数检查位置</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>*</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>check_geofence(39.9093,</span><span class="space"> </span><span>116.4074);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-路径规划和距离计算" tabindex="-1"><a class="header-anchor" href="#_3-路径规划和距离计算"><span>3. 路径规划和距离计算</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>创建路径点表</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>route_points</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>route_id</span><span class="space"> </span><span>INTEGER,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>sequence_order</span><span class="space"> </span><span>INTEGER,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>location</span><span class="space"> </span><span>GEOMETRY(POINT,</span><span class="space"> </span><span>4326),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>address</span><span class="space"> </span><span>VARCHAR(200)</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>插入路径数据</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>route_points</span><span class="space"> </span><span>(route_id,</span><span class="space"> </span><span>sequence_order,</span><span class="space"> </span><span>location,</span><span class="space"> </span><span>address)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(1,</span><span class="space"> </span><span>1,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.3974</span><span class="space"> </span><span>39.9093)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>&#39;天安门&#39;),</span></span>
<span class="line"><span>(1,</span><span class="space"> </span><span>2,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.4074</span><span class="space"> </span><span>39.9193)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>&#39;王府井&#39;),</span></span>
<span class="line"><span>(1,</span><span class="space"> </span><span>3,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.4174</span><span class="space"> </span><span>39.9093)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>&#39;建国门&#39;),</span></span>
<span class="line"><span>(1,</span><span class="space"> </span><span>4,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.4074</span><span class="space"> </span><span>39.8993)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>&#39;前门&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>计算路径总长度</span></span>
<span class="line"><span>WITH</span><span class="space"> </span><span>route_segments</span><span class="space"> </span><span>AS</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>route_id,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>sequence_order,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>location,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>LAG(location)</span><span class="space"> </span><span>OVER</span><span class="space"> </span><span>(PARTITION</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>route_id</span><span class="space"> </span><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>sequence_order)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>prev_location</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>route_points</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>route_id,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SUM(ST_Distance(ST_Transform(location,</span><span class="space"> </span><span>3857),</span><span class="space"> </span><span>ST_Transform(prev_location,</span><span class="space"> </span><span>3857)))</span><span class="space"> </span><span>as</span><span class="space"> </span><span>total_distance_meters</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>route_segments</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>prev_location</span><span class="space"> </span><span>IS</span><span class="space"> </span><span>NOT</span><span class="space"> </span><span>NULL</span></span>
<span class="line"><span>GROUP</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>route_id;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>创建路径线几何</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>route_id,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_AsText(ST_MakeLine(location</span><span class="space"> </span><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>sequence_order))</span><span class="space"> </span><span>as</span><span class="space"> </span><span>route_line</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>route_points</span></span>
<span class="line"><span>GROUP</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>route_id;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-热力图分析" tabindex="-1"><a class="header-anchor" href="#_4-热力图分析"><span>4. 热力图分析</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>创建事件表（如外卖订单）</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>delivery_orders</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>order_time</span><span class="space"> </span><span>TIMESTAMP,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>delivery_location</span><span class="space"> </span><span>GEOMETRY(POINT,</span><span class="space"> </span><span>4326),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>order_value</span><span class="space"> </span><span>DECIMAL(10,2)</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>插入模拟数据</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>delivery_orders</span><span class="space"> </span><span>(order_time,</span><span class="space"> </span><span>delivery_location,</span><span class="space"> </span><span>order_value)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;2024-01-15</span><span class="space"> </span><span>12:30:00&#39;,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.4074</span><span class="space"> </span><span>39.9093)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>85.50),</span></span>
<span class="line"><span>(&#39;2024-01-15</span><span class="space"> </span><span>12:35:00&#39;,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.4084</span><span class="space"> </span><span>39.9103)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>92.30),</span></span>
<span class="line"><span>(&#39;2024-01-15</span><span class="space"> </span><span>12:40:00&#39;,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.4064</span><span class="space"> </span><span>39.9083)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>76.80),</span></span>
<span class="line"><span>(&#39;2024-01-15</span><span class="space"> </span><span>18:30:00&#39;,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.4174</span><span class="space"> </span><span>39.9193)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>156.20),</span></span>
<span class="line"><span>(&#39;2024-01-15</span><span class="space"> </span><span>18:35:00&#39;,</span><span class="space"> </span><span>ST_GeomFromText(&#39;POINT(116.4184</span><span class="space"> </span><span>39.9183)&#39;,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>134.70);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>创建网格进行热力图分析</span></span>
<span class="line"><span>WITH</span><span class="space"> </span><span>grid</span><span class="space"> </span><span>AS</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>i,</span><span class="space"> </span><span>j,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_MakeEnvelope(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>116.40</span><span class="space"> </span><span>+</span><span class="space"> </span><span>(i</span><span class="space"> </span><span>*</span><span class="space"> </span><span>0.01),</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>39.90</span><span class="space"> </span><span>+</span><span class="space"> </span><span>(j</span><span class="space"> </span><span>*</span><span class="space"> </span><span>0.01),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>116.40</span><span class="space"> </span><span>+</span><span class="space"> </span><span>((i</span><span class="space"> </span><span>+</span><span class="space"> </span><span>1)</span><span class="space"> </span><span>*</span><span class="space"> </span><span>0.01),</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>39.90</span><span class="space"> </span><span>+</span><span class="space"> </span><span>((j</span><span class="space"> </span><span>+</span><span class="space"> </span><span>1)</span><span class="space"> </span><span>*</span><span class="space"> </span><span>0.01),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>4326</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>grid_cell</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>generate_series(0,</span><span class="space"> </span><span>2)</span><span class="space"> </span><span>i,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>generate_series(0,</span><span class="space"> </span><span>2)</span><span class="space"> </span><span>j</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>g.i,</span><span class="space"> </span><span>g.j,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>COUNT(o.id)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>order_count,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>COALESCE(SUM(o.order_value),</span><span class="space"> </span><span>0)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>total_value,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_AsText(ST_Centroid(g.grid_cell))</span><span class="space"> </span><span>as</span><span class="space"> </span><span>grid_center</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>grid</span><span class="space"> </span><span>g</span></span>
<span class="line"><span>LEFT</span><span class="space"> </span><span>JOIN</span><span class="space"> </span><span>delivery_orders</span><span class="space"> </span><span>o</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>ST_Contains(g.grid_cell,</span><span class="space"> </span><span>o.delivery_location)</span></span>
<span class="line"><span>GROUP</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>g.i,</span><span class="space"> </span><span>g.j,</span><span class="space"> </span><span>g.grid_cell</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>order_count</span><span class="space"> </span><span>DESC;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-扩展生态系统" tabindex="-1"><a class="header-anchor" href="#_5-扩展生态系统"><span>5. 扩展生态系统</span></a></h2><p>PostgreSQL的扩展机制是其最强大的特性之一，允许用户轻松添加新功能而无需修改核心代码。</p><h3 id="pg-stat-statements-性能监控" tabindex="-1"><a class="header-anchor" href="#pg-stat-statements-性能监控"><span>pg_stat_statements（性能监控）</span></a></h3><p>这个扩展提供了查询性能统计信息，是数据库性能调优的利器。</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>启用扩展</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>EXTENSION</span><span class="space"> </span><span>pg_stat_statements;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>查看最耗时的查询</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>query,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>calls,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>total_time,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>mean_time,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>rows,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>100.0</span><span class="space"> </span><span>*</span><span class="space"> </span><span>shared_blks_hit</span><span class="space"> </span><span>/</span><span class="space"> </span><span>nullif(shared_blks_hit</span><span class="space"> </span><span>+</span><span class="space"> </span><span>shared_blks_read,</span><span class="space"> </span><span>0)</span><span class="space"> </span><span>AS</span><span class="space"> </span><span>hit_percent</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>pg_stat_statements</span><span class="space"> </span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>total_time</span><span class="space"> </span><span>DESC</span><span class="space"> </span></span>
<span class="line"><span>LIMIT</span><span class="space"> </span><span>10;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>查看最频繁执行的查询</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>query,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>calls,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>total_time,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>mean_time</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>pg_stat_statements</span><span class="space"> </span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>calls</span><span class="space"> </span><span>DESC</span><span class="space"> </span></span>
<span class="line"><span>LIMIT</span><span class="space"> </span><span>10;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>重置统计信息</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>pg_stat_statements_reset();</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="pg-trgm-模糊匹配" tabindex="-1"><a class="header-anchor" href="#pg-trgm-模糊匹配"><span>pg_trgm（模糊匹配）</span></a></h3><p>提供三元组（trigram）相似度匹配，支持模糊搜索和相似度查询。</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>启用扩展</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>EXTENSION</span><span class="space"> </span><span>pg_trgm;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>创建测试表</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>products_search</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name</span><span class="space"> </span><span>VARCHAR(200),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>description</span><span class="space"> </span><span>TEXT</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>products_search</span><span class="space"> </span><span>(name,</span><span class="space"> </span><span>description)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;iPhone</span><span class="space"> </span><span>15</span><span class="space"> </span><span>Pro</span><span class="space"> </span><span>Max&#39;,</span><span class="space"> </span><span>&#39;Apple最新旗舰手机，配备A17</span><span class="space"> </span><span>Pro芯片&#39;),</span></span>
<span class="line"><span>(&#39;Samsung</span><span class="space"> </span><span>Galaxy</span><span class="space"> </span><span>S24&#39;,</span><span class="space"> </span><span>&#39;三星最新Android旗舰，拍照功能强大&#39;),</span></span>
<span class="line"><span>(&#39;MacBook</span><span class="space"> </span><span>Pro</span><span class="space"> </span><span>M3&#39;,</span><span class="space"> </span><span>&#39;Apple专业级笔记本电脑&#39;),</span></span>
<span class="line"><span>(&#39;ThinkPad</span><span class="space"> </span><span>X1</span><span class="space"> </span><span>Carbon&#39;,</span><span class="space"> </span><span>&#39;联想商务笔记本电脑&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>创建GIN索引支持模糊搜索</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_products_name_gin</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>products_search</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>GIN</span><span class="space"> </span><span>(name</span><span class="space"> </span><span>gin_trgm_ops);</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_products_desc_gin</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>products_search</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>GIN</span><span class="space"> </span><span>(description</span><span class="space"> </span><span>gin_trgm_ops);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>相似度搜索</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>similarity(name,</span><span class="space"> </span><span>&#39;iphone&#39;)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>name_similarity,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>similarity(description,</span><span class="space"> </span><span>&#39;手机&#39;)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>desc_similarity</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>products_search</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>name</span><span class="space"> </span><span>%</span><span class="space"> </span><span>&#39;iphone&#39;</span><span class="space"> </span><span>OR</span><span class="space"> </span><span>description</span><span class="space"> </span><span>%</span><span class="space"> </span><span>&#39;手机&#39;</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>greatest(similarity(name,</span><span class="space"> </span><span>&#39;iphone&#39;),</span><span class="space"> </span><span>similarity(description,</span><span class="space"> </span><span>&#39;手机&#39;))</span><span class="space"> </span><span>DESC;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>模糊匹配查询</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>name,</span><span class="space"> </span><span>description</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>products_search</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>name</span><span class="space"> </span><span>ILIKE</span><span class="space"> </span><span>&#39;%phone%&#39;</span><span class="space"> </span><span>OR</span><span class="space"> </span><span>description</span><span class="space"> </span><span>ILIKE</span><span class="space"> </span><span>&#39;%手机%&#39;;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="uuid-ossp-uuid生成" tabindex="-1"><a class="header-anchor" href="#uuid-ossp-uuid生成"><span>uuid-ossp（UUID生成）</span></a></h3><p>提供多种UUID生成函数，在分布式系统中非常有用。</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>启用扩展</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>EXTENSION</span><span class="space"> </span><span>&quot;uuid-ossp&quot;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>生成不同类型的UUID</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>uuid_generate_v1()</span><span class="space"> </span><span>as</span><span class="space"> </span><span>uuid_v1,</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>基于时间戳和MAC地址</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>uuid_generate_v4()</span><span class="space"> </span><span>as</span><span class="space"> </span><span>uuid_v4;</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>随机UUID</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>在表中使用UUID作为主键</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>distributed_users</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>UUID</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY</span><span class="space"> </span><span>DEFAULT</span><span class="space"> </span><span>uuid_generate_v4(),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>username</span><span class="space"> </span><span>VARCHAR(50)</span><span class="space"> </span><span>UNIQUE</span><span class="space"> </span><span>NOT</span><span class="space"> </span><span>NULL,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>email</span><span class="space"> </span><span>VARCHAR(100)</span><span class="space"> </span><span>UNIQUE</span><span class="space"> </span><span>NOT</span><span class="space"> </span><span>NULL,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>created_at</span><span class="space"> </span><span>TIMESTAMP</span><span class="space"> </span><span>DEFAULT</span><span class="space"> </span><span>NOW()</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>distributed_users</span><span class="space"> </span><span>(username,</span><span class="space"> </span><span>email)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;user1&#39;,</span><span class="space"> </span><span>&#39;user1@example.com&#39;),</span></span>
<span class="line"><span>(&#39;user2&#39;,</span><span class="space"> </span><span>&#39;user2@example.com&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>*</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>distributed_users;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-高级索引类型" tabindex="-1"><a class="header-anchor" href="#_6-高级索引类型"><span>6. 高级索引类型</span></a></h2><p>PostgreSQL支持多种高级索引类型，每种都针对特定的查询模式进行了优化。</p><h3 id="gin索引-倒排索引" tabindex="-1"><a class="header-anchor" href="#gin索引-倒排索引"><span>GIN索引（倒排索引）</span></a></h3><p>GIN（Generalized Inverted Index）索引特别适合包含多个值的数据类型，如数组、JSONB、全文搜索等。</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>为JSONB字段创建GIN索引</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>user_profiles</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>username</span><span class="space"> </span><span>VARCHAR(50),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>profile</span><span class="space"> </span><span>JSONB,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>tags</span><span class="space"> </span><span>TEXT[]</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>user_profiles</span><span class="space"> </span><span>(username,</span><span class="space"> </span><span>profile,</span><span class="space"> </span><span>tags)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;alice&#39;,</span><span class="space"> </span><span>&#39;{&quot;age&quot;:</span><span class="space"> </span><span>25,</span><span class="space"> </span><span>&quot;city&quot;:</span><span class="space"> </span><span>&quot;北京&quot;,</span><span class="space"> </span><span>&quot;interests&quot;:</span><span class="space"> </span><span>[&quot;编程&quot;,</span><span class="space"> </span><span>&quot;音乐&quot;,</span><span class="space"> </span><span>&quot;旅行&quot;]}&#39;,</span><span class="space"> </span><span>ARRAY[&#39;developer&#39;,</span><span class="space"> </span><span>&#39;music-lover&#39;]),</span></span>
<span class="line"><span>(&#39;bob&#39;,</span><span class="space"> </span><span>&#39;{&quot;age&quot;:</span><span class="space"> </span><span>30,</span><span class="space"> </span><span>&quot;city&quot;:</span><span class="space"> </span><span>&quot;上海&quot;,</span><span class="space"> </span><span>&quot;interests&quot;:</span><span class="space"> </span><span>[&quot;摄影&quot;,</span><span class="space"> </span><span>&quot;运动&quot;]}&#39;,</span><span class="space"> </span><span>ARRAY[&#39;photographer&#39;,</span><span class="space"> </span><span>&#39;athlete&#39;]),</span></span>
<span class="line"><span>(&#39;charlie&#39;,</span><span class="space"> </span><span>&#39;{&quot;age&quot;:</span><span class="space"> </span><span>28,</span><span class="space"> </span><span>&quot;city&quot;:</span><span class="space"> </span><span>&quot;深圳&quot;,</span><span class="space"> </span><span>&quot;interests&quot;:</span><span class="space"> </span><span>[&quot;编程&quot;,</span><span class="space"> </span><span>&quot;游戏&quot;]}&#39;,</span><span class="space"> </span><span>ARRAY[&#39;developer&#39;,</span><span class="space"> </span><span>&#39;gamer&#39;]);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>创建GIN索引</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_profile_gin</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>user_profiles</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>GIN</span><span class="space"> </span><span>(profile);</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_tags_gin</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>user_profiles</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>GIN</span><span class="space"> </span><span>(tags);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>高效的JSONB查询</span></span>
<span class="line"><span>EXPLAIN</span><span class="space"> </span><span>(ANALYZE,</span><span class="space"> </span><span>BUFFERS)</span><span class="space"> </span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>username</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>user_profiles</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>profile</span><span class="space"> </span><span>@&gt;</span><span class="space"> </span><span>&#39;{&quot;interests&quot;:</span><span class="space"> </span><span>[&quot;编程&quot;]}&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>数组查询</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>username</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>user_profiles</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>tags</span><span class="space"> </span><span>&amp;&amp;</span><span class="space"> </span><span>ARRAY[&#39;developer&#39;];</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>JSON路径查询</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>username,</span><span class="space"> </span><span>profile-&gt;&#39;city&#39;</span><span class="space"> </span><span>as</span><span class="space"> </span><span>city</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>user_profiles</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>profile-&gt;&gt;&#39;city&#39;</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;北京&#39;;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="gist索引-通用搜索树" tabindex="-1"><a class="header-anchor" href="#gist索引-通用搜索树"><span>GiST索引（通用搜索树）</span></a></h3><p>GiST（Generalized Search Tree）索引支持多种数据类型，特别适合几何数据和范围查询。</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>为几何数据创建GiST索引（PostGIS）</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_businesses_gist</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>businesses</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>GIST</span><span class="space"> </span><span>(location);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>为范围类型创建GiST索引</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>reservations</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>room_id</span><span class="space"> </span><span>INTEGER,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>time_range</span><span class="space"> </span><span>TSRANGE,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>guest_name</span><span class="space"> </span><span>VARCHAR(100)</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>reservations</span><span class="space"> </span><span>(room_id,</span><span class="space"> </span><span>time_range,</span><span class="space"> </span><span>guest_name)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(101,</span><span class="space"> </span><span>&#39;[2024-01-15</span><span class="space"> </span><span>14:00,</span><span class="space"> </span><span>2024-01-15</span><span class="space"> </span><span>16:00)&#39;,</span><span class="space"> </span><span>&#39;张三&#39;),</span></span>
<span class="line"><span>(102,</span><span class="space"> </span><span>&#39;[2024-01-15</span><span class="space"> </span><span>15:00,</span><span class="space"> </span><span>2024-01-15</span><span class="space"> </span><span>17:00)&#39;,</span><span class="space"> </span><span>&#39;李四&#39;),</span></span>
<span class="line"><span>(101,</span><span class="space"> </span><span>&#39;[2024-01-15</span><span class="space"> </span><span>18:00,</span><span class="space"> </span><span>2024-01-15</span><span class="space"> </span><span>20:00)&#39;,</span><span class="space"> </span><span>&#39;王五&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_reservations_time</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>reservations</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>GIST</span><span class="space"> </span><span>(time_range);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>查找时间冲突的预订</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>*</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>reservations</span><span class="space"> </span><span>r1</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>EXISTS</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SELECT</span><span class="space"> </span><span>1</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>reservations</span><span class="space"> </span><span>r2</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>r1.room_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>r2.room_id</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>AND</span><span class="space"> </span><span>r1.id</span><span class="space"> </span><span>!=</span><span class="space"> </span><span>r2.id</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>AND</span><span class="space"> </span><span>r1.time_range</span><span class="space"> </span><span>&amp;&amp;</span><span class="space"> </span><span>r2.time_range</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>查找特定时间段的可用房间</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>DISTINCT</span><span class="space"> </span><span>room_id</span><span class="space"> </span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>reservations</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>NOT</span><span class="space"> </span><span>time_range</span><span class="space"> </span><span>&amp;&amp;</span><span class="space"> </span><span>&#39;[2024-01-15</span><span class="space"> </span><span>15:30,</span><span class="space"> </span><span>2024-01-15</span><span class="space"> </span><span>16:30)&#39;::tsrange;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="brin索引-块范围索引" tabindex="-1"><a class="header-anchor" href="#brin索引-块范围索引"><span>BRIN索引（块范围索引）</span></a></h3><p>BRIN（Block Range Index）索引适合大表中有序或半有序的数据，占用空间小，维护成本低。</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>创建时序数据表</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>sensor_data</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>BIGSERIAL,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>sensor_id</span><span class="space"> </span><span>INTEGER,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>timestamp</span><span class="space"> </span><span>TIMESTAMP,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>temperature</span><span class="space"> </span><span>DECIMAL(5,2),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>humidity</span><span class="space"> </span><span>DECIMAL(5,2)</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>插入大量时序数据</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>sensor_data</span><span class="space"> </span><span>(sensor_id,</span><span class="space"> </span><span>timestamp,</span><span class="space"> </span><span>temperature,</span><span class="space"> </span><span>humidity)</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>(random()</span><span class="space"> </span><span>*</span><span class="space"> </span><span>100)::INTEGER,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&#39;2024-01-01&#39;::timestamp</span><span class="space"> </span><span>+</span><span class="space"> </span><span>(i</span><span class="space"> </span><span>||</span><span class="space"> </span><span>&#39;</span><span class="space"> </span><span>seconds&#39;)::interval,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>20</span><span class="space"> </span><span>+</span><span class="space"> </span><span>(random()</span><span class="space"> </span><span>*</span><span class="space"> </span><span>15),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>40</span><span class="space"> </span><span>+</span><span class="space"> </span><span>(random()</span><span class="space"> </span><span>*</span><span class="space"> </span><span>30)</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>generate_series(1,</span><span class="space"> </span><span>1000000)</span><span class="space"> </span><span>i;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>创建BRIN索引</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_sensor_timestamp_brin</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>sensor_data</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>BRIN</span><span class="space"> </span><span>(timestamp);</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_sensor_temp_brin</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>sensor_data</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>BRIN</span><span class="space"> </span><span>(temperature);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>范围查询性能测试</span></span>
<span class="line"><span>EXPLAIN</span><span class="space"> </span><span>(ANALYZE,</span><span class="space"> </span><span>BUFFERS)</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>AVG(temperature),</span><span class="space"> </span><span>AVG(humidity)</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>sensor_data</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>timestamp</span><span class="space"> </span><span>BETWEEN</span><span class="space"> </span><span>&#39;2024-01-01</span><span class="space"> </span><span>10:00:00&#39;</span><span class="space"> </span><span>AND</span><span class="space"> </span><span>&#39;2024-01-01</span><span class="space"> </span><span>12:00:00&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>比较索引大小</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>schemaname,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>tablename,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>indexname,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>pg_size_pretty(pg_relation_size(indexname::regclass))</span><span class="space"> </span><span>as</span><span class="space"> </span><span>index_size</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>pg_indexes</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>tablename</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;sensor_data&#39;;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-并发控制mvcc" tabindex="-1"><a class="header-anchor" href="#_7-并发控制mvcc"><span>7. 并发控制MVCC</span></a></h2><p>PostgreSQL使用多版本并发控制（MVCC），这是其相比MySQL的重要优势之一。</p><h3 id="mvcc原理" tabindex="-1"><a class="header-anchor" href="#mvcc原理"><span>MVCC原理</span></a></h3><p>MVCC允许读操作不阻塞写操作，写操作也不阻塞读操作，大大提高了并发性能。</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>创建测试表</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>account_balance</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>account_id</span><span class="space"> </span><span>VARCHAR(20),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>balance</span><span class="space"> </span><span>DECIMAL(15,2),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>last_updated</span><span class="space"> </span><span>TIMESTAMP</span><span class="space"> </span><span>DEFAULT</span><span class="space"> </span><span>NOW()</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>account_balance</span><span class="space"> </span><span>(account_id,</span><span class="space"> </span><span>balance)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;ACC001&#39;,</span><span class="space"> </span><span>1000.00),</span></span>
<span class="line"><span>(&#39;ACC002&#39;,</span><span class="space"> </span><span>2000.00);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>演示事务隔离</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>会话1：开始事务但不提交</span></span>
<span class="line"><span>BEGIN;</span></span>
<span class="line"><span>UPDATE</span><span class="space"> </span><span>account_balance</span><span class="space"> </span><span>SET</span><span class="space"> </span><span>balance</span><span class="space"> </span><span>=</span><span class="space"> </span><span>balance</span><span class="space"> </span><span>-</span><span class="space"> </span><span>100</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>account_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;ACC001&#39;;</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>此时不要COMMIT</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>会话2：在另一个连接中查询</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>*</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>account_balance</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>account_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;ACC001&#39;;</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>仍然看到原始值1000.00，因为会话1的事务未提交</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>会话1：提交事务</span></span>
<span class="line"><span>COMMIT;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>会话2：再次查询</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>*</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>account_balance</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>account_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;ACC001&#39;;</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>现在看到更新后的值900.00</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="事务隔离级别" tabindex="-1"><a class="header-anchor" href="#事务隔离级别"><span>事务隔离级别</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>查看当前隔离级别</span></span>
<span class="line"><span>SHOW</span><span class="space"> </span><span>transaction_isolation;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>设置不同的隔离级别</span></span>
<span class="line"><span>BEGIN</span><span class="space"> </span><span>ISOLATION</span><span class="space"> </span><span>LEVEL</span><span class="space"> </span><span>READ</span><span class="space"> </span><span>COMMITTED;</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>或者</span></span>
<span class="line"><span>BEGIN</span><span class="space"> </span><span>ISOLATION</span><span class="space"> </span><span>LEVEL</span><span class="space"> </span><span>REPEATABLE</span><span class="space"> </span><span>READ;</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>或者</span></span>
<span class="line"><span>BEGIN</span><span class="space"> </span><span>ISOLATION</span><span class="space"> </span><span>LEVEL</span><span class="space"> </span><span>SERIALIZABLE;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>演示可重复读</span></span>
<span class="line"><span>BEGIN</span><span class="space"> </span><span>ISOLATION</span><span class="space"> </span><span>LEVEL</span><span class="space"> </span><span>REPEATABLE</span><span class="space"> </span><span>READ;</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>balance</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>account_balance</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>account_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;ACC001&#39;;</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>即使其他事务修改了数据，在当前事务中多次读取会得到相同结果</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>balance</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>account_balance</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>account_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;ACC001&#39;;</span></span>
<span class="line"><span>COMMIT;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="死锁检测和处理" tabindex="-1"><a class="header-anchor" href="#死锁检测和处理"><span>死锁检测和处理</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>PostgreSQL自动检测死锁并回滚其中一个事务</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>创建死锁场景的示例</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>会话1</span></span>
<span class="line"><span>BEGIN;</span></span>
<span class="line"><span>UPDATE</span><span class="space"> </span><span>account_balance</span><span class="space"> </span><span>SET</span><span class="space"> </span><span>balance</span><span class="space"> </span><span>=</span><span class="space"> </span><span>balance</span><span class="space"> </span><span>-</span><span class="space"> </span><span>50</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>account_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;ACC001&#39;;</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>等待一会儿，然后执行：</span></span>
<span class="line"><span>UPDATE</span><span class="space"> </span><span>account_balance</span><span class="space"> </span><span>SET</span><span class="space"> </span><span>balance</span><span class="space"> </span><span>=</span><span class="space"> </span><span>balance</span><span class="space"> </span><span>+</span><span class="space"> </span><span>50</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>account_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;ACC002&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>会话2（同时执行）</span></span>
<span class="line"><span>BEGIN;</span></span>
<span class="line"><span>UPDATE</span><span class="space"> </span><span>account_balance</span><span class="space"> </span><span>SET</span><span class="space"> </span><span>balance</span><span class="space"> </span><span>=</span><span class="space"> </span><span>balance</span><span class="space"> </span><span>-</span><span class="space"> </span><span>30</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>account_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;ACC002&#39;;</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>然后执行：</span></span>
<span class="line"><span>UPDATE</span><span class="space"> </span><span>account_balance</span><span class="space"> </span><span>SET</span><span class="space"> </span><span>balance</span><span class="space"> </span><span>=</span><span class="space"> </span><span>balance</span><span class="space"> </span><span>+</span><span class="space"> </span><span>30</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>account_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;ACC001&#39;;</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>PostgreSQL会检测到死锁并自动回滚其中一个事务</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8-分区表支持" tabindex="-1"><a class="header-anchor" href="#_8-分区表支持"><span>8. 分区表支持</span></a></h2><p>PostgreSQL提供了强大的表分区功能，可以显著提高大表的查询性能。</p><h3 id="声明式分区" tabindex="-1"><a class="header-anchor" href="#声明式分区"><span>声明式分区</span></a></h3><h4 id="范围分区" tabindex="-1"><a class="header-anchor" href="#范围分区"><span>范围分区</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>创建按日期范围分区的表</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>sales_data</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>BIGSERIAL,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>sale_date</span><span class="space"> </span><span>DATE</span><span class="space"> </span><span>NOT</span><span class="space"> </span><span>NULL,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>product_id</span><span class="space"> </span><span>INTEGER,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>amount</span><span class="space"> </span><span>DECIMAL(10,2),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>customer_id</span><span class="space"> </span><span>INTEGER</span></span>
<span class="line"><span>)</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>RANGE</span><span class="space"> </span><span>(sale_date);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>创建分区</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>sales_2024_q1</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>OF</span><span class="space"> </span><span>sales_data</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FOR</span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>(&#39;2024-01-01&#39;)</span><span class="space"> </span><span>TO</span><span class="space"> </span><span>(&#39;2024-04-01&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>sales_2024_q2</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>OF</span><span class="space"> </span><span>sales_data</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FOR</span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>(&#39;2024-04-01&#39;)</span><span class="space"> </span><span>TO</span><span class="space"> </span><span>(&#39;2024-07-01&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>sales_2024_q3</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>OF</span><span class="space"> </span><span>sales_data</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FOR</span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>(&#39;2024-07-01&#39;)</span><span class="space"> </span><span>TO</span><span class="space"> </span><span>(&#39;2024-10-01&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>sales_2024_q4</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>OF</span><span class="space"> </span><span>sales_data</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FOR</span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>(&#39;2024-10-01&#39;)</span><span class="space"> </span><span>TO</span><span class="space"> </span><span>(&#39;2025-01-01&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>插入数据会自动路由到正确的分区</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>sales_data</span><span class="space"> </span><span>(sale_date,</span><span class="space"> </span><span>product_id,</span><span class="space"> </span><span>amount,</span><span class="space"> </span><span>customer_id)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;2024-02-15&#39;,</span><span class="space"> </span><span>101,</span><span class="space"> </span><span>299.99,</span><span class="space"> </span><span>1001),</span></span>
<span class="line"><span>(&#39;2024-05-20&#39;,</span><span class="space"> </span><span>102,</span><span class="space"> </span><span>199.99,</span><span class="space"> </span><span>1002),</span></span>
<span class="line"><span>(&#39;2024-08-10&#39;,</span><span class="space"> </span><span>103,</span><span class="space"> </span><span>399.99,</span><span class="space"> </span><span>1003),</span></span>
<span class="line"><span>(&#39;2024-11-25&#39;,</span><span class="space"> </span><span>104,</span><span class="space"> </span><span>499.99,</span><span class="space"> </span><span>1004);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>查询会自动使用分区裁剪</span></span>
<span class="line"><span>EXPLAIN</span><span class="space"> </span><span>(ANALYZE,</span><span class="space"> </span><span>BUFFERS)</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>*</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>sales_data</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>sale_date</span><span class="space"> </span><span>BETWEEN</span><span class="space"> </span><span>&#39;2024-02-01&#39;</span><span class="space"> </span><span>AND</span><span class="space"> </span><span>&#39;2024-02-28&#39;;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="列表分区" tabindex="-1"><a class="header-anchor" href="#列表分区"><span>列表分区</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>按地区分区</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>customer_data</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>BIGSERIAL,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>customer_name</span><span class="space"> </span><span>VARCHAR(100),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>region</span><span class="space"> </span><span>VARCHAR(20)</span><span class="space"> </span><span>NOT</span><span class="space"> </span><span>NULL,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>registration_date</span><span class="space"> </span><span>DATE,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>status</span><span class="space"> </span><span>VARCHAR(20)</span></span>
<span class="line"><span>)</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>LIST</span><span class="space"> </span><span>(region);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>创建地区分区</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>customer_data_north</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>OF</span><span class="space"> </span><span>customer_data</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FOR</span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>IN</span><span class="space"> </span><span>(&#39;华北&#39;,</span><span class="space"> </span><span>&#39;东北&#39;,</span><span class="space"> </span><span>&#39;西北&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>customer_data_south</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>OF</span><span class="space"> </span><span>customer_data</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FOR</span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>IN</span><span class="space"> </span><span>(&#39;华南&#39;,</span><span class="space"> </span><span>&#39;华中&#39;,</span><span class="space"> </span><span>&#39;西南&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>customer_data_east</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>OF</span><span class="space"> </span><span>customer_data</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FOR</span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>IN</span><span class="space"> </span><span>(&#39;华东&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>插入数据</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>customer_data</span><span class="space"> </span><span>(customer_name,</span><span class="space"> </span><span>region,</span><span class="space"> </span><span>registration_date,</span><span class="space"> </span><span>status)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;张三&#39;,</span><span class="space"> </span><span>&#39;华北&#39;,</span><span class="space"> </span><span>&#39;2024-01-15&#39;,</span><span class="space"> </span><span>&#39;active&#39;),</span></span>
<span class="line"><span>(&#39;李四&#39;,</span><span class="space"> </span><span>&#39;华南&#39;,</span><span class="space"> </span><span>&#39;2024-01-20&#39;,</span><span class="space"> </span><span>&#39;active&#39;),</span></span>
<span class="line"><span>(&#39;王五&#39;,</span><span class="space"> </span><span>&#39;华东&#39;,</span><span class="space"> </span><span>&#39;2024-01-25&#39;,</span><span class="space"> </span><span>&#39;inactive&#39;);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="哈希分区" tabindex="-1"><a class="header-anchor" href="#哈希分区"><span>哈希分区</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>按用户ID哈希分区</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>user_activities</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>BIGSERIAL,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>user_id</span><span class="space"> </span><span>BIGINT</span><span class="space"> </span><span>NOT</span><span class="space"> </span><span>NULL,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>activity_type</span><span class="space"> </span><span>VARCHAR(50),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>activity_time</span><span class="space"> </span><span>TIMESTAMP,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>details</span><span class="space"> </span><span>JSONB</span></span>
<span class="line"><span>)</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>HASH</span><span class="space"> </span><span>(user_id);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>创建哈希分区</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>user_activities_0</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>OF</span><span class="space"> </span><span>user_activities</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FOR</span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>WITH</span><span class="space"> </span><span>(modulus</span><span class="space"> </span><span>4,</span><span class="space"> </span><span>remainder</span><span class="space"> </span><span>0);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>user_activities_1</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>OF</span><span class="space"> </span><span>user_activities</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FOR</span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>WITH</span><span class="space"> </span><span>(modulus</span><span class="space"> </span><span>4,</span><span class="space"> </span><span>remainder</span><span class="space"> </span><span>1);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>user_activities_2</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>OF</span><span class="space"> </span><span>user_activities</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FOR</span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>WITH</span><span class="space"> </span><span>(modulus</span><span class="space"> </span><span>4,</span><span class="space"> </span><span>remainder</span><span class="space"> </span><span>2);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>user_activities_3</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>OF</span><span class="space"> </span><span>user_activities</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FOR</span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>WITH</span><span class="space"> </span><span>(modulus</span><span class="space"> </span><span>4,</span><span class="space"> </span><span>remainder</span><span class="space"> </span><span>3);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9-外部数据包装器-fdw" tabindex="-1"><a class="header-anchor" href="#_9-外部数据包装器-fdw"><span>9. 外部数据包装器（FDW）</span></a></h2><p>FDW允许PostgreSQL访问外部数据源，就像访问本地表一样。</p><h3 id="连接其他数据库" tabindex="-1"><a class="header-anchor" href="#连接其他数据库"><span>连接其他数据库</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>安装并启用postgres_fdw扩展</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>EXTENSION</span><span class="space"> </span><span>postgres_fdw;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>创建外部服务器</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>SERVER</span><span class="space"> </span><span>remote_pg_server</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FOREIGN</span><span class="space"> </span><span>DATA</span><span class="space"> </span><span>WRAPPER</span><span class="space"> </span><span>postgres_fdw</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>OPTIONS</span><span class="space"> </span><span>(host</span><span class="space"> </span><span>&#39;remote-host.example.com&#39;,</span><span class="space"> </span><span>port</span><span class="space"> </span><span>&#39;5432&#39;,</span><span class="space"> </span><span>dbname</span><span class="space"> </span><span>&#39;remote_db&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>创建用户映射</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>USER</span><span class="space"> </span><span>MAPPING</span><span class="space"> </span><span>FOR</span><span class="space"> </span><span>current_user</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SERVER</span><span class="space"> </span><span>remote_pg_server</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>OPTIONS</span><span class="space"> </span><span>(user</span><span class="space"> </span><span>&#39;remote_user&#39;,</span><span class="space"> </span><span>password</span><span class="space"> </span><span>&#39;remote_password&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>创建外部表</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>FOREIGN</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>remote_users</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>INTEGER,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>username</span><span class="space"> </span><span>VARCHAR(50),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>email</span><span class="space"> </span><span>VARCHAR(100),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>created_at</span><span class="space"> </span><span>TIMESTAMP</span></span>
<span class="line"><span>)</span><span class="space"> </span><span>SERVER</span><span class="space"> </span><span>remote_pg_server</span></span>
<span class="line"><span>OPTIONS</span><span class="space"> </span><span>(schema_name</span><span class="space"> </span><span>&#39;public&#39;,</span><span class="space"> </span><span>table_name</span><span class="space"> </span><span>&#39;users&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>查询外部表</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>*</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>remote_users</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>created_at</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>&#39;2024-01-01&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>本地表和外部表的联合查询</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>l.order_id,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>l.amount,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>r.username,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>r.email</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>local_orders</span><span class="space"> </span><span>l</span></span>
<span class="line"><span>JOIN</span><span class="space"> </span><span>remote_users</span><span class="space"> </span><span>r</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>l.user_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>r.id</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>l.order_date</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>&#39;2024-01-01&#39;;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="文件系统访问" tabindex="-1"><a class="header-anchor" href="#文件系统访问"><span>文件系统访问</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>启用file_fdw扩展</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>EXTENSION</span><span class="space"> </span><span>file_fdw;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>创建文件服务器</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>SERVER</span><span class="space"> </span><span>file_server</span><span class="space"> </span><span>FOREIGN</span><span class="space"> </span><span>DATA</span><span class="space"> </span><span>WRAPPER</span><span class="space"> </span><span>file_fdw;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>创建外部表读取CSV文件</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>FOREIGN</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>csv_import</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>INTEGER,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name</span><span class="space"> </span><span>VARCHAR(100),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>category</span><span class="space"> </span><span>VARCHAR(50),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>price</span><span class="space"> </span><span>DECIMAL(10,2)</span></span>
<span class="line"><span>)</span><span class="space"> </span><span>SERVER</span><span class="space"> </span><span>file_server</span></span>
<span class="line"><span>OPTIONS</span><span class="space"> </span><span>(filename</span><span class="space"> </span><span>&#39;/path/to/products.csv&#39;,</span><span class="space"> </span><span>format</span><span class="space"> </span><span>&#39;csv&#39;,</span><span class="space"> </span><span>header</span><span class="space"> </span><span>&#39;true&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>查询CSV数据</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>category,</span><span class="space"> </span><span>AVG(price)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>avg_price</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>csv_import</span></span>
<span class="line"><span>GROUP</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>category;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>将CSV数据导入到本地表</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>products</span><span class="space"> </span><span>(name,</span><span class="space"> </span><span>category,</span><span class="space"> </span><span>price)</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>name,</span><span class="space"> </span><span>category,</span><span class="space"> </span><span>price</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>csv_import;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_10-存储过程和函数" tabindex="-1"><a class="header-anchor" href="#_10-存储过程和函数"><span>10. 存储过程和函数</span></a></h2><p>PostgreSQL支持多种编程语言编写存储过程和函数。</p><h3 id="pl-pgsql" tabindex="-1"><a class="header-anchor" href="#pl-pgsql"><span>PL/pgSQL</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>创建复杂的存储过程</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>OR</span><span class="space"> </span><span>REPLACE</span><span class="space"> </span><span>FUNCTION</span><span class="space"> </span><span>calculate_customer_stats(customer_id_param</span><span class="space"> </span><span>INTEGER)</span></span>
<span class="line"><span>RETURNS</span><span class="space"> </span><span>TABLE(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>total_orders</span><span class="space"> </span><span>INTEGER,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>total_amount</span><span class="space"> </span><span>DECIMAL(15,2),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>avg_order_amount</span><span class="space"> </span><span>DECIMAL(15,2),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>last_order_date</span><span class="space"> </span><span>DATE,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>customer_tier</span><span class="space"> </span><span>VARCHAR(20)</span></span>
<span class="line"><span>)</span><span class="space"> </span><span>AS</span><span class="space"> </span><span>$$</span></span>
<span class="line"><span>DECLARE</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>order_count</span><span class="space"> </span><span>INTEGER;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>total_spent</span><span class="space"> </span><span>DECIMAL(15,2);</span></span>
<span class="line"><span>BEGIN</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>计算订单统计</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SELECT</span><span class="space"> </span><span>COUNT(*),</span><span class="space"> </span><span>COALESCE(SUM(amount),</span><span class="space"> </span><span>0)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>order_count,</span><span class="space"> </span><span>total_spent</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>orders</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>customer_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>customer_id_param;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>返回结果</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>RETURN</span><span class="space"> </span><span>QUERY</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>order_count,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>total_spent,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>CASE</span><span class="space"> </span><span>WHEN</span><span class="space"> </span><span>order_count</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>0</span><span class="space"> </span><span>THEN</span><span class="space"> </span><span>total_spent</span><span class="space"> </span><span>/</span><span class="space"> </span><span>order_count</span><span class="space"> </span><span>ELSE</span><span class="space"> </span><span>0</span><span class="space"> </span><span>END,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>(SELECT</span><span class="space"> </span><span>MAX(order_date)</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>orders</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>customer_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>customer_id_param),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>CASE</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>WHEN</span><span class="space"> </span><span>total_spent</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>10000</span><span class="space"> </span><span>THEN</span><span class="space"> </span><span>&#39;VIP&#39;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>WHEN</span><span class="space"> </span><span>total_spent</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>5000</span><span class="space"> </span><span>THEN</span><span class="space"> </span><span>&#39;Gold&#39;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>WHEN</span><span class="space"> </span><span>total_spent</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>1000</span><span class="space"> </span><span>THEN</span><span class="space"> </span><span>&#39;Silver&#39;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ELSE</span><span class="space"> </span><span>&#39;Bronze&#39;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>END;</span></span>
<span class="line"><span>END;</span></span>
<span class="line"><span>$$</span><span class="space"> </span><span>LANGUAGE</span><span class="space"> </span><span>plpgsql;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>使用函数</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>*</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>calculate_customer_stats(1001);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="触发器高级应用" tabindex="-1"><a class="header-anchor" href="#触发器高级应用"><span>触发器高级应用</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>创建审计表</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>audit_log</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>BIGSERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>table_name</span><span class="space"> </span><span>VARCHAR(50),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>operation</span><span class="space"> </span><span>VARCHAR(10),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>old_data</span><span class="space"> </span><span>JSONB,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>new_data</span><span class="space"> </span><span>JSONB,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>changed_by</span><span class="space"> </span><span>VARCHAR(50),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>changed_at</span><span class="space"> </span><span>TIMESTAMP</span><span class="space"> </span><span>DEFAULT</span><span class="space"> </span><span>NOW()</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>创建通用审计触发器函数</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>OR</span><span class="space"> </span><span>REPLACE</span><span class="space"> </span><span>FUNCTION</span><span class="space"> </span><span>audit_trigger_function()</span></span>
<span class="line"><span>RETURNS</span><span class="space"> </span><span>TRIGGER</span><span class="space"> </span><span>AS</span><span class="space"> </span><span>$$</span></span>
<span class="line"><span>BEGIN</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>IF</span><span class="space"> </span><span>TG_OP</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;DELETE&#39;</span><span class="space"> </span><span>THEN</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>audit_log</span><span class="space"> </span><span>(table_name,</span><span class="space"> </span><span>operation,</span><span class="space"> </span><span>old_data,</span><span class="space"> </span><span>changed_by)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>(TG_TABLE_NAME,</span><span class="space"> </span><span>TG_OP,</span><span class="space"> </span><span>row_to_json(OLD),</span><span class="space"> </span><span>current_user);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>RETURN</span><span class="space"> </span><span>OLD;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ELSIF</span><span class="space"> </span><span>TG_OP</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;UPDATE&#39;</span><span class="space"> </span><span>THEN</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>audit_log</span><span class="space"> </span><span>(table_name,</span><span class="space"> </span><span>operation,</span><span class="space"> </span><span>old_data,</span><span class="space"> </span><span>new_data,</span><span class="space"> </span><span>changed_by)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>(TG_TABLE_NAME,</span><span class="space"> </span><span>TG_OP,</span><span class="space"> </span><span>row_to_json(OLD),</span><span class="space"> </span><span>row_to_json(NEW),</span><span class="space"> </span><span>current_user);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>RETURN</span><span class="space"> </span><span>NEW;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ELSIF</span><span class="space"> </span><span>TG_OP</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;INSERT&#39;</span><span class="space"> </span><span>THEN</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>audit_log</span><span class="space"> </span><span>(table_name,</span><span class="space"> </span><span>operation,</span><span class="space"> </span><span>new_data,</span><span class="space"> </span><span>changed_by)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>(TG_TABLE_NAME,</span><span class="space"> </span><span>TG_OP,</span><span class="space"> </span><span>row_to_json(NEW),</span><span class="space"> </span><span>current_user);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>RETURN</span><span class="space"> </span><span>NEW;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>END</span><span class="space"> </span><span>IF;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>RETURN</span><span class="space"> </span><span>NULL;</span></span>
<span class="line"><span>END;</span></span>
<span class="line"><span>$$</span><span class="space"> </span><span>LANGUAGE</span><span class="space"> </span><span>plpgsql;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>为表添加审计触发器</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TRIGGER</span><span class="space"> </span><span>audit_trigger</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>AFTER</span><span class="space"> </span><span>INSERT</span><span class="space"> </span><span>OR</span><span class="space"> </span><span>UPDATE</span><span class="space"> </span><span>OR</span><span class="space"> </span><span>DELETE</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>account_balance</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FOR</span><span class="space"> </span><span>EACH</span><span class="space"> </span><span>ROW</span><span class="space"> </span><span>EXECUTE</span><span class="space"> </span><span>FUNCTION</span><span class="space"> </span><span>audit_trigger_function();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>测试审计功能</span></span>
<span class="line"><span>UPDATE</span><span class="space"> </span><span>account_balance</span><span class="space"> </span><span>SET</span><span class="space"> </span><span>balance</span><span class="space"> </span><span>=</span><span class="space"> </span><span>balance</span><span class="space"> </span><span>+</span><span class="space"> </span><span>100</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>account_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;ACC001&#39;;</span></span>
<span class="line"><span>DELETE</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>account_balance</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>account_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;ACC002&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>查看审计日志</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>*</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>audit_log</span><span class="space"> </span><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>changed_at</span><span class="space"> </span><span>DESC;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_11-性能优化" tabindex="-1"><a class="header-anchor" href="#_11-性能优化"><span>11. 性能优化</span></a></h2><p>PostgreSQL提供了丰富的性能优化工具和技术。</p><h3 id="查询计划分析" tabindex="-1"><a class="header-anchor" href="#查询计划分析"><span>查询计划分析</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>使用EXPLAIN分析查询计划</span></span>
<span class="line"><span>EXPLAIN</span><span class="space"> </span><span>(ANALYZE,</span><span class="space"> </span><span>BUFFERS,</span><span class="space"> </span><span>VERBOSE)</span><span class="space"> </span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>c.customer_name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>COUNT(o.id)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>order_count,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SUM(o.amount)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>total_amount</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>customers</span><span class="space"> </span><span>c</span></span>
<span class="line"><span>LEFT</span><span class="space"> </span><span>JOIN</span><span class="space"> </span><span>orders</span><span class="space"> </span><span>o</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>c.id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>o.customer_id</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>c.registration_date</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>&#39;2024-01-01&#39;</span></span>
<span class="line"><span>GROUP</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>c.id,</span><span class="space"> </span><span>c.customer_name</span></span>
<span class="line"><span>HAVING</span><span class="space"> </span><span>COUNT(o.id)</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>5</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>total_amount</span><span class="space"> </span><span>DESC;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>查看查询执行统计</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>schemaname,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>tablename,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>seq_scan,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>seq_tup_read,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>idx_scan,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>idx_tup_fetch,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>n_tup_ins,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>n_tup_upd,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>n_tup_del</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>pg_stat_user_tables</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>tablename</span><span class="space"> </span><span>IN</span><span class="space"> </span><span>(&#39;customers&#39;,</span><span class="space"> </span><span>&#39;orders&#39;);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="索引优化策略" tabindex="-1"><a class="header-anchor" href="#索引优化策略"><span>索引优化策略</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>创建复合索引</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_orders_customer_date</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>orders</span><span class="space"> </span><span>(customer_id,</span><span class="space"> </span><span>order_date);</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_orders_amount_date</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>orders</span><span class="space"> </span><span>(amount,</span><span class="space"> </span><span>order_date)</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>amount</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>100;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>部分索引（条件索引）</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_active_customers</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>customers</span><span class="space"> </span><span>(registration_date)</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>status</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;active&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>表达式索引</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_customers_lower_email</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>customers</span><span class="space"> </span><span>(LOWER(email));</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_orders_year_month</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>orders</span><span class="space"> </span><span>(EXTRACT(YEAR</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>order_date),</span><span class="space"> </span><span>EXTRACT(MONTH</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>order_date));</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>查看索引使用情况</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>schemaname,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>tablename,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>indexname,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>idx_scan,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>idx_tup_read,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>idx_tup_fetch</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>pg_stat_user_indexes</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>idx_scan</span><span class="space"> </span><span>DESC;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>查找未使用的索引</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>schemaname,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>tablename,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>indexname,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>pg_size_pretty(pg_relation_size(indexname::regclass))</span><span class="space"> </span><span>as</span><span class="space"> </span><span>index_size</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>pg_stat_user_indexes</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>idx_scan</span><span class="space"> </span><span>=</span><span class="space"> </span><span>0</span></span>
<span class="line"><span>AND</span><span class="space"> </span><span>schemaname</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;public&#39;;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="配置优化" tabindex="-1"><a class="header-anchor" href="#配置优化"><span>配置优化</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>查看重要的配置参数</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>name,</span><span class="space"> </span><span>setting,</span><span class="space"> </span><span>unit,</span><span class="space"> </span><span>context</span><span class="space"> </span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>pg_settings</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>name</span><span class="space"> </span><span>IN</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&#39;shared_buffers&#39;,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&#39;effective_cache_size&#39;,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&#39;work_mem&#39;,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&#39;maintenance_work_mem&#39;,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&#39;checkpoint_completion_target&#39;,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&#39;wal_buffers&#39;,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&#39;default_statistics_target&#39;</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>查看数据库统计信息</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>datname,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>numbackends,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>xact_commit,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>xact_rollback,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>blks_read,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>blks_hit,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>temp_files,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>temp_bytes,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>deadlocks</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>pg_stat_database</span><span class="space"> </span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>datname</span><span class="space"> </span><span>=</span><span class="space"> </span><span>current_database();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>缓存命中率分析</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&#39;Buffer</span><span class="space"> </span><span>Cache</span><span class="space"> </span><span>Hit</span><span class="space"> </span><span>Rate&#39;</span><span class="space"> </span><span>as</span><span class="space"> </span><span>metric,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ROUND(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>100.0</span><span class="space"> </span><span>*</span><span class="space"> </span><span>sum(blks_hit)</span><span class="space"> </span><span>/</span><span class="space"> </span><span>(sum(blks_hit)</span><span class="space"> </span><span>+</span><span class="space"> </span><span>sum(blks_read)),</span><span class="space"> </span><span>2</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>percentage</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>pg_stat_database</span></span>
<span class="line"><span>UNION</span><span class="space"> </span><span>ALL</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&#39;Index</span><span class="space"> </span><span>Cache</span><span class="space"> </span><span>Hit</span><span class="space"> </span><span>Rate&#39;</span><span class="space"> </span><span>as</span><span class="space"> </span><span>metric,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ROUND(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>100.0</span><span class="space"> </span><span>*</span><span class="space"> </span><span>sum(idx_blks_hit)</span><span class="space"> </span><span>/</span><span class="space"> </span><span>nullif(sum(idx_blks_hit)</span><span class="space"> </span><span>+</span><span class="space"> </span><span>sum(idx_blks_read),</span><span class="space"> </span><span>0),</span><span class="space"> </span><span>2</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>percentage</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>pg_statio_user_indexes;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="vacuum和analyze优化" tabindex="-1"><a class="header-anchor" href="#vacuum和analyze优化"><span>VACUUM和ANALYZE优化</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>手动VACUUM和ANALYZE</span></span>
<span class="line"><span>VACUUM</span><span class="space"> </span><span>ANALYZE</span><span class="space"> </span><span>customers;</span></span>
<span class="line"><span>VACUUM</span><span class="space"> </span><span>ANALYZE</span><span class="space"> </span><span>orders;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>查看表的膨胀情况</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>schemaname,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>tablename,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>n_dead_tup,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>n_live_tup,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ROUND(100</span><span class="space"> </span><span>*</span><span class="space"> </span><span>n_dead_tup</span><span class="space"> </span><span>/</span><span class="space"> </span><span>(n_live_tup</span><span class="space"> </span><span>+</span><span class="space"> </span><span>n_dead_tup),</span><span class="space"> </span><span>2)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>dead_tuple_percent,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>last_vacuum,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>last_autovacuum,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>last_analyze,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>last_autoanalyze</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>pg_stat_user_tables</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>n_dead_tup</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>0</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>dead_tuple_percent</span><span class="space"> </span><span>DESC;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>配置自动VACUUM</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>在postgresql.conf中设置：</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>autovacuum</span><span class="space"> </span><span>=</span><span class="space"> </span><span>on</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>autovacuum_vacuum_threshold</span><span class="space"> </span><span>=</span><span class="space"> </span><span>50</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>autovacuum_vacuum_scale_factor</span><span class="space"> </span><span>=</span><span class="space"> </span><span>0.2</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>autovacuum_analyze_threshold</span><span class="space"> </span><span>=</span><span class="space"> </span><span>50</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>autovacuum_analyze_scale_factor</span><span class="space"> </span><span>=</span><span class="space"> </span><span>0.1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_12-企业级特性" tabindex="-1"><a class="header-anchor" href="#_12-企业级特性"><span>12. 企业级特性</span></a></h2><h3 id="流复制和高可用" tabindex="-1"><a class="header-anchor" href="#流复制和高可用"><span>流复制和高可用</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>主服务器配置</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>在postgresql.conf中：</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>wal_level</span><span class="space"> </span><span>=</span><span class="space"> </span><span>replica</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>max_wal_senders</span><span class="space"> </span><span>=</span><span class="space"> </span><span>3</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>wal_keep_segments</span><span class="space"> </span><span>=</span><span class="space"> </span><span>64</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>archive_mode</span><span class="space"> </span><span>=</span><span class="space"> </span><span>on</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>archive_command</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;cp</span><span class="space"> </span><span>%p</span><span class="space"> </span><span>/path/to/archive/%f&#39;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>创建复制用户</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>ROLE</span><span class="space"> </span><span>replicator</span><span class="space"> </span><span>WITH</span><span class="space"> </span><span>REPLICATION</span><span class="space"> </span><span>LOGIN</span><span class="space"> </span><span>PASSWORD</span><span class="space"> </span><span>&#39;replica_password&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>在pg_hba.conf中添加：</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>host</span><span class="space"> </span><span>replication</span><span class="space"> </span><span>replicator</span><span class="space"> </span><span>slave_ip/32</span><span class="space"> </span><span>md5</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>查看复制状态</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>client_addr,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>state,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>sent_lsn,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>write_lsn,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>flush_lsn,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>replay_lsn,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>write_lag,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>flush_lag,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>replay_lag</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>pg_stat_replication;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>查看WAL状态</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>pg_current_wal_lsn(),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>pg_wal_lsn_diff(pg_current_wal_lsn(),</span><span class="space"> </span><span>&#39;0/0&#39;)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>wal_bytes;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="备份和恢复" tabindex="-1"><a class="header-anchor" href="#备份和恢复"><span>备份和恢复</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>逻辑备份</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>pg_dump</span><span class="space"> </span><span>-h</span><span class="space"> </span><span>localhost</span><span class="space"> </span><span>-U</span><span class="space"> </span><span>postgres</span><span class="space"> </span><span>-d</span><span class="space"> </span><span>mydb</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>backup.sql</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>pg_dump</span><span class="space"> </span><span>-h</span><span class="space"> </span><span>localhost</span><span class="space"> </span><span>-U</span><span class="space"> </span><span>postgres</span><span class="space"> </span><span>-d</span><span class="space"> </span><span>mydb</span><span class="space"> </span><span>-t</span><span class="space"> </span><span>customers</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>customers_backup.sql</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>物理备份（基础备份）</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>pg_basebackup</span><span class="space"> </span><span>-h</span><span class="space"> </span><span>localhost</span><span class="space"> </span><span>-D</span><span class="space"> </span><span>/backup/base</span><span class="space"> </span><span>-U</span><span class="space"> </span><span>replicator</span><span class="space"> </span><span>-v</span><span class="space"> </span><span>-P</span><span class="space"> </span><span>-W</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>时间点恢复（PITR）</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>在recovery.conf中：</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>restore_command</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;cp</span><span class="space"> </span><span>/path/to/archive/%f</span><span class="space"> </span><span>%p&#39;</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>recovery_target_time</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;2024-01-15</span><span class="space"> </span><span>14:30:00&#39;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>查看备份信息</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>pg_start_backup(&#39;manual_backup&#39;,</span><span class="space"> </span><span>false,</span><span class="space"> </span><span>false);</span></span>
<span class="line"><span>--</span><span class="space"> </span><span>执行文件系统备份</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span><span>pg_stop_backup(false,</span><span class="space"> </span><span>true);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="连接池和负载均衡" tabindex="-1"><a class="header-anchor" href="#连接池和负载均衡"><span>连接池和负载均衡</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>查看当前连接</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>datname,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>usename,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>client_addr,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>state,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>query_start,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>state_change,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>query</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>pg_stat_activity</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>state</span><span class="space"> </span><span>!=</span><span class="space"> </span><span>&#39;idle&#39;</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>query_start;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>连接统计</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>datname,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>COUNT(*)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>connection_count,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>COUNT(*)</span><span class="space"> </span><span>FILTER</span><span class="space"> </span><span>(WHERE</span><span class="space"> </span><span>state</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;active&#39;)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>active_connections,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>COUNT(*)</span><span class="space"> </span><span>FILTER</span><span class="space"> </span><span>(WHERE</span><span class="space"> </span><span>state</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;idle&#39;)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>idle_connections</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>pg_stat_activity</span></span>
<span class="line"><span>GROUP</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>datname;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>长时间运行的查询</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>pid,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>usename,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>datname,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>query_start,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>now()</span><span class="space"> </span><span>-</span><span class="space"> </span><span>query_start</span><span class="space"> </span><span>as</span><span class="space"> </span><span>duration,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>state,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>query</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>pg_stat_activity</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>state</span><span class="space"> </span><span>!=</span><span class="space"> </span><span>&#39;idle&#39;</span></span>
<span class="line"><span>AND</span><span class="space"> </span><span>now()</span><span class="space"> </span><span>-</span><span class="space"> </span><span>query_start</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>interval</span><span class="space"> </span><span>&#39;5</span><span class="space"> </span><span>minutes&#39;</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>duration</span><span class="space"> </span><span>DESC;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_13-实际案例研究" tabindex="-1"><a class="header-anchor" href="#_13-实际案例研究"><span>13. 实际案例研究</span></a></h2><h3 id="案例1-电商订单系统" tabindex="-1"><a class="header-anchor" href="#案例1-电商订单系统"><span>案例1：电商订单系统</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>创建电商订单系统的核心表结构</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>ecommerce_products</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>sku</span><span class="space"> </span><span>VARCHAR(50)</span><span class="space"> </span><span>UNIQUE</span><span class="space"> </span><span>NOT</span><span class="space"> </span><span>NULL,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name</span><span class="space"> </span><span>VARCHAR(200)</span><span class="space"> </span><span>NOT</span><span class="space"> </span><span>NULL,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>category_path</span><span class="space"> </span><span>LTREE,</span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>使用ltree扩展支持层级分类</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>price</span><span class="space"> </span><span>DECIMAL(10,2),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>inventory_count</span><span class="space"> </span><span>INTEGER,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>attributes</span><span class="space"> </span><span>JSONB,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>search_vector</span><span class="space"> </span><span>TSVECTOR,</span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>全文搜索</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>created_at</span><span class="space"> </span><span>TIMESTAMP</span><span class="space"> </span><span>DEFAULT</span><span class="space"> </span><span>NOW()</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>ecommerce_orders</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>BIGSERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>order_number</span><span class="space"> </span><span>VARCHAR(50)</span><span class="space"> </span><span>UNIQUE</span><span class="space"> </span><span>NOT</span><span class="space"> </span><span>NULL,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>customer_id</span><span class="space"> </span><span>INTEGER,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>status</span><span class="space"> </span><span>VARCHAR(20)</span><span class="space"> </span><span>DEFAULT</span><span class="space"> </span><span>&#39;pending&#39;,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>total_amount</span><span class="space"> </span><span>DECIMAL(15,2),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>shipping_address</span><span class="space"> </span><span>JSONB,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>order_date</span><span class="space"> </span><span>TIMESTAMP</span><span class="space"> </span><span>DEFAULT</span><span class="space"> </span><span>NOW(),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>shipped_date</span><span class="space"> </span><span>TIMESTAMP,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>delivered_date</span><span class="space"> </span><span>TIMESTAMP</span></span>
<span class="line"><span>)</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>RANGE</span><span class="space"> </span><span>(order_date);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>创建按月分区</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>ecommerce_orders_2024_01</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>OF</span><span class="space"> </span><span>ecommerce_orders</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FOR</span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>(&#39;2024-01-01&#39;)</span><span class="space"> </span><span>TO</span><span class="space"> </span><span>(&#39;2024-02-01&#39;);</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>ecommerce_orders_2024_02</span><span class="space"> </span><span>PARTITION</span><span class="space"> </span><span>OF</span><span class="space"> </span><span>ecommerce_orders</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FOR</span><span class="space"> </span><span>VALUES</span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>(&#39;2024-02-01&#39;)</span><span class="space"> </span><span>TO</span><span class="space"> </span><span>(&#39;2024-03-01&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>ecommerce_order_items</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>BIGSERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>order_id</span><span class="space"> </span><span>BIGINT</span><span class="space"> </span><span>REFERENCES</span><span class="space"> </span><span>ecommerce_orders(id),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>product_id</span><span class="space"> </span><span>INTEGER</span><span class="space"> </span><span>REFERENCES</span><span class="space"> </span><span>ecommerce_products(id),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>quantity</span><span class="space"> </span><span>INTEGER,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>unit_price</span><span class="space"> </span><span>DECIMAL(10,2),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>total_price</span><span class="space"> </span><span>DECIMAL(10,2)</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>启用必要的扩展</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>EXTENSION</span><span class="space"> </span><span>ltree;</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>EXTENSION</span><span class="space"> </span><span>pg_trgm;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>创建优化索引</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_products_category</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>ecommerce_products</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>GIST</span><span class="space"> </span><span>(category_path);</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_products_search</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>ecommerce_products</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>GIN</span><span class="space"> </span><span>(search_vector);</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_products_attributes</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>ecommerce_products</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>GIN</span><span class="space"> </span><span>(attributes);</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_orders_customer_date</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>ecommerce_orders</span><span class="space"> </span><span>(customer_id,</span><span class="space"> </span><span>order_date);</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_orders_status</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>ecommerce_orders</span><span class="space"> </span><span>(status)</span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>status</span><span class="space"> </span><span>!=</span><span class="space"> </span><span>&#39;delivered&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>插入示例数据</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>ecommerce_products</span><span class="space"> </span><span>(sku,</span><span class="space"> </span><span>name,</span><span class="space"> </span><span>category_path,</span><span class="space"> </span><span>price,</span><span class="space"> </span><span>inventory_count,</span><span class="space"> </span><span>attributes)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;PHONE001&#39;,</span><span class="space"> </span><span>&#39;iPhone</span><span class="space"> </span><span>15</span><span class="space"> </span><span>Pro&#39;,</span><span class="space"> </span><span>&#39;electronics.mobile.smartphones&#39;,</span><span class="space"> </span><span>999.99,</span><span class="space"> </span><span>50,</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span>&#39;{&quot;brand&quot;:</span><span class="space"> </span><span>&quot;Apple&quot;,</span><span class="space"> </span><span>&quot;color&quot;:</span><span class="space"> </span><span>&quot;Natural</span><span class="space"> </span><span>Titanium&quot;,</span><span class="space"> </span><span>&quot;storage&quot;:</span><span class="space"> </span><span>&quot;128GB&quot;,</span><span class="space"> </span><span>&quot;features&quot;:</span><span class="space"> </span><span>[&quot;Face</span><span class="space"> </span><span>ID&quot;,</span><span class="space"> </span><span>&quot;5G&quot;,</span><span class="space"> </span><span>&quot;ProRAW&quot;]}&#39;),</span></span>
<span class="line"><span>(&#39;LAPTOP001&#39;,</span><span class="space"> </span><span>&#39;MacBook</span><span class="space"> </span><span>Pro</span><span class="space"> </span><span>M3&#39;,</span><span class="space"> </span><span>&#39;electronics.computers.laptops&#39;,</span><span class="space"> </span><span>1999.99,</span><span class="space"> </span><span>25,</span></span>
<span class="line"><span class="space"> </span><span>&#39;{&quot;brand&quot;:</span><span class="space"> </span><span>&quot;Apple&quot;,</span><span class="space"> </span><span>&quot;screen&quot;:</span><span class="space"> </span><span>&quot;14-inch&quot;,</span><span class="space"> </span><span>&quot;processor&quot;:</span><span class="space"> </span><span>&quot;M3&quot;,</span><span class="space"> </span><span>&quot;memory&quot;:</span><span class="space"> </span><span>&quot;16GB&quot;,</span><span class="space"> </span><span>&quot;storage&quot;:</span><span class="space"> </span><span>&quot;512GB</span><span class="space"> </span><span>SSD&quot;}&#39;),</span></span>
<span class="line"><span>(&#39;BOOK001&#39;,</span><span class="space"> </span><span>&#39;PostgreSQL权威指南&#39;,</span><span class="space"> </span><span>&#39;books.technology.databases&#39;,</span><span class="space"> </span><span>89.99,</span><span class="space"> </span><span>100,</span></span>
<span class="line"><span class="space"> </span><span>&#39;{&quot;author&quot;:</span><span class="space"> </span><span>&quot;PostgreSQL专家&quot;,</span><span class="space"> </span><span>&quot;pages&quot;:</span><span class="space"> </span><span>800,</span><span class="space"> </span><span>&quot;language&quot;:</span><span class="space"> </span><span>&quot;中文&quot;,</span><span class="space"> </span><span>&quot;format&quot;:</span><span class="space"> </span><span>&quot;精装&quot;}&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>更新搜索向量</span></span>
<span class="line"><span>UPDATE</span><span class="space"> </span><span>ecommerce_products</span><span class="space"> </span><span>SET</span><span class="space"> </span><span>search_vector</span><span class="space"> </span><span>=</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>to_tsvector(&#39;chinese&#39;,</span><span class="space"> </span><span>name</span><span class="space"> </span><span>||</span><span class="space"> </span><span>&#39;</span><span class="space"> </span><span>&#39;</span><span class="space"> </span><span>||</span><span class="space"> </span><span>COALESCE(attributes-&gt;&gt;&#39;brand&#39;,</span><span class="space"> </span><span>&#39;&#39;));</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>复杂查询示例：商品推荐系统</span></span>
<span class="line"><span>WITH</span><span class="space"> </span><span>customer_preferences</span><span class="space"> </span><span>AS</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>o.customer_id,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>p.category_path,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>COUNT(*)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>purchase_count,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>AVG(oi.unit_price)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>avg_price</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>ecommerce_orders</span><span class="space"> </span><span>o</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>JOIN</span><span class="space"> </span><span>ecommerce_order_items</span><span class="space"> </span><span>oi</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>o.id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>oi.order_id</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>JOIN</span><span class="space"> </span><span>ecommerce_products</span><span class="space"> </span><span>p</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>oi.product_id</span><span class="space"> </span><span>=</span><span class="space"> </span><span>p.id</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>o.order_date</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>NOW()</span><span class="space"> </span><span>-</span><span class="space"> </span><span>INTERVAL</span><span class="space"> </span><span>&#39;6</span><span class="space"> </span><span>months&#39;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>GROUP</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>o.customer_id,</span><span class="space"> </span><span>p.category_path</span></span>
<span class="line"><span>),</span></span>
<span class="line"><span>similar_products</span><span class="space"> </span><span>AS</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>p.*,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>similarity(p.name,</span><span class="space"> </span><span>&#39;手机&#39;)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>name_similarity</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>FROM</span><span class="space"> </span><span>ecommerce_products</span><span class="space"> </span><span>p</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>WHERE</span><span class="space"> </span><span>p.search_vector</span><span class="space"> </span><span>@@</span><span class="space"> </span><span>to_tsquery(&#39;chinese&#39;,</span><span class="space"> </span><span>&#39;手机</span><span class="space"> </span><span>|</span><span class="space"> </span><span>电话&#39;)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>OR</span><span class="space"> </span><span>p.name</span><span class="space"> </span><span>%</span><span class="space"> </span><span>&#39;手机&#39;</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>sp.name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>sp.price,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>sp.category_path,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>sp.attributes,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>sp.name_similarity</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>similar_products</span><span class="space"> </span><span>sp</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>sp.inventory_count</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>0</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>sp.name_similarity</span><span class="space"> </span><span>DESC,</span><span class="space"> </span><span>sp.price</span><span class="space"> </span><span>ASC</span></span>
<span class="line"><span>LIMIT</span><span class="space"> </span><span>10;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="案例2-地理位置服务" tabindex="-1"><a class="header-anchor" href="#案例2-地理位置服务"><span>案例2：地理位置服务</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>--</span><span class="space"> </span><span>基于PostGIS的位置服务系统</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>location_businesses</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name</span><span class="space"> </span><span>VARCHAR(200),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>category</span><span class="space"> </span><span>VARCHAR(100),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>address</span><span class="space"> </span><span>TEXT,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>location</span><span class="space"> </span><span>GEOMETRY(POINT,</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>WGS84坐标系</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>rating</span><span class="space"> </span><span>DECIMAL(3,2),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>price_level</span><span class="space"> </span><span>INTEGER,</span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>1-4价格等级</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>opening_hours</span><span class="space"> </span><span>JSONB,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>contact_info</span><span class="space"> </span><span>JSONB,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>created_at</span><span class="space"> </span><span>TIMESTAMP</span><span class="space"> </span><span>DEFAULT</span><span class="space"> </span><span>NOW()</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>TABLE</span><span class="space"> </span><span>location_users</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>id</span><span class="space"> </span><span>SERIAL</span><span class="space"> </span><span>PRIMARY</span><span class="space"> </span><span>KEY,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>username</span><span class="space"> </span><span>VARCHAR(50),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>current_location</span><span class="space"> </span><span>GEOMETRY(POINT,</span><span class="space"> </span><span>4326),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>home_location</span><span class="space"> </span><span>GEOMETRY(POINT,</span><span class="space"> </span><span>4326),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>preferences</span><span class="space"> </span><span>JSONB,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>last_active</span><span class="space"> </span><span>TIMESTAMP</span><span class="space"> </span><span>DEFAULT</span><span class="space"> </span><span>NOW()</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>创建空间索引</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_businesses_location</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>location_businesses</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>GIST</span><span class="space"> </span><span>(location);</span></span>
<span class="line"><span>CREATE</span><span class="space"> </span><span>INDEX</span><span class="space"> </span><span>idx_users_current_location</span><span class="space"> </span><span>ON</span><span class="space"> </span><span>location_users</span><span class="space"> </span><span>USING</span><span class="space"> </span><span>GIST</span><span class="space"> </span><span>(current_location);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>插入示例数据（北京地区）</span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>location_businesses</span><span class="space"> </span><span>(name,</span><span class="space"> </span><span>category,</span><span class="space"> </span><span>address,</span><span class="space"> </span><span>location,</span><span class="space"> </span><span>rating,</span><span class="space"> </span><span>price_level,</span><span class="space"> </span><span>opening_hours)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;星巴克(三里屯店)&#39;,</span><span class="space"> </span><span>&#39;咖啡厅&#39;,</span><span class="space"> </span><span>&#39;北京市朝阳区三里屯路19号&#39;,</span><span class="space"> </span><span>ST_SetSRID(ST_MakePoint(116.4551,</span><span class="space"> </span><span>39.9365),</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>4.2,</span><span class="space"> </span><span>3,</span></span>
<span class="line"><span class="space"> </span><span>&#39;{&quot;monday&quot;:</span><span class="space"> </span><span>&quot;06:30-22:00&quot;,</span><span class="space"> </span><span>&quot;tuesday&quot;:</span><span class="space"> </span><span>&quot;06:30-22:00&quot;,</span><span class="space"> </span><span>&quot;sunday&quot;:</span><span class="space"> </span><span>&quot;07:00-21:00&quot;}&#39;),</span></span>
<span class="line"><span>(&#39;全聚德(前门店)&#39;,</span><span class="space"> </span><span>&#39;餐厅&#39;,</span><span class="space"> </span><span>&#39;北京市东城区前门大街30号&#39;,</span><span class="space"> </span><span>ST_SetSRID(ST_MakePoint(116.3967,</span><span class="space"> </span><span>39.9015),</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>4.0,</span><span class="space"> </span><span>4,</span></span>
<span class="line"><span class="space"> </span><span>&#39;{&quot;monday&quot;:</span><span class="space"> </span><span>&quot;11:00-21:00&quot;,</span><span class="space"> </span><span>&quot;tuesday&quot;:</span><span class="space"> </span><span>&quot;11:00-21:00&quot;,</span><span class="space"> </span><span>&quot;sunday&quot;:</span><span class="space"> </span><span>&quot;11:00-21:00&quot;}&#39;),</span></span>
<span class="line"><span>(&#39;北京大学&#39;,</span><span class="space"> </span><span>&#39;教育&#39;,</span><span class="space"> </span><span>&#39;北京市海淀区颐和园路5号&#39;,</span><span class="space"> </span><span>ST_SetSRID(ST_MakePoint(116.3105,</span><span class="space"> </span><span>39.9926),</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>4.8,</span><span class="space"> </span><span>1,</span></span>
<span class="line"><span class="space"> </span><span>&#39;{&quot;monday&quot;:</span><span class="space"> </span><span>&quot;全天开放&quot;,</span><span class="space"> </span><span>&quot;sunday&quot;:</span><span class="space"> </span><span>&quot;全天开放&quot;}&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>INSERT</span><span class="space"> </span><span>INTO</span><span class="space"> </span><span>location_users</span><span class="space"> </span><span>(username,</span><span class="space"> </span><span>current_location,</span><span class="space"> </span><span>home_location,</span><span class="space"> </span><span>preferences)</span><span class="space"> </span><span>VALUES</span><span class="space"> </span></span>
<span class="line"><span>(&#39;user1&#39;,</span><span class="space"> </span><span>ST_SetSRID(ST_MakePoint(116.4074,</span><span class="space"> </span><span>39.9042),</span><span class="space"> </span><span>4326),</span><span class="space"> </span><span>ST_SetSRID(ST_MakePoint(116.4074,</span><span class="space"> </span><span>39.9042),</span><span class="space"> </span><span>4326),</span></span>
<span class="line"><span class="space"> </span><span>&#39;{&quot;favorite_categories&quot;:</span><span class="space"> </span><span>[&quot;咖啡厅&quot;,</span><span class="space"> </span><span>&quot;书店&quot;],</span><span class="space"> </span><span>&quot;max_distance&quot;:</span><span class="space"> </span><span>2000,</span><span class="space"> </span><span>&quot;price_preference&quot;:</span><span class="space"> </span><span>[1,2,3]}&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>附近商家查询（2公里范围内）</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>b.name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>b.category,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>b.rating,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>b.price_level,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Distance(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Transform(b.location,</span><span class="space"> </span><span>3857),</span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>转换为米制坐标系</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Transform(u.current_location,</span><span class="space"> </span><span>3857)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>distance_meters</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>location_businesses</span><span class="space"> </span><span>b</span></span>
<span class="line"><span>CROSS</span><span class="space"> </span><span>JOIN</span><span class="space"> </span><span>location_users</span><span class="space"> </span><span>u</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>u.username</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;user1&#39;</span></span>
<span class="line"><span>AND</span><span class="space"> </span><span>ST_DWithin(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Transform(b.location,</span><span class="space"> </span><span>3857),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Transform(u.current_location,</span><span class="space"> </span><span>3857),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>2000</span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>2公里</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>distance_meters</span><span class="space"> </span><span>ASC;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>路径规划查询</span></span>
<span class="line"><span>WITH</span><span class="space"> </span><span>route_points</span><span class="space"> </span><span>AS</span><span class="space"> </span><span>(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_SetSRID(ST_MakePoint(116.4074,</span><span class="space"> </span><span>39.9042),</span><span class="space"> </span><span>4326)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>start_point,</span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>天安门</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_SetSRID(ST_MakePoint(116.3105,</span><span class="space"> </span><span>39.9926),</span><span class="space"> </span><span>4326)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>end_point</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>北大</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>b.name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>b.category,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Distance(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Transform(b.location,</span><span class="space"> </span><span>3857),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Transform(ST_MakeLine(rp.start_point,</span><span class="space"> </span><span>rp.end_point),</span><span class="space"> </span><span>3857)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>distance_to_route</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>location_businesses</span><span class="space"> </span><span>b</span></span>
<span class="line"><span>CROSS</span><span class="space"> </span><span>JOIN</span><span class="space"> </span><span>route_points</span><span class="space"> </span><span>rp</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>ST_DWithin(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Transform(b.location,</span><span class="space"> </span><span>3857),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Transform(ST_MakeLine(rp.start_point,</span><span class="space"> </span><span>rp.end_point),</span><span class="space"> </span><span>3857),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>500</span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>距离路线500米内</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>distance_to_route</span><span class="space"> </span><span>ASC;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--</span><span class="space"> </span><span>热力图数据生成</span></span>
<span class="line"><span>SELECT</span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_X(location)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>longitude,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_Y(location)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>latitude,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>COUNT(*)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>business_count,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>AVG(rating)</span><span class="space"> </span><span>as</span><span class="space"> </span><span>avg_rating</span></span>
<span class="line"><span>FROM</span><span class="space"> </span><span>location_businesses</span></span>
<span class="line"><span>WHERE</span><span class="space"> </span><span>ST_Within(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>location,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ST_MakeEnvelope(116.3,</span><span class="space"> </span><span>39.8,</span><span class="space"> </span><span>116.5,</span><span class="space"> </span><span>40.0,</span><span class="space"> </span><span>4326)</span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>北京市区范围</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span>GROUP</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>ST_SnapToGrid(location,</span><span class="space"> </span><span>0.01)</span><span class="space"> </span><span class="space"> </span><span>--</span><span class="space"> </span><span>按0.01度网格聚合</span></span>
<span class="line"><span>HAVING</span><span class="space"> </span><span>COUNT(*)</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>0</span></span>
<span class="line"><span>ORDER</span><span class="space"> </span><span>BY</span><span class="space"> </span><span>business_count</span><span class="space"> </span><span>DESC;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h2><p>通过这次PostgreSQL的深度探索，我们可以看到它相比MySQL的诸多优势：</p><ol><li><strong>数据类型丰富</strong>：原生支持JSON/JSONB、数组、自定义类型等</li><li><strong>查询功能强大</strong>：窗口函数、CTE、全文搜索等高级特性</li><li><strong>PostGIS地理信息</strong>：业界最强的地理信息系统支持</li><li><strong>扩展生态丰富</strong>：pg_stat_statements、pg_trgm、uuid-ossp等实用扩展</li><li><strong>索引类型多样</strong>：GIN、GiST、BRIN等针对不同场景的索引</li><li><strong>并发控制先进</strong>：MVCC机制提供更好的并发性能</li><li><strong>分区表支持</strong>：声明式分区简化大表管理</li><li><strong>外部数据访问</strong>：FDW实现数据联邦查询</li><li><strong>存储过程灵活</strong>：支持多种编程语言</li><li><strong>企业级特性</strong>：流复制、PITR、高可用等</li></ol><p>PostgreSQL不仅仅是一个关系型数据库，更是一个强大的数据平台。它的这些&quot;大杀招&quot;功能让它在处理复杂业务场景时游刃有余，特别是在需要地理信息处理、复杂数据分析、高并发读写的现代应用中表现出色。</p><p>对于开发者来说，掌握PostgreSQL的这些特性，不仅能提高开发效率，还能为系统架构提供更多可能性。在选择数据库技术栈时，PostgreSQL绝对值得认真考虑。</p></div><!----><!----><!----></div></main><footer class="vp-doc-footer" data-v-a703df67 data-v-55df5bf3><!--[--><!--]--><!----><div class="contributors" aria-label="Contributors" data-v-55df5bf3><span class="contributors-label" data-v-55df5bf3>贡献者: </span><span class="contributors-info" data-v-55df5bf3><!--[--><!--[--><span class="contributor" data-v-55df5bf3>exiao</span><!----><!--]--><!--]--></span></div><nav class="prev-next" data-v-55df5bf3><div class="pager" data-v-55df5bf3><a class="vp-link no-icon link pager-link prev" href="/article/kzlh905h/" data-v-55df5bf3 data-v-f64f8f73><!--[--><span class="desc" data-v-55df5bf3>上一页</span><span class="title" data-v-55df5bf3>工作扫盲之跨域问题</span><!--]--><!----></a></div><div class="pager" data-v-55df5bf3><a class="vp-link no-icon link pager-link next" href="/article/d37f9gvt/" data-v-55df5bf3 data-v-f64f8f73><!--[--><span class="desc" data-v-55df5bf3>下一页</span><span class="title" data-v-55df5bf3>工作扫盲之Postgres</span><!--]--><!----></a></div></nav></footer><!----><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!--]--><button type="button" class="vp-back-to-top" aria-label="back to top" data-v-17d2f8af style="display:none;" data-v-51206c70><span class="percent" data-allow-mismatch data-v-51206c70>0%</span><span class="show icon vpi-back-to-top" data-v-51206c70></span><svg aria-hidden="true" data-v-51206c70><circle cx="50%" cy="50%" data-allow-mismatch style="stroke-dasharray:calc(0% - 12.566370614359172px) calc(314.1592653589793% - 12.566370614359172px);" data-v-51206c70></circle></svg></button><footer class="vp-footer" vp-footer data-v-17d2f8af data-v-b8e531e8><!--[--><div class="container" data-v-b8e531e8><p class="message" data-v-b8e531e8>————————到底啦!————————</p><p class="copyright" data-v-b8e531e8>copyleft © 2025 Exiao</p></div><!--]--></footer><!--[--><!--]--><!--]--></div><!----><!--]--><!--[--><!--]--><!--]--></div><script type="module" src="/assets/app-DqRurxSm.js" defer></script></body></html>