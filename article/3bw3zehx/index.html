<!doctype html><html lang="zh-CN"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="generator" content="VuePress 2.0.0-rc.20" /><meta name="theme" content="VuePress Theme Plume " /><script id="check-mac-os">document.documentElement.classList.toggle('mac', /Mac|iPhone|iPod|iPad/i.test(navigator.platform))</script><meta property="og:url" content="https://callmeexiao.baby/article/3bw3zehx/"><meta property="og:site_name" content="Exiao's Blog"><meta property="og:title" content="从贫血模型到充血模型"><meta property="og:description" content="更新时间：2026-02-09 适合读者：正在做 DDD 落地、被“业务逻辑四处散落”困扰的后端工程师 先说结论 这次重构最关键的变化只有一句话： 让领域对象自己维护业务不变量，让应用层从“规则实现者”回到“流程编排者”。 落地后直接收益是： 规则不再散落在 Handler/Listener/Util，修改点更集中。 状态流转从“字符串 + if-el..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2026-02-09T04:43:36.000Z"><meta property="article:modified_time" content="2026-02-09T04:43:36.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"从贫血模型到充血模型","image":[""],"dateModified":"2026-02-09T04:43:36.000Z","author":[]}</script><link rel="icon" type="image/png" href="https://theme-plume.vuejs.press/favicon-32x32.png"><title>从贫血模型到充血模型 | Exiao's Blog</title><meta name="description" content="更新时间：2026-02-09 适合读者：正在做 DDD 落地、被“业务逻辑四处散落”困扰的后端工程师 先说结论 这次重构最关键的变化只有一句话： 让领域对象自己维护业务不变量，让应用层从“规则实现者”回到“流程编排者”。 落地后直接收益是： 规则不再散落在 Handler/Listener/Util，修改点更集中。 状态流转从“字符串 + if-el..."><link rel="preload" href="/assets/style-Cd332rkf.css" as="style"><link rel="stylesheet" href="/assets/style-Cd332rkf.css"><link rel="modulepreload" href="/assets/app-pBrtxVLr.js"><link rel="modulepreload" href="/assets/index.html-meTU3VTc.js"></head><body><div id="app"><!--[--><!--[--><div class="theme-plume vp-layout" vp-container data-v-3bf3774b><!--[--><!--[--><!--]--><!--[--><span tabindex="-1" data-v-1afd8ef4></span><a href="#VPContent" class="vp-skip-link visually-hidden" data-v-1afd8ef4> Skip to content </a><!--]--><!----><header class="vp-nav" data-v-3bf3774b data-v-93076610><div class="vp-navbar" vp-navbar data-v-93076610 data-v-fb9743c7><div class="wrapper" data-v-fb9743c7><div class="container" data-v-fb9743c7><div class="title" data-v-fb9743c7><div class="vp-navbar-title" data-v-fb9743c7 data-v-800466e1><a class="vp-link no-icon link title" href="/" data-v-800466e1 data-v-8fd51d7e><!--[--><!--[--><!--]--><!--[--><!--[--><!--[--><img class="vp-image dark logo" style="" src="https://theme-plume.vuejs.press/plume.png" alt data-v-c4044e2a><!--]--><!--[--><img class="vp-image light logo" style="" src="https://theme-plume.vuejs.press/plume.png" alt data-v-c4044e2a><!--]--><!--]--><!--]--><span data-v-800466e1>Exiao&#39;s Blog</span><!--[--><!--]--><!--]--><!----></a></div></div><div class="content" data-v-fb9743c7><div class="content-body" data-v-fb9743c7><!--[--><!--]--><div class="vp-navbar-search search" data-v-fb9743c7><div class="search-wrapper" data-v-9b6231cb><!----><div id="local-search" data-v-9b6231cb><button type="button" class="mini-search mini-search-button" aria-label="搜索文档" data-v-9b6231cb><span class="mini-search-button-container"><span class="mini-search-search-icon vpi-mini-search" aria-label="search icon"></span><span class="mini-search-button-placeholder">搜索文档</span></span><span class="mini-search-button-keys"><kbd class="mini-search-button-key"></kbd><kbd class="mini-search-button-key">K</kbd></span></button></div></div></div><nav aria-labelledby="main-nav-aria-label" class="vp-navbar-menu menu" data-v-fb9743c7 data-v-f0b866c0><span id="main-nav-aria-label" class="visually-hidden" data-v-f0b866c0>Main Navigation</span><!--[--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/" tabindex="0" data-v-f0b866c0 data-v-575a5ecb data-v-8fd51d7e><!--[--><!----><span data-v-575a5ecb>首页</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/blog/" tabindex="0" data-v-f0b866c0 data-v-575a5ecb data-v-8fd51d7e><!--[--><!----><span data-v-575a5ecb>博客</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/blog/tags/" tabindex="0" data-v-f0b866c0 data-v-575a5ecb data-v-8fd51d7e><!--[--><!----><span data-v-575a5ecb>标签</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/blog/archives/" tabindex="0" data-v-f0b866c0 data-v-575a5ecb data-v-8fd51d7e><!--[--><!----><span data-v-575a5ecb>归档</span><!--]--><!----></a><!--]--><!--[--><div class="vp-flyout vp-navbar-menu-group" data-v-f0b866c0 data-v-c02d6d2b><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-c02d6d2b><span class="text" data-v-c02d6d2b><!----><!----><span data-v-c02d6d2b>笔记</span><span class="vpi-chevron-down text-icon" data-v-c02d6d2b></span></span></button><div class="menu" data-v-c02d6d2b><div class="vp-menu" data-v-c02d6d2b data-v-97b8bc66><div class="items" data-v-97b8bc66><!--[--><!--[--><div class="vp-menu-link" data-v-97b8bc66 data-v-f09a0f1d><a class="vp-link no-icon link" href="/demo/" data-v-f09a0f1d data-v-8fd51d7e><!--[--><!----> 示例<!--]--><!----></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!----><!----><div class="vp-social-links vp-navbar-social-links social-links" data-v-fb9743c7 data-v-b384e0a0 data-v-820a862b><!--[--><a class="vp-social-link no-icon" href="https://github.com/callMeExiao/callMeExiao.github.io" aria-label="github" target="_blank" rel="noopener" data-v-820a862b data-v-20c69dec><span class="vpi-social-github" /></a><!--]--></div><div class="vp-flyout vp-navbar-extra extra" data-v-fb9743c7 data-v-450b28d0 data-v-c02d6d2b><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-c02d6d2b><span class="vpi-more-horizontal icon" data-v-c02d6d2b></span></button><div class="menu" data-v-c02d6d2b><div class="vp-menu" data-v-c02d6d2b data-v-97b8bc66><!----><!--[--><!--[--><!----><!----><div class="group" data-v-450b28d0><div class="item social-links" data-v-450b28d0><div class="vp-social-links social-links-list" data-v-450b28d0 data-v-820a862b><!--[--><a class="vp-social-link no-icon" href="https://github.com/callMeExiao/callMeExiao.github.io" aria-label="github" target="_blank" rel="noopener" data-v-820a862b data-v-20c69dec><span class="vpi-social-github" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="vp-navbar-hamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="nav-screen" data-v-fb9743c7 data-v-1bb12327><span class="container" data-v-1bb12327><span class="top" data-v-1bb12327></span><span class="middle" data-v-1bb12327></span><span class="bottom" data-v-1bb12327></span></span></button></div></div></div></div><div class="divider" data-v-fb9743c7><div class="divider-line" data-v-fb9743c7></div></div></div><!----></header><div class="vp-local-nav fixed reached-top is-blog" data-v-3bf3774b data-v-f47454cb><button class="hidden menu" disabled aria-expanded="false" aria-controls="SidebarNav" data-v-f47454cb><span class="vpi-align-left menu-icon" data-v-f47454cb></span><span class="menu-text" data-v-f47454cb>Menu</span></button><div class="vp-local-nav-outline-dropdown" style="--vp-vh:0px;" data-v-f47454cb data-v-9029d9f5><button data-v-9029d9f5>返回顶部</button><!----></div></div><!----><!--[--><div id="VPContent" vp-content class="vp-content" data-v-3bf3774b data-v-63d685ff><div class="vp-doc-container is-blog" data-v-63d685ff data-v-48823583><!--[--><!--]--><div class="container" data-v-48823583><!----><div class="content" data-v-48823583><div class="content-container" data-v-48823583><!--[--><!--]--><main class="main" data-v-48823583><nav class="vp-breadcrumb" data-v-48823583 data-v-c735a90d><ol vocab="https://schema.org/" typeof="BreadcrumbList" data-v-c735a90d><!--[--><li property="itemListElement" typeof="ListItem" data-v-c735a90d><a class="vp-link no-icon link breadcrumb" href="/" property="item" typeof="WebPage" data-v-c735a90d data-v-8fd51d7e><!--[-->首页<!--]--><!----></a><span class="vpi-chevron-right" data-v-c735a90d></span><meta property="name" content="首页" data-v-c735a90d><meta property="position" content="1" data-v-c735a90d></li><li property="itemListElement" typeof="ListItem" data-v-c735a90d><a class="vp-link no-icon link breadcrumb" href="/blog/" property="item" typeof="WebPage" data-v-c735a90d data-v-8fd51d7e><!--[-->博客<!--]--><!----></a><span class="vpi-chevron-right" data-v-c735a90d></span><meta property="name" content="博客" data-v-c735a90d><meta property="position" content="2" data-v-c735a90d></li><li property="itemListElement" typeof="ListItem" data-v-c735a90d><a class="vp-link no-icon link breadcrumb" href="/blog/categories/?id=543517" property="item" typeof="WebPage" data-v-c735a90d data-v-8fd51d7e><!--[-->后端技术<!--]--><!----></a><span class="vpi-chevron-right" data-v-c735a90d></span><meta property="name" content="后端技术" data-v-c735a90d><meta property="position" content="3" data-v-c735a90d></li><li property="itemListElement" typeof="ListItem" data-v-c735a90d><a class="vp-link no-icon link breadcrumb current" href="/article/3bw3zehx/" property="item" typeof="WebPage" data-v-c735a90d data-v-8fd51d7e><!--[-->从贫血模型到充血模型<!--]--><!----></a><!----><meta property="name" content="从贫血模型到充血模型" data-v-c735a90d><meta property="position" content="4" data-v-c735a90d></li><!--]--></ol></nav><!--[--><h1 class="vp-doc-title page-title" data-v-d8ca9256>从贫血模型到充血模型 <!----></h1><div class="vp-doc-meta" data-v-d8ca9256><p class="reading-time" data-v-d8ca9256><span class="vpi-books icon" data-v-d8ca9256></span><span data-v-d8ca9256>约 2124 字</span><span data-v-d8ca9256>大约 7 分钟</span></p><!----><p class="create-time" data-v-d8ca9256><span class="vpi-clock icon" data-v-d8ca9256></span><span data-v-d8ca9256>2026-02-09</span></p></div><!--]--><div class="_article_3bw3zehx_ external-link-icon-enabled vp-doc plume-content" vp-content data-v-48823583><div data-v-48823583><blockquote><p>更新时间：2026-02-09<br> 适合读者：正在做 DDD 落地、被“业务逻辑四处散落”困扰的后端工程师</p></blockquote><h2 id="先说结论" tabindex="-1"><a class="header-anchor" href="#先说结论"><span>先说结论</span></a></h2><p>这次重构最关键的变化只有一句话：</p><p><strong>让领域对象自己维护业务不变量，让应用层从“规则实现者”回到“流程编排者”。</strong></p><p>落地后直接收益是：</p><ul><li>规则不再散落在 <code>Handler/Listener/Util</code>，修改点更集中。</li><li>状态流转从“字符串 + if-else”变成“语义方法 + 枚举约束”。</li><li>单测颗粒度变小，核心逻辑不需要依赖数据库就能验证。</li></ul><hr><h2 id="_1-背景-为什么要从贫血走向充血" tabindex="-1"><a class="header-anchor" href="#_1-背景-为什么要从贫血走向充血"><span>1. 背景：为什么要从贫血走向充血</span></a></h2><p>在监测事件场景里，最初模型是典型的“贫血模型”：</p><ul><li>实体只有字段，不表达业务语义。</li><li>创建、校验、关闭、状态决策都在应用层散落实现。</li><li>同一条规则在多个入口被复制，最后出现“改一处漏三处”。</li></ul><p>这类代码短期看“开发快”，长期会遇到三个问题：</p><ol><li><strong>一致性差</strong>：不同入口对同一规则理解不同。</li><li><strong>可维护性差</strong>：排查一个状态问题要跨多层追逻辑。</li><li><strong>可测试性差</strong>：规则绑在流程代码里，单测成本高。</li></ol><hr><h2 id="_2-贫血模型长什么样" tabindex="-1"><a class="header-anchor" href="#_2-贫血模型长什么样"><span>2. 贫血模型长什么样</span></a></h2><h3 id="_2-1-实体只有属性" tabindex="-1"><a class="header-anchor" href="#_2-1-实体只有属性"><span>2.1 实体只有属性</span></a></h3><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//</span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">EventWarning.java（贫血）</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Data</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Accessors</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">chain</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#D19A66;">true</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span class="space"> </span><span style="color:#C678DD;">class</span><span class="space"> </span><span style="color:#E5C07B;">EventWarning</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">id</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">eventId</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">treeId</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">eventType</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">Long</span><span class="space"> </span><span style="color:#E06C75;">eventTime</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">Long</span><span class="space"> </span><span style="color:#E06C75;">endTime</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">Integer</span><span class="space"> </span><span style="color:#E06C75;">status</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-规则散落在应用层" tabindex="-1"><a class="header-anchor" href="#_2-2-规则散落在应用层"><span>2.2 规则散落在应用层</span></a></h3><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//</span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">WarningListener.java（业务规则散落）</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#C678DD;">void</span><span class="space"> </span><span style="color:#61AFEF;">createWarning</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">treeId</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">deviceCode</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#E5C07B;">Set</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">String</span><span style="color:#56B6C2;">&gt;</span><span class="space"> </span><span style="color:#E06C75;">eventTypes)</span><span class="space"> </span><span style="color:#E06C75;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">long</span><span class="space"> </span><span style="color:#E06C75;">now</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#E5C07B;">System</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">currentTimeMillis</span><span style="color:#ABB2BF;">()</span><span class="space"> </span><span style="color:#56B6C2;">/</span><span class="space"> </span><span style="color:#D19A66;">1000</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">EventWarning</span><span class="space"> </span><span style="color:#E06C75;">warning</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#C678DD;">new</span><span class="space"> </span><span style="color:#61AFEF;">EventWarning</span><span style="color:#E06C75;">()</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setTreeId</span><span style="color:#ABB2BF;">(treeId)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setEventId</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">IdUtil</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">nextId</span><span style="color:#ABB2BF;">())</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setEventType</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">join</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;,&quot;</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#ABB2BF;">eventTypes))</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setEventTime</span><span style="color:#ABB2BF;">(now)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setEndTime</span><span style="color:#ABB2BF;">(now</span><span class="space"> </span><span style="color:#56B6C2;">+</span><span class="space"> </span><span style="color:#E5C07B;">RandomUtil</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">randomInt</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#D19A66;">5</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">warningGateway</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">insert</span><span style="color:#ABB2BF;">(warning);</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//</span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">关闭逻辑也散落在外</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#C678DD;">void</span><span class="space"> </span><span style="color:#61AFEF;">closeWarning</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">EventWarning</span><span class="space"> </span><span style="color:#E06C75;">warning)</span><span class="space"> </span><span style="color:#E06C75;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">long</span><span class="space"> </span><span style="color:#E06C75;">endTime</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#E5C07B;">System</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">currentTimeMillis</span><span style="color:#ABB2BF;">()</span><span class="space"> </span><span style="color:#56B6C2;">/</span><span class="space"> </span><span style="color:#D19A66;">1000</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">warningGateway</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">updateEndTime</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">warning</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getEventId</span><span style="color:#ABB2BF;">(),</span><span class="space"> </span><span style="color:#ABB2BF;">endTime);</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>问题不在“代码能不能跑”，而在于：<strong>谁对业务规则负责并保证一致执行</strong>。</p><hr><h2 id="_3-改造原则-先收敛-再下沉" tabindex="-1"><a class="header-anchor" href="#_3-改造原则-先收敛-再下沉"><span>3. 改造原则：先收敛，再下沉</span></a></h2><p>这次改造遵循三条简单原则：</p><ol><li><strong>把业务不变量收回领域对象</strong>：对象在创建和状态变更时自校验。</li><li><strong>把状态表达升级为类型</strong>：用枚举和语义方法替代魔法值。</li><li><strong>应用层只做编排</strong>：保留流程控制，不直接操纵业务细节。</li></ol><p>换句话说，不是“把所有逻辑都塞进实体”，而是让“最应该由领域表达的规则”回到领域。</p><hr><h2 id="_4-充血模型一-事件实体负责创建与关闭" tabindex="-1"><a class="header-anchor" href="#_4-充血模型一-事件实体负责创建与关闭"><span>4. 充血模型一：事件实体负责创建与关闭</span></a></h2><p>改造后，<code>EventWarning</code> 直接提供语义方法：<code>createAiWarning</code>、<code>close</code>。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Data</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Accessors</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">chain</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#D19A66;">true</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span class="space"> </span><span style="color:#C678DD;">class</span><span class="space"> </span><span style="color:#E5C07B;">EventWarning</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#C678DD;">static</span><span class="space"> </span><span style="color:#C678DD;">final</span><span class="space"> </span><span style="color:#C678DD;">int</span><span class="space"> </span><span style="color:#E06C75;">MIN_AUTO_CLOSE_SECONDS</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">id</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">eventId</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">treeId</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">deviceCode</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">eventType</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">Long</span><span class="space"> </span><span style="color:#E06C75;">eventTime</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">Long</span><span class="space"> </span><span style="color:#E06C75;">creationTime</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">Long</span><span class="space"> </span><span style="color:#E06C75;">lastModificationTime</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">Long</span><span class="space"> </span><span style="color:#E06C75;">endTime</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">public</span><span class="space"> </span><span style="color:#C678DD;">static</span><span class="space"> </span><span style="color:#E5C07B;">EventWarning</span><span class="space"> </span><span style="color:#61AFEF;">createAiWarning</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">treeId</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">deviceCode</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">eventId</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">eventType</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">long</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">eventTime</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">int</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">autoCloseSeconds</span><span style="color:#ABB2BF;">)</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">if</span><span class="space"> </span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">StringUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isBlank</span><span style="color:#ABB2BF;">(treeId))</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">throw</span><span class="space"> </span><span style="color:#C678DD;">new</span><span class="space"> </span><span style="color:#61AFEF;">IllegalArgumentException</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;treeId</span><span class="space"> </span><span style="color:#98C379;">不能为空&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">if</span><span class="space"> </span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">StringUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isBlank</span><span style="color:#ABB2BF;">(deviceCode))</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">throw</span><span class="space"> </span><span style="color:#C678DD;">new</span><span class="space"> </span><span style="color:#61AFEF;">IllegalArgumentException</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;deviceCode</span><span class="space"> </span><span style="color:#98C379;">不能为空&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">if</span><span class="space"> </span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">StringUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isBlank</span><span style="color:#ABB2BF;">(eventId))</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">throw</span><span class="space"> </span><span style="color:#C678DD;">new</span><span class="space"> </span><span style="color:#61AFEF;">IllegalArgumentException</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;eventId</span><span class="space"> </span><span style="color:#98C379;">不能为空&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">if</span><span class="space"> </span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">StringUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isBlank</span><span style="color:#ABB2BF;">(eventType))</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">throw</span><span class="space"> </span><span style="color:#C678DD;">new</span><span class="space"> </span><span style="color:#61AFEF;">IllegalArgumentException</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;eventType</span><span class="space"> </span><span style="color:#98C379;">不能为空&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">if</span><span class="space"> </span><span style="color:#ABB2BF;">(autoCloseSeconds</span><span class="space"> </span><span style="color:#56B6C2;">&lt;</span><span class="space"> </span><span style="color:#ABB2BF;">MIN_AUTO_CLOSE_SECONDS)</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">throw</span><span class="space"> </span><span style="color:#C678DD;">new</span><span class="space"> </span><span style="color:#61AFEF;">IllegalArgumentException</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;autoCloseSeconds</span><span class="space"> </span><span style="color:#98C379;">不能小于</span><span class="space"> </span><span style="color:#98C379;">1&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#C678DD;">new</span><span class="space"> </span><span style="color:#61AFEF;">EventWarning</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setTreeId</span><span style="color:#ABB2BF;">(treeId)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setDeviceCode</span><span style="color:#ABB2BF;">(deviceCode)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setEventId</span><span style="color:#ABB2BF;">(eventId)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setEventType</span><span style="color:#ABB2BF;">(eventType)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setEventTime</span><span style="color:#ABB2BF;">(eventTime)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setCreationTime</span><span style="color:#ABB2BF;">(eventTime)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setEndTime</span><span style="color:#ABB2BF;">(eventTime</span><span class="space"> </span><span style="color:#56B6C2;">+</span><span class="space"> </span><span style="color:#ABB2BF;">autoCloseSeconds);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">public</span><span class="space"> </span><span style="color:#C678DD;">void</span><span class="space"> </span><span style="color:#61AFEF;">close</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">long</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">endTime</span><span style="color:#ABB2BF;">)</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">if</span><span class="space"> </span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">StringUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isBlank</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">eventId</span><span style="color:#ABB2BF;">))</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">throw</span><span class="space"> </span><span style="color:#C678DD;">new</span><span class="space"> </span><span style="color:#61AFEF;">IllegalArgumentException</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;eventId</span><span class="space"> </span><span style="color:#98C379;">不能为空，无法关闭事件&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">if</span><span class="space"> </span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">eventTime</span><span class="space"> </span><span style="color:#56B6C2;">!=</span><span class="space"> </span><span style="color:#D19A66;">null</span><span class="space"> </span><span style="color:#56B6C2;">&amp;&amp;</span><span class="space"> </span><span style="color:#ABB2BF;">endTime</span><span class="space"> </span><span style="color:#56B6C2;">&lt;</span><span class="space"> </span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">eventTime</span><span style="color:#ABB2BF;">)</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">throw</span><span class="space"> </span><span style="color:#C678DD;">new</span><span class="space"> </span><span style="color:#61AFEF;">IllegalArgumentException</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;结束时间不能早于事件时间&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">endTime</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#ABB2BF;">endTime;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">lastModificationTime</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#ABB2BF;">endTime;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样做的价值是：<strong>任何入口只要创建/关闭事件，都必须经过同一套规则</strong>。</p><hr><h2 id="_5-充血模型二-汇总实体负责状态决策" tabindex="-1"><a class="header-anchor" href="#_5-充血模型二-汇总实体负责状态决策"><span>5. 充血模型二：汇总实体负责状态决策</span></a></h2><h3 id="_5-1-先用枚举收敛状态定义" tabindex="-1"><a class="header-anchor" href="#_5-1-先用枚举收敛状态定义"><span>5.1 先用枚举收敛状态定义</span></a></h3><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Getter</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">AllArgsConstructor</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span class="space"> </span><span style="color:#C678DD;">enum</span><span class="space"> </span><span style="color:#E5C07B;">AlertSummaryStatus</span><span class="space"> </span><span style="color:#E06C75;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#D19A66;">WARNING</span><span style="color:#E06C75;">(</span><span style="color:#98C379;">&quot;预警中&quot;</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#D19A66;">PENDING</span><span style="color:#E06C75;">(</span><span style="color:#98C379;">&quot;待处置&quot;</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#D19A66;">PROCESSING</span><span style="color:#E06C75;">(</span><span style="color:#98C379;">&quot;处置中&quot;</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#D19A66;">AUDIT</span><span style="color:#E06C75;">(</span><span style="color:#98C379;">&quot;待审核&quot;</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#D19A66;">CLOSED</span><span style="color:#E06C75;">(</span><span style="color:#98C379;">&quot;结束&quot;</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#C678DD;">final</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">code</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">public</span><span class="space"> </span><span style="color:#C678DD;">boolean</span><span class="space"> </span><span style="color:#61AFEF;">matches</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">code</span><span style="color:#ABB2BF;">)</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">code</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">equals</span><span style="color:#ABB2BF;">(code);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-汇总实体决定初始状态" tabindex="-1"><a class="header-anchor" href="#_5-2-汇总实体决定初始状态"><span>5.2 汇总实体决定初始状态</span></a></h3><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Data</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Builder</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">NoArgsConstructor</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">AllArgsConstructor</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Accessors</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">chain</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#D19A66;">true</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span class="space"> </span><span style="color:#C678DD;">class</span><span class="space"> </span><span style="color:#E5C07B;">AlertSummary</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">id</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">treeId</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">level</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">content</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">status</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">deviceType</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">alarmType</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">LocalDateTime</span><span class="space"> </span><span style="color:#E06C75;">alarmTime</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">concerns</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">suggestions</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">public</span><span class="space"> </span><span style="color:#C678DD;">static</span><span class="space"> </span><span style="color:#E5C07B;">AlertSummary</span><span class="space"> </span><span style="color:#61AFEF;">create</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">treeId</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">level</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">content</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">LocalDateTime</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">alarmTime</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">deviceType</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">alarmType</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">boolean</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">strategyMatched</span><span style="color:#ABB2BF;">)</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">if</span><span class="space"> </span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">StringUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isBlank</span><span style="color:#ABB2BF;">(treeId))</span><span class="space"> </span><span style="color:#C678DD;">throw</span><span class="space"> </span><span style="color:#C678DD;">new</span><span class="space"> </span><span style="color:#61AFEF;">IllegalArgumentException</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;treeId</span><span class="space"> </span><span style="color:#98C379;">不能为空&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">if</span><span class="space"> </span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">StringUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isBlank</span><span style="color:#ABB2BF;">(level))</span><span class="space"> </span><span style="color:#C678DD;">throw</span><span class="space"> </span><span style="color:#C678DD;">new</span><span class="space"> </span><span style="color:#61AFEF;">IllegalArgumentException</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;level</span><span class="space"> </span><span style="color:#98C379;">不能为空&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">if</span><span class="space"> </span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">StringUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isBlank</span><span style="color:#ABB2BF;">(content))</span><span class="space"> </span><span style="color:#C678DD;">throw</span><span class="space"> </span><span style="color:#C678DD;">new</span><span class="space"> </span><span style="color:#61AFEF;">IllegalArgumentException</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;content</span><span class="space"> </span><span style="color:#98C379;">不能为空&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">if</span><span class="space"> </span><span style="color:#ABB2BF;">(alarmTime</span><span class="space"> </span><span style="color:#56B6C2;">==</span><span class="space"> </span><span style="color:#D19A66;">null</span><span style="color:#ABB2BF;">)</span><span class="space"> </span><span style="color:#C678DD;">throw</span><span class="space"> </span><span style="color:#C678DD;">new</span><span class="space"> </span><span style="color:#61AFEF;">IllegalArgumentException</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;alarmTime</span><span class="space"> </span><span style="color:#98C379;">不能为空&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">if</span><span class="space"> </span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">StringUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isBlank</span><span style="color:#ABB2BF;">(deviceType))</span><span class="space"> </span><span style="color:#C678DD;">throw</span><span class="space"> </span><span style="color:#C678DD;">new</span><span class="space"> </span><span style="color:#61AFEF;">IllegalArgumentException</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;deviceType</span><span class="space"> </span><span style="color:#98C379;">不能为空&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">if</span><span class="space"> </span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">StringUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isBlank</span><span style="color:#ABB2BF;">(alarmType))</span><span class="space"> </span><span style="color:#C678DD;">throw</span><span class="space"> </span><span style="color:#C678DD;">new</span><span class="space"> </span><span style="color:#61AFEF;">IllegalArgumentException</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;alarmType</span><span class="space"> </span><span style="color:#98C379;">不能为空&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#E5C07B;">AlertSummary</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">builder</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">treeId</span><span style="color:#ABB2BF;">(treeId)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">level</span><span style="color:#ABB2BF;">(level)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">content</span><span style="color:#ABB2BF;">(content)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">alarmTime</span><span style="color:#ABB2BF;">(alarmTime)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">deviceType</span><span style="color:#ABB2BF;">(deviceType)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">alarmType</span><span style="color:#ABB2BF;">(alarmType)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">status</span><span style="color:#ABB2BF;">(</span><span style="color:#61AFEF;">resolveInitialStatus</span><span style="color:#ABB2BF;">(strategyMatched))</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">build</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">public</span><span class="space"> </span><span style="color:#C678DD;">static</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#61AFEF;">resolveInitialStatus</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">boolean</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">strategyMatched</span><span style="color:#ABB2BF;">)</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#ABB2BF;">strategyMatched</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">?</span><span class="space"> </span><span style="color:#E5C07B;">AlertSummaryStatus</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">PENDING</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getCode</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">:</span><span class="space"> </span><span style="color:#E5C07B;">AlertSummaryStatus</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">WARNING</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getCode</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">public</span><span class="space"> </span><span style="color:#C678DD;">boolean</span><span class="space"> </span><span style="color:#61AFEF;">shouldCreateDisposeRecord</span><span style="color:#ABB2BF;">()</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#E5C07B;">AlertSummaryStatus</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">PENDING</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">matches</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">status</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>核心变化：应用层不再决定状态细节，只问领域“该不该创建处置记录”。</p><hr><h2 id="_6-充血模型三-策略实体负责匹配规则" tabindex="-1"><a class="header-anchor" href="#_6-充血模型三-策略实体负责匹配规则"><span>6. 充血模型三：策略实体负责匹配规则</span></a></h2><h3 id="_6-1-告警策略-字段匹配规则内聚" tabindex="-1"><a class="header-anchor" href="#_6-1-告警策略-字段匹配规则内聚"><span>6.1 告警策略：字段匹配规则内聚</span></a></h3><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Data</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Accessors</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">chain</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#D19A66;">true</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span class="space"> </span><span style="color:#C678DD;">class</span><span class="space"> </span><span style="color:#E5C07B;">AlertPolicy</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#C678DD;">static</span><span class="space"> </span><span style="color:#C678DD;">final</span><span class="space"> </span><span style="color:#E5C07B;">ObjectMapper</span><span class="space"> </span><span style="color:#E06C75;">OBJECT_MAPPER</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#C678DD;">new</span><span class="space"> </span><span style="color:#61AFEF;">ObjectMapper</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">treeIds</span><span style="color:#ABB2BF;">;</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">//</span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">可能是</span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">[&quot;T1&quot;,&quot;T2&quot;]</span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">或</span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">T1,T2</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">levels</span><span style="color:#ABB2BF;">;</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">//</span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">同上</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">deviceTypes</span><span style="color:#ABB2BF;">;</span><span class="space"> </span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">//</span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">同上</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">alarmTypes</span><span style="color:#ABB2BF;">;</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">//</span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">同上</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">Boolean</span><span class="space"> </span><span style="color:#E06C75;">enabled</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">policyName</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">public</span><span class="space"> </span><span style="color:#C678DD;">boolean</span><span class="space"> </span><span style="color:#61AFEF;">matches</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">treeId</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">level</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">deviceType</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#E5C07B;">Object</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">alarmTypesParam</span><span style="color:#ABB2BF;">)</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">if</span><span class="space"> </span><span style="color:#ABB2BF;">(</span><span style="color:#56B6C2;">!</span><span style="color:#61AFEF;">matchesField</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">treeIds</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#ABB2BF;">treeId))</span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">if</span><span class="space"> </span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">StringUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isNotBlank</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">levels</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#56B6C2;">&amp;&amp;</span><span class="space"> </span><span style="color:#E5C07B;">StringUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isNotBlank</span><span style="color:#ABB2BF;">(level)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#56B6C2;">&amp;&amp;</span><span class="space"> </span><span style="color:#56B6C2;">!</span><span style="color:#61AFEF;">matchesField</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">levels</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#ABB2BF;">level))</span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">if</span><span class="space"> </span><span style="color:#ABB2BF;">(</span><span style="color:#56B6C2;">!</span><span style="color:#61AFEF;">matchesField</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">deviceTypes</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#ABB2BF;">deviceType))</span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">if</span><span class="space"> </span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">StringUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isBlank</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">alarmTypes</span><span style="color:#ABB2BF;">))</span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">if</span><span class="space"> </span><span style="color:#ABB2BF;">(alarmTypesParam</span><span class="space"> </span><span style="color:#C678DD;">instanceof</span><span class="space"> </span><span style="color:#E5C07B;">Set</span><span style="color:#56B6C2;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#56B6C2;">&gt;</span><span class="space"> </span><span style="color:#ABB2BF;">typeSet)</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#E5C07B;">typeSet</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">stream</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">map</span><span style="color:#ABB2BF;">(String</span><span style="color:#C678DD;">::</span><span style="color:#ABB2BF;">valueOf)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">anyMatch</span><span style="color:#ABB2BF;">(type</span><span class="space"> </span><span style="color:#C678DD;">-&gt;</span><span class="space"> </span><span style="color:#61AFEF;">matchesField</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">alarmTypes</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#ABB2BF;">type));</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">if</span><span class="space"> </span><span style="color:#ABB2BF;">(alarmTypesParam</span><span class="space"> </span><span style="color:#C678DD;">instanceof</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#ABB2BF;">type)</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#61AFEF;">matchesField</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">alarmTypes</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#ABB2BF;">type);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#C678DD;">boolean</span><span class="space"> </span><span style="color:#61AFEF;">matchesField</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">jsonArrayOrCsv</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">targetValue</span><span style="color:#ABB2BF;">)</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">if</span><span class="space"> </span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">StringUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isBlank</span><span style="color:#ABB2BF;">(jsonArrayOrCsv))</span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">if</span><span class="space"> </span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">StringUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isBlank</span><span style="color:#ABB2BF;">(targetValue))</span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">try</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">if</span><span class="space"> </span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">jsonArrayOrCsv</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">trim</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">startsWith</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;[&quot;</span><span style="color:#ABB2BF;">))</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">ArrayNode</span><span class="space"> </span><span style="color:#E06C75;">arrayNode</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#ABB2BF;">(ArrayNode)</span><span class="space"> </span><span style="color:#E5C07B;">OBJECT_MAPPER</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">readTree</span><span style="color:#ABB2BF;">(jsonArrayOrCsv);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">if</span><span class="space"> </span><span style="color:#ABB2BF;">(arrayNode</span><span class="space"> </span><span style="color:#56B6C2;">==</span><span class="space"> </span><span style="color:#D19A66;">null</span><span class="space"> </span><span style="color:#56B6C2;">||</span><span class="space"> </span><span style="color:#E5C07B;">arrayNode</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isEmpty</span><span style="color:#ABB2BF;">())</span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">for</span><span class="space"> </span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">int</span><span class="space"> </span><span style="color:#E06C75;">i</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">;</span><span class="space"> </span><span style="color:#ABB2BF;">i</span><span class="space"> </span><span style="color:#56B6C2;">&lt;</span><span class="space"> </span><span style="color:#E5C07B;">arrayNode</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">size</span><span style="color:#ABB2BF;">();</span><span class="space"> </span><span style="color:#ABB2BF;">i++)</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">if</span><span class="space"> </span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">targetValue</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">equals</span><span style="color:#ABB2BF;">(</span><span style="color:#61AFEF;">cleanValue</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">arrayNode</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get</span><span style="color:#ABB2BF;">(i).</span><span style="color:#61AFEF;">asText</span><span style="color:#ABB2BF;">())))</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">[]</span><span class="space"> </span><span style="color:#E06C75;">valueArray</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#E5C07B;">jsonArrayOrCsv</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">split</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;,&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">for</span><span class="space"> </span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">value</span><span class="space"> </span><span style="color:#C678DD;">:</span><span class="space"> </span><span style="color:#ABB2BF;">valueArray)</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">if</span><span class="space"> </span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">targetValue</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">equals</span><span style="color:#ABB2BF;">(</span><span style="color:#61AFEF;">cleanValue</span><span style="color:#ABB2BF;">(value)))</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span><span class="space"> </span><span style="color:#C678DD;">catch</span><span class="space"> </span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Exception</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">e</span><span style="color:#ABB2BF;">)</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#61AFEF;">cleanValue</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">value</span><span style="color:#ABB2BF;">)</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">trimmed</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#E5C07B;">value</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">trim</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">if</span><span class="space"> </span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">trimmed</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">startsWith</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;</span><span style="color:#56B6C2;">\&quot;</span><span style="color:#98C379;">&quot;</span><span style="color:#ABB2BF;">)</span><span class="space"> </span><span style="color:#56B6C2;">&amp;&amp;</span><span class="space"> </span><span style="color:#E5C07B;">trimmed</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">endsWith</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;</span><span style="color:#56B6C2;">\&quot;</span><span style="color:#98C379;">&quot;</span><span style="color:#ABB2BF;">)</span><span class="space"> </span><span style="color:#56B6C2;">&amp;&amp;</span><span class="space"> </span><span style="color:#E5C07B;">trimmed</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">length</span><span style="color:#ABB2BF;">()</span><span class="space"> </span><span style="color:#56B6C2;">&gt;=</span><span class="space"> </span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">)</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#E5C07B;">trimmed</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">substring</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#E5C07B;">trimmed</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">length</span><span style="color:#ABB2BF;">()</span><span class="space"> </span><span style="color:#56B6C2;">-</span><span class="space"> </span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#ABB2BF;">trimmed;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-2-阈值策略-事件类型-置信度判定" tabindex="-1"><a class="header-anchor" href="#_6-2-阈值策略-事件类型-置信度判定"><span>6.2 阈值策略：事件类型 + 置信度判定</span></a></h3><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Data</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Accessors</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">chain</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#D19A66;">true</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span class="space"> </span><span style="color:#C678DD;">class</span><span class="space"> </span><span style="color:#E5C07B;">ConfidencePolicy</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">eventType</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#E5C07B;">BigDecimal</span><span class="space"> </span><span style="color:#E06C75;">warningValue</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">public</span><span class="space"> </span><span style="color:#C678DD;">boolean</span><span class="space"> </span><span style="color:#61AFEF;">supportsEventType</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">eventType</span><span style="color:#ABB2BF;">)</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#E5C07B;">StringUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isNotBlank</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">eventType</span><span style="color:#ABB2BF;">)</span><span class="space"> </span><span style="color:#56B6C2;">&amp;&amp;</span><span class="space"> </span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">eventType</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">equals</span><span style="color:#ABB2BF;">(eventType);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">public</span><span class="space"> </span><span style="color:#C678DD;">boolean</span><span class="space"> </span><span style="color:#61AFEF;">isConfidenceMatched</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Double</span><span class="space"> </span><span style="color:#E06C75;font-style:italic;">confidence</span><span style="color:#ABB2BF;">)</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">if</span><span class="space"> </span><span style="color:#ABB2BF;">(confidence</span><span class="space"> </span><span style="color:#56B6C2;">==</span><span class="space"> </span><span style="color:#D19A66;">null</span><span class="space"> </span><span style="color:#56B6C2;">||</span><span class="space"> </span><span style="color:#ABB2BF;">warningValue</span><span class="space"> </span><span style="color:#56B6C2;">==</span><span class="space"> </span><span style="color:#D19A66;">null</span><span style="color:#ABB2BF;">)</span><span class="space"> </span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">return</span><span class="space"> </span><span style="color:#E5C07B;">BigDecimal</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">valueOf</span><span style="color:#ABB2BF;">(confidence).</span><span style="color:#61AFEF;">compareTo</span><span style="color:#ABB2BF;">(warningValue)</span><span class="space"> </span><span style="color:#56B6C2;">&gt;=</span><span class="space"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>策略对象成为“规则载体”后，应用层只负责挑选和调用策略，不再拼装细节判断。</p><hr><h2 id="_7-应用层瘦身-从规则实现者到规则编排者" tabindex="-1"><a class="header-anchor" href="#_7-应用层瘦身-从规则实现者到规则编排者"><span>7. 应用层瘦身：从规则实现者到规则编排者</span></a></h2><h3 id="_7-1-创建事件-应用层更薄" tabindex="-1"><a class="header-anchor" href="#_7-1-创建事件-应用层更薄"><span>7.1 创建事件（应用层更薄）</span></a></h3><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#C678DD;">void</span><span class="space"> </span><span style="color:#61AFEF;">createWarningRecord</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">treeId</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">deviceCode</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#E5C07B;">Set</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">String</span><span style="color:#56B6C2;">&gt;</span><span class="space"> </span><span style="color:#E06C75;">eventTypes)</span><span class="space"> </span><span style="color:#E06C75;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">long</span><span class="space"> </span><span style="color:#E06C75;">now</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#E5C07B;">System</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">currentTimeMillis</span><span style="color:#ABB2BF;">()</span><span class="space"> </span><span style="color:#56B6C2;">/</span><span class="space"> </span><span style="color:#D19A66;">1000</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">EventWarning</span><span class="space"> </span><span style="color:#E06C75;">warning</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#E5C07B;">EventWarning</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">createAiWarning</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">treeId,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">deviceCode,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">IdUtil</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">nextId</span><span style="color:#ABB2BF;">(),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">join</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;,&quot;</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#ABB2BF;">eventTypes),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">now,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">RandomUtil</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">randomInt</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#D19A66;">5</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">warningGateway</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">insert</span><span style="color:#ABB2BF;">(warning);</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-2-关闭事件-应用层只触发行为" tabindex="-1"><a class="header-anchor" href="#_7-2-关闭事件-应用层只触发行为"><span>7.2 关闭事件（应用层只触发行为）</span></a></h3><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#C678DD;">void</span><span class="space"> </span><span style="color:#61AFEF;">closeWarning</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">EventWarning</span><span class="space"> </span><span style="color:#E06C75;">warning)</span><span class="space"> </span><span style="color:#E06C75;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">long</span><span class="space"> </span><span style="color:#E06C75;">endTime</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#E5C07B;">System</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">currentTimeMillis</span><span style="color:#ABB2BF;">()</span><span class="space"> </span><span style="color:#56B6C2;">/</span><span class="space"> </span><span style="color:#D19A66;">1000</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">warning</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">close</span><span style="color:#ABB2BF;">(endTime);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">warningGateway</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">updateEndTime</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">warning</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getEventId</span><span style="color:#ABB2BF;">(),</span><span class="space"> </span><span style="color:#E5C07B;">warning</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getEndTime</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-3-创建汇总-状态由领域决定" tabindex="-1"><a class="header-anchor" href="#_7-3-创建汇总-状态由领域决定"><span>7.3 创建汇总（状态由领域决定）</span></a></h3><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">private</span><span class="space"> </span><span style="color:#C678DD;">void</span><span class="space"> </span><span style="color:#61AFEF;">saveAlertSummary</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">TreeInfo</span><span class="space"> </span><span style="color:#E06C75;">tree</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#E5C07B;">AiResult</span><span class="space"> </span><span style="color:#E06C75;">result</span><span style="color:#ABB2BF;">,</span><span class="space"> </span><span style="color:#C678DD;">boolean</span><span class="space"> </span><span style="color:#E06C75;">strategyMatched)</span><span class="space"> </span><span style="color:#E06C75;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">LocalDateTime</span><span class="space"> </span><span style="color:#E06C75;">now</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#E5C07B;">LocalDateTime</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">now</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">AlertSummary</span><span class="space"> </span><span style="color:#E06C75;">summary</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#E5C07B;">AlertSummary</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">create</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">tree</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getTreeId</span><span style="color:#ABB2BF;">(),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">result</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getLevel</span><span style="color:#ABB2BF;">(),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">result</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getContent</span><span style="color:#ABB2BF;">(),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">now,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#98C379;">&quot;SENSOR&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#98C379;">&quot;ENV_CHANGE&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">strategyMatched</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">).</span><span style="color:#61AFEF;">setConcerns</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">JsonUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">toJson</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">result</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getConcerns</span><span style="color:#ABB2BF;">()))</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setSuggestions</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">JsonUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">toJson</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">result</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getSuggestions</span><span style="color:#ABB2BF;">()));</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">String</span><span class="space"> </span><span style="color:#E06C75;">summaryId</span><span class="space"> </span><span style="color:#56B6C2;">=</span><span class="space"> </span><span style="color:#E5C07B;">summaryGateway</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">insert</span><span style="color:#ABB2BF;">(summary);</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#C678DD;">if</span><span class="space"> </span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">summary</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">shouldCreateDisposeRecord</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">)</span><span class="space"> </span><span style="color:#E06C75;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E5C07B;">disposeRecordGateway</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">insert</span><span style="color:#ABB2BF;">(summaryId,</span><span class="space"> </span><span style="color:#E5C07B;">summary</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getStatus</span><span style="color:#ABB2BF;">(),</span><span class="space"> </span><span style="color:#ABB2BF;">now);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">}</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>一句话总结应用层职责变化：</p><ul><li>改造前：应用层实现规则。</li><li>改造后：应用层编排规则。</li></ul><hr><h2 id="_8-重构收益-怎么判断改造真的有效" tabindex="-1"><a class="header-anchor" href="#_8-重构收益-怎么判断改造真的有效"><span>8. 重构收益：怎么判断改造真的有效</span></a></h2><p>可以用下面 4 个可观测指标评估效果：</p><ol><li><strong>规则集中度</strong>：同一规则是否只在一个领域方法里维护。</li><li><strong>入口一致性</strong>：新增入口时是否天然复用已有规则。</li><li><strong>测试速度</strong>：核心逻辑能否在纯单测层快速覆盖。</li><li><strong>变更成本</strong>：状态机或校验规则变更时影响面是否可控。</li></ol><p>如果这 4 项都在向好，说明“充血改造”不是概念升级，而是工程质量升级。</p><hr><h2 id="_9-渐进式落地建议-避免大爆炸重构" tabindex="-1"><a class="header-anchor" href="#_9-渐进式落地建议-避免大爆炸重构"><span>9. 渐进式落地建议（避免大爆炸重构）</span></a></h2><p>建议按以下顺序推进：</p><ol><li><strong>先抓高频高风险对象</strong>：例如事件、订单、工单等核心实体。</li><li><strong>先收创建与状态流转</strong>：这两类逻辑最容易产生不一致。</li><li><strong>再收策略匹配与阈值判断</strong>：把 if-else 树迁回策略对象。</li><li><strong>最后清理应用层重复代码</strong>：让应用层只保留编排语义。</li></ol><p>这个顺序的好处是：每一步都有业务收益，同时可控回滚。</p><hr><h2 id="_10-常见误区" tabindex="-1"><a class="header-anchor" href="#_10-常见误区"><span>10. 常见误区</span></a></h2><h3 id="误区-1-充血模型-把所有逻辑塞进实体" tabindex="-1"><a class="header-anchor" href="#误区-1-充血模型-把所有逻辑塞进实体"><span>误区 1：充血模型 = 把所有逻辑塞进实体</span></a></h3><p>不是。实体承载的是“本领域强相关的不变量和行为”，跨聚合编排仍应放在应用层或领域服务。</p><h3 id="误区-2-用了枚举就等于-ddd" tabindex="-1"><a class="header-anchor" href="#误区-2-用了枚举就等于-ddd"><span>误区 2：用了枚举就等于 DDD</span></a></h3><p>不是。关键是“语义和约束是否被模型持有”，而不仅是常量写法变化。</p><h3 id="误区-3-一次性全量改造才算成功" tabindex="-1"><a class="header-anchor" href="#误区-3-一次性全量改造才算成功"><span>误区 3：一次性全量改造才算成功</span></a></h3><p>不是。真实项目应该增量演进，优先解决最痛点的规则分裂问题。</p><hr><h2 id="_11-收尾-一句话经验" tabindex="-1"><a class="header-anchor" href="#_11-收尾-一句话经验"><span>11. 收尾：一句话经验</span></a></h2><p><strong>充血模型的核心不是“方法变多”，而是“业务不变量有且只有一个可信入口”。</strong></p><p>当你把入口收拢，系统会同时得到三件事：可读性、可测试性、抗变更能力。</p></div><!----><!----><!----></div></main><footer class="vp-doc-footer" data-v-48823583 data-v-9110afba><!--[--><!--]--><!----><div class="contributors" aria-label="Contributors" data-v-9110afba><span class="contributors-label" data-v-9110afba>贡献者: </span><span class="contributors-info" data-v-9110afba><!--[--><!--[--><span class="contributor" data-v-9110afba>金逸霄</span><!----><!--]--><!--]--></span></div><nav class="prev-next" data-v-9110afba><div class="pager" data-v-9110afba><a class="vp-link no-icon link pager-link prev" href="/article/j3yf2tp3/" data-v-9110afba data-v-8fd51d7e><!--[--><span class="desc" data-v-9110afba>上一页</span><span class="title" data-v-9110afba>React 组件基础</span><!--]--><!----></a></div><div class="pager" data-v-9110afba><a class="vp-link no-icon link pager-link next" href="/article/b8e5hzao/" data-v-9110afba data-v-8fd51d7e><!--[--><span class="desc" data-v-9110afba>下一页</span><span class="title" data-v-9110afba>jpa-vs-mybatis-analysis</span><!--]--><!----></a></div></nav></footer><!----><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!--]--><button type="button" class="vp-back-to-top" aria-label="back to top" data-v-3bf3774b style="display:none;" data-v-22e14b5d><span class="percent" data-allow-mismatch data-v-22e14b5d>0%</span><span class="show icon vpi-back-to-top" data-v-22e14b5d></span><svg aria-hidden="true" data-v-22e14b5d><circle cx="50%" cy="50%" data-allow-mismatch style="stroke-dasharray:calc(0% - 12.566370614359172px) calc(314.1592653589793% - 12.566370614359172px);" data-v-22e14b5d></circle></svg></button><footer class="vp-footer" vp-footer data-v-3bf3774b data-v-232bff92><!--[--><div class="container" data-v-232bff92><p class="message" data-v-232bff92>————————到底啦!————————</p><p class="copyright" data-v-232bff92>copyleft © 2025 Exiao</p></div><!--]--></footer><!--[--><!--]--><!--]--></div><!----><!--]--><!--[--><!--]--><!--]--></div><script type="module" src="/assets/app-pBrtxVLr.js" defer></script></body></html>