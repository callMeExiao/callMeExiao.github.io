<!doctype html><html lang="zh-CN"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="generator" content="VuePress 2.0.0-rc.20" /><meta name="theme" content="VuePress Theme Plume " /><script id="check-mac-os">document.documentElement.classList.toggle('mac', /Mac|iPhone|iPod|iPad/i.test(navigator.platform))</script><meta property="og:url" content="https://callmeexiao.baby/article/rdmhyjn0/"><meta property="og:site_name" content="Exiao's Blog"><meta property="og:title" content="Docker DNS 与网络详解：Compose 到 ECS 实战全指南"><meta property="og:description" content="一篇讲透 Docker DNS 解析与容器网络的实战文章，覆盖 bridge/host/overlay、<DOCKER_DNS_IP>、extra_hosts、dns 配置、ECS 部署排障与最佳实践。"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2026-02-09T09:37:46.000Z"><meta property="article:modified_time" content="2026-02-09T09:37:46.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Docker DNS 与网络详解：Compose 到 ECS 实战全指南","image":[""],"dateModified":"2026-02-09T09:37:46.000Z","author":[]}</script><link rel="icon" type="image/png" href="https://theme-plume.vuejs.press/favicon-32x32.png"><title>Docker DNS 与网络详解：Compose 到 ECS 实战全指南 | Exiao's Blog</title><meta name="description" content="一篇讲透 Docker DNS 解析与容器网络的实战文章，覆盖 bridge/host/overlay、<DOCKER_DNS_IP>、extra_hosts、dns 配置、ECS 部署排障与最佳实践。"><link rel="preload" href="/assets/style-Cd332rkf.css" as="style"><link rel="stylesheet" href="/assets/style-Cd332rkf.css"><link rel="modulepreload" href="/assets/app-pBrtxVLr.js"><link rel="modulepreload" href="/assets/index.html-ClLZ5BQC.js"></head><body><div id="app"><!--[--><!--[--><div class="theme-plume vp-layout" vp-container data-v-3bf3774b><!--[--><!--[--><!--]--><!--[--><span tabindex="-1" data-v-1afd8ef4></span><a href="#VPContent" class="vp-skip-link visually-hidden" data-v-1afd8ef4> Skip to content </a><!--]--><!----><header class="vp-nav" data-v-3bf3774b data-v-93076610><div class="vp-navbar" vp-navbar data-v-93076610 data-v-fb9743c7><div class="wrapper" data-v-fb9743c7><div class="container" data-v-fb9743c7><div class="title" data-v-fb9743c7><div class="vp-navbar-title" data-v-fb9743c7 data-v-800466e1><a class="vp-link no-icon link title" href="/" data-v-800466e1 data-v-8fd51d7e><!--[--><!--[--><!--]--><!--[--><!--[--><!--[--><img class="vp-image dark logo" style="" src="https://theme-plume.vuejs.press/plume.png" alt data-v-c4044e2a><!--]--><!--[--><img class="vp-image light logo" style="" src="https://theme-plume.vuejs.press/plume.png" alt data-v-c4044e2a><!--]--><!--]--><!--]--><span data-v-800466e1>Exiao&#39;s Blog</span><!--[--><!--]--><!--]--><!----></a></div></div><div class="content" data-v-fb9743c7><div class="content-body" data-v-fb9743c7><!--[--><!--]--><div class="vp-navbar-search search" data-v-fb9743c7><div class="search-wrapper" data-v-9b6231cb><!----><div id="local-search" data-v-9b6231cb><button type="button" class="mini-search mini-search-button" aria-label="搜索文档" data-v-9b6231cb><span class="mini-search-button-container"><span class="mini-search-search-icon vpi-mini-search" aria-label="search icon"></span><span class="mini-search-button-placeholder">搜索文档</span></span><span class="mini-search-button-keys"><kbd class="mini-search-button-key"></kbd><kbd class="mini-search-button-key">K</kbd></span></button></div></div></div><nav aria-labelledby="main-nav-aria-label" class="vp-navbar-menu menu" data-v-fb9743c7 data-v-f0b866c0><span id="main-nav-aria-label" class="visually-hidden" data-v-f0b866c0>Main Navigation</span><!--[--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/" tabindex="0" data-v-f0b866c0 data-v-575a5ecb data-v-8fd51d7e><!--[--><!----><span data-v-575a5ecb>首页</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/blog/" tabindex="0" data-v-f0b866c0 data-v-575a5ecb data-v-8fd51d7e><!--[--><!----><span data-v-575a5ecb>博客</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/blog/tags/" tabindex="0" data-v-f0b866c0 data-v-575a5ecb data-v-8fd51d7e><!--[--><!----><span data-v-575a5ecb>标签</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/blog/archives/" tabindex="0" data-v-f0b866c0 data-v-575a5ecb data-v-8fd51d7e><!--[--><!----><span data-v-575a5ecb>归档</span><!--]--><!----></a><!--]--><!--[--><div class="vp-flyout vp-navbar-menu-group" data-v-f0b866c0 data-v-c02d6d2b><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-c02d6d2b><span class="text" data-v-c02d6d2b><!----><!----><span data-v-c02d6d2b>笔记</span><span class="vpi-chevron-down text-icon" data-v-c02d6d2b></span></span></button><div class="menu" data-v-c02d6d2b><div class="vp-menu" data-v-c02d6d2b data-v-97b8bc66><div class="items" data-v-97b8bc66><!--[--><!--[--><div class="vp-menu-link" data-v-97b8bc66 data-v-f09a0f1d><a class="vp-link no-icon link" href="/demo/" data-v-f09a0f1d data-v-8fd51d7e><!--[--><!----> 示例<!--]--><!----></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!----><!----><div class="vp-social-links vp-navbar-social-links social-links" data-v-fb9743c7 data-v-b384e0a0 data-v-820a862b><!--[--><a class="vp-social-link no-icon" href="https://github.com/callMeExiao/callMeExiao.github.io" aria-label="github" target="_blank" rel="noopener" data-v-820a862b data-v-20c69dec><span class="vpi-social-github" /></a><!--]--></div><div class="vp-flyout vp-navbar-extra extra" data-v-fb9743c7 data-v-450b28d0 data-v-c02d6d2b><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-c02d6d2b><span class="vpi-more-horizontal icon" data-v-c02d6d2b></span></button><div class="menu" data-v-c02d6d2b><div class="vp-menu" data-v-c02d6d2b data-v-97b8bc66><!----><!--[--><!--[--><!----><!----><div class="group" data-v-450b28d0><div class="item social-links" data-v-450b28d0><div class="vp-social-links social-links-list" data-v-450b28d0 data-v-820a862b><!--[--><a class="vp-social-link no-icon" href="https://github.com/callMeExiao/callMeExiao.github.io" aria-label="github" target="_blank" rel="noopener" data-v-820a862b data-v-20c69dec><span class="vpi-social-github" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="vp-navbar-hamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="nav-screen" data-v-fb9743c7 data-v-1bb12327><span class="container" data-v-1bb12327><span class="top" data-v-1bb12327></span><span class="middle" data-v-1bb12327></span><span class="bottom" data-v-1bb12327></span></span></button></div></div></div></div><div class="divider" data-v-fb9743c7><div class="divider-line" data-v-fb9743c7></div></div></div><!----></header><div class="vp-local-nav fixed reached-top is-blog" data-v-3bf3774b data-v-f47454cb><button class="hidden menu" disabled aria-expanded="false" aria-controls="SidebarNav" data-v-f47454cb><span class="vpi-align-left menu-icon" data-v-f47454cb></span><span class="menu-text" data-v-f47454cb>Menu</span></button><div class="vp-local-nav-outline-dropdown" style="--vp-vh:0px;" data-v-f47454cb data-v-9029d9f5><button data-v-9029d9f5>返回顶部</button><!----></div></div><!----><!--[--><div id="VPContent" vp-content class="vp-content" data-v-3bf3774b data-v-63d685ff><div class="vp-doc-container is-blog" data-v-63d685ff data-v-48823583><!--[--><!--]--><div class="container" data-v-48823583><!----><div class="content" data-v-48823583><div class="content-container" data-v-48823583><!--[--><!--]--><main class="main" data-v-48823583><nav class="vp-breadcrumb" data-v-48823583 data-v-c735a90d><ol vocab="https://schema.org/" typeof="BreadcrumbList" data-v-c735a90d><!--[--><li property="itemListElement" typeof="ListItem" data-v-c735a90d><a class="vp-link no-icon link breadcrumb" href="/" property="item" typeof="WebPage" data-v-c735a90d data-v-8fd51d7e><!--[-->首页<!--]--><!----></a><span class="vpi-chevron-right" data-v-c735a90d></span><meta property="name" content="首页" data-v-c735a90d><meta property="position" content="1" data-v-c735a90d></li><li property="itemListElement" typeof="ListItem" data-v-c735a90d><a class="vp-link no-icon link breadcrumb" href="/blog/" property="item" typeof="WebPage" data-v-c735a90d data-v-8fd51d7e><!--[-->博客<!--]--><!----></a><span class="vpi-chevron-right" data-v-c735a90d></span><meta property="name" content="博客" data-v-c735a90d><meta property="position" content="2" data-v-c735a90d></li><li property="itemListElement" typeof="ListItem" data-v-c735a90d><a class="vp-link no-icon link breadcrumb" href="/blog/categories/?id=f3809c" property="item" typeof="WebPage" data-v-c735a90d data-v-8fd51d7e><!--[-->网络知识<!--]--><!----></a><span class="vpi-chevron-right" data-v-c735a90d></span><meta property="name" content="网络知识" data-v-c735a90d><meta property="position" content="3" data-v-c735a90d></li><li property="itemListElement" typeof="ListItem" data-v-c735a90d><a class="vp-link no-icon link breadcrumb current" href="/article/rdmhyjn0/" property="item" typeof="WebPage" data-v-c735a90d data-v-8fd51d7e><!--[-->Docker DNS 与网络详解：Compose 到 ECS 实战全指南<!--]--><!----></a><!----><meta property="name" content="Docker DNS 与网络详解：Compose 到 ECS 实战全指南" data-v-c735a90d><meta property="position" content="4" data-v-c735a90d></li><!--]--></ol></nav><!--[--><h1 class="vp-doc-title page-title" data-v-d8ca9256>Docker DNS 与网络详解：Compose 到 ECS 实战全指南 <!----></h1><div class="vp-doc-meta" data-v-d8ca9256><p class="reading-time" data-v-d8ca9256><span class="vpi-books icon" data-v-d8ca9256></span><span data-v-d8ca9256>约 2111 字</span><span data-v-d8ca9256>大约 7 分钟</span></p><!----><p class="create-time" data-v-d8ca9256><span class="vpi-clock icon" data-v-d8ca9256></span><span data-v-d8ca9256>2026-02-09</span></p></div><!--]--><div class="_article_rdmhyjn0_ external-link-icon-enabled vp-doc plume-content" vp-content data-v-48823583><div data-v-48823583><hr><h2 id="一、先给你答案" tabindex="-1"><a class="header-anchor" href="#一、先给你答案"><span>一、先给你答案</span></a></h2><ol><li><strong>容器网络通信</strong>核心是 Linux Namespace + veth + bridge + NAT。</li><li><strong>容器 DNS 默认并不是直接查公网 DNS</strong>，在自定义网络中通常先走 Docker 内置 DNS（<code>&lt;DOCKER_DNS_IP&gt;</code>）。</li><li><code>dns</code> 的作用是配置“上游 DNS 服务器”，不负责把某个域名固定到某个 IP。</li><li><code>extra_hosts</code> 的作用是把映射写进容器 <code>/etc/hosts</code>，适合“强制域名 -&gt; IP”场景。</li><li>服务间互访优先使用 Compose 服务名（如 <code>service-a:8001</code>），而不是容器 IP。</li><li>排查时先看三处：<code>/etc/hosts</code>、<code>/etc/resolv.conf</code>、<code>docker network inspect</code>。</li></ol><hr><h2 id="二、本文适合谁" tabindex="-1"><a class="header-anchor" href="#二、本文适合谁"><span>二、本文适合谁</span></a></h2><p>你可能正处于以下场景之一：</p><ul><li>Docker Compose 项目里，部分容器能访问域名，部分不行。</li><li>在阿里云 ECS 上部署后，容器里 <code>curl</code> 某域名失败。</li><li>你不确定应该用 <code>dns</code> 还是 <code>extra_hosts</code>。</li><li>你用 sidecar（比如 <code>sidecar-runtime</code>）后，发现主容器与 sidecar 解析行为不一致。</li><li>你要给生产环境写一份可维护的网络与 DNS 运维规范。</li></ul><p>如果你符合其中任意一条，继续往下看就对了。</p><hr><h2 id="三、目录" tabindex="-1"><a class="header-anchor" href="#三、目录"><span>三、目录</span></a></h2><ul><li><a href="#%E5%9B%9Bdocker-%E7%BD%91%E7%BB%9C%E5%BA%95%E5%B1%82%E5%AE%B9%E5%99%A8%E4%B8%BA%E4%BB%80%E4%B9%88%E8%83%BD%E9%80%9A%E4%BF%A1">四、Docker 网络底层：容器为什么能通信</a></li><li><a href="#%E4%BA%94docker-%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F%E5%AF%B9%E6%AF%94">五、Docker 网络模式对比</a></li><li><a href="#%E5%85%ADdocker-dns-%E8%A7%A3%E6%9E%90%E5%85%A8%E6%B5%81%E7%A8%8B">六、Docker DNS 解析全流程</a></li><li><a href="#%E4%B8%83compose-%E4%B8%AD-dns-%E4%B8%8E-extra_hosts-%E7%9A%84%E8%BE%B9%E7%95%8C">七、Compose 中 <code>dns</code> 与 <code>extra_hosts</code> 的边界</a></li><li><a href="#%E5%85%AB%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%E4%BB%85%E7%BB%99-service-a-%E6%B7%BB%E5%8A%A0%E5%9F%9F%E5%90%8D%E6%98%A0%E5%B0%84">八、实战案例：仅给 <code>service-a</code> 添加域名映射</a></li><li><a href="#%E4%B9%9Decs-%E5%9C%BA%E6%99%AF%E6%8E%92%E9%9A%9C%E6%89%8B%E5%86%8C%E5%8F%AF%E7%9B%B4%E6%8E%A5%E6%89%A7%E8%A1%8C">九、ECS 场景排障手册（可直接执行）</a></li><li><a href="#%E5%8D%81%E5%B8%B8%E8%A7%81%E8%AF%AF%E5%8C%BA%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">十、常见误区与最佳实践</a></li><li><a href="#%E5%8D%81%E4%B8%80faq%E9%AB%98%E9%A2%91%E6%90%9C%E7%B4%A2%E9%97%AE%E9%A2%98">十一、FAQ（高频搜索问题）</a></li><li><a href="#%E5%8D%81%E4%BA%8C%E6%80%BB%E7%BB%93">十二、总结</a></li></ul><hr><h2 id="四、docker-网络底层-容器为什么能通信" tabindex="-1"><a class="header-anchor" href="#四、docker-网络底层-容器为什么能通信"><span>四、Docker 网络底层：容器为什么能通信</span></a></h2><h3 id="_4-1-四个关键组件" tabindex="-1"><a class="header-anchor" href="#_4-1-四个关键组件"><span>4.1 四个关键组件</span></a></h3><ul><li><strong>Network Namespace</strong>：容器各自拥有独立网络栈（网卡、路由、端口空间）。</li><li><strong>veth pair</strong>：一端在容器内（通常是 <code>eth0</code>），另一端挂到宿主机 bridge。</li><li><strong>bridge（网桥）</strong>：同网桥容器二层互通。</li><li><strong>iptables/NAT</strong>：容器访问外网时 SNAT，外部访问容器端口时 DNAT。</li></ul><h3 id="_4-2-三条典型流量路径" tabindex="-1"><a class="header-anchor" href="#_4-2-三条典型流量路径"><span>4.2 三条典型流量路径</span></a></h3><ul><li><strong>容器到容器（同网络）</strong>：容器 A -&gt; bridge -&gt; 容器 B。</li><li><strong>容器到公网</strong>：容器 -&gt; bridge -&gt; 宿主机 NAT -&gt; Internet。</li><li><strong>公网到容器</strong>：公网 -&gt; ECS 端口 -&gt; DNAT -&gt; 容器端口。</li></ul><p>理解这三条路径，基本就能解释 80% 的“Docker 网络不通”问题。</p><hr><h2 id="五、docker-网络模式对比" tabindex="-1"><a class="header-anchor" href="#五、docker-网络模式对比"><span>五、Docker 网络模式对比</span></a></h2><h3 id="_5-1-bridge-默认推荐" tabindex="-1"><a class="header-anchor" href="#_5-1-bridge-默认推荐"><span>5.1 <code>bridge</code>（默认推荐）</span></a></h3><ul><li>隔离性和可维护性最好，最适合大多数业务。</li><li>自定义 bridge 网络下支持 Docker DNS 服务发现（服务名解析）。</li></ul><h3 id="_5-2-host" tabindex="-1"><a class="header-anchor" href="#_5-2-host"><span>5.2 <code>host</code></span></a></h3><ul><li>容器直接使用宿主机网络栈，不需要 <code>-p</code> 映射。</li><li>性能高，但隔离性差，端口冲突风险高。</li></ul><h3 id="_5-3-none" tabindex="-1"><a class="header-anchor" href="#_5-3-none"><span>5.3 <code>none</code></span></a></h3><ul><li>仅 loopback，无外部网络连接。</li><li>用于高隔离任务或离线作业。</li></ul><h3 id="_5-4-overlay" tabindex="-1"><a class="header-anchor" href="#_5-4-overlay"><span>5.4 <code>overlay</code></span></a></h3><ul><li>常见于 Swarm/K8s 跨主机场景。</li><li>跨节点网络能力强，但复杂度更高。</li></ul><hr><h2 id="六、docker-dns-解析全流程" tabindex="-1"><a class="header-anchor" href="#六、docker-dns-解析全流程"><span>六、Docker DNS 解析全流程</span></a></h2><h3 id="_6-1-为什么容器里会出现-docker-dns-ip" tabindex="-1"><a class="header-anchor" href="#_6-1-为什么容器里会出现-docker-dns-ip"><span>6.1 为什么容器里会出现 <code>&lt;DOCKER_DNS_IP&gt;</code></span></a></h3><p>在 user-defined network 中，容器常见 <code>resolv.conf</code>：</p><div class="language-conf line-numbers-mode" data-ext="conf" data-title="conf"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>nameserver</span><span class="space"> </span><span>&lt;DOCKER_DNS_IP&gt;</span></span>
<span class="line"><span>options</span><span class="space"> </span><span>ndots:0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>这意味着容器先问 Docker 内置 DNS，再由它向上游 DNS 递归查询。</p><h3 id="_6-2-服务名解析是怎么来的" tabindex="-1"><a class="header-anchor" href="#_6-2-服务名解析是怎么来的"><span>6.2 服务名解析是怎么来的</span></a></h3><p>在同一 Compose 网络中可直接访问：</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>http://service-a:8001</span></span>
<span class="line"><span>http://redis:6379</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>这不是公网 DNS 解析，而是 Docker 内置服务发现。</p><h3 id="_6-3-解析优先级-非常关键" tabindex="-1"><a class="header-anchor" href="#_6-3-解析优先级-非常关键"><span>6.3 解析优先级（非常关键）</span></a></h3><p>多数 Linux 发行版 <code>nsswitch.conf</code> 为：</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>hosts:</span><span class="space"> </span><span>files</span><span class="space"> </span><span>dns</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>即：</p><ol><li>先查 <code>/etc/hosts</code></li><li>再查 DNS</li></ol><p>所以 <code>extra_hosts</code> 生效后，经常会覆盖 DNS 返回结果。</p><hr><h2 id="七、compose-中-dns-与-extra-hosts-的边界" tabindex="-1"><a class="header-anchor" href="#七、compose-中-dns-与-extra-hosts-的边界"><span>七、Compose 中 <code>dns</code> 与 <code>extra_hosts</code> 的边界</span></a></h2><p>这是搜索量最高、也最容易混淆的一点。</p><h3 id="_7-1-dns-指定上游-dns-服务器" tabindex="-1"><a class="header-anchor" href="#_7-1-dns-指定上游-dns-服务器"><span>7.1 <code>dns</code>：指定上游 DNS 服务器</span></a></h3><div class="language-yaml line-numbers-mode" data-ext="yaml" data-title="yaml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#E06C75;">services</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">gateway-service</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">dns</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">-</span><span class="space"> </span><span style="color:#98C379;">&lt;DNS_SERVER_1&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">-</span><span class="space"> </span><span style="color:#98C379;">&lt;DNS_SERVER_2&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>适用场景：</p><ul><li>你要指定企业内网 DNS。</li><li>宿主机默认 DNS 不可靠。</li><li>想统一容器 DNS 递归路径。</li></ul><p>不适用场景：</p><ul><li>把某一个域名强制绑定到某一个 IP。</li></ul><h3 id="_7-2-extra-hosts-静态写入-etc-hosts" tabindex="-1"><a class="header-anchor" href="#_7-2-extra-hosts-静态写入-etc-hosts"><span>7.2 <code>extra_hosts</code>：静态写入 <code>/etc/hosts</code></span></a></h3><div class="language-yaml line-numbers-mode" data-ext="yaml" data-title="yaml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#E06C75;">services</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">service-a</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">extra_hosts</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">-</span><span class="space"> </span><span style="color:#98C379;">&quot;&lt;TARGET_DOMAIN&gt;:&lt;TARGET_IP&gt;&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>适用场景：</p><ul><li>联调临时切流。</li><li>上游 DNS 还没发布或不在你控制范围。</li><li>你必须保证某个容器固定访问某个 IP。</li></ul><p>注意事项：</p><ul><li>修改后需重建容器才能稳定生效。</li><li>IP 变更要人工维护，长期使用要有审计机制。</li></ul><h3 id="_7-3-x-extra-hosts-是什么" tabindex="-1"><a class="header-anchor" href="#_7-3-x-extra-hosts-是什么"><span>7.3 <code>x-extra_hosts</code> 是什么</span></a></h3><p><code>x-</code> 前缀是 Compose 扩展字段，常用于锚点复用：</p><div class="language-yaml line-numbers-mode" data-ext="yaml" data-title="yaml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#E06C75;">x-extra_hosts</span><span style="color:#ABB2BF;">:</span><span class="space"> </span><span style="color:#C678DD;">&amp;</span><span style="color:#E5C07B;">default-extra_hosts</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">-</span><span class="space"> </span><span style="color:#98C379;">&quot;&lt;INTERNAL_DOMAIN&gt;:${HOST_IP_PLACEHOLDER}&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;">services</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">web</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">extra_hosts</span><span style="color:#ABB2BF;">:</span><span class="space"> </span><span style="color:#C678DD;">*</span><span style="color:#E06C75;">default-extra_hosts</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>有些 IDE 会对扩展字段做严格 schema 校验，出现“应为单值/类型不匹配”提示。<br> 这通常是编辑器规则提示，不等于运行时一定报错。</p><hr><h2 id="八、实战案例-仅给-service-a-添加域名映射" tabindex="-1"><a class="header-anchor" href="#八、实战案例-仅给-service-a-添加域名映射"><span>八、实战案例：仅给 <code>service-a</code> 添加域名映射</span></a></h2><blockquote><p>目标：只让 <code>service-a</code> 具备 <code>&lt;TARGET_DOMAIN&gt; -&gt; &lt;TARGET_IP&gt;</code>，避免影响其他容器。</p></blockquote><h3 id="_8-1-推荐配置-最小影响面" tabindex="-1"><a class="header-anchor" href="#_8-1-推荐配置-最小影响面"><span>8.1 推荐配置（最小影响面）</span></a></h3><div class="language-yaml line-numbers-mode" data-ext="yaml" data-title="yaml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#E06C75;">services</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">service-a</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">extra_hosts</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">-</span><span class="space"> </span><span style="color:#98C379;">&quot;&lt;INTERNAL_DOMAIN_A&gt;:&lt;TARGET_IP&gt;&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">-</span><span class="space"> </span><span style="color:#98C379;">&quot;&lt;TARGET_DOMAIN&gt;:&lt;TARGET_IP&gt;&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样做的好处：</p><ul><li>只影响目标服务。</li><li>风险最小，回滚简单。</li><li>避免公共锚点扩散带来的隐性副作用。</li></ul><h3 id="_8-2-生效命令-ecs-常用" tabindex="-1"><a class="header-anchor" href="#_8-2-生效命令-ecs-常用"><span>8.2 生效命令（ECS 常用）</span></a></h3><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#61AFEF;">docker</span><span class="space"> </span><span style="color:#98C379;">compose</span><span class="space"> </span><span style="color:#D19A66;">-f</span><span class="space"> </span><span style="color:#98C379;">deploy/docker-compose.yml</span><span class="space"> </span><span style="color:#98C379;">up</span><span class="space"> </span><span style="color:#D19A66;">-d</span><span class="space"> </span><span style="color:#D19A66;">--force-recreate</span><span class="space"> </span><span style="color:#98C379;">service-a</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="九、ecs-场景排障手册-可直接执行" tabindex="-1"><a class="header-anchor" href="#九、ecs-场景排障手册-可直接执行"><span>九、ECS 场景排障手册（可直接执行）</span></a></h2><h3 id="_9-1-检查容器内-hosts-resolv" tabindex="-1"><a class="header-anchor" href="#_9-1-检查容器内-hosts-resolv"><span>9.1 检查容器内 hosts/resolv</span></a></h3><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#61AFEF;">docker</span><span class="space"> </span><span style="color:#98C379;">exec</span><span class="space"> </span><span style="color:#98C379;">service-a</span><span class="space"> </span><span style="color:#98C379;">sh</span><span class="space"> </span><span style="color:#D19A66;">-lc</span><span class="space"> </span><span style="color:#98C379;">&#39;cat</span><span class="space"> </span><span style="color:#98C379;">/etc/hosts&#39;</span></span>
<span class="line"><span style="color:#61AFEF;">docker</span><span class="space"> </span><span style="color:#98C379;">exec</span><span class="space"> </span><span style="color:#98C379;">service-a</span><span class="space"> </span><span style="color:#98C379;">sh</span><span class="space"> </span><span style="color:#D19A66;">-lc</span><span class="space"> </span><span style="color:#98C379;">&#39;cat</span><span class="space"> </span><span style="color:#98C379;">/etc/resolv.conf&#39;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_9-2-检查解析结果" tabindex="-1"><a class="header-anchor" href="#_9-2-检查解析结果"><span>9.2 检查解析结果</span></a></h3><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#61AFEF;">docker</span><span class="space"> </span><span style="color:#98C379;">exec</span><span class="space"> </span><span style="color:#98C379;">service-a</span><span class="space"> </span><span style="color:#98C379;">sh</span><span class="space"> </span><span style="color:#D19A66;">-lc</span><span class="space"> </span><span style="color:#98C379;">&#39;getent</span><span class="space"> </span><span style="color:#98C379;">hosts</span><span class="space"> </span><span style="color:#98C379;">&lt;TARGET_DOMAIN&gt;&#39;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">#</span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">若镜像无</span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">getent，可退化为</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">#</span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">docker</span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">exec</span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">service-a</span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">sh</span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">-lc</span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">&#39;grep</span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">-n</span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">&quot;&lt;TARGET_DOMAIN&gt;&quot;</span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">/etc/hosts&#39;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_9-3-检查-compose-静态配置" tabindex="-1"><a class="header-anchor" href="#_9-3-检查-compose-静态配置"><span>9.3 检查 Compose 静态配置</span></a></h3><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#61AFEF;">docker</span><span class="space"> </span><span style="color:#98C379;">compose</span><span class="space"> </span><span style="color:#D19A66;">-f</span><span class="space"> </span><span style="color:#98C379;">deploy/docker-compose.yml</span><span class="space"> </span><span style="color:#98C379;">config</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_9-4-检查容器网络归属" tabindex="-1"><a class="header-anchor" href="#_9-4-检查容器网络归属"><span>9.4 检查容器网络归属</span></a></h3><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#61AFEF;">docker</span><span class="space"> </span><span style="color:#98C379;">inspect</span><span class="space"> </span><span style="color:#98C379;">service-a</span><span class="space"> </span><span style="color:#D19A66;">--format</span><span class="space"> </span><span style="color:#98C379;">&#39;{{json .NetworkSettings.Networks}}&#39;</span></span>
<span class="line"><span style="color:#61AFEF;">docker</span><span class="space"> </span><span style="color:#98C379;">network</span><span class="space"> </span><span style="color:#98C379;">ls</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">#</span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">将</span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">&lt;network_name&gt;</span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">替换为上面查到的实际网络名（常见如</span><span class="space"> </span><span style="color:#7F848E;font-style:italic;">project_default）</span></span>
<span class="line"><span style="color:#61AFEF;">docker</span><span class="space"> </span><span style="color:#98C379;">network</span><span class="space"> </span><span style="color:#98C379;">inspect</span><span class="space"> </span><span style="color:#ABB2BF;">&lt;</span><span style="color:#98C379;">network_nam</span><span style="color:#ABB2BF;">e&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_9-5-一张排障决策表" tabindex="-1"><a class="header-anchor" href="#_9-5-一张排障决策表"><span>9.5 一张排障决策表</span></a></h3><table><thead><tr><th>现象</th><th>高概率原因</th><th>优先检查</th></tr></thead><tbody><tr><td>容器中域名解析到旧 IP</td><td><code>/etc/hosts</code> 有历史映射</td><td><code>cat /etc/hosts</code></td></tr><tr><td>同域名在不同容器结果不同</td><td><code>extra_hosts</code> 作用域不一致</td><td>各容器 <code>extra_hosts</code> 配置</td></tr><tr><td>服务名无法解析</td><td>不在同一 Docker 网络</td><td><code>docker network inspect</code></td></tr><tr><td>偶发解析超时</td><td>上游 DNS 不稳定</td><td><code>dns</code> 配置与连通性</td></tr><tr><td>Compose 通过但运行不通</td><td>运行态网络/防火墙问题</td><td>安全组、路由、容器日志</td></tr></tbody></table><hr><h2 id="十、常见误区与最佳实践" tabindex="-1"><a class="header-anchor" href="#十、常见误区与最佳实践"><span>十、常见误区与最佳实践</span></a></h2><h3 id="_10-1-常见误区" tabindex="-1"><a class="header-anchor" href="#_10-1-常见误区"><span>10.1 常见误区</span></a></h3><ol><li>配了 <code>dns</code> 就等于把域名绑到 IP。</li><li>DNS 问题一定是公网 DNS 坏了。</li><li>所有容器都应该共享同一组 <code>extra_hosts</code>。</li><li><code>docker compose config</code> 成功就等于线上可用。</li></ol><h3 id="_10-2-推荐实践" tabindex="-1"><a class="header-anchor" href="#_10-2-推荐实践"><span>10.2 推荐实践</span></a></h3><ul><li>服务互调优先用服务名，不硬编码容器 IP。</li><li>仅在“需要该域名解析”的服务中配置 <code>extra_hosts</code>。</li><li>给每条静态映射标注用途、责任人、计划回收时间。</li><li>将 DNS 排障命令写入 Runbook，减少故障恢复时间。</li><li>定期审计历史映射，避免“僵尸配置”。</li></ul><hr><h2 id="十一、faq" tabindex="-1"><a class="header-anchor" href="#十一、faq"><span>十一、FAQ</span></a></h2><h3 id="q1-docker-dns-和-extra-hosts-到底有什么区别" tabindex="-1"><a class="header-anchor" href="#q1-docker-dns-和-extra-hosts-到底有什么区别"><span>Q1：Docker <code>dns</code> 和 <code>extra_hosts</code> 到底有什么区别？</span></a></h3><p><code>dns</code> 决定“问谁（DNS 服务器）”；<code>extra_hosts</code> 决定“先写死答案（/etc/hosts）”。</p><h3 id="q2-为什么我在宿主机能解析-容器里不行" tabindex="-1"><a class="header-anchor" href="#q2-为什么我在宿主机能解析-容器里不行"><span>Q2：为什么我在宿主机能解析，容器里不行？</span></a></h3><p>容器 DNS 可能走了不同链路（<code>&lt;DOCKER_DNS_IP&gt;</code> + 上游 DNS），且容器内 <code>/etc/hosts</code> 可能覆盖了解析结果。</p><h3 id="q3-extra-hosts-会不会覆盖真实-dns" tabindex="-1"><a class="header-anchor" href="#q3-extra-hosts-会不会覆盖真实-dns"><span>Q3：<code>extra_hosts</code> 会不会覆盖真实 DNS？</span></a></h3><p>通常会。因为多数系统优先查 <code>files</code>（<code>/etc/hosts</code>）再查 <code>dns</code>。</p><h3 id="q4-在-ecs-上应该优先-extra-hosts-还是内网-dns" tabindex="-1"><a class="header-anchor" href="#q4-在-ecs-上应该优先-extra-hosts-还是内网-dns"><span>Q4：在 ECS 上应该优先 <code>extra_hosts</code> 还是内网 DNS？</span></a></h3><p>短期联调/临时切流优先 <code>extra_hosts</code>；长期稳定策略优先内网 DNS，运维成本更低。</p><h3 id="q5-只改一个服务能不能生效" tabindex="-1"><a class="header-anchor" href="#q5-只改一个服务能不能生效"><span>Q5：只改一个服务能不能生效？</span></a></h3><p>可以。<code>extra_hosts</code> 是容器级配置，按服务粒度生效，最符合“最小影响面”原则。</p><hr><h2 id="十二、总结" tabindex="-1"><a class="header-anchor" href="#十二、总结"><span>十二、总结</span></a></h2><p>Docker 网络与 DNS 本质上是三个层面的组合：</p><ol><li><strong>网络可达性</strong>：namespace + bridge + route + NAT。</li><li><strong>名称解析链路</strong>：<code>/etc/hosts</code> 与 DNS 的优先级关系。</li><li><strong>配置作用域控制</strong>：仅在必要服务配置 <code>extra_hosts</code>。</li></ol><p>如果你把这三层拆开排障，绝大多数 “Docker DNS/网络问题” 都能快速定位。</p><hr><h2 id="附录-a-可直接复用的最小配置片段" tabindex="-1"><a class="header-anchor" href="#附录-a-可直接复用的最小配置片段"><span>附录 A：可直接复用的最小配置片段</span></a></h2><div class="language-yaml line-numbers-mode" data-ext="yaml" data-title="yaml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#E06C75;">services</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">service-a</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">image</span><span style="color:#ABB2BF;">:</span><span class="space"> </span><span style="color:#98C379;">your-image</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">extra_hosts</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">-</span><span class="space"> </span><span style="color:#98C379;">&quot;&lt;INTERNAL_DOMAIN_A&gt;:&lt;TARGET_IP&gt;&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">-</span><span class="space"> </span><span style="color:#98C379;">&quot;&lt;TARGET_DOMAIN&gt;:&lt;TARGET_IP&gt;&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">networks</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#ABB2BF;">-</span><span class="space"> </span><span style="color:#98C379;">net</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;">networks</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">net</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">external</span><span style="color:#ABB2BF;">:</span><span class="space"> </span><span style="color:#D19A66;">true</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="color:#E06C75;">name</span><span style="color:#ABB2BF;">:</span><span class="space"> </span><span style="color:#98C379;">eth0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr></div><!----><!----><!----></div></main><footer class="vp-doc-footer" data-v-48823583 data-v-9110afba><!--[--><!--]--><!----><div class="contributors" aria-label="Contributors" data-v-9110afba><span class="contributors-label" data-v-9110afba>贡献者: </span><span class="contributors-info" data-v-9110afba><!--[--><!--[--><span class="contributor" data-v-9110afba>金逸霄</span><!----><!--]--><!--]--></span></div><nav class="prev-next" data-v-9110afba><div class="pager" data-v-9110afba><a class="vp-link no-icon link pager-link prev" href="/article/cacwh3dx/" data-v-9110afba data-v-8fd51d7e><!--[--><span class="desc" data-v-9110afba>上一页</span><span class="title" data-v-9110afba>为什么安卓app要适配不同机型</span><!--]--><!----></a></div><div class="pager" data-v-9110afba><a class="vp-link no-icon link pager-link next" href="/article/j3yf2tp3/" data-v-9110afba data-v-8fd51d7e><!--[--><span class="desc" data-v-9110afba>下一页</span><span class="title" data-v-9110afba>React 组件基础</span><!--]--><!----></a></div></nav></footer><!----><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!--]--><button type="button" class="vp-back-to-top" aria-label="back to top" data-v-3bf3774b style="display:none;" data-v-22e14b5d><span class="percent" data-allow-mismatch data-v-22e14b5d>0%</span><span class="show icon vpi-back-to-top" data-v-22e14b5d></span><svg aria-hidden="true" data-v-22e14b5d><circle cx="50%" cy="50%" data-allow-mismatch style="stroke-dasharray:calc(0% - 12.566370614359172px) calc(314.1592653589793% - 12.566370614359172px);" data-v-22e14b5d></circle></svg></button><footer class="vp-footer" vp-footer data-v-3bf3774b data-v-232bff92><!--[--><div class="container" data-v-232bff92><p class="message" data-v-232bff92>————————到底啦!————————</p><p class="copyright" data-v-232bff92>copyleft © 2025 Exiao</p></div><!--]--></footer><!--[--><!--]--><!--]--></div><!----><!--]--><!--[--><!--]--><!--]--></div><script type="module" src="/assets/app-pBrtxVLr.js" defer></script></body></html>